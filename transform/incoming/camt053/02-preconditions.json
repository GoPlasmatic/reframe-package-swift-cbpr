{
    "id": "camt053-preconditions",
    "name": "camt.053 to MT940 Preconditions",
    "description": "Validates preconditions per specification (PREC001-009)",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.053"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt053-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "set_target_message"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_sequence_numbers",
            "name": "Validate Sequence Numbers (PREC001)",
            "description": "Check legal or electronic sequence number present and <= 5 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt",
                            "logic": { "or": [
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.LglSeqNb"},
                                    {"<=": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.LglSeqNb"}, 99999]}
                                ]},
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.ElctrncSeqNb"},
                                    {"<=": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.ElctrncSeqNb"}, 99999]}
                                ]}
                            ]},
                            "message": "T20103/T20150: LegalSequenceNumber or ElectronicSequenceNumber must be present and <= 5 digits"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_opening_balance",
            "name": "Validate Opening Balance (PREC002/003)",
            "description": "Check opening balance requirements based on page number",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt",
                            "logic": { "if": [
                                {"==": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.StmtPgntn.PgNb"}, "1"]},
                                {
                                    "some": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal"},
                                        { "and": [
                                            {"==": [{"var": "Tp.CdOrPrtry.Cd"}, "OPBD"]},
                                            {"!=": [{"var": "Tp.SubTp.Cd"}, "INTM"]}
                                        ]}
                                    ]
                                },
                                {
                                    "some": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal"},
                                        { "and": [
                                            {"==": [{"var": "Tp.CdOrPrtry.Cd"}, "OPBD"]},
                                            {"==": [{"var": "Tp.SubTp.Cd"}, "INTM"]}
                                        ]}
                                    ]
                                }
                            ]},
                            "message": "T20104-T20106/T20151-T20153: Invalid opening balance for page position"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_closing_balance",
            "name": "Validate Closing Balance (PREC004/005)",
            "description": "Check closing balance requirements based on last page indicator",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt",
                            "logic": { "if": [
                                {"==": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.StmtPgntn.LastPgInd"}, true]},
                                {
                                    "some": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal"},
                                        { "and": [
                                            {"==": [{"var": "Tp.CdOrPrtry.Cd"}, "CLBD"]},
                                            {"!=": [{"var": "Tp.SubTp.Cd"}, "INTM"]}
                                        ]}
                                    ]
                                },
                                {
                                    "some": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal"},
                                        { "and": [
                                            {"==": [{"var": "Tp.CdOrPrtry.Cd"}, "CLBD"]},
                                            {"==": [{"var": "Tp.SubTp.Cd"}, "INTM"]}
                                        ]}
                                    ]
                                }
                            ]},
                            "message": "T20107-T20108/T20154-T20155: Invalid closing balance for page position"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_available_balance",
            "name": "Validate Available Balance (PREC006)",
            "description": "Check maximum 1 CLAV balance",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal",
                            "logic": {"<=": [{"length": {"filter": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal"}, {"==": [{"var": "Tp.CdOrPrtry.Cd"}, "CLAV"]}]}}, 1]},
                            "message": "T20109/T20156: Maximum 1 occurrence of CLAV balance allowed"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_entry_count",
            "name": "Validate Entry Count (PREC007)",
            "description": "Check number of entries does not exceed 190",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Ntry",
                            "logic": { "or": [
                                {"!": {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Ntry"}},
                                {"<=": [{"length": {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Ntry"}}, 190]}
                            ]},
                            "message": "T20110/T20157: Number of entries exceeds 190 (max for 10K message)"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_entry_amounts",
            "name": "Validate Entry Amounts (PREC008)",
            "description": "Check entry currencies match account and amounts <= 14 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Ntry",
                            "logic": { "if": [
                                {"exists": ["data", "ISO20022_MX", "Document", "BkToCstmrStmt", "Stmt", "Ntry"]},
                                {
                                    "all": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Ntry"},
                                        { "and": [
                                            {"==": [{"var": "Amt.@Ccy"}, {"val": [[-3], "data", "ISO20022_MX", "Document", "BkToCstmrStmt", "Stmt", "Acct", "Ccy"]}]},
                                            {"<=": [{"var": "Amt.$value"}, 99999999999999]}
                                        ]}
                                    ]
                                },
                                true
                            ]},
                            "message": "T20113/T20116/T20160/T20163: Entry currency mismatch or amount > 14 digits"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_balance_currencies",
            "name": "Validate Balance Currencies (PREC009)",
            "description": "Check balance currencies match and amounts <= 14 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal",
                            "logic": {
                                "all": [
                                    {
                                        "filter": [
                                            {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Bal"},
                                            {
                                                "in": [
                                                    {"var": "Tp.CdOrPrtry.Cd"},
                                                    ["OPBD", "CLBD", "CLAV", "FWAV"]
                                                ]
                                            }
                                        ]
                                    },
                                    { "and": [
                                        {"<=": [{"var": "Amt.$value"}, 99999999999999]},
                                        {"==": [{"substr": [{"var": "Amt.@Ccy"}, 0, 2]}, {"substr": [{"val": [[-3], "data", "ISO20022_MX", "Document", "BkToCstmrStmt", "Stmt", "Acct", "Ccy"]}, 0, 2]}]}
                                    ]}
                                ]
                            },
                            "message": "T20111-T20112/T20158-T20159: Balance currency mismatch or amount > 14 digits"
                        }
                    ]
                }
            }
        }
    ]
}
