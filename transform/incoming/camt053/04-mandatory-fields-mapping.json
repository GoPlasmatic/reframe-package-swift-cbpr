{
    "id": "camt053-mandatory-fields-mapping",
    "name": "camt.053 to MT940 Mandatory Fields Mapping",
    "description": "Maps mandatory fields per specification (TR001-003)",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.053"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt053-headers-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_swift_headers"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_20",
            "name": "Map Statement Reference (Field 20)",
            "description": "Maps Statement/Identification per TR001",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#20",
                            "logic": {
                                "reference": { "if": [
                                    { "or": [
                                        {"starts_with": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Id"}, "/"]},
                                        {"ends_with": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Id"}, "/"]},
                                        {"in": ["//", {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Id"}]}
                                    ]},
                                    "NOTPROVIDED",
                                    { "if": [
                                        {">": [{"length": {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Id"}}, 16]},
                                        {
                                            "cat": [
                                                {
                                                    "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Id"}, 0, 15]
                                                },
                                                "+"
                                            ]
                                        },
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Id"}
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_25",
            "name": "Map Account Identification (Field 25)",
            "description": "Maps account per TR002",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#25",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Ownr.Id.OrgId.AnyBIC"},
                                    {"!=": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Ownr.Id.OrgId.AnyBIC"}, {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"}]}
                                ]},
                                {
                                    "P": {
                                        "account": { "if": [
                                            {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Id.IBAN"},
                                            {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Id.IBAN"},
                                            {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Id.Othr.Id"}
                                        ]},
                                        "bic": {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Ownr.Id.OrgId.AnyBIC"}
                                    }
                                },
                                {
                                    "authorisation": { "if": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Id.IBAN"},
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Id.IBAN"},
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Acct.Id.Othr.Id"}
                                    ]}
                                }
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_28C",
            "name": "Map Statement Number (Field 28C)",
            "description": "Maps sequence numbers per TR003",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.28C",
                            "logic": {
                                "statement_number": { "if": [
                                    { "and": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.LglSeqNb"},
                                        {"<=": [{"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.LglSeqNb"}, 99999]}
                                    ]},
                                    {"+": {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.LglSeqNb"}},
                                    {"+": {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.ElctrncSeqNb"}}
                                ]},
                                "sequence_number": {
                                    "+": { "if": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.StmtPgntn.PgNb"},
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.StmtPgntn.PgNb"},
                                        0
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}
