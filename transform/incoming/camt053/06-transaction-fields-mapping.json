{
    "id": "camt053-transaction-fields-mapping",
    "name": "camt.053 to MT940 Transaction Fields Mapping",
    "description": "Maps transaction entries per specification (TR005-007, TR012)",
    "priority": 7,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.053"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt053-balance-fields-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_available_balance"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_61",
            "name": "Map Statement Entries (Field 61)",
            "description": "Maps entries per TR005-006",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##",
                            "logic": {
                                "map": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrStmt.Stmt.Ntry"},
                                    {
                                        "61": {
                                            "value_date": { "if": [
                                                {"var": "ValDt.Dt"},
                                                {"var": "ValDt.Dt"},
                                                {
                                                    "substr": [{"var": "ValDt.DtTm"}, 0, 10]
                                                }
                                            ]},
                                            "entry_date": { "if": [
                                                {"var": "BookgDt.Dt"},
                                                {"var": "BookgDt.Dt"},
                                                { "if": [
                                                    {"var": "BookgDt.DtTm"},
                                                    {
                                                        "substr": [{"var": "BookgDt.DtTm"}, 0, 10]
                                                    },
                                                    null
                                                ]}
                                            ]},
                                            "debit_credit_mark": { "if": [
                                                {"==": [{"var": "RvslInd"}, true]},
                                                { "if": [
                                                    {"==": [{"var": "CdtDbtInd"}, "DBIT"]},
                                                    "RC",
                                                    "RD"
                                                ]},
                                                { "if": [
                                                    {"==": [{"var": "CdtDbtInd"}, "DBIT"]},
                                                    "D",
                                                    "C"
                                                ]}
                                            ]},
                                            "funds_code": null,
                                            "amount": {"var": "Amt.$value"},
                                            "transaction_type": "NTRF",
                                            "customer_reference": { "if": [
                                                {"==": [{"var": "CdtDbtInd"}, "CRDT"]},
                                                { "if": [
                                                    { "and": [
                                                        {"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"},
                                                        {"!=": [{"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"}, "NOTPROVIDED"]}
                                                    ]},
                                                    { "if": [
                                                        {">": [{"length": {"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"}}, 16]},
                                                        {
                                                            "cat": [
                                                                {
                                                                    "substr": [{"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"}, 0, 15]
                                                                },
                                                                "+"
                                                            ]
                                                        },
                                                        { "if": [
                                                            { "or": [
                                                                {"starts_with": [{"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"}, "/"]},
                                                                {"ends_with": [{"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"}, "/"]},
                                                                {"in": ["//", {"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"}]}
                                                            ]},
                                                            "NONREF",
                                                            {"var": "NtryDtls.0.TxDtls.0.Refs.EndToEndId"}
                                                        ]}
                                                    ]},
                                                    "NONREF"
                                                ]},
                                                { "if": [
                                                    {"var": "NtryDtls.0.TxDtls.0.Refs.InstrId"},
                                                    { "if": [
                                                        {">": [{"length": {"var": "NtryDtls.0.TxDtls.0.Refs.InstrId"}}, 16]},
                                                        {
                                                            "cat": [
                                                                {
                                                                    "substr": [{"var": "NtryDtls.0.TxDtls.0.Refs.InstrId"}, 0, 15]
                                                                },
                                                                "+"
                                                            ]
                                                        },
                                                        { "if": [
                                                            { "or": [
                                                                {"starts_with": [{"var": "NtryDtls.0.TxDtls.0.Refs.InstrId"}, "/"]},
                                                                {"ends_with": [{"var": "NtryDtls.0.TxDtls.0.Refs.InstrId"}, "/"]},
                                                                {"in": ["//", {"var": "NtryDtls.0.TxDtls.0.Refs.InstrId"}]}
                                                            ]},
                                                            "NONREF",
                                                            {"var": "NtryDtls.0.TxDtls.0.Refs.InstrId"}
                                                        ]}
                                                    ]},
                                                    "NONREF"
                                                ]}
                                            ]},
                                            "bank_reference": { "if": [
                                                {"var": "NtryDtls.0.TxDtls.0.Refs.AcctSvcrRef"},
                                                { "if": [
                                                    {">": [{"length": {"var": "NtryDtls.0.TxDtls.0.Refs.AcctSvcrRef"}}, 16]},
                                                    {
                                                        "cat": [
                                                            {
                                                                "substr": [{"var": "NtryDtls.0.TxDtls.0.Refs.AcctSvcrRef"}, 0, 15]
                                                            },
                                                            "+"
                                                        ]
                                                    },
                                                    {"var": "NtryDtls.0.TxDtls.0.Refs.AcctSvcrRef"}
                                                ]},
                                                null
                                            ]},
                                            "supplementary_details": { "if": [
                                                {"var": "AddtlNtryInf"},
                                                { "if": [
                                                    {">": [{"length": {"var": "AddtlNtryInf"}}, 34]},
                                                    {
                                                        "cat": [
                                                            {
                                                                "substr": [{"var": "AddtlNtryInf"}, 0, 33]
                                                            },
                                                            "+"
                                                        ]
                                                    },
                                                    {"var": "AddtlNtryInf"}
                                                ]},
                                                null
                                            ]}
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        }
    ]
}
