{
    "id": "pacs008-to-mt103-charge-fields",
    "name": "pacs.008 to MT103 Charge Fields Mapping",
    "description": "Maps charge-related fields including Field 71A (Details of Charges - TR016), Field 71F (Sender's Charges - TR017), and Field 71G (Receiver's Charges - TR018)",
    "priority": 7,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.008"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs008-to-mt103-amount-fields"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_exchange_rate"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_charge_bearer",
            "name": "Map Charge Bearer",
            "description": "Map Field 71A (Details of Charges) based on ChargeBearer code (TR016)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#71A",
                            "logic": { "if": [
                                {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr"}, "CRED"]},
                                {"code": "BEN"},
                                { "if": [
                                    {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr"}, "DEBT"]},
                                    {"code": "OUR"},
                                    { "if": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr"}, "SHAR"]},
                                        {"code": "SHA"},
                                        null
                                    ]}
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_senders_charges",
            "name": "Map Sender's Charges",
            "description": "Map Field 71F (Sender's Charges) when ChargeBearer is CRED or SHAR (TR017)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.71F",
                            "logic": { "if": [
                                { "and": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr"}, "CRED"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr"}, "SHAR"]}
                                    ]},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgsInf"}
                                ]},
                                {
                                    "map": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgsInf"},
                                        {"currency": {"var": "Amt.@Ccy"}, "amount": {"var": "Amt.$value"}}
                                    ]
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_receivers_charges",
            "name": "Map Receiver's Charges",
            "description": "Map Field 71G (Receiver's Charges) when ChargeBearer is DEBT - sum of all charges (TR018)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.total_charges",
                            "logic": { "if": [
                                { "and": [
                                    {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr"}, "DEBT"]},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgsInf"}
                                ]},
                                { "reduce": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgsInf"},
                                    {"+": [{"var": "accumulator"}, {"var": "current.Amt.$value"}]},
                                    0
                                ]},
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.charges_currency",
                            "logic": { "if": [
                                { "and": [
                                    {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr"}, "DEBT"]},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgsInf.0.Amt.@Ccy"}
                                ]},
                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgsInf.0.Amt.@Ccy"},
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.71G",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.total_charges"},
                                    {"var": "temp_data.charges_currency"},
                                    {">": [{"var": "temp_data.total_charges"}, 0]}
                                ]},
                                {
                                    "currency": {"var": "temp_data.charges_currency"},
                                    "amount": {"var": "temp_data.total_charges"}
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}
