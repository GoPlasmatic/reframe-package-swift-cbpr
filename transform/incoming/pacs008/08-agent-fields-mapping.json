{
    "id": "pacs008-to-mt103-agent-fields",
    "name": "pacs.008 to MT103 Agent Fields Mapping",
    "description": "Mapping for agent fields (52-57) implementing full CBPR+ specification with proper clearing system logic, option prioritization, and //RT//FW handling per TR003, TR005, TR007, TR019, TR021, TR023",
    "priority": 9,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.008"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs008-to-mt103-party-fields"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_beneficiary_customer"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_ordering_institution",
            "name": "Map Ordering Institution",
            "description": "Map Field 52A/D (Ordering Institution) from DebtorAgent per TR021 with proper BIC/clearing code priority",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.52A",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.BICFI"},
                                {
                                    "bic": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.BICFI"},
                                    "party_identifier": { "if": [
                                        { "and": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgtAcct.Id.Othr.Id"},
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.BICFI"}
                                        ]},
                                        {
                                            "cat": [
                                                "/",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgtAcct.Id.Othr.Id"}
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                                {
                                                    "in": [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                        [
                                                            "ATBLZ",
                                                            "AUBSB",
                                                            "CNAPS",
                                                            "DEBLZ",
                                                            "CACPA",
                                                            "GRBIC",
                                                            "HKNCC",
                                                            "IENCC",
                                                            "INFSC",
                                                            "ITNCC",
                                                            "PLKNR",
                                                            "PTNCC",
                                                            "ZANCC",
                                                            "ESNCC",
                                                            "GBDSC",
                                                            "USABA"
                                                        ]
                                                    ]
                                                }
                                            ]},
                                            {
                                                "cat": [
                                                    "//",
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                                ]
                                            },
                                            null
                                        ]}
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.52D",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.Nm"}
                                ]},
                                {
                                    "party_identifier": { "if": [
                                        { "and": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                            {
                                                "in": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    [
                                                        "ATBLZ",
                                                        "AUBSB",
                                                        "DEBLZ",
                                                        "CACPA",
                                                        "GRBIC",
                                                        "HKNCC",
                                                        "IENCC",
                                                        "INFSC",
                                                        "ITNCC",
                                                        "PLKNR",
                                                        "PTNCC",
                                                        "ZANCC",
                                                        "RUCBC",
                                                        "CHBCC",
                                                        "CHSIC",
                                                        "ESNCC",
                                                        "GBDSC",
                                                        "USPID",
                                                        "USABA"
                                                    ]
                                                ]
                                            }
                                        ]},
                                        {
                                            "cat": [
                                                "//",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]
                                        },
                                        ""
                                    ]},
                                    "name_and_address": {
                                        "merge": [
                                            [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.Nm"}
                                            ],
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.PstlAdr.AdrLine"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.PstlAdr.AdrLine"},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.PstlAdr.StrtNm"},
                                                    [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.PstlAdr.StrtNm"},
                                                        {
                                                            "cat": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.PstlAdr.TwnNm"},
                                                                { "if": [
                                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.PstlAdr.Ctry"},
                                                                    {
                                                                        "cat": [
                                                                            ", ",
                                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.PstlAdr.Ctry"}
                                                                        ]
                                                                    },
                                                                    ""
                                                                ]}
                                                            ]
                                                        }
                                                    ],
                                                    ["NOTPROVIDED"]
                                                ]}
                                            ]}
                                        ]
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_senders_correspondent",
            "name": "Map Sender's Correspondent",
            "description": "Map Field 53A/B (Sender's Correspondent) per TR003 with settlement method validation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.53A",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.BICFI"},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmMtd"},
                                    {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmMtd"}, "COVE"]}
                                ]},
                                {
                                    "bic": {"raw": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.BICFI"}},
                                    "party_identifier": { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.Othr.Id"},
                                        {
                                            "cat": [
                                                "/",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.Othr.Id"}
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                                {
                                                    "!": [
                                                        {
                                                            "in": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                                ["USPID", "RUCBC", "CHBCC", "CHSIC"]
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]},
                                            {
                                                "cat": [
                                                    "//",
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                                ]
                                            },
                                            ""
                                        ]}
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.53B",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.Othr.Id"},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmMtd"},
                                    {
                                        "in": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmMtd"},
                                            ["INGA", "INDA"]
                                        ]
                                    }
                                ]},
                                {"party_identifier": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.Othr.Id"}},
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_receivers_correspondent",
            "name": "Map Receiver's Correspondent",
            "description": "Map Field 54A/D (Receiver's Correspondent) per TR005 with clearing system validation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.54A",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.BICFI"},
                                {
                                    "bic": {"raw": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.BICFI"}},
                                    "party_identifier": { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgtAcct.Id.Othr.Id"},
                                        {
                                            "cat": [
                                                "/",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgtAcct.Id.Othr.Id"}
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                                {
                                                    "!": [
                                                        {
                                                            "in": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                                ["USPID", "RUCBC", "CHBCC", "CHSIC"]
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]},
                                            {
                                                "cat": [
                                                    "//",
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                                ]
                                            },
                                            ""
                                        ]}
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.54D",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.Nm"}
                                ]},
                                {
                                    "party_identifier": { "if": [
                                        { "and": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                        ]},
                                        {
                                            "cat": [
                                                "//",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]
                                        },
                                        ""
                                    ]},
                                    "name_and_address": {
                                        "merge": [
                                            [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.Nm"}
                                            ],
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.PstlAdr.AdrLine"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.PstlAdr.AdrLine"},
                                                ["NOTPROVIDED"]
                                            ]}
                                        ]
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_third_reimbursement",
            "name": "Map Third Reimbursement Institution",
            "description": "Map Field 55A/D (Third Reimbursement Institution) per TR007 with full option support",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.55A",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.BICFI"},
                                {
                                    "bic": {"raw": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.BICFI"}},
                                    "party_identifier": { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgtAcct.Id.Othr.Id"},
                                        {
                                            "cat": [
                                                "/",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgtAcct.Id.Othr.Id"}
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                                {
                                                    "!": [
                                                        {
                                                            "in": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                                ["USPID", "RUCBC", "CHBCC", "CHSIC"]
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]},
                                            {
                                                "cat": [
                                                    "//",
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                                ]
                                            },
                                            ""
                                        ]}
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.55D",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.Nm"}
                                ]},
                                {
                                    "party_identifier": { "if": [
                                        { "and": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                        ]},
                                        {
                                            "cat": [
                                                "//",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]
                                        },
                                        ""
                                    ]},
                                    "name_and_address": {
                                        "merge": [
                                            [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.Nm"}
                                            ],
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.PstlAdr.AdrLine"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.ThrdRmbrsmntAgt.FinInstnId.PstlAdr.AdrLine"},
                                                ["NOTPROVIDED"]
                                            ]}
                                        ]
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_intermediary_institution",
            "name": "Map Intermediary Institution",
            "description": "Map Field 56A/C/D (Intermediary Institution) per TR019 with RTGS and clearing channel support",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.56A",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.BICFI"},
                                {
                                    "bic": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.BICFI"},
                                    "party_identifier": { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1Acct.Id.Othr.Id"},
                                        {
                                            "cat": [
                                                "/",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1Acct.Id.Othr.Id"}
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]},
                                            { "if": [
                                                {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}, "RTGS"]},
                                                {
                                                    "cat": [
                                                        "//RT",
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}
                                                    ]
                                                },
                                                {
                                                    "cat": [
                                                        "//",
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}
                                                    ]
                                                }
                                            ]},
                                            null
                                        ]}
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.56C",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}
                                ]},
                                {
                                    "account_number": { "if": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}, "RTGS"]},
                                        {
                                            "cat": [
                                                "//RT",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]
                                        },
                                        {
                                            "cat": [
                                                "//",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]
                                        }
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.56D",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId.ClrSysId.Cd"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.Nm"}
                                ]},
                                {
                                    "name_and_address": {
                                        "merge": [
                                            [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.Nm"}
                                            ],
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.PstlAdr.AdrLine"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.PstlAdr.AdrLine"},
                                                ["NOTPROVIDED"]
                                            ]}
                                        ]
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_account_with_institution",
            "name": "Map Account With Institution",
            "description": "Map Field 57A/B/C/D (Account With Institution) per TR023 with full CBPR+ compliance and clearing validation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.57A",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"},
                                {
                                    "bic": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"},
                                    "party_identifier": { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgtAcct.Id.Othr.Id"},
                                        {
                                            "cat": [
                                                "/",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgtAcct.Id.Othr.Id"}
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]},
                                            { "if": [
                                                {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}, "RTGS"]},
                                                {
                                                    "cat": [
                                                        "//RT",
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                                    ]
                                                },
                                                {
                                                    "cat": [
                                                        "//",
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                                    ]
                                                }
                                            ]},
                                            null
                                        ]}
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.57B",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                    {
                                        "in": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                            ["USABA", "CACPA", "GBDSC", "AUBSB"]
                                        ]
                                    }
                                ]},
                                {"party_identifier": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}},
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.57C",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                    {
                                        "!": [
                                            {
                                                "in": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    ["USABA", "CACPA", "GBDSC", "AUBSB"]
                                                ]
                                            }
                                        ]
                                    }
                                ]},
                                {
                                    "account_number": { "if": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}, "RTGS"]},
                                        {
                                            "cat": [
                                                "//RT",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]
                                        },
                                        {
                                            "cat": [
                                                "//",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                            ]
                                        }
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.57D",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"}
                                        ]
                                    },
                                    {
                                        "!": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"}
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.Nm"}
                                ]},
                                {
                                    "name_and_address": {
                                        "merge": [
                                            [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.Nm"}
                                            ],
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.PstlAdr.AdrLine"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.PstlAdr.AdrLine"},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.PstlAdr.StrtNm"},
                                                    [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.PstlAdr.StrtNm"},
                                                        {
                                                            "cat": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.PstlAdr.TwnNm"},
                                                                { "if": [
                                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.PstlAdr.Ctry"},
                                                                    {
                                                                        "cat": [
                                                                            ", ",
                                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.PstlAdr.Ctry"}
                                                                        ]
                                                                    },
                                                                    ""
                                                                ]}
                                                            ]
                                                        }
                                                    ],
                                                    ["NOTPROVIDED"]
                                                ]}
                                            ]}
                                        ]
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}
