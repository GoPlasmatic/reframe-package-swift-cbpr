{
    "id": "pacs008-to-mt103-additional-optional-fields",
    "name": "pacs.008 to MT103 Additional Optional Fields Mapping",
    "description": "Maps additional optional MT103 fields including Field 21, 26T, 13C, and settlement fields 53A/B per CBPR+ specification",
    "priority": 13,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.008"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs008-to-mt103-optional-fields"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_regulatory_reporting"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_transaction_type_code",
            "name": "Map Transaction Type Code",
            "description": "Map Field 26T (Transaction Type Code) from Purpose code with specific pattern matching",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#26T",
                            "logic": {
                                "type_code": { "if": [
                                    { "and": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.Purp.Cd"},
                                        {"==": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.Purp.Cd"}, 0, 1]}, "T"]}
                                    ]},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.Purp.Cd"},
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_related_reference",
            "name": "Map Related Reference",
            "description": "Map Field 21 (Related Reference) from OriginalEndToEndIdentification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#21",
                            "logic": {
                                "related_reference": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtId.TxId"},
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtId.TxId"},
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_settlement_account",
            "name": "Map Settlement Account",
            "description": "Map Field 53A/B per TR002/TR027/TR028 - Settlement account and instructing reimbursement agent",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#53",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "in": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmMtd"},
                                            ["INDA", "INGA"]
                                        ]
                                    },
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt"}
                                ]},
                                { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.BICFI"},
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct"},
                                        {
                                            "A": {
                                                "bic": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.BICFI"},
                                                "party_identifier": { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.IBAN"},
                                                    {
                                                        "cat": [
                                                            "/",
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.IBAN"}
                                                        ]
                                                    },
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.Othr.Id"},
                                                        {
                                                            "cat": [
                                                                "/",
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.Othr.Id"}
                                                            ]
                                                        },
                                                        null
                                                    ]}
                                                ]}
                                            }
                                        },
                                        {"A": {"bic": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.BICFI"}}}
                                    ]},
                                    { "if": [
                                        { "or": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct"},
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                        ]},
                                        {
                                            "B": {
                                                "party_identifier": { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.IBAN"},
                                                    {
                                                        "cat": [
                                                            "/",
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.IBAN"}
                                                        ]
                                                    },
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.Othr.Id"},
                                                        {
                                                            "cat": [
                                                                "/",
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Id.Othr.Id"}
                                                            ]
                                                        },
                                                        { "if": [
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                                            {
                                                                "cat": [
                                                                    "/",
                                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.MmbId"}
                                                                ]
                                                            },
                                                            null
                                                        ]}
                                                    ]}
                                                ]},
                                                "location": { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.InstgRmbrsmntAgtAcct.Nm"}
                                                ]}
                                            }
                                        },
                                        null
                                    ]}
                                ]},
                                { "if": [
                                    { "and": [
                                        {
                                            "in": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmMtd"},
                                                ["INDA", "INGA"]
                                            ]
                                        },
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct"}
                                    ]},
                                    {
                                        "B": {
                                            "party_identifier": { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.IBAN"},
                                                {
                                                    "cat": [
                                                        "/",
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.IBAN"}
                                                    ]
                                                },
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.Othr.Id"},
                                                    {
                                                        "cat": [
                                                            "/",
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.Othr.Id"}
                                                        ]
                                                    },
                                                    null
                                                ]}
                                            ]},
                                            "location": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmAcct.Nm"}
                                        }
                                    },
                                    null
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_time_indications",
            "name": "Map Time Indications",
            "description": "Map Field 13C (Time Indications) per TR014 specification - SNDTIME, RNCTIME, CLSTIME, TILTIME, FROTIME, REJTIME",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.13C",
                            "logic": {
                                "filter": [
                                    [
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"},
                                                {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"}}, 16]}
                                            ]},
                                            {
                                                "code": "/SNDTIME/",
                                                "time": {
                                                    "cat": [
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"},
                                                                11,
                                                                2
                                                            ]
                                                        },
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"},
                                                                14,
                                                                2
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "sign": { "if": [
                                                    { "and": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"}}, 20]},
                                                        {"==": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"}, -1, 1]}, "Z"]}
                                                    ]},
                                                    "+",
                                                    { "if": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"}}, 25]},
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"},
                                                                -6,
                                                                1
                                                            ]
                                                        },
                                                        "+"
                                                    ]}
                                                ]},
                                                "offset": { "if": [
                                                    { "and": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"}}, 20]},
                                                        {"==": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"}, -1, 1]}, "Z"]}
                                                    ]},
                                                    "0000",
                                                    { "if": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"}}, 25]},
                                                        {
                                                            "cat": [
                                                                {
                                                                    "substr": [
                                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"},
                                                                        -5,
                                                                        2
                                                                    ]
                                                                },
                                                                {
                                                                    "substr": [
                                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"},
                                                                        -2,
                                                                        2
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "0000"
                                                    ]}
                                                ]}
                                            },
                                            null
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"},
                                                {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"}}, 16]}
                                            ]},
                                            {
                                                "code": "/RNCTIME/",
                                                "time": {
                                                    "cat": [
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"},
                                                                11,
                                                                2
                                                            ]
                                                        },
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"},
                                                                14,
                                                                2
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "sign": { "if": [
                                                    { "and": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"}}, 20]},
                                                        {"==": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"}, -1, 1]}, "Z"]}
                                                    ]},
                                                    "+",
                                                    { "if": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"}}, 25]},
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"},
                                                                -6,
                                                                1
                                                            ]
                                                        },
                                                        "+"
                                                    ]}
                                                ]},
                                                "offset": { "if": [
                                                    { "and": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"}}, 20]},
                                                        {"==": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"}, -1, 1]}, "Z"]}
                                                    ]},
                                                    "0000",
                                                    { "if": [
                                                        {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"}}, 25]},
                                                        {
                                                            "cat": [
                                                                {
                                                                    "substr": [
                                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"},
                                                                        -5,
                                                                        2
                                                                    ]
                                                                },
                                                                {
                                                                    "substr": [
                                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"},
                                                                        -2,
                                                                        2
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "0000"
                                                    ]}
                                                ]}
                                            },
                                            null
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.CLSTm"},
                                                {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.CLSTm"}}, 5]}
                                            ]},
                                            {
                                                "code": "/CLSTIME/",
                                                "time": {
                                                    "cat": [
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.CLSTm"},
                                                                0,
                                                                2
                                                            ]
                                                        },
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.CLSTm"},
                                                                3,
                                                                2
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "sign": "+",
                                                "offset": "0000"
                                            },
                                            null
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.TillTm"},
                                                {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.TillTm"}}, 5]}
                                            ]},
                                            {
                                                "code": "/TILTIME/",
                                                "time": {
                                                    "cat": [
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.TillTm"},
                                                                0,
                                                                2
                                                            ]
                                                        },
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.TillTm"},
                                                                3,
                                                                2
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "sign": "+",
                                                "offset": "0000"
                                            },
                                            null
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.FrTm"},
                                                {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.FrTm"}}, 5]}
                                            ]},
                                            {
                                                "code": "/FROTIME/",
                                                "time": {
                                                    "cat": [
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.FrTm"},
                                                                0,
                                                                2
                                                            ]
                                                        },
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.FrTm"},
                                                                3,
                                                                2
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "sign": "+",
                                                "offset": "0000"
                                            },
                                            null
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.RjctTm"},
                                                {">=": [{"length": {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.RjctTm"}}, 5]}
                                            ]},
                                            {
                                                "code": "/REJTIME/",
                                                "time": {
                                                    "cat": [
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.RjctTm"},
                                                                0,
                                                                2
                                                            ]
                                                        },
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SttlmTmReq.RjctTm"},
                                                                3,
                                                                2
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "sign": "+",
                                                "offset": "0000"
                                            },
                                            null
                                        ]}
                                    ],
                                    {"!!": {"var": ""}}
                                ]
                            }
                        }
                    ]
                }
            }
        }
    ]
}
