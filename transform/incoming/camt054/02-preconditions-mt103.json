{
    "id": "camt054-to-mt103-preconditions",
    "name": "camt.054 to MT103 Advice Preconditions Validation",
    "description": "Validates preconditions for camt.054 to MT103 Advice transformation",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.variant"}, "MT103_ADVICE"]},
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.054"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt054-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "determine_target_message"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_debtor_creditor",
            "name": "Validate Debtor and Creditor (PREC003-004)",
            "description": "Check debtor or debtor agent AND creditor or creditor agent present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties",
                            "logic": { "and": [
                                { "or": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Pty"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt"}}
                                ]},
                                { "or": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Cdtr.Pty"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Cdtr.Agt"}}
                                ]}
                            ]},
                            "message": "PREC003/004: Debtor/DebtorAgent and Creditor/CreditorAgent must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_credit_indicator",
            "name": "Validate Credit Indicator (PREC005)",
            "description": "Check credit/debit indicator is not DBIT",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.CdtDbtInd",
                            "logic": {"!=": [{"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.CdtDbtInd"}, "DBIT"]},
                            "message": "PREC005: CreditDebitIndicator must not be DBIT"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_settlement_date",
            "name": "Validate Settlement Date (PREC006)",
            "description": "Check interbank settlement date present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdDts.IntrBkSttlmDt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdDts.IntrBkSttlmDt"}},
                            "message": "PREC006: InterbankSettlementDate must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_uetr",
            "name": "Validate UETR (PREC007)",
            "description": "Check UETR present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs.UETR",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs.UETR"}},
                            "message": "PREC007: UETR must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_amount",
            "name": "Validate Amount (PREC008)",
            "description": "Check amount present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Amt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Amt.$value"}},
                            "message": "PREC008: Amount must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_agents_exclusivity",
            "name": "Validate Agents Exclusivity (PREC010)",
            "description": "Check that both CreditorAgent and DebtorAgent are not present together",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties",
                            "logic": {
                                "!": { "and": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Cdtr.Agt"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt"}}
                                ]}
                            },
                            "message": "PREC010: Both CreditorAgent and DebtorAgent cannot be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_debtor_agent",
            "name": "Validate Debtor Agent (PREC027)",
            "description": "Check debtor agent present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.DbtrAgt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.DbtrAgt"}},
                            "message": "PREC027: DebtorAgent must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_intermediary_sequence",
            "name": "Validate Intermediary Agent Sequence (PREC045-047)",
            "description": "Check intermediary agents in correct sequence",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts",
                            "logic": { "if": [
                                { "or": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.IntrmyAgt2"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.IntrmyAgt3"}}
                                ]},
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.IntrmyAgt1"}},
                                true
                            ]},
                            "message": "PREC045: IntermediaryAgent2/3 requires IntermediaryAgent1"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts",
                            "logic": { "if": [
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.IntrmyAgt3"}},
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.IntrmyAgt2"}},
                                true
                            ]},
                            "message": "PREC046: IntermediaryAgent3 requires IntermediaryAgent2"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts",
                            "logic": { "if": [
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.IntrmyAgt1"}},
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.CdtrAgt"}},
                                true
                            ]},
                            "message": "PREC047: IntermediaryAgent1 requires CreditorAgent"
                        }
                    ]
                }
            }
        }
    ]
}
