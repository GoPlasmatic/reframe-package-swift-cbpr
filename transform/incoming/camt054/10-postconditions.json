{
    "id": "camt054-postconditions",
    "name": "camt.054 Post-conditions and Final Assembly",
    "description": "Validates post-conditions and assembles final MT message for all variants",
    "priority": 7,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.054"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]},
        { "or": [
            { "and": [
                {"==": [{"var": "metadata.SwiftMT.variant"}, "MT103_ADVICE"]},
                {"==": [{"var": "metadata.progress.workflow_id"}, "camt054-to-mt103-fields-mapping"]},
                {"==": [{"var": "metadata.progress.task_id"}, "map_remittance_info"]}
            ]},
            { "and": [
                {"==": [{"var": "metadata.SwiftMT.variant"}, "MT202_ADVICE"]},
                {"==": [{"var": "metadata.progress.workflow_id"}, "camt054-to-mt202-fields-mapping"]},
                {"==": [{"var": "metadata.progress.task_id"}, "map_sender_receiver_info"]}
            ]},
            { "and": [
                {"in": [{"var": "metadata.SwiftMT.variant"}, ["MT900", "MT910"]]},
                {"==": [{"var": "metadata.progress.workflow_id"}, "camt054-to-mt9x0-fields-mapping"]},
                {"==": [{"var": "metadata.progress.task_id"}, "map_additional_info"]}
            ]}
        ]}
    ]},
    "tasks": [
        {
            "id": "validate_final_message",
            "name": "Validate Final MT Message",
            "description": "Validates the generated MT message structure",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.SwiftMT.fields",
                            "logic": {"!!": {"var": "data.SwiftMT.fields.20"}},
                            "message": "T20115: Field 20 is mandatory"
                        },
                        {
                            "path": "data.SwiftMT.fields",
                            "logic": {"!!": {"var": "data.SwiftMT.fields.21"}},
                            "message": "T20116: Field 21 is mandatory"
                        }
                    ]
                }
            }
        },
        {
            "id": "generate_mt_message",
            "name": "Generate MT Message",
            "description": "Generate the final MT message",
            "function": {"name": "publish_mt", "input": {"source": "SwiftMT", "target": "result"}}
        }
    ]
}
