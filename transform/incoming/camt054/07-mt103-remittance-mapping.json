{
    "id": "camt054-to-mt103-remittance-mapping",
    "name": "camt.054 to MT103 Advice Remittance Information Mapping",
    "description": "Maps remittance information and field 72 for MT103 Advice",
    "priority": 6,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.variant"}, "MT103_ADVICE"]},
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.054"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt054-to-mt103-fields-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_agent_fields"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "prepare_remittance_components",
            "name": "Prepare Remittance Components",
            "description": "Prepares components for field 70 and field 72",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field70_components",
                            "logic": {
                                "purpose": { "if": [
                                    {"var": "temp_data.txn_path.Purp.Cd"},
                                    {"cat": ["/PURP/", {"var": "temp_data.txn_path.Purp.Cd"}]},
                                    { "if": [
                                        { "and": [
                                            {"var": "temp_data.txn_path.Purp.Prtry"},
                                            {"match": [{"var": "temp_data.txn_path.Purp.Prtry"}, "^:26T:[A-Z0-9]{3}$"]}
                                        ]},
                                        null,
                                        { "if": [
                                            {"var": "temp_data.txn_path.Purp.Prtry"},
                                            {
                                                "cat": [
                                                    "/PURP/",
                                                    {
                                                        "substr": [{"var": "temp_data.txn_path.Purp.Prtry"}, 0, 30]
                                                    }
                                                ]
                                            },
                                            null
                                        ]}
                                    ]}
                                ]},
                                "ultd": { "if": [
                                    {"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty"},
                                    {
                                        "cat": [
                                            "/ULTD/",
                                            { "if": [
                                                {"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Nm"},
                                                {
                                                    "substr": [{"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Nm"}, 0, 33]
                                                },
                                                { "if": [
                                                    {"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Id.OrgId.AnyBIC"},
                                                    {"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Id.OrgId.AnyBIC"},
                                                    { "if": [
                                                        {"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Id.OrgId.Othr.0.Id"},
                                                        {
                                                            "substr": [{"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Id.OrgId.Othr.0.Id"}, 0, 33]
                                                        },
                                                        { "if": [
                                                            {"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Id.PrvtId.Othr.0.Id"},
                                                            {
                                                                "substr": [{"var": "temp_data.txn_path.RltdPties.UltmtDbtr.Pty.Id.PrvtId.Othr.0.Id"}, 0, 33]
                                                            },
                                                            ""
                                                        ]}
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "ultb": { "if": [
                                    {"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty"},
                                    {
                                        "cat": [
                                            "/ULTB/",
                                            { "if": [
                                                {"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Nm"},
                                                {
                                                    "substr": [{"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Nm"}, 0, 33]
                                                },
                                                { "if": [
                                                    {"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Id.OrgId.AnyBIC"},
                                                    {"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Id.OrgId.AnyBIC"},
                                                    { "if": [
                                                        {"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Id.OrgId.Othr.0.Id"},
                                                        {
                                                            "substr": [{"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Id.OrgId.Othr.0.Id"}, 0, 33]
                                                        },
                                                        { "if": [
                                                            {"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Id.PrvtId.Othr.0.Id"},
                                                            {
                                                                "substr": [{"var": "temp_data.txn_path.RltdPties.UltmtCdtr.Pty.Id.PrvtId.Othr.0.Id"}, 0, 33]
                                                            },
                                                            ""
                                                        ]}
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "roc": { "if": [
                                    {"var": "temp_data.txn_path.Refs.EndToEndId"},
                                    {
                                        "cat": [
                                            "/ROC/",
                                            {
                                                "substr": [{"var": "temp_data.txn_path.Refs.EndToEndId"}, 0, 30]
                                            }
                                        ]
                                    },
                                    null
                                ]},
                                "uri": { "if": [
                                    {"var": "temp_data.txn_path.RmtInf.Ustrd"},
                                    {"join": [{"var": "temp_data.txn_path.RmtInf.Ustrd"}, " "]},
                                    null
                                ]},
                                "sri": { "if": [
                                    {"var": "temp_data.txn_path.RmtInf.Strd"},
                                    {
                                        "cat": [
                                            "/SRI/",
                                            { "if": [
                                                {"var": "temp_data.txn_path.RmtInf.Strd.0.CdtrRefInf.Ref"},
                                                {"var": "temp_data.txn_path.RmtInf.Strd.0.CdtrRefInf.Ref"},
                                                {
                                                    "join": [
                                                        {"map": [{"var": "temp_data.txn_path.RmtInf.Strd"}, {"cat": [{"var": ""}, " "]}]},
                                                        " "
                                                    ]
                                                }
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "relid": { "if": [
                                    {"var": "temp_data.txn_path.RltdRmtInf.0.RmtId"},
                                    {
                                        "cat": [
                                            "/RELID/",
                                            {
                                                "substr": [{"var": "temp_data.txn_path.RltdRmtInf.0.RmtId"}, 0, 30]
                                            }
                                        ]
                                    },
                                    null
                                ]}
                            }
                        },
                        {
                            "path": "temp_data.field26T",
                            "condition": { "and": [
                                {"var": "temp_data.txn_path.Purp.Prtry"},
                                {"match": [{"var": "temp_data.txn_path.Purp.Prtry"}, "^:26T:[A-Z0-9]{3}$"]}
                            ]},
                            "logic": {
                                "substr": [{"var": "temp_data.txn_path.Purp.Prtry"}, 5, 3]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_26T",
            "name": "Map Field 26T",
            "description": "Maps Transaction Type Code",
            "condition": {"var": "temp_data.field26T"},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.26T",
                            "logic": {"transaction_type_code": {"var": "temp_data.field26T"}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_70",
            "name": "Map Field 70",
            "description": "Maps Remittance Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#70",
                            "logic": {
                                "remittance_information": {
                                    "split": [
                                        {
                                            "substr": [
                                                {
                                                    "join": [
                                                        {
                                                            "filter": [
                                                                [
                                                                    {"var": "temp_data.field70_components.ultb"},
                                                                    {"var": "temp_data.field70_components.ultd"},
                                                                    {"var": "temp_data.field70_components.purpose"},
                                                                    {"var": "temp_data.field70_components.roc"},
                                                                    { "if": [
                                                                        { "or": [
                                                                            {"var": "temp_data.field70_components.ultb"},
                                                                            {"var": "temp_data.field70_components.ultd"},
                                                                            {"var": "temp_data.field70_components.purpose"},
                                                                            {"var": "temp_data.field70_components.roc"},
                                                                            {"var": "temp_data.field70_components.sri"},
                                                                            {"var": "temp_data.field70_components.relid"}
                                                                        ]},
                                                                        {"cat": ["/URI/", {"var": "temp_data.field70_components.uri"}]},
                                                                        {"var": "temp_data.field70_components.uri"}
                                                                    ]},
                                                                    {"var": "temp_data.field70_components.relid"},
                                                                    {"var": "temp_data.field70_components.sri"}
                                                                ],
                                                                {"var": ""}
                                                            ]
                                                        },
                                                        " "
                                                    ]
                                                },
                                                0,
                                                140
                                            ]
                                        },
                                        35
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_72",
            "name": "Map Field 72",
            "description": "Maps Sender to Receiver Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field72_components",
                            "logic": {
                                "locins": { "if": [
                                    {"var": "temp_data.txn_path.LclInstrm.Cd"},
                                    { "if": [
                                        {
                                            "not": {
                                                "in": [
                                                    {"var": "temp_data.txn_path.LclInstrm.Cd"},
                                                    ["CRED", "CRTS", "SPAY", "SPRI", "SSTD"]
                                                ]
                                            }
                                        },
                                        {"cat": ["/LOCINS/", {"var": "temp_data.txn_path.LclInstrm.Cd"}]},
                                        null
                                    ]},
                                    { "if": [
                                        {"var": "temp_data.txn_path.LclInstrm.Prtry"},
                                        { "if": [
                                            {
                                                "not": {
                                                    "in": [
                                                        {"var": "temp_data.txn_path.LclInstrm.Prtry"},
                                                        ["CRED", "CRTS", "SPAY", "SPRI", "SSTD"]
                                                    ]
                                                }
                                            },
                                            {
                                                "cat": [
                                                    "/LOCINS/",
                                                    {
                                                        "substr": [{"var": "temp_data.txn_path.LclInstrm.Prtry"}, 0, 30]
                                                    }
                                                ]
                                            },
                                            null
                                        ]},
                                        null
                                    ]}
                                ]},
                                "inta2": { "if": [
                                    {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt2"},
                                    {
                                        "cat": [
                                            "/INTA/",
                                            { "if": [
                                                {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt2.FinInstnId.BICFI"},
                                                {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt2.FinInstnId.BICFI"},
                                                { "if": [
                                                    {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt2.FinInstnId.ClrSysMmbId.MmbId"},
                                                    {
                                                        "cat": [
                                                            "//",
                                                            {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt2.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                            {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt2.FinInstnId.ClrSysMmbId.MmbId"}
                                                        ]
                                                    },
                                                    {
                                                        "substr": [{"var": "temp_data.txn_path.RltdAgts.IntrmyAgt2.FinInstnId.Nm"}, 0, 30]
                                                    }
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "inta3": { "if": [
                                    {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt3"},
                                    {
                                        "cat": [
                                            "/INTA/",
                                            { "if": [
                                                {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt3.FinInstnId.BICFI"},
                                                {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt3.FinInstnId.BICFI"},
                                                { "if": [
                                                    {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt3.FinInstnId.ClrSysMmbId.MmbId"},
                                                    {
                                                        "cat": [
                                                            "//",
                                                            {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt3.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                            {"var": "temp_data.txn_path.RltdAgts.IntrmyAgt3.FinInstnId.ClrSysMmbId.MmbId"}
                                                        ]
                                                    },
                                                    {
                                                        "substr": [{"var": "temp_data.txn_path.RltdAgts.IntrmyAgt3.FinInstnId.Nm"}, 0, 30]
                                                    }
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]}
                            }
                        },
                        {
                            "path": "data.SwiftMT.fields.#72",
                            "condition": { "or": [
                                {"var": "temp_data.field72_components.locins"},
                                {"var": "temp_data.field72_components.inta2"},
                                {"var": "temp_data.field72_components.inta3"}
                            ]},
                            "logic": {
                                "sender_to_receiver_info": {
                                    "split": [
                                        {
                                            "substr": [
                                                {
                                                    "join": [
                                                        {
                                                            "filter": [
                                                                [
                                                                    {"var": "temp_data.field72_components.locins"},
                                                                    {"var": "temp_data.field72_components.inta2"},
                                                                    {"var": "temp_data.field72_components.inta3"}
                                                                ],
                                                                {"var": ""}
                                                            ]
                                                        },
                                                        " "
                                                    ]
                                                },
                                                0,
                                                210
                                            ]
                                        },
                                        35
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}
