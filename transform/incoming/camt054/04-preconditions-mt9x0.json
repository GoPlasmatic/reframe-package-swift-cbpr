{
    "id": "camt054-to-mt9x0-preconditions",
    "name": "camt.054 to MT900/MT910 Preconditions Validation",
    "description": "Validates preconditions for camt.054 to MT900/MT910 transformation",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.054"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt054-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "determine_target_message"]},
        {"in": [{"var": "metadata.SwiftMT.variant"}, ["MT900", "MT910"]]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_amount",
            "name": "Validate Amount (PREC003)",
            "description": "Check amount present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.Amt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.Amt.$value"}},
                            "message": "PREC003: Entry amount must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_value_date",
            "name": "Validate Value Date (PREC005)",
            "description": "Check value date or interbank settlement date present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0",
                            "logic": { "or": [
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.ValDt"}},
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdDts.IntrBkSttlmDt"}}
                            ]},
                            "message": "PREC005: ValueDate or InterbankSettlementDate must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_mt910_specific",
            "name": "Validate MT910 Specific Requirements",
            "description": "Validate MT910 specific requirements for credit entries",
            "condition": {"==": [{"var": "SwiftMT.variant"}, "MT910"]},
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr",
                            "logic": { "if": [
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Pty"}},
                                { "or": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Pty.Nm"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Pty.Id.OrgId.AnyBIC"}}
                                ]},
                                true
                            ]},
                            "message": "PREC006: If DebtorParty present, Name or BIC must be present"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt",
                            "logic": { "if": [
                                {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt.FinInstnId"}},
                                { "or": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt.FinInstnId.Nm"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt.FinInstnId.BICFI"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt.FinInstnId.ClrSysMmbId"}}
                                ]},
                                true
                            ]},
                            "message": "PREC010: If DebtorAgent present, Name, BIC or ClearingSystemMemberId must be present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_mt900_specific",
            "name": "Validate MT900 Specific Requirements",
            "description": "Validate MT900 specific requirements for debit entries",
            "condition": {"==": [{"var": "SwiftMT.variant"}, "MT900"]},
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0",
                            "logic": { "if": [
                                { "and": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt"}},
                                    {"!": {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdAgts.DbtrAgt"}}}
                                ]},
                                { "or": [
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt.FinInstnId.Nm"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt.FinInstnId.BICFI"}},
                                    {"!!": {"var": "data.ISO20022_MX.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.Dbtr.Agt.FinInstnId.ClrSysMmbId"}}
                                ]},
                                true
                            ]},
                            "message": "PREC011: If DebtorAgent present without RelatedDebtorAgent, identification must be present"
                        }
                    ]
                }
            }
        }
    ]
}
