{
    "id": "pain001-to-mt101-preconditions",
    "name": "pain.001 to MT101 Preconditions Validation",
    "description": "Validates preconditions for pain.001 to MT101 transformation according to CBPR+ specification PREC001-PREC017",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pain.001"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pain001-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_pain001_structure"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "PREC001_validate_initiating_party",
            "name": "PREC001: Validate Initiating Party",
            "description": "Ensures InitiatingParty has either BIC or Name for field 50C/L mapping",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "or": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "GrpHdr", "InitgPty", "Id", "OrgId", "AnyBIC"]},
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "GrpHdr", "InitgPty", "Nm"]}
                            ]},
                            "message": "T20322: PREC001: InitiatingParty must have either BIC or Name"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC002_validate_debtor_agent",
            "name": "PREC002: Validate Debtor Agent",
            "description": "Ensures DebtorAgent has BIC or ClearingSystemMemberIdentification for field 52A/C mapping",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "or": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "DbtrAgt", "FinInstnId", "BICFI"]},
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "DbtrAgt", "FinInstnId", "ClrSysMmbId", "MmbId"]}
                            ]},
                            "message": "T20323: PREC002: DebtorAgent must have BICFI or ClearingSystemMemberIdentification"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC003_validate_intermediary_agent",
            "name": "PREC003: Validate Intermediary Agent",
            "description": "Ensures IntermediaryAgent1 if present has required identification",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "IntrmyAgt1"]},
                                { "or": [
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "IntrmyAgt1", "FinInstnId", "BICFI"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "IntrmyAgt1", "FinInstnId", "Nm"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "IntrmyAgt1", "FinInstnId", "ClrSysMmbId", "MmbId"]}
                                ]},
                                true
                            ]},
                            "message": "T20324: PREC003: IntermediaryAgent1 must have BICFI, Name or ClearingSystemMemberIdentification"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC004_validate_creditor_agent",
            "name": "PREC004: Validate Creditor Agent",
            "description": "Ensures CreditorAgent if present has required identification",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "CdtrAgt"]},
                                { "or": [
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "CdtrAgt", "FinInstnId", "BICFI"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "CdtrAgt", "FinInstnId", "Nm"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "CdtrAgt", "FinInstnId", "ClrSysMmbId", "MmbId"]}
                                ]},
                                true
                            ]},
                            "message": "T20324: PREC004: CreditorAgent must have BICFI, Name or ClearingSystemMemberIdentification"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC005_validate_agent_hierarchy",
            "name": "PREC005: Validate Agent Hierarchy",
            "description": "Ensures CreditorAgent is present when IntermediaryAgent1 is present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "CdtrAgt"]},
                            "message": "T20325: PREC005: CreditorAgent must be present when IntermediaryAgent1 is present"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC006_validate_debtor",
            "name": "PREC006: Validate Debtor",
            "description": "Ensures Debtor has either BIC or Name for field 50F/G/H mapping",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "or": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "Dbtr", "Id", "OrgId", "AnyBIC"]},
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "Dbtr", "Nm"]}
                            ]},
                            "message": "T20322: PREC006: Debtor must have either BIC or Name"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC007_validate_creditor",
            "name": "PREC007: Validate Creditor",
            "description": "Ensures Creditor has either BIC or Name for field 59/59A/59F mapping",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "or": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "Cdtr", "Id", "OrgId", "AnyBIC"]},
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "Cdtr", "Nm"]}
                            ]},
                            "message": "T20322: PREC007: Creditor must have either BIC or Name"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC008_validate_currency",
            "name": "PREC008: Validate Currency",
            "description": "Ensures currencies are not commodity currencies",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": {
                                "!": { "or": [
                                    {
                                        "in": [
                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.Amt.InstdAmt.@Ccy"},
                                            ["XAU", "XAG", "XPD", "XPT"]
                                        ]
                                    },
                                    {
                                        "in": [
                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.Amt.EqvtAmt.Amt.@Ccy"},
                                            ["XAU", "XAG", "XPD", "XPT"]
                                        ]
                                    },
                                    {
                                        "in": [
                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.Amt.EqvtAmt.CcyOfTrf"},
                                            ["XAU", "XAG", "XPD", "XPT"]
                                        ]
                                    }
                                ]}
                            },
                            "message": "T20054: PREC008: Commodity currencies (XAU, XAG, XPD, XPT) not allowed"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC012_validate_ultimate_debtor",
            "name": "PREC012: Validate Ultimate Debtor",
            "description": "Ensures UltimateDebtor if present has required identification",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "UltmtDbtr"]},
                                { "or": [
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "UltmtDbtr", "Nm"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "UltmtDbtr", "Id", "OrgId", "AnyBIC"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "UltmtDbtr", "Id", "OrgId", "Othr"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "UltmtDbtr", "Id", "PrvtId", "Othr"]}
                                ]},
                                true
                            ]},
                            "message": "T20327: PREC012: UltimateDebtor must have Name or valid Identification"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtDbtr"]},
                                { "or": [
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtDbtr", "Nm"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtDbtr", "Id", "OrgId", "AnyBIC"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtDbtr", "Id", "OrgId", "Othr"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtDbtr", "Id", "PrvtId", "Othr"]}
                                ]},
                                true
                            ]},
                            "message": "T20327: PREC012: UltimateDebtor must have Name or valid Identification"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC013_validate_ultimate_creditor",
            "name": "PREC013: Validate Ultimate Creditor",
            "description": "Ensures UltimateCreditor if present has required identification",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtCdtr"]},
                                { "or": [
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtCdtr", "Nm"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtCdtr", "Id", "OrgId", "AnyBIC"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtCdtr", "Id", "OrgId", "Othr"]},
                                    {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "UltmtCdtr", "Id", "PrvtId", "Othr"]}
                                ]},
                                true
                            ]},
                            "message": "T20327: PREC013: UltimateCreditor must have Name or valid Identification"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC014_validate_instructed_amount",
            "name": "PREC014: Validate Instructed Amount Length",
            "description": "Ensures InstructedAmount when converted to MT format does not exceed 15 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": {"<=": [{"length": [{"cat": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.Amt.InstdAmt."}]}]}, 15]},
                            "message": "T13001: PREC014: InstructedAmount exceeds 15 digits when formatted for MT"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC015_validate_equivalent_amount",
            "name": "PREC015: Validate Equivalent Amount Length",
            "description": "Ensures EquivalentAmount when converted to MT format does not exceed 15 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": {"<=": [{"length": [{"cat": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.Amt.EqvtAmt.Amt."}]}]}, 15]},
                            "message": "T13001: PREC015: EquivalentAmount exceeds 15 digits when formatted for MT"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC016_validate_creditor_agent_account",
            "name": "PREC016: Validate Creditor Agent Account",
            "description": "Ensures CreditorAgentAccount is not present without CreditorAgent",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": {"exists": ["data", "ISO20022_MX", "Document", "CstmrCdtTrfInitn", "PmtInf", "CdtTrfTxInf", "CdtrAgt"]},
                            "message": "T20328: PREC016: CreditorAgentAccount cannot be present without CreditorAgent"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC009_validate_debtor_agent_clearing",
            "name": "PREC009: Validate Debtor Agent Clearing System Member ID",
            "description": "Ensures DebtorAgent ClearingSystemMemberID does not exceed 28 characters",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                {"<=": [{"strlen": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId"}]}, 28]},
                                true
                            ]},
                            "message": "T20329: PREC009: DebtorAgent ClearingSystemMemberID must not exceed 28 characters"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC010_validate_intermediary_agent_clearing",
            "name": "PREC010: Validate Intermediary Agent Clearing System Member ID",
            "description": "Ensures IntermediaryAgent1 ClearingSystemMemberID does not exceed 34 characters",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"},
                                {"<=": [{"strlen": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}]}, 34]},
                                true
                            ]},
                            "message": "T20330: PREC010: IntermediaryAgent1 ClearingSystemMemberID must not exceed 34 characters"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC011_validate_creditor_agent_clearing",
            "name": "PREC011: Validate Creditor Agent Clearing System Member ID",
            "description": "Ensures CreditorAgent ClearingSystemMemberID does not exceed 34 characters",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"},
                                {"<=": [{"strlen": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}]}, 34]},
                                true
                            ]},
                            "message": "T20331: PREC011: CreditorAgent ClearingSystemMemberID must not exceed 34 characters"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC017_validate_clearing_system_consistency",
            "name": "PREC017: Validate Clearing System Consistency",
            "description": "Ensures ClearingSystemCode has corresponding non-empty MemberID",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                { "if": [
                                    { "and": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                        {"!": {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId"}}
                                    ]},
                                    false,
                                    true
                                ]},
                                { "if": [
                                    { "and": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.IntrmyAgt1.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                        {"!": {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}}
                                    ]},
                                    false,
                                    true
                                ]},
                                { "if": [
                                    { "and": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.CdtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                        {"!": {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.0.CdtrAgt.FinInstnId.ClrSysMmbId.MmbId"}}
                                    ]},
                                    false,
                                    true
                                ]}
                            ]},
                            "message": "T20332: PREC017: ClearingSystemCode requires non-empty MemberID"
                        }
                    ]
                }
            }
        }
    ]
}
