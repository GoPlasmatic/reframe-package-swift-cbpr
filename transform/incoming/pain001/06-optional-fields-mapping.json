{
    "id": "pain001-to-mt101-optional-fields",
    "name": "pain.001 to MT101 Optional Fields Mapping",
    "description": "Maps optional fields including charges, authorisation, instruction codes, and remittance information",
    "priority": 7,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pain.001"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pain001-to-mt101-party-fields"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_creditor_field_59"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_authorisation",
            "name": "Map Authorisation Field 25",
            "description": "Maps GroupHeader Authorisation to field 25",
            "condition": {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.GrpHdr.Authstn"},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#25",
                            "logic": {
                                "authorisation": { "if": [
                                    {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.GrpHdr.Authstn.0.Cd"},
                                    {
                                        "substr": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.GrpHdr.Authstn.0.Cd"}, 0, 35]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.GrpHdr.Authstn.0.Prtry"},
                                        {
                                            "substr": [
                                                {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.GrpHdr.Authstn.0.Prtry"},
                                                0,
                                                35
                                            ]
                                        },
                                        null
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_charge_bearer",
            "name": "Map Charge Bearer Field 71A",
            "description": "Maps ChargeBearer to field 71A",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#71A",
                            "logic": {
                                "code": { "if": [
                                    {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgBr"},
                                    { "if": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgBr"}, "CRED"]},
                                        "BEN",
                                        { "if": [
                                            {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgBr"}, "DEBT"]},
                                            "OUR",
                                            "SHA"
                                        ]}
                                    ]},
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.ChrgBr"},
                                        { "if": [
                                            {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.ChrgBr"}, "CRED"]},
                                            "BEN",
                                            { "if": [
                                                {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.ChrgBr"}, "DEBT"]},
                                                "OUR",
                                                "SHA"
                                            ]}
                                        ]},
                                        null
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_charges_account",
            "name": "Map Charges Account Field 25A",
            "description": "Maps ChargesAccount to field 25A",
            "condition": {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgsAcct.Id"},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#25A",
                            "logic": {
                                "account": { "if": [
                                    {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgsAcct.Id.IBAN"},
                                    {
                                        "cat": [
                                            "/",
                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgsAcct.Id.IBAN"}
                                        ]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgsAcct.Id.Othr.Id"},
                                        {
                                            "cat": [
                                                "/",
                                                {
                                                    "substr": [
                                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.ChrgsAcct.Id.Othr.Id"},
                                                        0,
                                                        33
                                                    ]
                                                }
                                            ]
                                        },
                                        null
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_instruction_codes",
            "name": "Map Instruction Codes Field 23E",
            "description": "Maps various instruction codes to field 23E occurrences",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.instruction_codes_raw",
                            "logic": [
                                { "if": [
                                    {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.Amt.EqvtAmt"},
                                    {"instruction_code": "EQUI"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.CtgyPurp.Cd"}, "CMSW"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.CtgyPurp.Cd"}, "CMSW"]}
                                    ]},
                                    {"instruction_code": "CMSW"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.CtgyPurp.Cd"}, "CMTO"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.CtgyPurp.Cd"}, "CMTO"]}
                                    ]},
                                    {"instruction_code": "CMTO"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.CtgyPurp.Cd"}, "CMZB"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.CtgyPurp.Cd"}, "CMZB"]}
                                    ]},
                                    {"instruction_code": "CMZB"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.CtgyPurp.Cd"}, "INTC"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.CtgyPurp.Cd"}, "INTC"]}
                                    ]},
                                    {"instruction_code": "INTC"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.CtgyPurp.Cd"}, "REPA"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.CtgyPurp.Cd"}, "REPA"]}
                                    ]},
                                    {"instruction_code": "REPA"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.CtgyPurp.Cd"}, "CORT"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.CtgyPurp.Cd"}, "CORT"]}
                                    ]},
                                    {"instruction_code": "CORT"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.SvcLvl.Cd"}, "URGP"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.SvcLvl.Cd"}, "URGP"]}
                                    ]},
                                    {"instruction_code": "URGP"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.SvcLvl.Cd"}, "NETS"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.SvcLvl.Cd"}, "NETS"]}
                                    ]},
                                    {"instruction_code": "NETS"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtTpInf.SvcLvl.Cd"}, "RTGS"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtTpInf.SvcLvl.Cd"}, "RTGS"]}
                                    ]},
                                    {"instruction_code": "RTGS"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.PmtMtd"}, "CHK"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForCdtrAgt.0.Cd"}, "CHQB"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForCdtrAgt.1.Cd"}, "CHQB"]}
                                    ]},
                                    {"instruction_code": "CHQB"},
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForCdtrAgt.0.Cd"}, "PHOB"]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForCdtrAgt.1.Cd"}, "PHOB"]}
                                    ]},
                                    {
                                        "instruction_code": "PHON",
                                        "additional_info": { "if": [
                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForCdtrAgt.0.InstrInf"},
                                            {
                                                "substr": [
                                                    {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForCdtrAgt.0.InstrInf"},
                                                    0,
                                                    30
                                                ]
                                            },
                                            null
                                        ]}
                                    },
                                    null
                                ]},
                                { "if": [
                                    { "or": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.InstrForDbtrAgt"},
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForDbtrAgt"}
                                    ]},
                                    {
                                        "instruction_code": "OTHR",
                                        "additional_info": { "if": [
                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.InstrForDbtrAgt"},
                                            {
                                                "substr": [
                                                    {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.InstrForDbtrAgt"},
                                                    0,
                                                    30
                                                ]
                                            },
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForDbtrAgt"},
                                                {
                                                    "substr": [
                                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.InstrForDbtrAgt"},
                                                        0,
                                                        30
                                                    ]
                                                },
                                                null
                                            ]}
                                        ]}
                                    },
                                    null
                                ]}
                            ]
                        },
                        {
                            "path": "data.SwiftMT.fields.##.0.#23E",
                            "logic": {"filter": [{"var": "temp_data.instruction_codes_raw"}, {"!=": [{"var": ""}, null]}]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_fx_reference",
            "name": "Map FX Deal Reference Field 21F",
            "description": "Maps ExchangeRateInformation ContractIdentification to field 21F with TR009 validation",
            "condition": {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.XchgRateInf.CtrctId"},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#21F",
                            "logic": {
                                "reference": {
                                    "substr": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.XchgRateInf.CtrctId"},
                                        0,
                                        16
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}
