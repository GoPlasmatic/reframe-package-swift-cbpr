{
    "id": "pain001-to-mt101-remittance-fields",
    "name": "pain.001 to MT101 Remittance Fields Mapping",
    "description": "Maps remittance information, ultimate parties, purpose and regulatory reporting to field 70 and 77B",
    "priority": 9,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pain.001"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pain001-to-mt101-agent-fields"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_creditor_agent_57D"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_70",
            "name": "Map Field 70 Remittance Information",
            "description": "Combines all remittance components into field 70",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#70",
                            "logic": {
                                "narrative": [
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.RmtInf.Ustrd"},
                                        {
                                            "substr": [
                                                {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.RmtInf.Ustrd"},
                                                0,
                                                35
                                            ]
                                        },
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtId.EndToEndId"},
                                            {
                                                "cat": [
                                                    "/ROC/",
                                                    {
                                                        "substr": [
                                                            {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.PmtId.EndToEndId"},
                                                            0,
                                                            30
                                                        ]
                                                    }
                                                ]
                                            },
                                            ""
                                        ]}
                                    ]}
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_regulatory_reporting",
            "name": "Map Regulatory Reporting Field 77B",
            "description": "Maps RegulatoryReporting information to field 77B",
            "condition": {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.RgltryRptg"},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#77B",
                            "logic": {
                                "regulatory_reporting": {
                                    "map": [
                                        {
                                            "slice": [
                                                {"var": "data.ISO20022_MX.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf.RgltryRptg"},
                                                0,
                                                3
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "Dtls.0.Tp"},
                                                { "or": [
                                                    {"var": "Dtls.0.Cd"},
                                                    {"var": "Dtls.0.Inf"}
                                                ]}
                                            ]},
                                            {
                                                "substr": [
                                                    {
                                                        "join": [
                                                            {"filter": [[{"var": "Dtls.0.Tp"}, {"var": "Dtls.0.Cd"}, {"var": "Dtls.0.Inf"}], {"var": ""}]},
                                                            "/"
                                                        ]
                                                    },
                                                    0,
                                                    35
                                                ]
                                            },
                                            null
                                        ]}
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}
