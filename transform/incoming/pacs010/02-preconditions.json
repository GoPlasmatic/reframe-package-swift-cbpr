{
    "id": "pacs010-to-mt204-preconditions",
    "name": "pacs.010 to MT204 Preconditions Validation",
    "description": "Validates preconditions for pacs.010 to MT204 transformation according to CBPR+ specification",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.010"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs010-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "detect_variant"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "PREC001_validate_amount_length",
            "name": "PREC001: Validate Amount Length",
            "description": "Ensures InterbankSettlementAmount doesn't exceed 15 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.IntrBkSttlmAmt.$value",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.IntrBkSttlmAmt.$value"},
                                {"<=": [{"length": {"cat": [{"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.IntrBkSttlmAmt.$value"}]}}, 15]},
                                true
                            ]},
                            "message": "PREC001: T13001 - InterbankSettlementAmount exceeds 15 digits for MT204"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_mandatory_elements",
            "name": "Validate Mandatory Elements",
            "description": "Validates that all required elements for MT204 are present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.CdtId",
                            "logic": {"!!": [{"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.CdtId"}]},
                            "message": "T20001 - CreditIdentification is mandatory for MT204 field 20 (Sequence A)"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtId.InstrId",
                            "logic": {
                                "!!": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtId.InstrId"}
                                ]
                            },
                            "message": "T20002 - InstructionIdentification is mandatory for MT204 field 20 (Sequence B)"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtId.EndToEndId",
                            "logic": {
                                "!!": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtId.EndToEndId"}
                                ]
                            },
                            "message": "T20003 - EndToEndIdentification is mandatory for MT204 field 21"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.IntrBkSttlmAmt",
                            "logic": {
                                "!!": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.IntrBkSttlmAmt"}
                                ]
                            },
                            "message": "T20004 - InterbankSettlementAmount is mandatory for MT204 field 32B and field 19"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.IntrBkSttlmDt",
                            "logic": {
                                "!!": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.IntrBkSttlmDt"}
                                ]
                            },
                            "message": "T20005 - InterbankSettlementDate is mandatory for MT204 field 30"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.Cdtr",
                            "logic": {"!!": [{"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.Cdtr"}]},
                            "message": "T20006 - Creditor is mandatory for MT204 field 58"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.Dbtr",
                            "logic": {"!!": [{"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.Dbtr"}]},
                            "message": "T20007 - Debtor is mandatory for MT204 field 53"
                        }
                    ]
                }
            }
        }
    ]
}
