{
    "id": "pacs010-to-mt204-sender-receiver-info",
    "name": "pacs.010 to MT204 Sender to Receiver Information Mapping",
    "description": "Maps various elements to field 72 for both Sequence A and B",
    "priority": 8,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.010"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs010-to-mt204-agent-fields"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_creditor_agent_field_57D"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "prepare_field_72_components",
            "name": "Prepare Field 72 Components",
            "description": "Prepares components for field 72 from various MX elements",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field72_seq_a",
                            "logic": {
                                "catpurp": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.PmtTpInf.CtgyPurp.Cd"},
                                    {
                                        "cat": [
                                            "/CATPURP/",
                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.PmtTpInf.CtgyPurp.Cd"}
                                        ]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.PmtTpInf.CtgyPurp.Prtry"},
                                        {
                                            "cat": [
                                                "/CATPURP/",
                                                {
                                                    "substr": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.PmtTpInf.CtgyPurp.Prtry"},
                                                        0,
                                                        30
                                                    ]
                                                }
                                            ]
                                        },
                                        null
                                    ]}
                                ]},
                                "inta1": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1"},
                                    {
                                        "cat": [
                                            "/INTA1/",
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1.FinInstnId.BICFI"},
                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1.FinInstnId.BICFI"},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"},
                                                    {
                                                        "cat": [
                                                            "//",
                                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1.FinInstnId.ClrSysMmbId.MmbId"}
                                                        ]
                                                    },
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1.FinInstnId.Nm"},
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt1.FinInstnId.Nm"},
                                                                0,
                                                                30
                                                            ]
                                                        },
                                                        ""
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "inta2": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2"},
                                    {
                                        "cat": [
                                            "/INTA/",
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2.FinInstnId.BICFI"},
                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2.FinInstnId.BICFI"},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2.FinInstnId.ClrSysMmbId.MmbId"},
                                                    {
                                                        "cat": [
                                                            "//",
                                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2.FinInstnId.ClrSysMmbId.ClrSysId.Cd"},
                                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2.FinInstnId.ClrSysMmbId.MmbId"}
                                                        ]
                                                    },
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2.FinInstnId.Nm"},
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt2.FinInstnId.Nm"},
                                                                0,
                                                                30
                                                            ]
                                                        },
                                                        ""
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "inta3": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3"},
                                    {
                                        "cat": [
                                            "/INTA/",
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3.FinInstnId.BICFI"},
                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3.FinInstnId.BICFI"},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3.FinInstnId.ClrSysMmbId.MmbId"},
                                                    {
                                                        "cat": [
                                                            "//",
                                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3.FinInstnId.ClrSysId.Cd"},
                                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3.FinInstnId.ClrSysMmbId.MmbId"}
                                                        ]
                                                    },
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3.FinInstnId.Nm"},
                                                        {
                                                            "substr": [
                                                                {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.IntrmyAgt3.FinInstnId.Nm"},
                                                                0,
                                                                30
                                                            ]
                                                        },
                                                        ""
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]}
                            }
                        },
                        {
                            "path": "temp_data.field72_seq_b",
                            "logic": {
                                "svclvl": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.SvcLvl.0.Cd"},
                                    {
                                        "cat": [
                                            "/SVCLVL/",
                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.SvcLvl.0.Cd"}
                                        ]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.SvcLvl.0.Prtry"},
                                        {
                                            "cat": [
                                                "/SVCLVL/",
                                                {
                                                    "substr": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.SvcLvl.0.Prtry"},
                                                        0,
                                                        30
                                                    ]
                                                }
                                            ]
                                        },
                                        null
                                    ]}
                                ]},
                                "catpurp": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.CtgyPurp.Cd"},
                                    {
                                        "cat": [
                                            "/CATPURP/",
                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.CtgyPurp.Cd"}
                                        ]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.CtgyPurp.Prtry"},
                                        {
                                            "cat": [
                                                "/CATPURP/",
                                                {
                                                    "substr": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.CtgyPurp.Prtry"},
                                                        0,
                                                        30
                                                    ]
                                                }
                                            ]
                                        },
                                        null
                                    ]}
                                ]},
                                "locins": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.LclInstrm.Cd"},
                                    {
                                        "cat": [
                                            "/LOCINS/",
                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.LclInstrm.Cd"}
                                        ]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.LclInstrm.Prtry"},
                                        {
                                            "cat": [
                                                "/LOCINS/",
                                                {
                                                    "substr": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.PmtTpInf.LclInstrm.Prtry"},
                                                        0,
                                                        30
                                                    ]
                                                }
                                            ]
                                        },
                                        null
                                    ]}
                                ]},
                                "rec": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.InstrForDbtrAgt"},
                                    {
                                        "cat": [
                                            "/REC/",
                                            {
                                                "substr": [
                                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.InstrForDbtrAgt"},
                                                    0,
                                                    140
                                                ]
                                            }
                                        ]
                                    },
                                    null
                                ]},
                                "purp": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.Purp.Cd"},
                                    {
                                        "cat": [
                                            "/BNF/",
                                            {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.Purp.Cd"}
                                        ]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.Purp.Prtry"},
                                        {
                                            "cat": [
                                                "/BNF/",
                                                {
                                                    "substr": [
                                                        {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.Purp.Prtry"},
                                                        0,
                                                        140
                                                    ]
                                                }
                                            ]
                                        },
                                        null
                                    ]}
                                ]},
                                "rmt": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.RmtInf.Ustrd"},
                                    {
                                        "cat": [
                                            "/BNF/",
                                            {
                                                "join": [
                                                    {"var": "data.ISO20022_MX.Document.FIDrctDbt.CdtInstr.DrctDbtTxInf.RmtInf.Ustrd"},
                                                    " "
                                                ]
                                            }
                                        ]
                                    },
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_72_seq_a",
            "name": "Map Field 72 Sequence A",
            "description": "Maps concatenated information to field 72 in Sequence A",
            "condition": { "or": [
                {"var": "temp_data.field72_seq_a.catpurp"},
                {"var": "temp_data.field72_seq_a.inta1"},
                {"var": "temp_data.field72_seq_a.inta2"},
                {"var": "temp_data.field72_seq_a.inta3"}
            ]},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.72_seq_a",
                            "logic": {
                                "sender_to_receiver_info": {
                                    "split": [
                                        {
                                            "substr": [
                                                {
                                                    "join": [
                                                        {
                                                            "filter": [
                                                                [
                                                                    {"var": "temp_data.field72_seq_a.catpurp"},
                                                                    {"var": "temp_data.field72_seq_a.inta1"},
                                                                    {"var": "temp_data.field72_seq_a.inta2"},
                                                                    {"var": "temp_data.field72_seq_a.inta3"}
                                                                ],
                                                                {"var": ""}
                                                            ]
                                                        },
                                                        " "
                                                    ]
                                                },
                                                0,
                                                210
                                            ]
                                        },
                                        35
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_72_seq_b",
            "name": "Map Field 72 Sequence B",
            "description": "Maps concatenated information to field 72 in Sequence B",
            "condition": { "or": [
                {"var": "temp_data.field72_seq_b.svclvl"},
                {"var": "temp_data.field72_seq_b.catpurp"},
                {"var": "temp_data.field72_seq_b.locins"},
                {"var": "temp_data.field72_seq_b.rec"},
                {"var": "temp_data.field72_seq_b.purp"},
                {"var": "temp_data.field72_seq_b.rmt"}
            ]},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#72",
                            "logic": {
                                "sender_to_receiver_info": {
                                    "split": [
                                        {
                                            "substr": [
                                                {
                                                    "join": [
                                                        {
                                                            "filter": [
                                                                [
                                                                    {"var": "temp_data.field72_seq_b.svclvl"},
                                                                    {"var": "temp_data.field72_seq_b.catpurp"},
                                                                    {"var": "temp_data.field72_seq_b.locins"},
                                                                    {"var": "temp_data.field72_seq_b.rec"},
                                                                    {"var": "temp_data.field72_seq_b.purp"},
                                                                    {"var": "temp_data.field72_seq_b.rmt"}
                                                                ],
                                                                {"var": ""}
                                                            ]
                                                        },
                                                        " "
                                                    ]
                                                },
                                                0,
                                                210
                                            ]
                                        },
                                        35
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "complete_sender_receiver_info",
            "name": "Complete Sender Receiver Info",
            "description": "Ensures workflow completion even when no field 72 data is available",
            "condition": { "and": [
                {
                    "!": { "or": [
                        {"var": "temp_data.field72_seq_a.catpurp"},
                        {"var": "temp_data.field72_seq_a.inta1"},
                        {"var": "temp_data.field72_seq_a.inta2"},
                        {"var": "temp_data.field72_seq_a.inta3"}
                    ]}
                },
                {
                    "!": { "or": [
                        {"var": "temp_data.field72_seq_b.svclvl"},
                        {"var": "temp_data.field72_seq_b.catpurp"},
                        {"var": "temp_data.field72_seq_b.locins"},
                        {"var": "temp_data.field72_seq_b.rec"},
                        {"var": "temp_data.field72_seq_b.purp"},
                        {"var": "temp_data.field72_seq_b.rmt"}
                    ]}
                }
            ]},
            "function": {
                "name": "map",
                "input": {"mappings": [{"path": "temp_data.field72_skipped", "logic": true}]}
            }
        }
    ]
}
