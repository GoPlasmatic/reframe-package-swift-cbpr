{
    "id": "pacs004-mt103-charge-fields-mapping",
    "name": "PACS.004 to MT103 RETN Charge Fields Mapping",
    "description": "Maps charge-related fields for MT103 RETN (Fields 71A, 71F, 71G)",
    "priority": 7,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.004"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs004-mt103-amount-fields-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_field_53b"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_71a",
            "name": "Map Field 71A - Details of Charges",
            "description": "TR008: Map charge bearer",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.71A",
                            "logic": { "code": "OUR"}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_71f_71g",
            "name": "Map Fields 71F/71G - Sender's Charges",
            "description": "TR009/TR010: Map charges information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.charges_array",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.ChrgBr"},
                                {"map": [
                                    {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.ChrgsInf"},
                                    {"cat": [
                                        {"var": "Amt.Ccy"},
                                        {"replace": [
                                            {"cat": [{"var": "Amt.value"}]},
                                            ".",
                                            ","
                                        ]}
                                    ]}
                                ]},
                                []
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.71F",
                            "logic": { "if": [
                                {"or": [
                                    {"!": {"exists": ["data", "ISO20022_MX", "document", "TxInf", "ChrgBr"]}},
                                    {"in": [{"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.ChrgBr"}, ["SHAR", "CRED"]]}
                                ]},
                                {"map": [
                                    {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.ChrgsInf"},
                                    {
                                        "currency": {"var": "Amt.@Ccy"},
                                        "amount": {"+": [{"var": "Amt.$value"}]}
                                    }
                                ]},
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.71G",
                            "logic": { "if": [
                                {"and" : [
                                    {"==": [{"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.ChrgBr"}, "DEBT"]},
                                    {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.ChrgsInf"}
                                ]},
                                {
                                    "currency": {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.ChrgsInf.0.Amt.@Ccy"},
                                    "amount": {"reduce": [
                                        {"var": "temp_data.charges_array"}, 
                                        {"+": [{"var": "accumulator"}, {"var": "current.Amt.$value"}]}
                                    ]}
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}