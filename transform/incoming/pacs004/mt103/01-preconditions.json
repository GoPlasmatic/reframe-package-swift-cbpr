{
    "id": "pacs004-mt103-preconditions",
    "name": "PACS.004 to MT103 RETN Preconditions",
    "description": "Validates preconditions for pacs.004 to MT103 RETN transformation per CBPR+ specifications",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.004"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs004-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_variant"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_currency",
            "name": "Validate Currency",
            "description": "PREC001: Ensure commodities currencies are not present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrdIntrBkSttlmAmt.Ccy",
                            "logic": {"!": {"in": [{"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrdIntrBkSttlmAmt.Ccy"}, ["XAU", "XAG", "XPD", "XPT"]]}},
                            "message": "T20054: Commodities currencies not allowed in Field 32A"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_transaction_count",
            "name": "Validate Transaction Count",
            "description": "PREC002: Ensure only one transaction is present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.PmtRtr.GrpHdr.NbOfTxs",
                            "logic": {"==": [{"var": "data.ISO20022_MX.Document.PmtRtr.GrpHdr.NbOfTxs"}, "1"]},
                            "message": "T20053: Multiple transactions not supported for MT103 RETN"
                        }
                    ]
                }
            }
        }
    ]
}