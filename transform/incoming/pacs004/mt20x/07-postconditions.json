{
    "id": "pacs004-mt20x-postconditions",
    "name": "PACS.004 to MT202/205 RETN Postconditions",
    "description": "Validates and publishes MT202/205 RETN message",
    "priority": 9,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.004"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs004-mt20x-field72-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_field_72"]},
        {"in": [{"var": "metadata.SwiftMT.message_type"}, ["202", "205"]]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_required_fields",
            "name": "Validate Required Fields",
            "description": "Ensure all mandatory fields are present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.SwiftMT.fields.#20",
                            "logic": {"exists": ["data", "SwiftMT", "fields", "20"]},
                            "message": "Field 20 (Transaction Reference) is required"
                        },
                        {
                            "path": "data.SwiftMT.fields.#21",
                            "logic": {"exists": ["data", "SwiftMT", "fields", "21"]},
                            "message": "Field 21 (Related Reference) is required"
                        },
                        {
                            "path": "data.SwiftMT.fields.32A",
                            "logic": {"exists": ["data", "SwiftMT", "fields", "32A"]},
                            "message": "Field 32A (Value Date/Currency/Amount) is required"
                        },
                        {
                            "path": "data.SwiftMT.fields.#58",
                            "logic": {"or": [
                                {"exists": ["data", "SwiftMT", "fields", "58A"]},
                                {"exists": ["data", "SwiftMT", "fields", "58D"]}
                            ]},
                            "message": "Field 58 (Beneficiary Institution) is required"
                        },
                        {
                            "path": "data.SwiftMT.fields.#72",
                            "logic": { "and": [
                                {"exists": ["data", "SwiftMT", "fields", "72"]},
                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/RETN/"]}
                            ]},
                            "message": "Field 72 with /RETN/ is required for MT202/205 RETN"
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_message",
            "name": "Publish MT202/205 RETN",
            "description": "Generate and publish the final MT message",
            "function": {
                "name": "publish_mt",
                "input": {
                    "source": "SwiftMT",
                    "target": "result"
                }
            }
        }
    ]
}