{
    "id": "pacs004-mt20x-mandatory-fields-mapping",
    "name": "PACS.004 to MT202/205 RETN Mandatory Fields Mapping",
    "description": "Maps mandatory fields for MT202/205 RETN (Fields 20, 21, 32A)",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.004"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs004-mt20x-headers-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_headers"]},
        {"in": [{"var": "metadata.SwiftMT.message_type"}, ["202", "205"]]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_20",
            "name": "Map Field 20 - Transaction Reference",
            "description": "TR001: Map MessageIdentification to field 20 with truncation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#20",
                            "logic": {"reference": {"substr": [{"var": "data.ISO20022_MX.Document.PmtRtr.GrpHdr.MsgId"}, 0, 16]}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_21",
            "name": "Map Field 21 - Related Reference",
            "description": "TR006: Map OriginalEndToEndIdentification to field 21 with truncation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#21",
                            "logic": {"reference": {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.OrgnlEndToEndId"}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_32a",
            "name": "Map Field 32A - Value Date/Currency/Amount",
            "description": "TR004: Map value date, currency and amount",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.32A",
                            "logic": {
                                "value_date": {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.IntrBkSttlmDt"},
                                "currency": {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrdIntrBkSttlmAmt.@Ccy"},
                                "amount": {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrdIntrBkSttlmAmt.$value"}
                            }
                        }
                    ]
                }
            }
        }
    ]
}