{
    "id": "pacs004-mt20x-preconditions",
    "name": "PACS.004 to MT202/205 RETN Preconditions",
    "description": "Validates preconditions for MT202/205 RETN transformation according to CBPR+ PREC003",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.004"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs004-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_variant"]},
        {"in": [{"var": "metadata.SwiftMT.message_type"}, ["202", "205"]]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_currency",
            "name": "Validate Currency Support",
            "description": "PREC002: Ensure currency is supported in FIN",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrdIntrBkSttlmAmt.@Ccy",
                            "logic": {"in": [{"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrdIntrBkSttlmAmt.@Ccy"}, ["USD", "EUR", "GBP", "JPY", "CHF", "CAD", "AUD", "CNY", "HKD", "SGD"]]},
                            "message": "Unsupported currency for MT202/205 RETN transformation"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_no_customer_party",
            "name": "Validate No Customer Parties",
            "description": "TR008/TR009: Ensure no customer parties in return chain",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrChain.Dbtr.Pty",
                            "logic": {"!": {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrChain.Dbtr.Pty"}},
                            "message": "MT202/205 RETN cannot have Debtor Party - only Agent allowed (TR008)"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrChain.Cdtr.Pty",
                            "logic": {"!": {"var": "data.ISO20022_MX.Document.PmtRtr.TxInf.RtrChain.Cdtr.Pty"}},
                            "message": "MT202/205 RETN cannot have Creditor Party - only Agent allowed (TR009)"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_transaction_count",
            "name": "Validate Single Transaction",
            "description": "Ensure single transaction in batch",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.PmtRtr.GrpHdr.NbOfTxs",
                            "logic": {"==": [{"var": "data.ISO20022_MX.Document.PmtRtr.GrpHdr.NbOfTxs"}, "1"]},
                            "message": "MT202/205 RETN requires exactly one transaction"
                        }
                    ]
                }
            }
        }
    ]
}