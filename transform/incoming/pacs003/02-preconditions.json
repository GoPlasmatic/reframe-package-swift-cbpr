{
    "id": "pacs003-preconditions",
    "name": "pacs.003 to MT104 Preconditions Validation",
    "description": "Validates preconditions for pacs.003 to MT104 transformation according to CBPR+ specification",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.003"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs003-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "detect_variant"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "PREC001_validate_amounts",
            "name": "PREC001: Validate Amounts Difference",
            "description": "Ensures InstructedAmount and InterbankSettlementAmount are different if both present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.InstdAmt"},
                                {
                                    "!": { "and": [
                                        {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.InstdAmt.$value"}, {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.IntrBkSttlmAmt.$value"}]},
                                        {"==": [{"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.InstdAmt.@Ccy"}, {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.IntrBkSttlmAmt.@Ccy"}]}
                                    ]}
                                },
                                true
                            ]},
                            "message": "PREC001: InstructedAmount and its Currency must be different from InterbankSettlementAmount and its Currency"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_mandatory_elements",
            "name": "Validate Mandatory Elements",
            "description": "Validates that all required elements for MT104 are present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.PmtId.InstrId",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.PmtId.InstrId"}},
                            "message": "InstructionIdentification is mandatory for MT104 field 20"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.IntrBkSttlmAmt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.IntrBkSttlmAmt"}},
                            "message": "InterbankSettlementAmount is mandatory for MT104 field 32B"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.ReqdColltnDt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.ReqdColltnDt"}},
                            "message": "RequestedCollectionDate is mandatory for MT104 field 30"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Cdtr",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Cdtr"}},
                            "message": "Creditor is mandatory for MT104 field 50"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.CdtrAgt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.CdtrAgt"}},
                            "message": "CreditorAgent is mandatory for MT104 field 52"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Dbtr",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Dbtr"}},
                            "message": "Debtor is mandatory for MT104 field 59"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.DbtrAgt",
                            "logic": {"!!": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.DbtrAgt"}},
                            "message": "DebtorAgent is mandatory for MT104 field 57"
                        }
                    ]
                }
            }
        }
    ]
}
