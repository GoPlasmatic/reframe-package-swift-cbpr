{
    "id": "pacs003-postconditions",
    "name": "pacs.003 to MT104 Post-conditions and Final Assembly",
    "description": "Validates post-conditions and assembles final MT104 message",
    "priority": 10,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.003"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs003-remittance-fields-mapping"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_postconditions",
            "name": "Validate Post-conditions",
            "description": "Validates post-conditions POSTC003 and POSTC005 according to CBPR+ specification",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.SwiftMT.fields.#.0.71G",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.#.0.71G"},
                                {"==": [{"var": "data.SwiftMT.fields.#.0.71G.currency"}, {"var": "data.SwiftMT.fields.#.0.32B.currency"}]},
                                true
                            ]},
                            "message": "POSTC003/T20320: Field 71G Currency is not equal to 32B Currency. This generates an invalid MT. 71G should not be translated to the target message",
                            "severity": "warning"
                        },
                        {
                            "path": "data.SwiftMT.user_header.validation_flag",
                            "logic": {"!": {"var": "data.SwiftMT.user_header.validation_flag"}},
                            "message": "POSTC005/T20321: Field 119 in the User Header must be absent for MT104 Direct Debit"
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mt104",
            "name": "Publish MT104 Message",
            "description": "Publishes the complete MT104 message (handles POSTC001, POSTC002, POSTC004)",
            "function": {"name": "publish_mt", "input": {"source": "SwiftMT", "target": "result"}}
        }
    ]
}
