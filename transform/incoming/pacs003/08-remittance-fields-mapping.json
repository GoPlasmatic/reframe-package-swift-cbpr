{
    "id": "pacs003-remittance-fields-mapping",
    "name": "pacs.003 to MT104 Remittance Fields Mapping",
    "description": "Maps remittance information, ultimate parties, purpose and regulatory reporting to field 70 and 77B",
    "priority": 9,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.003"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs003-optional-fields-mapping"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "prepare_remittance_components",
            "name": "Prepare Remittance Components",
            "description": "Prepares components for field 70 remittance information mapping",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.remittance",
                            "logic": {
                                "end_to_end_id": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.PmtId.EndToEndId"},
                                    {
                                        "cat": [
                                            "/ROC/",
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.PmtId.EndToEndId"}
                                        ]
                                    },
                                    null
                                ]},
                                "ultimate_debtor": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr"},
                                    {
                                        "cat": [
                                            "/ULTD/",
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Nm"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Nm"},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Id.OrgId.AnyBIC"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Id.OrgId.AnyBIC"},
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Id.OrgId.Othr.0.Id"},
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Id.OrgId.Othr.0.Id"},
                                                        { "if": [
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Id.PrvtId.Othr.0.Id"},
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtDbtr.Id.PrvtId.Othr.0.Id"},
                                                            ""
                                                        ]}
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "ultimate_creditor": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr"},
                                    {
                                        "cat": [
                                            "/ULTB/",
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Nm"},
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Nm"},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Id.OrgId.AnyBIC"},
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Id.OrgId.AnyBIC"},
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Id.OrgId.Othr.0.Id"},
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Id.OrgId.Othr.0.Id"},
                                                        { "if": [
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Id.PrvtId.Othr.0.Id"},
                                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.UltmtCdtr.Id.PrvtId.Othr.0.Id"},
                                                            ""
                                                        ]}
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    null
                                ]},
                                "purpose": { "if": [
                                    { "and": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Prtry"},
                                        {
                                            "regex_match": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Prtry"},
                                                "^:26T:[A-Z0-9]{3}$"
                                            ]
                                        }
                                    ]},
                                    null,
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Cd"},
                                        {
                                            "cat": [
                                                "/PURP/",
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Cd"}
                                            ]
                                        },
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Prtry"},
                                            {
                                                "cat": [
                                                    "/PURP/",
                                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Prtry"}
                                                ]
                                            },
                                            null
                                        ]}
                                    ]}
                                ]},
                                "remittance_info": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RmtInf.Ustrd"},
                                    {
                                        "join": [
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RmtInf.Ustrd"},
                                            " "
                                        ]
                                    },
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RmtInf.Strd"},
                                        {
                                            "join": [
                                                {
                                                    "map": [
                                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RmtInf.Strd"},
                                                        { "if": [
                                                            {"var": "RfrdDocInf.0.Nb"},
                                                            {"var": "RfrdDocInf.0.Nb"},
                                                            ""
                                                        ]}
                                                    ]
                                                },
                                                " "
                                            ]
                                        },
                                        null
                                    ]}
                                ]},
                                "related_remittance": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RltdRmtInf.0.RmtId"},
                                    {
                                        "cat": [
                                            "/RFB/",
                                            {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RltdRmtInf.0.RmtId"}
                                        ]
                                    },
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_26T",
            "name": "Map Field 26T Transaction Type Code",
            "description": "Maps Purpose/Proprietary with specific pattern to field 26T",
            "condition": { "and": [
                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Prtry"},
                {
                    "regex_match": [
                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Prtry"},
                        "^:26T:[A-Z0-9]{3}$"
                    ]
                }
            ]},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#26T",
                            "logic": {
                                "transaction_type_code": {
                                    "substr": [
                                        {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.Purp.Prtry"},
                                        5,
                                        3
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_70",
            "name": "Map Field 70 Remittance Information",
            "description": "Combines all remittance components into field 70",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#70",
                            "logic": {
                                "narrative": {
                                    "filter": [
                                        [
                                            {"var": "temp_data.remittance.end_to_end_id"},
                                            {"var": "temp_data.remittance.ultimate_debtor"},
                                            {"var": "temp_data.remittance.ultimate_creditor"},
                                            {"var": "temp_data.remittance.purpose"},
                                            {"var": "temp_data.remittance.related_remittance"},
                                            {"var": "temp_data.remittance.remittance_info"}
                                        ],
                                        {"var": ""}
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_regulatory_reporting",
            "name": "Map Regulatory Reporting Field 77B",
            "description": "Maps RegulatoryReporting information to field 77B",
            "condition": {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RgltryRptg"},
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.##.0.#77B",
                            "logic": {
                                "regulatory_reporting": {
                                    "map": [
                                        {
                                            "slice": [
                                                {"var": "data.ISO20022_MX.Document.FIToFICstmrDrctDbt.DrctDbtTxInf.RgltryRptg"},
                                                0,
                                                3
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"var": "Dtls.0.Tp"},
                                                { "or": [
                                                    {"var": "Dtls.0.Cd"},
                                                    {"var": "Dtls.0.Inf"}
                                                ]}
                                            ]},
                                            {
                                                "substr": [
                                                    {
                                                        "join": [
                                                            {"filter": [[{"var": "Dtls.0.Tp"}, {"var": "Dtls.0.Cd"}, {"var": "Dtls.0.Inf"}], {"var": ""}]},
                                                            "/"
                                                        ]
                                                    },
                                                    0,
                                                    35
                                                ]
                                            },
                                            null
                                        ]}
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}
