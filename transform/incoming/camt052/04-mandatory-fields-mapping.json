{
    "id": "camt052-mandatory-fields-mapping",
    "name": "camt.052 to MT942 Mandatory Fields Mapping",
    "description": "Maps mandatory fields per specification (TR001-003, TR008)",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.052"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt052-headers-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_swift_headers"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_20",
            "name": "Map Transaction Reference (Field 20)",
            "description": "Maps Report/Identification per TR001",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#20",
                            "logic": {
                                "reference": { "if": [
                                    { "or": [
                                        {"starts_with": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Id"}, "/"]},
                                        {"ends_with": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Id"}, "/"]},
                                        {"in": ["//", {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Id"}]}
                                    ]},
                                    "NOTPROVIDED",
                                    { "if": [
                                        {">": [{"length": {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Id"}}, 16]},
                                        {
                                            "cat": [
                                                {
                                                    "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Id"}, 0, 15]
                                                },
                                                "+"
                                            ]
                                        },
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Id"}
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_25",
            "name": "Map Account Identification (Field 25)",
            "description": "Maps account per TR002",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#25",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Ownr.Id.OrgId.AnyBIC"},
                                    {"!=": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Ownr.Id.OrgId.AnyBIC"}, {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"}]}
                                ]},
                                {
                                    "P": {
                                        "account": { "if": [
                                            {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Id.IBAN"},
                                            {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Id.IBAN"},
                                            {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Id.Othr.Id"}
                                        ]},
                                        "bic": {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Ownr.Id.OrgId.AnyBIC"}
                                    }
                                },
                                {
                                    "authorisation": { "if": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Id.IBAN"},
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Id.IBAN"},
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Id.Othr.Id"}
                                    ]}
                                }
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_28C",
            "name": "Map Statement Number (Field 28C)",
            "description": "Maps sequence numbers per TR003",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.28C",
                            "logic": {
                                "statement_number": { "if": [
                                    { "and": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.LglSeqNb"},
                                        {"<=": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.LglSeqNb"}, 99999]}
                                    ]},
                                    {"+": {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.LglSeqNb"}},
                                    {"+": {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.ElctrncSeqNb"}}
                                ]},
                                "sequence_number": {
                                    "+": { "if": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.RptPgntn.PgNb"},
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.RptPgntn.PgNb"},
                                        0
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_34F",
            "name": "Map Floor Limit Indicator (Field 34F#1)",
            "description": "Maps dummy value per specification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.34F_debit",
                            "logic": {
                                "currency": {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Acct.Ccy"},
                                "amount": 0
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_13D",
            "name": "Map Date/Time Indication (Field 13D)",
            "description": "Maps creation date/time per TR008",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.13D",
                            "logic": {
                                "date": { "if": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"},
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}, 2, 2]
                                            },
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}, 5, 2]
                                            },
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}, 8, 2]
                                            }
                                        ]
                                    },
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.GrpHdr.CreDtTm"}, 2, 2]
                                            },
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.GrpHdr.CreDtTm"}, 5, 2]
                                            },
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.GrpHdr.CreDtTm"}, 8, 2]
                                            }
                                        ]
                                    }
                                ]},
                                "time": { "if": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"},
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}, 11, 2]
                                            },
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}, 14, 2]
                                            }
                                        ]
                                    },
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.GrpHdr.CreDtTm"}, 11, 2]
                                            },
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.GrpHdr.CreDtTm"}, 14, 2]
                                            }
                                        ]
                                    }
                                ]},
                                "offset_sign": { "if": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"},
                                    { "if": [
                                        {"in": ["+", {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}]},
                                        "+",
                                        "-"
                                    ]},
                                    { "if": [
                                        {"in": ["+", {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.GrpHdr.CreDtTm"}]},
                                        "+",
                                        "-"
                                    ]}
                                ]},
                                "offset": { "if": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"},
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}, -5, 2]
                                            },
                                            {
                                                "substr": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.CreDtTm"}, -2, 2]
                                            }
                                        ]
                                    },
                                    "0000"
                                ]}
                            }
                        }
                    ]
                }
            }
        }
    ]
}
