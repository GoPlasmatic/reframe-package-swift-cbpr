{
    "id": "camt052-preconditions",
    "name": "camt.052 to MT942 Preconditions",
    "description": "Validates preconditions per specification (PREC001-004)",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.052"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt052-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "set_target_message"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_sequence_numbers",
            "name": "Validate Sequence Numbers (PREC001)",
            "description": "Check legal or electronic sequence number present and <= 5 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt",
                            "logic": { "or": [
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.LglSeqNb"},
                                    {"<=": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.LglSeqNb"}, 99999]}
                                ]},
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.ElctrncSeqNb"},
                                    {"<=": [{"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.ElctrncSeqNb"}, 99999]}
                                ]}
                            ]},
                            "message": "T20103/T20150: LegalSequenceNumber or ElectronicSequenceNumber must be present and <= 5 digits"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_entry_count",
            "name": "Validate Entry Count (PREC002)",
            "description": "Check number of entries does not exceed 190",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Ntry",
                            "logic": { "or": [
                                {"!": {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Ntry"}},
                                {"<=": [{"length": {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Ntry"}}, 190]}
                            ]},
                            "message": "T20110/T20157: Number of entries exceeds 190 (max for 10K message)"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_content_presence",
            "name": "Validate Content Presence (PREC003)",
            "description": "Check entries or transaction summary present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt",
                            "logic": { "or": [
                                {"exists": ["data", "ISO20022_MX", "Document", "BkToCstmrAcctRpt", "Rpt", "Ntry"]},
                                {"exists": ["data", "ISO20022_MX", "Document", "BkToCstmrAcctRpt", "Rpt", "TxsSummry", "TtlCdtNtries", "NbOfNtries"]},
                                {"exists": ["data", "ISO20022_MX", "Document", "BkToCstmrAcctRpt", "Rpt", "TxsSummry", "TtlDbtNtries", "NbOfNtries"]}
                            ]},
                            "message": "T20114/T20161: No entries or valid transaction summary present"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_entry_amounts",
            "name": "Validate Entry Amounts (PREC004)",
            "description": "Check entry currencies match account and amounts <= 14 digits",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Ntry",
                            "logic": { "and": [
                                {"exists": ["data", "ISO20022_MX", "Document", "BkToCstmrAcctRpt", "Rpt", "Ntry"]},
                                {
                                    "all": [
                                        {"var": "data.ISO20022_MX.Document.BkToCstmrAcctRpt.Rpt.Ntry"},
                                        { "and": [
                                            {"==": [{"var": "Amt.@Ccy"}, {"val": [[-3], "data", "ISO20022_MX", "Document", "BkToCstmrAcctRpt", "Rpt", "Acct", "Ccy"]}]},
                                            {"<=": [{"var": "Amt.$value"}, 99999999999999]}
                                        ]}
                                    ]
                                }
                            ]},
                            "message": "T20113/T20116/T20160/T20163: Entry currency mismatch or amount > 14 digits"
                        }
                    ]
                }
            }
        }
    ]
}
