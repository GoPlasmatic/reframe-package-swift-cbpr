{
    "id": "pacs002-status-fields-mapping",
    "name": "pacs.002 to MT199/MT299 Status Fields Mapping",
    "description": "Maps rejection status and details to Field 79 using CBPR+ structured format",
    "priority": 6,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.002"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs002-mandatory-fields-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_field_21"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_field_79",
            "name": "Construct Field 79",
            "description": "Build Field 79 with rejection information in structured format",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#79",
                            "logic": {
                                "information": {
                                    "filter": [
                                        {
                                            "merge": [
                                                ["/REJT/"],
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.Rsn.Cd"},
                                                    [
                                                        { "if": [
                                                            {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf.0"},
                                                            {
                                                                "cat": [
                                                                    "/",
                                                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.Rsn.Cd"},
                                                                    "/",
                                                                    {
                                                                        "substr": [
                                                                            {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf.0"},
                                                                            0,
                                                                            40
                                                                        ]
                                                                    }
                                                                ]
                                                            },
                                                            {
                                                                "cat": [
                                                                    "/",
                                                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.Rsn.Cd"},
                                                                    "/"
                                                                ]
                                                            }
                                                        ]}
                                                    ],
                                                    []
                                                ]},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlGrpInf.OrgnlMsgId"},
                                                    [
                                                        {
                                                            "cat": [
                                                                "/MREF/",
                                                                {
                                                                    "substr": [
                                                                        {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlGrpInf.OrgnlMsgId"},
                                                                        0,
                                                                        43
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ],
                                                    []
                                                ]},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlEndToEndId"},
                                                    [
                                                        {
                                                            "cat": [
                                                                "/TREF/",
                                                                {
                                                                    "substr": [
                                                                        {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlEndToEndId"},
                                                                        0,
                                                                        43
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ],
                                                    []
                                                ]},
                                                { "if": [
                                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlUETR"},
                                                    [
                                                        {
                                                            "cat": [
                                                                "/UETR/",
                                                                {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlUETR"}
                                                            ]
                                                        }
                                                    ],
                                                    []
                                                ]},
                                                { "if": [
                                                    { "and": [
                                                        {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf"},
                                                        {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf.1"}
                                                    ]},
                                                    {
                                                        "map": [
                                                            {
                                                                "filter": [
                                                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf"},
                                                                    {"!=": [{"var": ""}, {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf.0"}]}
                                                                ]
                                                            },
                                                            {
                                                                "cat": [
                                                                    "/TEXT/",
                                                                    {
                                                                        "substr": [{"var": ""}, 0, 43]
                                                                    }
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    []
                                                ]}
                                            ]
                                        },
                                        {"!=": [{"var": ""}, null]}
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}
