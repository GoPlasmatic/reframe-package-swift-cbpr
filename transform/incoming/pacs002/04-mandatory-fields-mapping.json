{
    "id": "pacs002-mandatory-fields-mapping",
    "name": "pacs.002 to MT199/MT299 Mandatory Fields Mapping",
    "description": "Maps mandatory fields: Field 20 (Transaction Reference) and Field 21 (Related Reference)",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.002"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs002-headers-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "construct_user_header"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_20",
            "name": "Map Field 20 - Transaction Reference Number",
            "description": "Map MessageIdentification to Field 20 with truncation if needed (TR001)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#20",
                            "logic": {
                                "reference": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"},
                                    { "if": [
                                        {">": [{"length": {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}}, 16]},
                                        { "if": [
                                            { "and": [
                                                {"!=": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, 0, 1]}, "/"]},
                                                {"!=": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, -1, 1]}, "/"]},
                                                {"==": [{"in": ["//", {"substr": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, 0, 15]}]}, false]}
                                            ]},
                                            {
                                                "cat": [
                                                    {
                                                        "substr": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, 0, 15]
                                                    },
                                                    "+"
                                                ]
                                            },
                                            "NOTPROVIDED"
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"!=": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, 0, 1]}, "/"]},
                                                {"!=": [{"substr": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, -1, 1]}, "/"]},
                                                {"==": [{"in": ["//", {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}]}, false]}
                                            ]},
                                            {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"},
                                            "NOTPROVIDED"
                                        ]}
                                    ]},
                                    "NOTPROVIDED"
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_21",
            "name": "Map Field 21 - Related Reference",
            "description": "Map OriginalInstructionIdentification to Field 21",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#21",
                            "logic": {
                                "reference": { "if": [
                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlInstrId"},
                                    {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlInstrId"},
                                    "NOTPROVIDED"
                                ]}
                            }
                        }
                    ]
                }
            }
        }
    ]
}
