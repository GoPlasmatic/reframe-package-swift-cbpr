{
    "id": "pacs002-preconditions",
    "name": "pacs.002 to MT199/MT299 Preconditions Validation",
    "description": "Validates preconditions for pacs.002 to MT199/MT299 REJT transformation according to CBPR+ specification",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.002"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs002-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "detect_mt_variant"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_status_report_type",
            "name": "Validate Status Report Type",
            "description": "Validate that this is a REJT status report",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.TxSts",
                            "logic": {"==": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.TxSts"}, "RJCT"]},
                            "message": "Only REJT status is supported for MT199/MT299 transformation"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_basic_requirements",
            "name": "Validate Basic Requirements",
            "description": "Validate basic requirements for pacs.002 to MT199/MT299 transformation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId",
                            "logic": { "and": [
                                {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, ""]},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.GrpHdr.MsgId"}, null]}
                            ]},
                            "message": "MessageIdentification is mandatory for Field 20 construction"
                        },
                        {
                            "path": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI",
                            "logic": {"!!": {"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI"}},
                            "message": "BAH From/Sender BICFI is required for SWIFT headers construction"
                        },
                        {
                            "path": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI",
                            "logic": {"!!": {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"}},
                            "message": "BAH To/Receiver BICFI is required for SWIFT headers construction"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.Rsn.Cd",
                            "logic": { "and": [
                                {"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.Rsn.Cd"},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.Rsn.Cd"}, ""]},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.Rsn.Cd"}, null]}
                            ]},
                            "message": "Status Reason Code is required for MT199/MT299 REJT message"
                        }
                    ]
                }
            }
        }
    ]
}
