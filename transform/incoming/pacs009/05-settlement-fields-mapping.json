{
    "id": "pacs009-to-mt202-settlement-fields",
    "name": "pacs.009 to MT202 Settlement Fields Mapping",
    "description": "Maps settlement fields from pacs.009 to MT202 according to CBPR+ specification (Fields 53 and 54) for CORE/COVE/ADV variants - TR003, TR015",
    "priority": 6,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.009"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs009-to-mt202-mandatory-fields"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_field_32a"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "check_settlement_method",
            "name": "Check Settlement Method",
            "description": "Check if settlement method requires Field 53 mapping and determine variant-specific handling",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.use_clearing_codes",
                            "logic": { "or": [
                                {"==": [{"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.SttlmMtd"}, "INGA"]},
                                {"==": [{"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.SttlmMtd"}, "INDA"]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_53",
            "name": "Map Field 53 - Sender's Correspondent",
            "description": "Map settlement information to Field 53 based on variant (TR003 for CORE/COVE, direct mapping for ADV)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.53A",
                            "condition": { "and": [
                                {"var": "temp_data.use_clearing_codes"},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.SttlmAcct"},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.InstrgRmbrsmntAgt.FinInstnId.BICFI"}
                            ]},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.InstrgRmbrsmntAgt.FinInstnId.BICFI"}}
                        },
                        {
                            "path": "data.SwiftMT.fields.53A",
                            "condition": { "and": [
                                {"==": [{"var": "temp_data.pacs009_variant"}, "ADV"]},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.InstrgRmbrsmntAgt.FinInstnId.BICFI"}
                            ]},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.InstrgRmbrsmntAgt.FinInstnId.BICFI"}}
                        },
                        {
                            "path": "data.SwiftMT.fields.53B",
                            "condition": { "and": [
                                {"var": "temp_data.use_clearing_codes"},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.SttlmAcct"},
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.InstrgRmbrsmntAgt.FinInstnId.BICFI"}},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.IBAN"}
                            ]},
                            "logic": {"party_identifier": {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.SttlmAcct.Id.IBAN"}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_54",
            "name": "Map Field 54 - Receiver's Correspondent",
            "description": "Map instructed reimbursement agent to Field 54 for ADV variant only (not present in CORE/COVE)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.54A",
                            "condition": { "and": [
                                {"==": [{"var": "temp_data.pacs009_variant"}, "ADV"]},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.BICFI"}
                            ]},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.SttlmInf.InstdRmbrsmntAgt.FinInstnId.BICFI"}}
                        }
                    ]
                }
            }
        }
    ]
}
