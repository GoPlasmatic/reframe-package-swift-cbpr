{
    "id": "pacs009-to-mt202-preconditions",
    "name": "pacs.009 to MT202 Preconditions Validation",
    "description": "Validates preconditions for pacs.009 to MT202/MT205 transformation according to CBPR+ specification PREC001-PREC002",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.009"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs009-variant-detection"]},
        {"==": [{"var": "metadata.progress.task_id"}, "detect_pacs009_variant"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_prec001_prec002",
            "name": "Validate PREC001-PREC002",
            "description": "Validate CBPR+ specification preconditions for PACS009 to MT202 transformation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.@Ccy",
                            "logic": {
                                "!": {
                                    "in": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.@Ccy"},
                                        ["XAU", "XAG", "XPD", "XPT"]
                                    ]
                                }
                            },
                            "message": "PREC001: T20054 - Commodities currencies not allowed in Field 32A. Note: This is redundant as such currencies are excluded in the UGs, so this will never be met if the MX is valid"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.NbOfTxs",
                            "logic": { "or": [
                                {"==": [{"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.NbOfTxs"}, "1"]},
                                {"==": [{"var": "data.ISO20022_MX.Document.FICdtTrf.GrpHdr.NbOfTxs"}, 1]}
                            ]},
                            "message": "PREC002: T20053 - The number of occurrences must be 1. Note: This is redundant as the schema already restricts to 1 occurrence"
                        }
                    ]
                }
            }
        },
        {
            "id": "set_target_message_type",
            "name": "Set Target Message Type",
            "description": "Set target message type to 202 for pacs.009 to MT202 transformation",
            "function": {
                "name": "map",
                "input": {"mappings": [{"path": "temp_data.target_message_type", "logic": "202"}]}
            }
        },
        {
            "id": "validate_basic_requirements",
            "name": "Validate Basic Requirements",
            "description": "Validate basic requirements for PACS009 to MT202 transformation (not explicitly in CBPR+ preconditions but required for valid MT construction)",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtId.InstrId",
                            "logic": { "and": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtId.InstrId"},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtId.InstrId"}, ""]},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtId.InstrId"}, null]}
                            ]},
                            "message": "InstructionIdentification is mandatory for Field 20 construction"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt",
                            "logic": { "and": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.@Ccy"},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.@Ccy"}, ""]},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.$value"},
                                {">": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.$value"}, 0]}
                            ]},
                            "message": "InterbankSettlementAmount with currency is mandatory for Field 32A construction"
                        },
                        {
                            "path": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmDt",
                            "logic": { "and": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmDt"},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmDt"}, ""]},
                                {"!=": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmDt"}, null]}
                            ]},
                            "message": "InterbankSettlementDate is mandatory for Field 32A construction"
                        },
                        {
                            "path": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI",
                            "logic": { "and": [
                                {"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                {"!=": [{"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI"}, ""]},
                                {"!=": [{"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI"}, null]}
                            ]},
                            "message": "BAH From/Sender BICFI is required for SWIFT headers construction"
                        },
                        {
                            "path": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI",
                            "logic": { "and": [
                                {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"},
                                {"!=": [{"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"}, ""]},
                                {"!=": [{"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"}, null]}
                            ]},
                            "message": "BAH To/Receiver BICFI is required for SWIFT headers construction"
                        }
                    ]
                }
            }
        }
    ]
}
