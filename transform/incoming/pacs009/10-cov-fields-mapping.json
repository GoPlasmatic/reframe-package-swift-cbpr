{
    "id": "pacs009-to-mt202cov-fields",
    "name": "pacs.009 COVE to MT202COV Specific Fields Mapping",
    "description": "Maps COV-specific fields from pacs.009 COVE variant to MT202COV message including Field 119 and Sequence B",
    "priority": 11,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.009"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "temp_data.pacs009_variant"}, "COVE"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs009-to-mt202-postconditions"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_postconditions"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_119",
            "name": "Map Field 119 - STP Indicator",
            "description": "Map STP indicator COV for MT202COV message",
            "function": {
                "name": "map",
                "input": {"mappings": [{"path": "data.SwiftMT.fields.#119", "logic": "COV"}]}
            }
        },
        {
            "id": "map_sequence_b_field_50",
            "name": "Map Sequence B Field 50 - Ordering Customer",
            "description": "Map underlying debtor/ultimate debtor to Field 50 in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.50K",
                            "condition": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr"},
                            "logic": {
                                "cat": [
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr.Id.OrgId.AnyBIC"},
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr.Id.OrgId.AnyBIC"},
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr.Nm"},
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr.Nm"},
                                            ""
                                        ]}
                                    ]},
                                    "\n",
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr.PstlAdr.AdrLine"},
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr.PstlAdr.AdrLine[0]"},
                                        ""
                                    ]}
                                ]
                            }
                        },
                        {
                            "path": "data.SwiftMT.sequence_b.fields.50F",
                            "condition": { "and": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Dbtr"},
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtDbtr"}}
                            ]},
                            "logic": {
                                "cat": [
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Dbtr.Id"},
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Dbtr.Id"},
                                        ""
                                    ]},
                                    "\n",
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Dbtr.Nm"},
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Dbtr.Nm"},
                                        ""
                                    ]},
                                    "\n",
                                    { "if": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Dbtr.PstlAdr"},
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Dbtr.PstlAdr.AdrLine[0]"},
                                        ""
                                    ]}
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_sequence_b_field_52",
            "name": "Map Sequence B Field 52 - Ordering Institution",
            "description": "Map underlying debtor agent to Field 52 in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.52A",
                            "condition": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.DbtrAgt.FinInstnId.BICFI"},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.DbtrAgt.FinInstnId.BICFI"}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_sequence_b_field_56",
            "name": "Map Sequence B Field 56 - Intermediary",
            "description": "Map underlying intermediary agent to Field 56 in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.56A",
                            "condition": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.IntrmyAgt1.FinInstnId.BICFI"},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.IntrmyAgt1.FinInstnId.BICFI"}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_sequence_b_field_57",
            "name": "Map Sequence B Field 57 - Account With Institution",
            "description": "Map underlying creditor agent to Field 57 in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.57A",
                            "condition": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.CdtrAgt.FinInstnId.BICFI"},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.CdtrAgt.FinInstnId.BICFI"}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_sequence_b_field_59",
            "name": "Map Sequence B Field 59 - Beneficiary Customer",
            "description": "Map underlying creditor/ultimate creditor to Field 59 in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.#59",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtCdtr"},
                                {
                                    "cat": [
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtCdtr.Id.OrgId.AnyBIC"},
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtCdtr.Id.OrgId.AnyBIC"},
                                            ""
                                        ]},
                                        "\n",
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtCdtr.Nm"},
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtCdtr.Nm"},
                                            ""
                                        ]},
                                        "\n",
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtCdtr.PstlAdr.AdrLine"},
                                            {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UltmtCdtr.PstlAdr.AdrLine[0]"},
                                            ""
                                        ]}
                                    ]
                                },
                                { "if": [
                                    {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Cdtr"},
                                    {
                                        "cat": [
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Cdtr.Id"},
                                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Cdtr.Id"},
                                                ""
                                            ]},
                                            "\n",
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Cdtr.Nm"},
                                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Cdtr.Nm"},
                                                ""
                                            ]},
                                            "\n",
                                            { "if": [
                                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Cdtr.PstlAdr"},
                                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.Cdtr.PstlAdr.AdrLine[0]"},
                                                ""
                                            ]}
                                        ]
                                    },
                                    null
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_sequence_b_field_70",
            "name": "Map Sequence B Field 70 - Remittance Information",
            "description": "Map underlying remittance information to Field 70 in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.#70",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.RmtInf.Ustrd"},
                                {
                                    "substr": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.RmtInf.Ustrd[0]"},
                                        0,
                                        140
                                    ]
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_sequence_b_field_21",
            "name": "Map Sequence B Field 21 - Related Reference",
            "description": "Map underlying transaction reference to Field 21 in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.#21",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.PmtId.EndToEndId"},
                                {
                                    "substr": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.PmtId.EndToEndId"},
                                        0,
                                        16
                                    ]
                                },
                                "NOTPROVIDED"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_sequence_b_field_32b",
            "name": "Map Sequence B Field 32B - Currency/Amount",
            "description": "Map underlying transaction amount to Field 32B in Sequence B",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.sequence_b.fields.32B",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.IntrBkSttlmAmt.@Ccy"},
                                    {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.IntrBkSttlmAmt.$value"}
                                ]},
                                {
                                    "cat": [
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.IntrBkSttlmAmt.@Ccy"},
                                        {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf.IntrBkSttlmAmt.$value"}
                                    ]
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}
