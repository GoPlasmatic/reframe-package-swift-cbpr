{
    "id": "pacs009-to-mt202-agent-fields",
    "name": "pacs.009 to MT202 Agent Fields Mapping",
    "description": "Maps agent fields from pacs.009 to MT202 (Fields 52, 56, 57, 58) according to CBPR+ specification",
    "priority": 8,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.009"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs009-to-mt202-time-indication"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_field_13c"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_field_52",
            "name": "Map Field 52 - Ordering Institution",
            "description": "Map debtor to Field 52 using MX_To_MTAgentGeneric (TR009)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.52A",
                            "condition": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Dbtr.FinInstnId.BICFI"},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Dbtr.FinInstnId.BICFI"}}
                        },
                        {
                            "path": "data.SwiftMT.fields.52D",
                            "condition": { "and": [
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Dbtr.FinInstnId.BICFI"}},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Dbtr.FinInstnId.Nm"}
                            ]},
                            "logic": {"name_and_address": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Dbtr.FinInstnId.Nm"}]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_56",
            "name": "Map Field 56 - Intermediary Institution",
            "description": "Map intermediary agent 1 to Field 56 using MX_To_MTAgentGeneric (TR007)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.56A",
                            "condition": { "and": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.BICFI"},
                                { "or": [
                                    {"!": {"var": "temp_data.use_clearing_codes"}},
                                    {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}}
                                ]}
                            ]},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.BICFI"}}
                        },
                        {
                            "path": "data.SwiftMT.fields.56D",
                            "condition": { "and": [
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.BICFI"}},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.Nm"}
                            ]},
                            "logic": {
                                "name_and_address": [
                                    {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.Nm"}
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_57",
            "name": "Map Field 57 - Account With Institution",
            "description": "Map creditor agent to Field 57 using MX_To_MTAgentGeneric with option B allowed (TR011)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.57A",
                            "condition": { "and": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"},
                                { "or": [
                                    {"!": {"var": "temp_data.use_clearing_codes"}},
                                    {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}}
                                ]}
                            ]},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"}}
                        },
                        {
                            "path": "data.SwiftMT.fields.57B",
                            "condition": { "and": [
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"}},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgtAcct.Id.IBAN"}
                            ]},
                            "logic": {"party_identifier": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgtAcct.Id.IBAN"}}
                        },
                        {
                            "path": "data.SwiftMT.fields.57D",
                            "condition": { "and": [
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI"}},
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgtAcct.Id.IBAN"}},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.Nm"}
                            ]},
                            "logic": {"name_and_address": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.Nm"}]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_field_58",
            "name": "Map Field 58 - Beneficiary Institution",
            "description": "Map creditor to Field 58 using MX_To_MTAgentGeneric (TR013)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.58A",
                            "condition": { "and": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Cdtr.FinInstnId.BICFI"},
                                { "or": [
                                    {"!": {"var": "temp_data.use_clearing_codes"}},
                                    {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}}
                                ]}
                            ]},
                            "logic": {"bic": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Cdtr.FinInstnId.BICFI"}}
                        },
                        {
                            "path": "data.SwiftMT.fields.58D",
                            "condition": { "and": [
                                {"!": {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Cdtr.FinInstnId.BICFI"}},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Cdtr.FinInstnId.Nm"}
                            ]},
                            "logic": {"name_and_address": [{"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.Cdtr.FinInstnId.Nm"}]}
                        }
                    ]
                }
            }
        }
    ]
}
