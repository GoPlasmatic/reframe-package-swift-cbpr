{
    "id": "pacs009-to-mt202-headers",
    "name": "pacs.009 to MT202 Headers Construction",
    "description": "Constructs SWIFT MT202 basic and application headers from pacs.009 BAH information",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "pacs.009"]},
        {"==": [{"var": "metadata.direction"}, "incoming"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "pacs009-to-mt202-preconditions"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_basic_requirements"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "extract_temp_variables",
            "name": "Extract Temporary Variables",
            "description": "Extract sender and receiver BIC codes from header for use in translation rules",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.Sender",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                {"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.Receiver",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"},
                                {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.BICFI"},
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_swift_headers",
            "name": "Construct SWIFT Headers",
            "description": "Build SWIFT MT202 basic and application headers using sender and receiver BICs",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {"path": "data.SwiftMT.message_type", "logic": "202"},
                        {"path": "data.SwiftMT.sender", "logic": {"var": "temp_data.Sender"}},
                        {"path": "data.SwiftMT.receiver", "logic": {"var": "temp_data.Receiver"}},
                        {
                            "path": "data.SwiftMT.basic_header.sender_bic",
                            "logic": {
                                "substr": [{"var": "temp_data.Sender"}, 0, 8]
                            }
                        },
                        {
                            "path": "data.SwiftMT.application_header.receiver_bic",
                            "logic": {
                                "substr": [{"var": "temp_data.Receiver"}, 0, 8]
                            }
                        },
                        {"path": "data.SwiftMT.application_header.message_type", "logic": "202"},
                        {"path": "data.SwiftMT.application_header.direction", "logic": "I"},
                        {"path": "data.SwiftMT.application_header.priority", "logic": "N"},
                        {"path": "data.SwiftMT.basic_header.application_id", "logic": "F"},
                        {"path": "data.SwiftMT.basic_header.service_id", "logic": "01"},
                        {
                            "path": "data.SwiftMT.basic_header.logical_terminal",
                            "logic": { "if": [
                                {"==": [{"length": {"var": "temp_data.Sender"}}, 8]},
                                {
                                    "cat": [
                                        {
                                            "substr": [{"var": "temp_data.Sender"}, 0, 8]
                                        },
                                        "AXXX"
                                    ]
                                },
                                { "if": [
                                    {"==": [{"length": {"var": "temp_data.Sender"}}, 11]},
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "temp_data.Sender"}, 0, 8]
                                            },
                                            "A",
                                            {
                                                "substr": [{"var": "temp_data.Sender"}, 8, 3]
                                            }
                                        ]
                                    },
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "temp_data.Sender"}, 0, 8]
                                            },
                                            "AXXX"
                                        ]
                                    }
                                ]}
                            ]}
                        },
                        {"path": "data.SwiftMT.basic_header.session_number", "logic": "0001"},
                        {"path": "data.SwiftMT.basic_header.sequence_number", "logic": "000001"},
                        {
                            "path": "data.SwiftMT.application_header.destination_address",
                            "logic": { "if": [
                                {"==": [{"length": {"var": "temp_data.Receiver"}}, 8]},
                                {
                                    "cat": [
                                        {
                                            "substr": [{"var": "temp_data.Receiver"}, 0, 8]
                                        },
                                        "AXXX"
                                    ]
                                },
                                { "if": [
                                    {"==": [{"length": {"var": "temp_data.Receiver"}}, 11]},
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "temp_data.Receiver"}, 0, 8]
                                            },
                                            "A",
                                            {
                                                "substr": [{"var": "temp_data.Receiver"}, 8, 3]
                                            }
                                        ]
                                    },
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "temp_data.Receiver"}, 0, 8]
                                            },
                                            "AXXX"
                                        ]
                                    }
                                ]}
                            ]}
                        },
                        {"path": "data.SwiftMT.application_header.delivery_monitoring", "logic": "2"},
                        {"path": "data.SwiftMT.application_header.obsolescence_period", "logic": "003"}
                    ]
                }
            }
        },
        {
            "id": "map_user_header",
            "name": "Map User Header",
            "description": "Map Block 3 user header fields (UETR)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.uetr",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtId.UETR"},
                                {"var": "data.ISO20022_MX.Document.FICdtTrf.CdtTrfTxInf.PmtId.UETR"},
                                null
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}
