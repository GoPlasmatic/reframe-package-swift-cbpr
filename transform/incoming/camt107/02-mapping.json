{
    "id": "camt107-to-mt110-mapping",
    "name": "camt.107 to MT110 Complete Mapping",
    "description": "Maps camt.107 to MT110 with proper message structure including cheques array",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.ISO20022_MX.message_type"}, "camt.107"]},
        {"==": [{"var": "metadata.transformation_direction"}, "mx-to-mt"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "camt107-headers-mapping"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_headers"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_mt110_structure",
            "name": "Map Complete MT110 Structure",
            "description": "Map all MT110 fields with proper structure: top-level field 20 and cheques array",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.SwiftMT.fields.#20",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.Document.GrpHdr.MsgId"},
                                {
                                    "reference": {
                                        "substr": [{"replace": [{"var": "data.ISO20022_MX.Document.GrpHdr.MsgId"}, "-", ""]}, 0, 16]
                                    }
                                },
                                {"reference": "NOTPROVIDED"}
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.53A",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.ClrSysMmbId.MmbId"},
                                {"bic": {"var": "data.ISO20022_MX.AppHdr.Fr.FIId.FinInstnId.ClrSysMmbId.MmbId"}},
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.54A",
                            "logic": { "if": [
                                {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.ClrSysMmbId.MmbId"},
                                {"bic": {"var": "data.ISO20022_MX.AppHdr.To.FIId.FinInstnId.ClrSysMmbId.MmbId"}},
                                null
                            ]}
                        },
                        {
                            "path": "data.SwiftMT.fields.##",
                            "logic": [
                                {
                                    "21": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.ChqNb"},
                                        {
                                            "reference": {
                                                "substr": [
                                                    {"replace": [{"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.ChqNb"}, "-", ""]},
                                                    0,
                                                    16
                                                ]
                                            }
                                        },
                                        {"reference": "NOTPROVIDED"}
                                    ]},
                                    "30": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.IsseDt"},
                                        {"execution_date": {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.IsseDt"}},
                                        {"execution_date": "000101"}
                                    ]},
                                    "32A": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.ValDt.Dt"},
                                        {
                                            "value_date": {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.ValDt.Dt"},
                                            "currency": {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Amt.@Ccy"},
                                            "amount": {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Amt.$value"}
                                        },
                                        null
                                    ]},
                                    "32B": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.ValDt.Dt"},
                                        null,
                                        {
                                            "currency": {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Amt.@Ccy"},
                                            "amount": {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Amt.$value"}
                                        }
                                    ]},
                                    "50F": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyer"},
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.PyerAcct"},
                                            {
                                                "account": { "if": [
                                                    {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.PyerAcct.Id.IBAN"},
                                                    {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.PyerAcct.Id.IBAN"},
                                                    { "if": [
                                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.PyerAcct.Id.Othr.Id"},
                                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.PyerAcct.Id.Othr.Id"},
                                                        "NOTPROVIDED"
                                                    ]}
                                                ]},
                                                "bic": { "if": [
                                                    {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyer.Id.OrgId.AnyBIC"},
                                                    {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyer.Id.OrgId.AnyBIC"},
                                                    "NOTPROVIDED"
                                                ]}
                                            },
                                            null
                                        ]},
                                        null
                                    ]},
                                    "50K": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyer"},
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.PyerAcct"},
                                            null,
                                            {
                                                "name_and_address": {
                                                    "filter": [
                                                        [
                                                            {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyer.Nm"},
                                                            { "if": [
                                                                {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyer.PstlAdr.AdrLine.0"},
                                                                {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyer.PstlAdr.AdrLine.0"},
                                                                null
                                                            ]}
                                                        ],
                                                        {"!!": {"var": ""}}
                                                    ]
                                                }
                                            }
                                        ]},
                                        null
                                    ]},
                                    "52": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.DrwrAgt"},
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.DrwrAgt.FinInstnId.BICFI"},
                                            {"A": {"bic": {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.DrwrAgt.FinInstnId.BICFI"}}},
                                            {
                                                "D": {
                                                    "name_and_address": {
                                                        "filter": [
                                                            [
                                                                {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.DrwrAgt.FinInstnId.Nm"},
                                                                { "if": [
                                                                    {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.DrwrAgt.PstlAdr.AdrLine.0"},
                                                                    {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.DrwrAgt.PstlAdr.AdrLine.0"},
                                                                    null
                                                                ]}
                                                            ],
                                                            {"!!": {"var": ""}}
                                                        ]
                                                    }
                                                }
                                            }
                                        ]},
                                        null
                                    ]},
                                    "59F": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee"},
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.PstlAdr.Ctry"},
                                            {
                                                "name_and_address": {
                                                    "filter": [
                                                        [
                                                            {"cat": ["1/", {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.Nm"}]},
                                                            { "if": [
                                                                {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.PstlAdr.AdrLine.0"},
                                                                {
                                                                    "cat": [
                                                                        "2/",
                                                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.PstlAdr.AdrLine.0"}
                                                                    ]
                                                                },
                                                                null
                                                            ]},
                                                            { "if": [
                                                                {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.PstlAdr.TwnNm"},
                                                                {
                                                                    "cat": [
                                                                        "3/",
                                                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.PstlAdr.TwnNm"}
                                                                    ]
                                                                },
                                                                null
                                                            ]},
                                                            {
                                                                "cat": [
                                                                    "4/",
                                                                    {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.PstlAdr.Ctry"}
                                                                ]
                                                            }
                                                        ],
                                                        {"!!": {"var": ""}}
                                                    ]
                                                }
                                            },
                                            null
                                        ]},
                                        null
                                    ]},
                                    "59": { "if": [
                                        {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee"},
                                        { "if": [
                                            {"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.PstlAdr.Ctry"},
                                            null,
                                            {
                                                "name_and_address": {
                                                    "filter": [
                                                        [{"var": "data.ISO20022_MX.Document.ChqPresntmntNtfctn.Chq.Pyee.Nm"}],
                                                        {"!!": {"var": ""}}
                                                    ]
                                                }
                                            }
                                        ]},
                                        null
                                    ]}
                                }
                            ]
                        }
                    ]
                }
            }
        }
    ]
}
