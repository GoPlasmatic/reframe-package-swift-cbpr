{
    "id": "mt103-precondition",
    "name": "MT103 Message Precondition",
    "description": "Precondition checks for MT103 message",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"in": [{"var": "metadata.SwiftMT.method"}, ["normal", "stp"]]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt103-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "construct_business_application_header"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "PREC001_validate_bah_translation",
            "name": "PREC001: Validate BAH Translation",
            "description": "CBPR+ PREC001: Ensures MT Headers to Business Application Header (BAH) translation is complete before payload translation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"},
                                {"!=": [{"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}, "NOTPROVIDED"]},
                                {"!=": [{"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}, "NOTPROVIDED"]}
                            ]},
                            "message": "PREC001: Translation stopped - Business Application Header (BAH) translation incomplete. Missing Sender or Receiver BIC from TR001."
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_settlement_method_errors",
            "name": "Validate Settlement Method Errors",
            "description": "Validates CBPR+ settlement method determination errors and generates appropriate T20xxx error codes for fields 53a/54a/55a combination violations",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "or": [
                                {"!": {"var": "data.SwiftMT.fields.53B"}},
                                {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                {"!": {"var": "data.SwiftMT.fields.53B.location"}}
                            ]},
                            "message": "T20001: Field 53B with location only cannot be translated"
                        },
                        {
                            "path": "temp_data",
                            "logic": { "or": [
                                {"!": {"var": "data.SwiftMT.fields.54B"}},
                                {"var": "data.SwiftMT.fields.54B.party_identifier"},
                                {"!": {"var": "data.SwiftMT.fields.54B.location"}}
                            ]},
                            "message": "T20004/T11001: Field 54B with location only requires NOTPROVIDED"
                        },
                        {
                            "path": "temp_data",
                            "logic": { "or": [
                                {"!": {"var": "data.SwiftMT.fields.55B"}},
                                {"var": "data.SwiftMT.fields.55B.party_identifier"},
                                {"!": {"var": "data.SwiftMT.fields.55B.location"}}
                            ]},
                            "message": "T20005/T11001: Field 55B with location only requires NOTPROVIDED"
                        },
                        {
                            "path": "temp_data",
                            "logic": { "or": [
                                {"!": {"var": "data.SwiftMT.fields.57B"}},
                                {"var": "data.SwiftMT.fields.57B.party_identifier"},
                                {"!": {"var": "data.SwiftMT.fields.57B.location"}}
                            ]},
                            "message": "T20007/T11001: Field 57B with location only requires NOTPROVIDED"
                        }
                    ]
                }
            }
        }
    ]
}
