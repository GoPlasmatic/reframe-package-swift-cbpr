{
    "id": "mt103-document-mapper",
    "name": "MT103 to pacs.008 Document Mapping for CBPR+",
    "description": "Maps MT103 message to ISO 20022 pacs.008.001.08 FIToFICustomerCreditTransferV08 document structure according to CBPR+ translation specification",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        { "or": [
            {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
            {"==": [{"var": "metadata.SwiftMT.method"}, "stp"]}
        ]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt103-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_settlement_method_errors"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "initialize_context_and_settlement",
            "name": "Initialize Context and Settlement Method",
            "description": "Initializes sender/receiver BICs, clearing system codes, and determines settlement method (INDA/INGA/COVE) with reimbursement agents",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data",
                            "logic": {
                                "Sender": { "if": [
                                    {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                    {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                    "NOTPROVIDED"
                                ]},
                                "Receiver": { "if": [
                                    {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"},
                                    {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"},
                                    "NOTPROVIDED"
                                ]},
                                "clearing_system_codes": {
                                    "AT": "ATBLZ",
                                    "AU": "AUBSB",
                                    "CN": "CNAPS",
                                    "BL": "DEBLZ",
                                    "CC": "CACPA",
                                    "GR": "GRBIC",
                                    "HK": "HKNCC",
                                    "IE": "IENCC",
                                    "IN": "INFSC",
                                    "IT": "ITNCC",
                                    "JP": "JPZGN",
                                    "NZ": "NZNCC",
                                    "PL": "PLKNR",
                                    "PT": "PTNCC",
                                    "RU": "RUCBC",
                                    "ZA": "ZANCC",
                                    "SW": "CHBCC",
                                    "ES": "ESNCC",
                                    "SC": "GBDSC",
                                    "CP": "USPID",
                                    "FW": "USABA"
                                },
                                "has_53": { "or": [
                                    {"var": "data.SwiftMT.fields.53A"},
                                    {"var": "data.SwiftMT.fields.53B"},
                                    {"var": "data.SwiftMT.fields.53D"}
                                ]},
                                "has_54": { "or": [
                                    {"var": "data.SwiftMT.fields.54A"},
                                    {"var": "data.SwiftMT.fields.54B"},
                                    {"var": "data.SwiftMT.fields.54D"}
                                ]},
                                "settlement_method": { "if": [
                                    { "and": [
                                        {"!": {"var": "temp_data.has_53"}},
                                        {"!": {"var": "temp_data.has_54"}}
                                    ]},
                                    "INDA",
                                    { "if": [
                                        { "and": [
                                            {"var": "temp_data.has_53"},
                                            {"!": {"var": "temp_data.has_54"}}
                                        ]},
                                        { "if": [
                                            { "or": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.53B.party_identifier"}, "/C"]}
                                                ]},
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53A.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.53A.party_identifier"}, "/C"]}
                                                ]},
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53D.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.53D.party_identifier"}, "/C"]}
                                                ]}
                                            ]},
                                            "INGA",
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53A.bic"},
                                                    {
                                                        "!": { "or": [
                                                            {"==": [{"substr": [{"var": "data.SwiftMT.fields.53A.bic"}, 0, 6]}, {"substr": [{"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}, 0, 6]}]},
                                                            {"==": [{"substr": [{"var": "data.SwiftMT.fields.53A.bic"}, 0, 6]}, {"substr": [{"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}, 0, 6]}]}
                                                        ]}
                                                    }
                                                ]},
                                                "COVE",
                                                "INDA"
                                            ]}
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"!": {"var": "temp_data.has_53"}},
                                                {"var": "temp_data.has_54"}
                                            ]},
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.54A.bic"},
                                                    { "or": [
                                                        {"==": [{"substr": [{"var": "data.SwiftMT.fields.54A.bic"}, 0, 8]}, {"substr": [{"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}, 0, 8]}]},
                                                        {"==": [{"substr": [{"var": "data.SwiftMT.fields.54A.bic"}, 0, 8]}, {"substr": [{"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}, 0, 8]}]}
                                                    ]}
                                                ]},
                                                "INDA",
                                                "COVE"
                                            ]},
                                            "COVE"
                                        ]}
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_group_header",
            "name": "Construct Group Header with Settlement Info",
            "description": "Builds pacs.008 group header including message ID, settlement information, and reimbursement agent details",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.GrpHdr",
                            "logic": {
                                "MsgId": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "CreDtTm": "9999-12-31T00:00:00+00:00",
                                "NbOfTxs": "1",
                                "TtlIntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]},
                                    "$value": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        0.0
                                    ]}
                                },
                                "IntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"format_date": [{"now": []}, "yyyy-MM-dd"]}
                                ]},
                                "SttlmInf": {
                                    "SttlmMtd": {"var": "temp_data.settlement_method"},
                                    "SttlmAcct": { "if": [
                                        { "and": [
                                            {"in": [{"var": "temp_data.settlement_method"}, ["INDA", "INGA"]]},
                                            { "or": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.53B.party_identifier"}, "/"]}
                                                ]},
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53A.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.53A.party_identifier"}, "/"]}
                                                ]},
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53D.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.53D.party_identifier"}, "/"]}
                                                ]}
                                            ]}
                                        ]},
                                        {
                                            "Id": {
                                                "Othr": {
                                                    "Id": { "if": [
                                                        {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                                        {"substr": [{"var": "data.SwiftMT.fields.53B.party_identifier"}, 1]},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.53A.party_identifier"},
                                                            {"substr": [{"var": "data.SwiftMT.fields.53A.party_identifier"}, 1]},
                                                            { "if": [
                                                                {"var": "data.SwiftMT.fields.53D.party_identifier"},
                                                                {"substr": [{"var": "data.SwiftMT.fields.53D.party_identifier"}, 1]},
                                                                ""
                                                            ]}
                                                        ]}
                                                    ]}
                                                }
                                            }
                                        },
                                        null
                                    ]},
                                    "InstrReimbAgt": { "if": [
                                        {"==": [{"var": "temp_data.settlement_method"}, "COVE"]},
                                        {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"var": "data.SwiftMT.fields.53A.bic"},
                                                    {"var": "data.SwiftMT.fields.53A.bic"},
                                                    ""
                                                ]},
                                                "Nm": { "if": [
                                                    {"var": "data.SwiftMT.fields.53D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.53D.name_and_address.0"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.53C.name_and_address"},
                                                        {"var": "data.SwiftMT.fields.53C.name_and_address.0"},
                                                        ""
                                                    ]}
                                                ]}
                                            }
                                        },
                                        null
                                    ]},
                                    "InstrReimbAgtAcct": { "if": [
                                        {"==": [{"var": "temp_data.settlement_method"}, "COVE"]},
                                        {
                                            "Id": {
                                                "Othr": {
                                                    "Id": { "if": [
                                                        {"var": "data.SwiftMT.fields.53A.account_number"},
                                                        {"var": "data.SwiftMT.fields.53A.account_number"},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.53D.account_number"},
                                                            {"var": "data.SwiftMT.fields.53D.account_number"},
                                                            ""
                                                        ]}
                                                    ]}
                                                }
                                            }
                                        },
                                        null
                                    ]},
                                    "InstdReimbAgt": { "if": [
                                        {"==": [{"var": "temp_data.settlement_method"}, "COVE"]},
                                        {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"var": "data.SwiftMT.fields.54A.bic"},
                                                    {"var": "data.SwiftMT.fields.54A.bic"},
                                                    ""
                                                ]},
                                                "Nm": { "if": [
                                                    {"var": "data.SwiftMT.fields.54D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.54D.name_and_address.0"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.54C.name_and_address"},
                                                        {"var": "data.SwiftMT.fields.54C.name_and_address.0"},
                                                        ""
                                                    ]}
                                                ]}
                                            }
                                        },
                                        null
                                    ]},
                                    "InstdReimbAgtAcct": { "if": [
                                        {"==": [{"var": "temp_data.settlement_method"}, "COVE"]},
                                        {
                                            "Id": {
                                                "Othr": {
                                                    "Id": { "if": [
                                                        {"var": "data.SwiftMT.fields.54A.account_number"},
                                                        {"var": "data.SwiftMT.fields.54A.account_number"},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.54D.account_number"},
                                                            {"var": "data.SwiftMT.fields.54D.account_number"},
                                                            ""
                                                        ]}
                                                    ]}
                                                }
                                            }
                                        },
                                        null
                                    ]},
                                    "ThrdReimbAgt": { "if": [
                                        { "and": [
                                            {"==": [{"var": "temp_data.settlement_method"}, "COVE"]},
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.55A.bic"},
                                                {"var": "data.SwiftMT.fields.55B.bic"},
                                                {"var": "data.SwiftMT.fields.55D.bic"}
                                            ]}
                                        ]},
                                        {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"var": "data.SwiftMT.fields.55A.bic"},
                                                    {"var": "data.SwiftMT.fields.55A.bic"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.55B.bic"},
                                                        {"var": "data.SwiftMT.fields.55B.bic"},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.55D.bic"},
                                                            {"var": "data.SwiftMT.fields.55D.bic"},
                                                            ""
                                                        ]}
                                                    ]}
                                                ]},
                                                "Nm": { "if": [
                                                    {"var": "data.SwiftMT.fields.55D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.55D.name_and_address.0"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.55C.name_and_address"},
                                                        {"var": "data.SwiftMT.fields.55C.name_and_address.0"},
                                                        { "if": [
                                                            {"==": [{"var": "SwiftMT.method"}, "stp"]},
                                                            "",
                                                            "NOTPROVIDED"
                                                        ]}
                                                    ]}
                                                ]}
                                            }
                                        },
                                        null
                                    ]},
                                    "ThrdReimbAgtAcct": { "if": [
                                        { "and": [
                                            {"==": [{"var": "temp_data.settlement_method"}, "COVE"]},
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.55A.bic"},
                                                {"var": "data.SwiftMT.fields.55B.bic"},
                                                {"var": "data.SwiftMT.fields.55D.bic"}
                                            ]}
                                        ]},
                                        {
                                            "Id": {
                                                "Othr": {
                                                    "Id": { "if": [
                                                        {"var": "data.SwiftMT.fields.55A.account_number"},
                                                        {"var": "data.SwiftMT.fields.55A.account_number"},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.55D.account_number"},
                                                            {"var": "data.SwiftMT.fields.55D.account_number"},
                                                            ""
                                                        ]}
                                                    ]}
                                                }
                                            }
                                        },
                                        null
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_credit_transfer_transaction_core",
            "name": "Map Credit Transfer Transaction Core Fields",
            "description": "Maps core transaction fields including payment ID, amounts, parties, agents, and payment type information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf",
                            "logic": {
                                "PmtId": { "if": [
                                    {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                    {
                                        "InstrId": { "if": [
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "EndToEndId": { "if": [
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "TxId": {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        "UETR": {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"}
                                    },
                                    {
                                        "InstrId": { "if": [
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "EndToEndId": { "if": [
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "TxId": "NOTPROVIDED"
                                    }
                                ]},
                                "PmtTpInf": {
                                    "InstrPrty": { "if": [
                                        {"var": "data.SwiftMT.fields.13C.code_time"},
                                        {
                                            "map": [
                                                {"var": "data.SwiftMT.fields.13C.code_time"},
                                                { "if": [
                                                    {"==": [{"var": "code"}, "URGP"]},
                                                    "HIGH",
                                                    { "if": [
                                                        {"==": [{"var": "code"}, "URGT"]},
                                                        "HIGH",
                                                        ""
                                                    ]}
                                                ]}
                                            ]
                                        },
                                        null
                                    ]},
                                    "SvcLvl": { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.23E.0.code"},
                                            {"==": [{"var": "data.SwiftMT.fields.23E.0.code"}, "SDVA"]}
                                        ]},
                                        [{"Cd": "SDVA"}],
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.23E.0.code"},
                                                {"==": [{"var": "data.SwiftMT.fields.23E.0.code"}, "INTC"]}
                                            ]},
                                            [{"Prtry": "INTC"}],
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.23E"},
                                                    {"some": [{"var": "data.SwiftMT.fields.23E"}, {"in": [{"var": "code"}, ["CORT", "INTC"]]}]}
                                                ]},
                                                [{"Prtry": "INTC CORT"}],
                                                []
                                            ]}
                                        ]}
                                    ]},
                                    "ClrChanl": { "if": [
                                        { "or": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.56A.party_identifier"}, "//RT"]},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.56A.party_identifier"}, "//FW"]},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.57A.party_identifier"}, "//RT"]},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.57A.party_identifier"}, "//FW"]}
                                        ]},
                                        "RTGS",
                                        "BOOK"
                                    ]}
                                },
                                "IntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]},
                                    "$value": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        0.0
                                    ]}
                                },
                                "IntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"format_date": [{"now": []}, "yyyy-MM-dd"]}
                                ]},
                                "InstdAmt": { "if": [
                                    {"var": "data.SwiftMT.fields.33B.currency_amount"},
                                    {
                                        "@Ccy": {"var": "data.SwiftMT.fields.33B.currency_amount.currency"},
                                        "$value": {"var": "data.SwiftMT.fields.33B.currency_amount.amount"}
                                    },
                                    null
                                ]},
                                "XchgRate": { "if": [
                                    {"var": "data.SwiftMT.fields.36.rate"},
                                    {"var": "data.SwiftMT.fields.36.rate"},
                                    null
                                ]},
                                "ChrgBr": { "if": [
                                    {"var": "data.SwiftMT.fields.71A.charge_code"},
                                    {"var": "data.SwiftMT.fields.71A.charge_code"},
                                    "SHAR"
                                ]},
                                "InstgAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}},
                                "InstdAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}},
                                "Purp": { "if": [
                                    {"var": "data.SwiftMT.fields.26T.transaction_type_code"},
                                    {"Prtry": {"cat": [":26T:", {"var": "data.SwiftMT.fields.26T.transaction_type_code"}]}},
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_parties_and_accounts",
            "name": "Map Parties and Accounts",
            "description": "Maps debtor, creditor, their accounts and financial institution agents",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.Dbtr",
                            "logic": {
                                "Nm": { "if": [
                                    {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                    { "if": [
                                        {">=": [{"length": {"var": "data.SwiftMT.fields.50K.name_and_address"}}, 1]},
                                        {"var": "data.SwiftMT.fields.50K.name_and_address.0"},
                                        ""
                                    ]},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.50A.name_and_address"},
                                        {"var": "data.SwiftMT.fields.50A.name_and_address.0"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.50F.name_and_address"},
                                            {"var": "data.SwiftMT.fields.50F.name_and_address.0"},
                                            { "if": [
                                                {"==": [{"var": "SwiftMT.method"}, "stp"]},
                                                "",
                                                "NOTPROVIDED"
                                            ]}
                                        ]}
                                    ]}
                                ]},
                                "Id": { "if": [
                                    {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                    {
                                        "OrgId": {
                                            "LEI": { "reduce": [
                                                {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                                { "if": [
                                                    { "and": [
                                                        {"starts_with": [{"var": "current"}, "/LEI/"]},
                                                        {">=": [{"length": {"var": "current"}}, 25]}
                                                    ]},
                                                    {
                                                        "substr": [{"var": "current"}, 5, 20]
                                                    },
                                                    {"var": "accumulator"}
                                                ]},
                                                ""
                                            ]},
                                            "Othr": { "if": [
                                                { "and": [
                                                    {"!": {"var": "data.SwiftMT.fields.50K.account"}},
                                                    {"var": "data.SwiftMT.fields.50A.bic"}
                                                ]},
                                                [{"Id": "NOTPROVIDED", "SchmeNm": {"Cd": "TXID"}}],
                                                null
                                            ]}
                                        }
                                    },
                                    null
                                ]},
                                "CtryOfRes": { "if": [
                                    {"var": "data.SwiftMT.fields.77B.lines"},
                                    { "reduce": [
                                        {"var": "data.SwiftMT.fields.77B.lines"},
                                        { "if": [
                                            { "and": [
                                                {"==": [{"var": "accumulator"}, ""]},
                                                {"in": ["/ORDERRES/", {"var": "current"}]},
                                                {">=": [{"length": {"var": "current"}}, 12]}
                                            ]},
                                            {
                                                "substr": [{"var": "current"}, 10, 2]
                                            },
                                            {"var": "accumulator"}
                                        ]},
                                        ""
                                    ]},
                                    null
                                ]}
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAcct",
                            "logic": {
                                "Id": {
                                    "Othr": {
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.50K.lines"},
                                            { "if": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.50K.lines.0"}, "50K:/"]},
                                                {"substr": [{"var": "data.SwiftMT.fields.50K.lines.0"}, 5]},
                                                { "if": [
                                                    {"==": [{"var": "SwiftMT.method"}, "stp"]},
                                                    "",
                                                    "NOTPROVIDED"
                                                ]}
                                            ]},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.50A.account"},
                                                {"var": "data.SwiftMT.fields.50A.account"},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.50F.account"},
                                                    {"var": "data.SwiftMT.fields.50F.account"},
                                                    { "if": [
                                                        {"==": [{"var": "SwiftMT.method"}, "stp"]},
                                                        "",
                                                        "NOTPROVIDED"
                                                    ]}
                                                ]}
                                            ]}
                                        ]}
                                    }
                                }
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.52A.bic"},
                                        {"var": "data.SwiftMT.fields.52A.bic"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.52D.name_and_address"},
                                            "NOTPROVIDED",
                                            {"var": "temp_data.Sender"}
                                        ]}
                                    ]}
                                }
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.Cdtr",
                            "logic": {
                                "Nm": { "if": [
                                    {"var": "data.SwiftMT.fields.59.name_and_address"},
                                    { "if": [
                                        {">=": [{"length": {"var": "data.SwiftMT.fields.59.name_and_address"}}, 1]},
                                        {"var": "data.SwiftMT.fields.59.name_and_address.0"},
                                        ""
                                    ]},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.59A.name_and_address"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.59A.name_and_address.0"},
                                            {"var": "data.SwiftMT.fields.59A.name_and_address.0"},
                                            ""
                                        ]},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.59A.bic"},
                                            {"var": "data.SwiftMT.fields.59A.bic"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.59F.name_and_address"},
                                                {"var": "data.SwiftMT.fields.59F.name_and_address.0"},
                                                { "if": [
                                                    {"==": [{"var": "SwiftMT.method"}, "stp"]},
                                                    "",
                                                    "NOTPROVIDED"
                                                ]}
                                            ]}
                                        ]}
                                    ]}
                                ]},
                                "Id": { "if": [
                                    {"var": "data.SwiftMT.fields.59.name_and_address"},
                                    {
                                        "OrgId": {
                                            "LEI": { "reduce": [
                                                {"var": "data.SwiftMT.fields.59.name_and_address"},
                                                { "if": [
                                                    { "and": [
                                                        {"starts_with": [{"var": "current"}, "/LEI/"]},
                                                        {">=": [{"length": {"var": "current"}}, 25]}
                                                    ]},
                                                    {
                                                        "substr": [{"var": "current"}, 5, 20]
                                                    },
                                                    {"var": "accumulator"}
                                                ]},
                                                ""
                                            ]},
                                            "Othr": { "if": [
                                                { "and": [
                                                    {"!": {"var": "data.SwiftMT.fields.59.account"}},
                                                    {"var": "data.SwiftMT.fields.59A.bic"}
                                                ]},
                                                [{"Id": "NOTPROVIDED", "SchmeNm": {"Cd": "TXID"}}],
                                                null
                                            ]}
                                        }
                                    },
                                    null
                                ]},
                                "CtryOfRes": { "if": [
                                    {"var": "data.SwiftMT.fields.77B.lines"},
                                    { "reduce": [
                                        {"var": "data.SwiftMT.fields.77B.lines"},
                                        { "if": [
                                            { "and": [
                                                {"==": [{"var": "accumulator"}, ""]},
                                                {"in": ["/BENEFRES/", {"var": "current"}]},
                                                {">=": [{"length": {"var": "current"}}, 12]}
                                            ]},
                                            {
                                                "substr": [{"var": "current"}, 10, 2]
                                            },
                                            {"var": "accumulator"}
                                        ]},
                                        ""
                                    ]},
                                    null
                                ]}
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAcct",
                            "logic": {
                                "Id": {
                                    "Othr": {
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.59.account"},
                                            {"var": "data.SwiftMT.fields.59.account"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.59A.account"},
                                                {"var": "data.SwiftMT.fields.59A.account"},
                                                { "if": [
                                                    {"==": [{"var": "SwiftMT.method"}, "stp"]},
                                                    "",
                                                    "NOTPROVIDED"
                                                ]}
                                            ]}
                                        ]}
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_intermediary_and_creditor_agents",
            "name": "Map Intermediary and Creditor Agents",
            "description": "Maps intermediary agent (field 56) and creditor agent (field 57) with their accounts",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.56A.bic"},
                                    {"var": "data.SwiftMT.fields.56C.party_identifier"},
                                    {"var": "data.SwiftMT.fields.56D"}
                                ]},
                                {
                                    "FinInstnId": { "if": [
                                        {"var": "data.SwiftMT.fields.56A.bic"},
                                        {"BICFI": {"var": "data.SwiftMT.fields.56A.bic"}},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.56C.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, "//"]},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, "//CH"]}},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, "//RT"]}},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, "//FW"]}}
                                            ]},
                                            {
                                                "ClrSysMmbId": {
                                                    "ClrSysId": {
                                                        "Cd": { "if": [
                                                            {"var": ["temp_data.clearing_system_codes", {"substr": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, 2, 2]}]},
                                                            {"var": ["temp_data.clearing_system_codes", {"substr": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, 2, 2]}]},
                                                            {
                                                                "substr": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, 2, 2]
                                                            }
                                                        ]}
                                                    },
                                                    "MmbId": {"substr": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, 4]}
                                                },
                                                "Nm": "NOTPROVIDED",
                                                "PstlAdr": {"AdrLine": ["NOTPROVIDED"]}
                                            },
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.56C.party_identifier"},
                                                {
                                                    "Nm": {"var": "data.SwiftMT.fields.56C.party_identifier"},
                                                    "PstlAdr": {"AdrLine": ["NOTPROVIDED"]}
                                                },
                                                { "if": [
                                                    {"==": [{"var": "SwiftMT.method"}, "stp"]},
                                                    {"BICFI": {"var": "temp_data.Receiver"}},
                                                    {"BICFI": "NOTPROVIDED"}
                                                ]}
                                            ]}
                                        ]}
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrmyAgt1Acct",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.56A.party_identifier"},
                                    { "and": [
                                        {"var": "data.SwiftMT.fields.56C.party_identifier"},
                                        { "or": [
                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, "//"]}},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.56C.party_identifier"}, "//CH"]}
                                        ]}
                                    ]}
                                ]},
                                {
                                    "Id": {
                                        "Othr": {
                                            "Id": { "if": [
                                                {"var": "data.SwiftMT.fields.56A.party_identifier"},
                                                {"var": "data.SwiftMT.fields.56A.party_identifier"},
                                                {"var": "data.SwiftMT.fields.56C.party_identifier"}
                                            ]}
                                        }
                                    }
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt",
                            "logic": {
                                "FinInstnId": { "if": [
                                    {"var": "data.SwiftMT.fields.57A.bic"},
                                    {"BICFI": {"var": "data.SwiftMT.fields.57A.bic"}},
                                    { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.57B.party_identifier"},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, "//"]},
                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, "//CH"]}}
                                        ]},
                                        {
                                            "ClrSysMmbId": {
                                                "ClrSysId": {
                                                    "Cd": { "if": [
                                                        {"var": ["temp_data.clearing_system_codes", {"substr": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, 2, 2]}]},
                                                        {"var": ["temp_data.clearing_system_codes", {"substr": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, 2, 2]}]},
                                                        {
                                                            "substr": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, 2, 2]
                                                        }
                                                    ]}
                                                },
                                                "MmbId": {"substr": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, 4]}
                                            },
                                            "Nm": { "if": [
                                                {"var": "data.SwiftMT.fields.57B.location"},
                                                "NOTPROVIDED",
                                                ""
                                            ]},
                                            "PstlAdr": { "if": [
                                                {"var": "data.SwiftMT.fields.57B.location"},
                                                {"AdrLine": [{"var": "data.SwiftMT.fields.57B.location"}]},
                                                {}
                                            ]}
                                        },
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.57C"},
                                            {
                                                "ClrSysMmbId": {
                                                    "ClrSysId": {
                                                        "Cd": { "if": [
                                                            {"var": ["temp_data.clearing_system_codes", {"substr": [{"var": "data.SwiftMT.fields.57.C"}, 1, 2]}]},
                                                            {"var": ["temp_data.clearing_system_codes", {"substr": [{"var": "data.SwiftMT.fields.57.C"}, 1, 2]}]},
                                                            {
                                                                "substr": [{"var": "data.SwiftMT.fields.57C"}, 1, 2]
                                                            }
                                                        ]}
                                                    },
                                                    "MmbId": {"substr": [{"var": "data.SwiftMT.fields.57C"}, 3]}
                                                },
                                                "Nm": "NOTPROVIDED",
                                                "PstlAdr": {"AdrLine": ["NOTPROVIDED"]}
                                            },
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.57D.name_and_address"},
                                                {
                                                    "BICFI": "NOTPROVIDED",
                                                    "Nm": {"var": "data.SwiftMT.fields.57D.name_and_address.0"},
                                                    "PstlAdr": {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.57D.name_and_address"}, 1]}}
                                                },
                                                {"BICFI": {"var": "temp_data.Receiver"}}
                                            ]}
                                        ]}
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_instructions_charges_and_remittance",
            "name": "Map Instructions, Charges and Remittance Information",
            "description": "Maps instruction codes from field 23E and 72, charges information, regulatory reporting, and remittance information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.InstrForNxtAgt",
                            "logic": { "if": [
                                { "or": [
                                    { "and": [
                                        {"var": "data.SwiftMT.fields.53A.bic"},
                                        { "or": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.53A.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.53A.party_identifier"}, "/"]},
                                                {"!": {"var": "data.SwiftMT.fields.54A"}}
                                            ]},
                                            { "and": [
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.53A.party_identifier"}, "/"]}},
                                                { "or": [
                                                    {"==": [{"substr": [{"var": "data.SwiftMT.fields.53A.bic"}, 0, 6]}, {"substr": [{"var": "temp_data.Sender"}, 0, 6]}]},
                                                    {"==": [{"substr": [{"var": "data.SwiftMT.fields.53A.bic"}, 0, 6]}, {"substr": [{"var": "temp_data.Receiver"}, 0, 6]}]}
                                                ]},
                                                {"!": {"var": "data.SwiftMT.fields.54A"}}
                                            ]}
                                        ]}
                                    ]},
                                    {"var": "data.SwiftMT.fields.72.information"}
                                ]},
                                { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.53A.bic"},
                                        {"var": "data.SwiftMT.fields.72.information"}
                                    ]},
                                    {
                                        "filter": [
                                            [
                                                {
                                                    "InstrInf": {
                                                        "cat": [
                                                            { "if": [
                                                                {"var": "data.SwiftMT.fields.53A.bic"},
                                                                {"cat": ["/FIN53/", {"var": "data.SwiftMT.fields.53A.bic"}]},
                                                                ""
                                                            ]},
                                                            { "if": [
                                                                {"var": "data.SwiftMT.fields.72.information"},
                                                                { "reduce": [
                                                                    {
                                                                        "filter": [
                                                                            {"var": "data.SwiftMT.fields.72.information"},
                                                                            {
                                                                                "!": { "or": [
                                                                                    {"starts_with": [{"var": ""}, "/INS/"]},
                                                                                    {"starts_with": [{"var": ""}, "/ACC/"]},
                                                                                    {"starts_with": [{"var": ""}, "/REC/"]},
                                                                                    {"starts_with": [{"var": ""}, "/BNF/"]},
                                                                                    {"starts_with": [{"var": ""}, "//CH"]},
                                                                                    {"starts_with": [{"var": ""}, "//FW"]},
                                                                                    {"starts_with": [{"var": ""}, "//RT"]}
                                                                                ]}
                                                                            }
                                                                        ]
                                                                    },
                                                                    {
                                                                        "cat": [{"var": "accumulator"}, " ", {"var": "current"}]
                                                                    },
                                                                    ""
                                                                ]},
                                                                ""
                                                            ]}
                                                        ]
                                                    }
                                                }
                                            ],
                                            {"var": ""}
                                        ]
                                    },
                                    []
                                ]},
                                []
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.InstrForCdtrAgt",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.23E"},
                                    {"var": "data.SwiftMT.fields.72.information"}
                                ]},
                                {
                                    "filter": [
                                        [
                                            {
                                                "InstrInf": {
                                                    "cat": [
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.23E"},
                                                            { "reduce": [
                                                                {
                                                                    "filter": [
                                                                        {"var": "data.SwiftMT.fields.23E"},
                                                                        {
                                                                            "in": [
                                                                                {"var": "code"},
                                                                                ["CHQB", "HOLD", "PHOB", "TELB"]
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "cat": [
                                                                        {"var": "accumulator"},
                                                                        { "if": [
                                                                            {"==": [{"var": "code"}, "CHQB"]},
                                                                            "CHQB: Cheque to beneficiary. ",
                                                                            { "if": [
                                                                                {"==": [{"var": "code"}, "HOLD"]},
                                                                                "HOLD: Hold for beneficiary. ",
                                                                                { "if": [
                                                                                    {"==": [{"var": "code"}, "PHOB"]},
                                                                                    "PHOB: Please advise beneficiary by phone. ",
                                                                                    { "if": [
                                                                                        {"==": [{"var": "code"}, "TELB"]},
                                                                                        "TELB: Please advise beneficiary by other telecommunication. ",
                                                                                        ""
                                                                                    ]}
                                                                                ]}
                                                                            ]}
                                                                        ]}
                                                                    ]
                                                                },
                                                                ""
                                                            ]},
                                                            ""
                                                        ]},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.72.information"},
                                                            { "reduce": [
                                                                {
                                                                    "filter": [
                                                                        {"var": "data.SwiftMT.fields.72.information"},
                                                                        {
                                                                            "!": { "or": [
                                                                                {"starts_with": [{"var": ""}, "/INS/"]},
                                                                                {"starts_with": [{"var": ""}, "/ACC/"]},
                                                                                {"starts_with": [{"var": ""}, "/REC/"]},
                                                                                {"starts_with": [{"var": ""}, "/BNF/"]},
                                                                                {"starts_with": [{"var": ""}, "//CH"]},
                                                                                {"starts_with": [{"var": ""}, "//FW"]},
                                                                                {"starts_with": [{"var": ""}, "//RT"]}
                                                                            ]}
                                                                        }
                                                                    ]
                                                                },
                                                                {
                                                                    "cat": [{"var": "accumulator"}, " ", {"var": "current"}]
                                                                },
                                                                ""
                                                            ]},
                                                            ""
                                                        ]}
                                                    ]
                                                }
                                            }
                                        ],
                                        {"!=": [{"var": "InstrInf"}, ""]}
                                    ]
                                },
                                []
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgsInf",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.71F"},
                                    {"var": "data.SwiftMT.fields.71G"}
                                ]},
                                {
                                    "merge": [
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.71F"},
                                            { "if": [
                                                {"is_array": {"var": "data.SwiftMT.fields.71F"}},
                                                {
                                                    "map": [
                                                        {"var": "data.SwiftMT.fields.71F"},
                                                        {
                                                            "Amt": {"@Ccy": {"var": "currency"}, "$value": {"var": "amount"}},
                                                            "Agt": {"FinInstnId": {"BICFI": {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}}}
                                                        }
                                                    ]
                                                },
                                                [
                                                    {
                                                        "Amt": {
                                                            "@Ccy": {"var": "data.SwiftMT.fields.71F.currency"},
                                                            "$value": {"var": "data.SwiftMT.fields.71F.amount"}
                                                        },
                                                        "Agt": {"FinInstnId": {"BICFI": {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}}}
                                                    }
                                                ]
                                            ]},
                                            []
                                        ]},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.71G"},
                                            [
                                                {
                                                    "Amt": {
                                                        "@Ccy": {"var": "data.SwiftMT.fields.71G.currency"},
                                                        "$value": {"var": "data.SwiftMT.fields.71G.amount"}
                                                    },
                                                    "Agt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}
                                                }
                                            ],
                                            []
                                        ]}
                                    ]
                                },
                                []
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.RgltryRptg",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.77B.lines"},
                                [
                                    {
                                        "Dtls": [
                                            {
                                                "Inf": { "reduce": [
                                                    {"var": "data.SwiftMT.fields.77B.lines"},
                                                    {"cat": [{"var": "accumulator"}, {"var": "current"}]},
                                                    ""
                                                ]}
                                            }
                                        ]
                                    }
                                ],
                                []
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.RmtInf",
                            "logic": {
                                "Ustrd": { "if": [
                                    {"var": "data.SwiftMT.fields.70.narrative"},
                                    {"var": "data.SwiftMT.fields.70.narrative.0"},
                                    "NOTPROVIDED"
                                ]}
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFICstmrCdtTrf.CdtTrfTxInf.SplmtryData",
                            "logic": null
                        }
                    ]
                }
            }
        },
        {
            "id": "generate_document_xml",
            "name": "Generate MX Envelope XML",
            "description": "Generates the complete ISO20022 XML output (AppHdr + Document) for normal MT103 processing",
            "condition": {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        },
        {
            "id": "generate_stp_document_xml",
            "name": "Generate STP MX Envelope XML",
            "description": "Generates the complete ISO20022 XML output (AppHdr + Document) for STP MT103 processing",
            "condition": {"==": [{"var": "metadata.SwiftMT.method"}, "stp"]},
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
