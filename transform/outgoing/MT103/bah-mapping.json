{
    "id": "mt103-bah-mapper",
    "name": "MT103 Business Application Header Mapping for CBPR+",
    "description": "Maps MT103 message to ISO 20022 Business Application Header (AppHdr) using head.001.001.02 schema",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"in": [{"var": "metadata.SwiftMT.method"}, ["normal", "stp"]]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt103-method-detector"]},
        {"==": [{"var": "metadata.progress.task_id"}, "detect_mt103_method"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_business_application_header",
            "name": "Construct Business Application Header with Related Message",
            "description": "Builds complete CBPR+ business application header (AppHdr) and related message metadata per head.001.001.02 specification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.AppHdr",
                            "logic": {
                                "CharSet": { "if": [
                                    {"var": "parameters.CharacterSet"},
                                    {"var": "parameters.CharacterSet"},
                                    null
                                ]},
                                "Fr": {
                                    "FIId": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"==": [{"var": "data.SwiftMT.application_header.direction"}, "I"]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    "NOTPROVIDED"
                                                ]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.application_header.mir_sender_bic"},
                                                    {"var": "data.SwiftMT.application_header.mir_sender_bic"},
                                                    "NOTPROVIDED"
                                                ]}
                                            ]}
                                        }
                                    }
                                },
                                "To": {
                                    "FIId": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"==": [{"var": "data.SwiftMT.application_header.direction"}, "I"]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.application_header.receiver_bic"},
                                                    {"var": "data.SwiftMT.application_header.receiver_bic"},
                                                    "NOTPROVIDED"
                                                ]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    "NOTPROVIDED"
                                                ]}
                                            ]}
                                        }
                                    }
                                },
                                "BizMsgIdr": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "MsgDefIdr": "pacs.008.001.08",
                                "BizSvc": "swift.cbprplus.01",
                                "MktPrctc": { "if": [
                                    {"var": "parameters.MarketPractice"},
                                    {"var": "parameters.MarketPractice"},
                                    null
                                ]},
                                "CreDt": { "if": [
                                    {"var": "parameters.CreationDate"},
                                    {"var": "parameters.CreationDate"},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        {
                                            "cat": [
                                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                                "T",
                                                {"format_date": [{"now": []}, "HH:mm:ss"]},
                                                "+00:00"
                                            ]
                                        },
                                        "9999-12-31T00:00:00+00:00"
                                    ]}
                                ]},
                                "CpyDplct": { "if": [
                                    {"var": "parameters.CopyDuplicate"},
                                    {"var": "parameters.CopyDuplicate"},
                                    null
                                ]},
                                "PssblDplct": { "if": [
                                    {"var": "data.SwiftMT.trailer.PDE"},
                                    true,
                                    false
                                ]},
                                "Prty": { "if": [
                                    {"var": "parameters.Priority"},
                                    {"var": "parameters.Priority"},
                                    { "if": [
                                        {"var": "data.SwiftMT.user_header.113"},
                                        { "if": [
                                            {"==": [{"var": "data.SwiftMT.user_header.113"}, "HIGH"]},
                                            "HIGH",
                                            "NORM"
                                        ]},
                                        null
                                    ]}
                                ]},
                                "Rltd": {
                                    "Fr": {
                                        "FIId": {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"==": [{"var": "data.SwiftMT.application_header.direction"}, "I"]},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                        {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                        "NOTPROVIDED"
                                                    ]},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.application_header.mir_sender_bic"},
                                                        {"var": "data.SwiftMT.application_header.mir_sender_bic"},
                                                        "NOTPROVIDED"
                                                    ]}
                                                ]}
                                            }
                                        }
                                    },
                                    "To": {
                                        "FIId": {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"==": [{"var": "data.SwiftMT.application_header.direction"}, "I"]},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.application_header.receiver_bic"},
                                                        {"var": "data.SwiftMT.application_header.receiver_bic"},
                                                        "NOTPROVIDED"
                                                    ]},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                        {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                        "NOTPROVIDED"
                                                    ]}
                                                ]}
                                            }
                                        }
                                    },
                                    "MsgDefIdr": "pacs.008.001.08",
                                    "BizMsgIdr": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "CreDt": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        {
                                            "cat": [
                                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                                "T",
                                                {"format_date": [{"now": []}, "HH:mm:ss"]},
                                                "+00:00"
                                            ]
                                        },
                                        "9999-12-31T00:00:00+00:00"
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        }
    ]
}
