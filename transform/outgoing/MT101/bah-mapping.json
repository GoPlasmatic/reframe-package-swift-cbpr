{
    "id": "mt101-bah-mapper",
    "name": "MT101 Business Application Header Mapping for CBPR+",
    "description": "Maps MT101 message to ISO 20022 Business Application Header (AppHdr) using head.001.001.02 schema for pain.001",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "101"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt101-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_cbpr_requirements"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_business_application_header",
            "name": "Construct Business Application Header with Context",
            "description": "Creates the ISO 20022 AppHdr for pain.001 with sender/receiver extraction",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.AppHdr",
                            "logic": {
                                "Fr": {
                                    "FIId": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"==": [{"var": "data.SwiftMT.application_header.direction"}, "I"]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    "NOTPROVIDED"
                                                ]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.application_header.mir_sender_bic"},
                                                    {"var": "data.SwiftMT.application_header.mir_sender_bic"},
                                                    "NOTPROVIDED"
                                                ]}
                                            ]}
                                        }
                                    }
                                },
                                "To": {
                                    "FIId": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"==": [{"var": "data.SwiftMT.application_header.direction"}, "I"]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.application_header.receiver_bic"},
                                                    {"var": "data.SwiftMT.application_header.receiver_bic"},
                                                    "NOTPROVIDED"
                                                ]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                                    "NOTPROVIDED"
                                                ]}
                                            ]}
                                        }
                                    }
                                },
                                "BizMsgIdr": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "MsgDefIdr": "pain.001.001.09",
                                "BizSvc": "cbpr.plus.01",
                                "CreDt": { "if": [
                                    {"var": "data.SwiftMT.fields.30.execution_date"},
                                    {"cat": [{"var": "data.SwiftMT.fields.30.execution_date"}, "T12:00:00Z"]},
                                    {
                                        "cat": [
                                            {
                                                "substr": [{"var": "_timestamp"}, 0, 10]
                                            },
                                            "T12:00:00Z"
                                        ]
                                    }
                                ]},
                                "Sgntr": null
                            }
                        },
                        {
                            "path": "temp_data.DebtorAgentProvided",
                            "logic": { "or": [
                                {"var": "data.SwiftMT.fields.52A"},
                                {"var": "data.SwiftMT.fields.52C"}
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}
