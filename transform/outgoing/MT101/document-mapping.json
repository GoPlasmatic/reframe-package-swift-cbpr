{
    "id": "mt101-document-mapper",
    "name": "MT101 to pain.001 Document Mapper",
    "description": "Maps MT101 SWIFT message to ISO 20022 pain.001.001.09 document",
    "type": "workflow",
    "version": "1.0.0",
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "101"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt101-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "construct_business_application_header"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "priority": 4,
    "tasks": [
        {
            "id": "map_group_header",
            "name": "Map Group Header",
            "description": "Maps MT101 header fields to pain.001 GroupHeader",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.GrpHdr.MsgId",
                            "logic": {"var": "data.SwiftMT.fields.20.reference"}
                        },
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.GrpHdr.CreDtTm",
                            "logic": "9999-12-31T00:00:00+00:00"
                        },
                        {"path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.GrpHdr.NbOfTxs", "logic": "1"},
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.GrpHdr.InitgPty",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.50C"},
                                {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50C.bic"}}}},
                                { "if": [
                                    {"var": "data.SwiftMT.fields.50L"},
                                    {"Nm": {"var": "data.SwiftMT.fields.50L.party_identification"}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.50G"},
                                        {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50G.bic"}}}},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.50F"},
                                            {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50F.bic"}}}},
                                            {"Nm": "NOTPROVIDED"}
                                        ]}
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.GrpHdr.Authstn",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.25"},
                                [{"Cd": "AUTH"}],
                                []
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_payment_information",
            "name": "Map Payment Information",
            "description": "Maps MT101 fields to PaymentInformation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.PmtInfId",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.#.0.21"},
                                {"var": "data.SwiftMT.fields.#.0.21.reference"},
                                {"var": "data.SwiftMT.fields.20.reference"}
                            ]}
                        },
                        {"path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.PmtMtd", "logic": "TRF"},
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.ReqdExctnDt",
                            "logic": {"Dt": {"var": "data.SwiftMT.fields.30.execution_date"}}
                        },
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.Dbtr",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.50G"},
                                {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50G.bic"}}}},
                                { "if": [
                                    {"var": "data.SwiftMT.fields.50F"},
                                    {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50F.bic"}}}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.50G"},
                                        {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.#.0.50G.bic"}}}},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.#.0.50F"},
                                            {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.#.0.50F.bic"}}}},
                                            {"Nm": "NOTPROVIDED"}
                                        ]}
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.DbtrAcct",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.50G.account"},
                                {"Id": {"IBAN": {"var": "data.SwiftMT.fields.50G.account"}}},
                                { "if": [
                                    {"var": "data.SwiftMT.fields.50F.account"},
                                    {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.50F.account"}}}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.50G.account"},
                                        {"Id": {"IBAN": {"var": "data.SwiftMT.fields.#.0.50G.account"}}},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.#.0.50F.account"},
                                            {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.#.0.50F.account"}}}},
                                            {"Id": {"Othr": {"Id": "NOTPROVIDED"}}}
                                        ]}
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.DbtrAgt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.52A"},
                                {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.52A.bic"}}},
                                { "if": [
                                    {"var": "data.SwiftMT.fields.52C"},
                                    {
                                        "FinInstnId": { "if": [
                                            {
                                                "substr": [{"var": "data.SwiftMT.fields.52C.party_identifier"}, 0, 2]
                                            },
                                            {
                                                "ClrSysMmbId": {
                                                    "ClrSysId": {
                                                        "Cd": {
                                                            "substr": [{"var": "data.SwiftMT.fields.52C.party_identifier"}, 2, 5]
                                                        }
                                                    },
                                                    "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52C.party_identifier"}, 7]}
                                                }
                                            },
                                            {"Nm": "NOTPROVIDED"}
                                        ]}
                                    },
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.52A"},
                                        {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.#.0.52A.bic"}}},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.#.0.52C"},
                                            {"FinInstnId": {"Nm": "NOTPROVIDED"}},
                                            {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}
                                        ]}
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.InstrForDbtrAgt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.23E"},
                                { "if": [
                                    {
                                        "some": [
                                            {"var": "data.SwiftMT.fields.23E"},
                                            {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "OTHR"]}
                                        ]
                                    },
                                    {
                                        "substr": [
                                            { "reduce": [
                                                {
                                                    "filter": [
                                                        {"var": "data.SwiftMT.fields.23E"},
                                                        {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "OTHR"]}
                                                    ]
                                                },
                                                { "if": [
                                                    {">": [{"length": {"var": "current.instruction_code"}}, 5]},
                                                    { "if": [
                                                        {"==": [{"var": "accumulator"}, ""]},
                                                        {"substr": [{"var": "current.instruction_code"}, 5]},
                                                        { "if": [
                                                            {"<": [{"length": {"substr": [{"var": "accumulator"}, {"*": [{"length": {"var": "accumulator"}}, -1]}, 30]}}, 30]},
                                                            {
                                                                "cat": [{"var": "accumulator"}, " ", {"substr": [{"var": "current.instruction_code"}, 5]}]
                                                            },
                                                            {"cat": [{"var": "accumulator"}, {"substr": [{"var": "current.instruction_code"}, 5]}]}
                                                        ]}
                                                    ]},
                                                    {"var": "accumulator"}
                                                ]},
                                                ""
                                            ]},
                                            0,
                                            140
                                        ]
                                    },
                                    null
                                ]},
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.ChrgsAcct",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.#.0.25A"},
                                {
                                    "Id": { "if": [
                                        {
                                            "substr": [{"var": "data.SwiftMT.fields.#.0.25A.account"}, 0, 1]
                                        },
                                        {"IBAN": {"substr": [{"var": "data.SwiftMT.fields.#.0.25A.account"}, 1]}},
                                        {"Othr": {"Id": {"var": "data.SwiftMT.fields.#.0.25A.account"}}}
                                    ]}
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "process_instruction_codes",
            "name": "Process 23E Instruction Codes",
            "description": "Advanced processing of 23E instruction codes per specification TR004 and code mapping table",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.instruction_processing",
                            "logic": {
                                "chqb_present": {
                                    "some": [
                                        {"var": "data.SwiftMT.fields.#.0.23E"},
                                        {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "CHQB"]}
                                    ]
                                },
                                "instruction_for_creditor_agent": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.23E"},
                                    { "reduce": [
                                        {"var": "data.SwiftMT.fields.#.0.23E"},
                                        { "if": [
                                            {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "CHQB"]},
                                            [{"Cd": "CHQB"}],
                                            { "if": [
                                                {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "PHON"]},
                                                { "if": [
                                                    {">": [{"length": {"var": "current.instruction_code"}}, 4]},
                                                    [{"Cd": "PHOB", "InstrInf": {"substr": [{"var": "current.instruction_code"}, 5]}}],
                                                    [{"Cd": "PHOB"}]
                                                ]},
                                                {"var": "accumulator"}
                                            ]}
                                        ]},
                                        []
                                    ]},
                                    null
                                ]},
                                "payment_type_category": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.23E"},
                                    { "reduce": [
                                        {"var": "data.SwiftMT.fields.#.0.23E"},
                                        { "if": [
                                            {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "CMSW"]},
                                            {"Cd": "SWEP"},
                                            { "if": [
                                                {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "CMTO"]},
                                                {"Cd": "TOPG"},
                                                { "if": [
                                                    {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "CMZB"]},
                                                    {"Cd": "ZABA"},
                                                    { "if": [
                                                        {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "CORT"]},
                                                        {"Cd": "CORT"},
                                                        { "if": [
                                                            {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "INTC"]},
                                                            {"Cd": "INTC"},
                                                            {"var": "accumulator"}
                                                        ]}
                                                    ]}
                                                ]}
                                            ]}
                                        ]},
                                        null
                                    ]},
                                    null
                                ]},
                                "service_level": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.23E"},
                                    { "reduce": [
                                        {"var": "data.SwiftMT.fields.#.0.23E"},
                                        { "if": [
                                            {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "NETS"]},
                                            {"Cd": "NURG"},
                                            { "if": [
                                                { "or": [
                                                    {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "URGP"]},
                                                    {"==": [{"substr": [{"var": "current.instruction_code"}, 0, 4]}, "RTGS"]}
                                                ]},
                                                {"Cd": "URGP"},
                                                {"var": "accumulator"}
                                            ]}
                                        ]},
                                        null
                                    ]},
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_credit_transfer",
            "name": "Map Credit Transfer Transaction",
            "description": "Maps first MT101 transaction to CreditTransferTransactionInformation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.CstmrCdtTrfInitn.PmtInf.CdtTrfTxInf",
                            "logic": {
                                "PmtId": {
                                    "InstrId": {"var": "data.SwiftMT.fields.#.0.21.reference"},
                                    "EndToEndId": { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.70"},
                                        { "if": [
                                            {
                                                "some": [
                                                    {"var": "data.SwiftMT.fields.#.0.70.narrative"},
                                                    {"in": ["/ROC/", {"var": "current"}]}
                                                ]
                                            },
                                            { "reduce": [
                                                {"var": "data.SwiftMT.fields.#.0.70.narrative"},
                                                { "if": [
                                                    {"in": ["/ROC/", {"var": "current"}]},
                                                    {"substr": [{"var": "current"}, 5]},
                                                    {"var": "accumulator"}
                                                ]},
                                                "NOTPROVIDED"
                                            ]},
                                            { "if": [
                                                {
                                                    "some": [
                                                        {"var": "data.SwiftMT.fields.#.0.70.narrative"},
                                                        {"in": ["/RFB/", {"var": "current"}]}
                                                    ]
                                                },
                                                { "reduce": [
                                                    {"var": "data.SwiftMT.fields.#.0.70.narrative"},
                                                    { "if": [
                                                        {"in": ["/RFB/", {"var": "current"}]},
                                                        {"substr": [{"var": "current"}, 5]},
                                                        {"var": "accumulator"}
                                                    ]},
                                                    "NOTPROVIDED"
                                                ]},
                                                "NOTPROVIDED"
                                            ]}
                                        ]},
                                        "NOTPROVIDED"
                                    ]},
                                    "UETR": { "if": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        ""
                                    ]}
                                },
                                "Amt": {
                                    "InstdAmt": { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.33B"},
                                        {
                                            "@Ccy": {"var": "data.SwiftMT.fields.#.0.33B.currency"},
                                            "$value": {"var": "data.SwiftMT.fields.#.0.33B.amount"}
                                        },
                                        {
                                            "@Ccy": {"var": "data.SwiftMT.fields.#.0.32B.currency"},
                                            "$value": {"var": "data.SwiftMT.fields.#.0.32B.amount"}
                                        }
                                    ]},
                                    "EqvtAmt": { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.33B"},
                                        {
                                            "Amt": {
                                                "@Ccy": {"var": "data.SwiftMT.fields.#.0.32B.currency"},
                                                "$value": {"var": "data.SwiftMT.fields.#.0.32B.amount"}
                                            },
                                            "CcyOfTrf": {"var": "data.SwiftMT.fields.#.0.32B.currency"}
                                        },
                                        null
                                    ]}
                                },
                                "XchgRateInf": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.#.0.21F"},
                                        {"var": "data.SwiftMT.fields.#.0.36"}
                                    ]},
                                    {
                                        "CtrctId": { "if": [
                                            {"var": "data.SwiftMT.fields.#.0.21F"},
                                            {"var": "data.SwiftMT.fields.#.0.21F.reference"},
                                            null
                                        ]},
                                        "XchgRate": { "if": [
                                            {"var": "data.SwiftMT.fields.#.0.36"},
                                            {"var": "data.SwiftMT.fields.#.0.36.rate"},
                                            null
                                        ]}
                                    },
                                    null
                                ]},
                                "ChrgBr": { "if": [
                                    {"==": [{"var": "data.SwiftMT.fields.#.0.71A.code"}, "BEN"]},
                                    "CRED",
                                    { "if": [
                                        {"==": [{"var": "data.SwiftMT.fields.#.0.71A.code"}, "OUR"]},
                                        "DEBT",
                                        "SHAR"
                                    ]}
                                ]},
                                "IntrmyAgt1": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.56A"},
                                    {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.#.0.56A.bic"}}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.56D"},
                                        {"FinInstnId": {"Nm": {"var": "data.SwiftMT.fields.#.0.56D.name_and_address.0"}}},
                                        null
                                    ]}
                                ]},
                                "CdtrAgt": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.57A"},
                                    {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.#.0.57A.bic"}}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.57D"},
                                        {"FinInstnId": {"Nm": {"var": "data.SwiftMT.fields.#.0.57D.name_and_address.0"}}},
                                        {"FinInstnId": {"BICFI": "NOTPROVIDED"}}
                                    ]}
                                ]},
                                "Cdtr": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.59A"},
                                    {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.#.0.59A.bic"}}}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.59F"},
                                        {"Nm": {"var": "data.SwiftMT.fields.#.0.59F.name_and_address.0"}},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.#.0.59"},
                                            {"Nm": {"var": "data.SwiftMT.fields.#.0.59.name_and_address.0"}},
                                            {"Nm": "NOTPROVIDED"}
                                        ]}
                                    ]}
                                ]},
                                "CdtrAcct": { "if": [
                                    {"!": {"var": "temp_data.instruction_processing.chqb_present"}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.#.0.59A.account"},
                                        {"Id": {"IBAN": {"var": "data.SwiftMT.fields.#.0.59A.account"}}},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.#.0.59F.account"},
                                            {"Id": {"IBAN": {"var": "data.SwiftMT.fields.#.0.59F.account"}}},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.#.0.59.account"},
                                                {"Id": {"IBAN": {"var": "data.SwiftMT.fields.#.0.59.account"}}},
                                                {"Id": {"Othr": {"Id": "NOTPROVIDED"}}}
                                            ]}
                                        ]}
                                    ]},
                                    null
                                ]},
                                "InstrForCdtrAgt": {"var": "temp_data.instruction_processing.instruction_for_creditor_agent"},
                                "PmtTpInf": { "if": [
                                    { "or": [
                                        {"var": "temp_data.instruction_processing.payment_type_category"},
                                        {"var": "temp_data.instruction_processing.service_level"}
                                    ]},
                                    {
                                        "CtgyPurp": {"var": "temp_data.instruction_processing.payment_type_category"},
                                        "SvcLvl": { "if": [
                                            {"var": "temp_data.instruction_processing.service_level"},
                                            [{"var": "temp_data.instruction_processing.service_level"}],
                                            []
                                        ]}
                                    },
                                    null
                                ]},
                                "RmtInf": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.70"},
                                    {
                                        "Ustrd": { "reduce": [
                                            {"var": "data.SwiftMT.fields.#.0.70.narrative"},
                                            { "if": [
                                                {"==": [{"var": "accumulator"}, ""]},
                                                {"var": "current"},
                                                {
                                                    "cat": [{"var": "accumulator"}, " ", {"var": "current"}]
                                                }
                                            ]},
                                            ""
                                        ]}
                                    },
                                    {}
                                ]},
                                "RgltryRptg": { "if": [
                                    {"var": "data.SwiftMT.fields.#.0.77B"},
                                    [
                                        {
                                            "Dtls": [
                                                {
                                                    "Inf": [
                                                        { "reduce": [
                                                            {"var": "data.SwiftMT.fields.#.0.77B.narrative"},
                                                            { "if": [
                                                                {"==": [{"var": "accumulator"}, ""]},
                                                                {"var": "current"},
                                                                {
                                                                    "cat": [{"var": "accumulator"}, " ", {"var": "current"}]
                                                                }
                                                            ]},
                                                            ""
                                                        ]}
                                                    ]
                                                }
                                            ]
                                        }
                                    ],
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "generate_document_xml",
            "name": "Generate Document XML",
            "description": "Converts the Document to XML",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
