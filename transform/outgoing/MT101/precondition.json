{
    "id": "mt101-precondition",
    "name": "MT101 Precondition Checks for CBPR+",
    "description": "Validates MT101 message before transformation to pain.001 according to CBPR+ translation rules",
    "priority": 2,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "101"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "parser"]},
        {"==": [{"var": "metadata.progress.task_id"}, "parse_mt_message"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_cbpr_requirements",
            "name": "Validate CBPR+ Requirements",
            "description": "Validates CBPR+ specific requirements for MT101",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": {"!!": {"var": "data.SwiftMT"}},
                            "message": "SwiftMT data not available - parsing may have failed"
                        },
                        {
                            "path": "data",
                            "logic": {"!!": {"var": "data.SwiftMT.fields.20"}},
                            "message": "Missing field 20 (Sender's Reference)"
                        },
                        {
                            "path": "data",
                            "logic": {"!!": {"var": "data.SwiftMT.fields.30"}},
                            "message": "Missing field 30 (Execution Date)"
                        },
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"var": "data.SwiftMT.fields.#"},
                                {">": [{"length": {"var": "data.SwiftMT.fields.#"}}, 0]}
                            ]},
                            "message": "Missing transaction blocks"
                        },
                        {
                            "path": "data",
                            "logic": {"==": [{"length": {"var": "data.SwiftMT.fields.#"}}, 1]},
                            "message": "CBPR+ requires exactly one transaction (PREC002 - T20053)"
                        },
                        {
                            "path": "data",
                            "logic": {"!!": {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"}},
                            "message": "Missing UETR (PREC003 - T20087)"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.#.0"},
                                {"!!": {"var": "data.SwiftMT.fields.#.0.21"}},
                                true
                            ]},
                            "message": "Missing required field 21 in transaction"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.#.0"},
                                {"!!": {"var": "data.SwiftMT.fields.#.0.32B"}},
                                true
                            ]},
                            "message": "Missing required field 32B in transaction"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.#.0"},
                                {"!!": {"var": "data.SwiftMT.fields.#.0.59A"}},
                                true
                            ]},
                            "message": "Missing required field 59A in transaction"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.#.0"},
                                {"!!": {"var": "data.SwiftMT.fields.#.0.71A"}},
                                true
                            ]},
                            "message": "Missing required field 71A in transaction"
                        }
                    ]
                }
            }
        }
    ]
}
