{
    "id": "mt202cov-document-mapper",
    "name": "MT202 COV to pacs.009 COVE Document Mapping for CBPR+",
    "description": "Maps MT202 COV message to ISO 20022 pacs.009.001.08 FinancialInstitutionCreditTransferV08 COVE document structure",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "202"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "cover"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt202cov-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_sequence_b_and_cover_structure"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "extract_and_process_field72_tr008",
            "name": "TR008: Extract and Process Field 72 with Priority Logic",
            "description": "Implements TR008 field 72 processing with priority handling for InstructionForNextAgent codes and proper concatenation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field_72_concatenated",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    {">": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 0]}
                                ]},
                                {
                                    "cat": [
                                        { "if": [
                                            {"var": "temp_data.instruction_for_next_agent_fin53"},
                                            {"var": "temp_data.instruction_for_next_agent_fin53"},
                                            ""
                                        ]},
                                        { "if": [
                                            {"var": "temp_data.instruction_for_next_agent_fin54"},
                                            {"var": "temp_data.instruction_for_next_agent_fin54"},
                                            ""
                                        ]},
                                        { "reduce": [
                                            {"var": "data.SwiftMT.fields.72.information"},
                                            { "if": [
                                                { "and": [
                                                    {"!": {"starts_with": [{"var": "current"}, "/INS/"]}},
                                                    { "or": [
                                                        {"starts_with": [{"var": "current"}, "/ACC/"]},
                                                        {"starts_with": [{"var": "current"}, "/UDLC/"]},
                                                        {"starts_with": [{"var": "current"}, "/BNF/"]},
                                                        {"starts_with": [{"var": "current"}, "/TSU/"]},
                                                        {"starts_with": [{"var": "current"}, "/TEXT/"]},
                                                        {"starts_with": [{"var": "current"}, "/PURP/"]}
                                                    ]}
                                                ]},
                                                {"cat": [{"var": "accumulator"}, {"var": "current"}]},
                                                {"var": "accumulator"}
                                            ]},
                                            ""
                                        ]}
                                    ]
                                },
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.instruction_for_next_agent",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_72_concatenated"},
                                    {">": [{"length": {"var": "temp_data.field_72_concatenated"}}, 210]}
                                ]},
                                {
                                    "substr": [{"var": "temp_data.field_72_concatenated"}, 0, 210]
                                },
                                { "if": [
                                    {"var": "temp_data.field_72_concatenated"},
                                    {"var": "temp_data.field_72_concatenated"},
                                    ""
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_group_header",
            "name": "Construct Group Header",
            "description": "Builds pacs.009 group header with message identification, creation timestamp, and settlement information for MT202 COV using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.GrpHdr",
                            "logic": {
                                "MsgId": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "CreDtTm": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"cat": [{"var": "data.SwiftMT.fields.32A.value_date"}, "T00:00:00+00:00"]},
                                    "9999-12-31T00:00:00+00:00"
                                ]},
                                "NbOfTxs": "1",
                                "SttlmInf": {
                                    "SttlmMtd": { "if": [
                                        {"var": "temp_data.settlement_method"},
                                        {"var": "temp_data.settlement_method"},
                                        "INDA"
                                    ]},
                                    "SttlmAcct": { "if": [
                                        { "and": [
                                            {"==": [{"var": "temp_data.settlement_method"}, "INGA"]},
                                            {"var": "temp_data.settlement_account"},
                                            {"!=": [{"var": "temp_data.settlement_account"}, ""]}
                                        ]},
                                        {"Id": {"Othr": {"Id": {"var": "temp_data.settlement_account"}}}},
                                        null
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_credit_transfer_transaction_information",
            "name": "Map Credit Transfer Transaction Information",
            "description": "Maps consolidated credit transfer transaction information including payment identification, settlement amounts, dates, agents, and parties for MT202 COV using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf",
                            "logic": {
                                "PmtId": {
                                    "InstrId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        ""
                                    ]},
                                    "EndToEndId": { "if": [
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        ""
                                    ]},
                                    "UETR": { "if": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        ""
                                    ]}
                                },
                                "IntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]},
                                    "$value": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        0.0
                                    ]}
                                },
                                "IntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    "9999-12-31"
                                ]},
                                "InstgAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}},
                                "InstdAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}},
                                "Dbtr": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "temp_data.Sender"}
                                        ]}
                                    }
                                },
                                "CdtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            ""
                                        ]}
                                    }
                                },
                                "Cdtr": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.58.A.bic"},
                                            {"var": "data.SwiftMT.fields.58.A.bic"},
                                            ""
                                        ]}
                                    }
                                },
                                "PmtTpInf": {
                                    "SvcLvl": { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.user_header.service_type_identifier"},
                                            {"match": [{"var": "data.SwiftMT.user_header.service_type_identifier"}, "^00[1-9]$"]}
                                        ]},
                                        [
                                            {"Cd": {"cat": ["G", {"var": "data.SwiftMT.user_header.service_type_identifier"}]}}
                                        ],
                                        []
                                    ]},
                                    "ClrChanl": { "if": [
                                        { "or": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.56.A.party_identifier"},
                                                { "or": [
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//RT"]},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//FW"]}
                                                ]}
                                            ]},
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.57.A.party_identifier"},
                                                { "or": [
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//RT"]},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//FW"]}
                                                ]}
                                            ]},
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.58.A.party_identifier"},
                                                { "or": [
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//RT"]},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//FW"]}
                                                ]}
                                            ]}
                                        ]},
                                        "RTGS",
                                        null
                                    ]}
                                },
                                "SttlmTmIndctn": {
                                    "DbtDtTm": { "if": [
                                        {"var": "data.SwiftMT.fields.13.C.time_indication"},
                                        { "if": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, "/SNDTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 9, 4]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 13, 2]
                                                    },
                                                    ":00",
                                                    {"substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 15]}
                                                ]
                                            },
                                            ""
                                        ]},
                                        ""
                                    ]},
                                    "CdtDtTm": { "if": [
                                        {"var": "data.SwiftMT.fields.13.C.time_indication"},
                                        { "if": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, "/RNCTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 10, 4]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 14, 2]
                                                    },
                                                    ":00",
                                                    {"substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 16]}
                                                ]
                                            },
                                            ""
                                        ]},
                                        ""
                                    ]},
                                    "ClsTm": { "if": [
                                        {"var": "data.SwiftMT.fields.13.C.time_indication"},
                                        { "if": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, "/CLSTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 9, 4]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 13, 2]
                                                    },
                                                    ":00",
                                                    {"substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 15]}
                                                ]
                                            },
                                            ""
                                        ]},
                                        ""
                                    ]},
                                    "TillTm": { "if": [
                                        {"var": "data.SwiftMT.fields.13.C.time_indication"},
                                        { "if": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, "/TILTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 9, 4]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 13, 2]
                                                    },
                                                    ":00",
                                                    {"substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 15]}
                                                ]
                                            },
                                            ""
                                        ]},
                                        ""
                                    ]},
                                    "FrTm": { "if": [
                                        {"var": "data.SwiftMT.fields.13.C.time_indication"},
                                        { "if": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, "/FROTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 9, 4]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 13, 2]
                                                    },
                                                    ":00",
                                                    {"substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 15]}
                                                ]
                                            },
                                            ""
                                        ]},
                                        ""
                                    ]},
                                    "RjctTm": { "if": [
                                        {"var": "data.SwiftMT.fields.13.C.time_indication"},
                                        { "if": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, "/REJTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 9, 4]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 14, 2]
                                                    },
                                                    ":00",
                                                    {"substr": [{"var": "data.SwiftMT.fields.13.C.time_indication"}, 15]}
                                                ]
                                            },
                                            ""
                                        ]},
                                        ""
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_underlying_customer_credit_transfer",
            "name": "Map Underlying Customer Credit Transfer",
            "description": "Maps complete underlying customer credit transfer information from sequence B fields including debtor, creditor, their agents and accounts using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf",
                            "logic": {
                                "Dbtr": {
                                    "Nm": { "if": [
                                        {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                        {"var": "data.SwiftMT.fields.50K.name_and_address.0"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.50F.name_and_address"},
                                            {"var": "data.SwiftMT.fields.50F.name_and_address.0"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.50A.bic"},
                                                {"var": "data.SwiftMT.fields.50A.bic"},
                                                "NOTPROVIDED"
                                            ]}
                                        ]}
                                    ]},
                                    "Id": { "if": [
                                        {"var": "data.SwiftMT.fields.50A.bic"},
                                        {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50A.bic"}}},
                                        {"OrgId": {"Othr": [{"Id": "NOTPROVIDED", "SchmeNm": {"Cd": "TXID"}}]}}
                                    ]},
                                    "PstlAdr": { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                            {">=": [{"length": {"var": "data.SwiftMT.fields.50K.name_and_address"}}, 2]}
                                        ]},
                                        {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.50K.name_and_address"}, 1]}},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.50F.name_and_address"},
                                                {">=": [{"length": {"var": "data.SwiftMT.fields.50F.name_and_address"}}, 2]}
                                            ]},
                                            {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.50F.name_and_address"}, 1]}},
                                            null
                                        ]}
                                    ]}
                                },
                                "DbtrAcct": {
                                    "Id": {
                                        "Othr": {
                                            "Id": { "if": [
                                                {"var": "data.SwiftMT.fields.50K.account"},
                                                {"var": "data.SwiftMT.fields.50K.account"},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.50F.account"},
                                                    {"var": "data.SwiftMT.fields.50F.account"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.50A.account"},
                                                        {"var": "data.SwiftMT.fields.50A.account"},
                                                        "NOTPROVIDED"
                                                    ]}
                                                ]}
                                            ]}
                                        }
                                    }
                                },
                                "DbtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.52A.bic"},
                                            {"var": "data.SwiftMT.fields.52A.bic"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.52D.bic"},
                                                {"var": "data.SwiftMT.fields.52D.bic"},
                                                {"var": "temp_data.Sender"}
                                            ]}
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.52D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                            ""
                                        ]}
                                    }
                                },
                                "IntrmyAgt1": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.56A"},
                                        {"var": "data.SwiftMT.fields.56D"}
                                    ]},
                                    {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "data.SwiftMT.fields.56A.bic"},
                                                {"var": "data.SwiftMT.fields.56A.bic"},
                                                ""
                                            ]},
                                            "Nm": { "if": [
                                                {"var": "data.SwiftMT.fields.56D.name_and_address"},
                                                {"var": "data.SwiftMT.fields.56D.name_and_address.0"},
                                                ""
                                            ]}
                                        }
                                    },
                                    null
                                ]},
                                "CdtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.57A.bic"},
                                            {"var": "data.SwiftMT.fields.57A.bic"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.57B.bic"},
                                                {"var": "data.SwiftMT.fields.57B.bic"},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.57D.bic"},
                                                    {"var": "data.SwiftMT.fields.57D.bic"},
                                                    {"var": "data.SwiftMT.fields.58A.bic"}
                                                ]}
                                            ]}
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.57D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.57D.name_and_address.0"},
                                            ""
                                        ]}
                                    }
                                },
                                "Cdtr": {
                                    "Nm": { "if": [
                                        {"var": "data.SwiftMT.fields.59.NoOption.name_and_address"},
                                        {"var": "data.SwiftMT.fields.59.NoOption.name_and_address.0"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.59F.name_and_address"},
                                            {"var": "data.SwiftMT.fields.59F.name_and_address.0"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.59A.bic"},
                                                {"var": "data.SwiftMT.fields.59A.bic"},
                                                "NOTPROVIDED"
                                            ]}
                                        ]}
                                    ]},
                                    "Id": { "if": [
                                        {"var": "data.SwiftMT.fields.59A.bic"},
                                        {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.59A.bic"}}},
                                        {"OrgId": {"Othr": [{"Id": "NOTPROVIDED", "SchmeNm": {"Cd": "TXID"}}]}}
                                    ]},
                                    "PstlAdr": { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.59.NoOption.name_and_address"},
                                            {">=": [{"length": {"var": "data.SwiftMT.fields.59.NoOption.name_and_address"}}, 2]}
                                        ]},
                                        {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.59.NoOption.name_and_address"}, 1]}},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.59F.name_and_address"},
                                                {">=": [{"length": {"var": "data.SwiftMT.fields.59F.name_and_address"}}, 2]}
                                            ]},
                                            {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.59F.name_and_address"}, 1]}},
                                            null
                                        ]}
                                    ]}
                                },
                                "CdtrAcct": {
                                    "Id": {
                                        "Othr": {
                                            "Id": { "if": [
                                                {"var": "data.SwiftMT.fields.59.NoOption.account"},
                                                {"var": "data.SwiftMT.fields.59.NoOption.account"},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.59F.account"},
                                                    {"var": "data.SwiftMT.fields.59F.account"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.59A.account"},
                                                        {"var": "data.SwiftMT.fields.59A.account"},
                                                        "NOTPROVIDED"
                                                    ]}
                                                ]}
                                            ]}
                                        }
                                    }
                                },
                                "RmtInf": {
                                    "Ustrd": { "if": [
                                        {"var": "data.SwiftMT.fields.70.narrative"},
                                        {"join": [" ", {"var": "data.SwiftMT.fields.70.narrative"}]},
                                        { "if": [
                                            {"var": "temp_data.has_field_70"},
                                            "NOTPROVIDED",
                                            null
                                        ]}
                                    ]}
                                },
                                "InstrForNxtAgt": { "if": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    {
                                        "map": [
                                            {
                                                "filter": [
                                                    {"var": "data.SwiftMT.fields.72.information"},
                                                    { "and": [
                                                        {"!=": [{"var": ""}, ""]},
                                                        {
                                                            "!": { "or": [
                                                                {"starts_with": [{"var": ""}, "/ACC/"]},
                                                                {"starts_with": [{"var": ""}, "/BNF/"]},
                                                                {"starts_with": [{"var": ""}, "/INS/"]},
                                                                {"starts_with": [{"var": ""}, "/TSU/"]},
                                                                {"starts_with": [{"var": ""}, "/UDLC/"]},
                                                                {"starts_with": [{"var": ""}, "/PHONBEN/"]},
                                                                {"starts_with": [{"var": ""}, "/TELEBEN/"]}
                                                            ]}
                                                        }
                                                    ]}
                                                ]
                                            },
                                            {
                                                "InstrInf": { "if": [
                                                    {">": [{"length": [{"var": ""}]}, 35]},
                                                    {
                                                        "substr": [{"var": ""}, 0, 35]
                                                    },
                                                    {"var": ""}
                                                ]}
                                            }
                                        ]
                                    },
                                    []
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
