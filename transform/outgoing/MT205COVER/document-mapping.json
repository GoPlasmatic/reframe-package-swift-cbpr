{
    "id": "mt205cov-document-mapper",
    "name": "MT205 COV to pacs.009 ADV Document Mapping for CBPR+",
    "description": "Maps MT205 COV message to ISO 20022 pacs.009.001.08 FinancialInstitutionCreditTransferV08 ADV document structure according to CBPR+ MT202-COVE translation specification for Cover payments",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "205"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "cover"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt205cov-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "MT205COV_set_cover_translation"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "extract_sender_receiver",
            "name": "Extract Sender and Receiver BICs",
            "description": "Extracts sender and receiver BIC codes from SwiftMT headers for use throughout the document mapping",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.Sender",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                { "if": [
                                    {"var": "data.SwiftMT.basic_header.sender"},
                                    {"var": "data.SwiftMT.basic_header.sender"},
                                    "NOTPROVIDED"
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.Receiver",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                { "if": [
                                    {"var": "data.SwiftMT.application_header.receiver"},
                                    {"var": "data.SwiftMT.application_header.receiver"},
                                    "NOTPROVIDED"
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "METAFCT003_settlement_method_determination",
            "name": "METAFCT003: Complete Settlement Method for MT205 COV (Tables 1-2 only)",
            "description": "Implements complete METAFCT003 logic for MT205 COV - Tables 1 (53a absent) and Table 2 (53a present) only, no field 54a in MT205",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field_53a_present",
                            "logic": { "or": [
                                {"var": "data.SwiftMT.fields.53.A"},
                                {"var": "data.SwiftMT.fields.53.B"},
                                {"var": "data.SwiftMT.fields.53.D"}
                            ]}
                        },
                        {
                            "path": "temp_data.field_53a_bic",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.53.A.bic"},
                                {"var": "data.SwiftMT.fields.53.A.bic"},
                                { "if": [
                                    {"var": "data.SwiftMT.fields.53.B.bic"},
                                    {"var": "data.SwiftMT.fields.53.B.bic"},
                                    null
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.sender_bic_first8",
                            "logic": {
                                "substr": [{"var": "temp_data.Sender"}, 0, 8]
                            }
                        },
                        {
                            "path": "temp_data.field_53a_bic_first8",
                            "logic": { "if": [
                                {"var": "temp_data.field_53a_bic"},
                                {
                                    "substr": [{"var": "temp_data.field_53a_bic"}, 0, 8]
                                },
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.field_53a_matches_sender",
                            "logic": { "and": [
                                {"var": "temp_data.field_53a_bic"},
                                {"==": [{"var": "temp_data.sender_bic_first8"}, {"var": "temp_data.field_53a_bic_first8"}]}
                            ]}
                        },
                        {
                            "path": "temp_data.field_53b_has_C_prefix",
                            "logic": { "and": [
                                {"var": "data.SwiftMT.fields.53.B"},
                                {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/C"]}
                            ]}
                        },
                        {
                            "path": "temp_data.settlement_method",
                            "logic": { "if": [
                                {"!": {"var": "temp_data.field_53a_present"}},
                                "INDA",
                                { "if": [
                                    {"var": "temp_data.field_53a_matches_sender"},
                                    "INDA",
                                    { "if": [
                                        {"var": "temp_data.field_53b_has_C_prefix"},
                                        "INGA",
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.53.D"},
                                            "INDA",
                                            "INDA"
                                        ]}
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.settlement_account",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_53b_has_C_prefix"},
                                    {"==": [{"var": "temp_data.settlement_method"}, "INGA"]}
                                ]},
                                {"substr": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, 2]},
                                { "if": [
                                    { "and": [
                                        {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                        {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/"]}
                                    ]},
                                    {"substr": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, 1]},
                                    { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.53.A.party_identifier"},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, "/"]}
                                        ]},
                                        {"substr": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, 1]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.53.D.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.53.D.party_identifier"}, "/"]}
                                            ]},
                                            {"substr": [{"var": "data.SwiftMT.fields.53.D.party_identifier"}, 1]},
                                            null
                                        ]}
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.instructing_reimbursement_agent_bic",
                            "logic": { "if": [
                                { "and": [
                                    {"==": [{"var": "temp_data.settlement_method"}, "INGA"]},
                                    {"var": "data.SwiftMT.fields.53.A.bic"}
                                ]},
                                {"var": "data.SwiftMT.fields.53.A.bic"},
                                null
                            ]}
                        },
                        {"path": "temp_data.instructed_reimbursement_agent_bic", "logic": null},
                        {
                            "path": "temp_data.instruction_for_next_agent_fin53",
                            "logic": { "if": [
                                { "and": [
                                    {"==": [{"var": "temp_data.settlement_method"}, "INDA"]},
                                    {"var": "data.SwiftMT.fields.53.D"},
                                    {"var": "data.SwiftMT.fields.53.D.name_and_address"}
                                ]},
                                {"join": [" ", {"var": "data.SwiftMT.fields.53.D.name_and_address"}]},
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_group_header",
            "name": "Construct Group Header",
            "description": "Builds pacs.009 group header with message identification, creation timestamp, settlement information, and reimbursement agent details from MT205 fields and computed settlement method using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.GrpHdr",
                            "logic": {
                                "MsgId": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "CreDtTm": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {
                                        "cat": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            "T",
                                            {"format_date": [{"now": []}, "HH:mm:ss"]},
                                            "+00:00"
                                        ]
                                    },
                                    "9999-12-31T00:00:00+00:00"
                                ]},
                                "NbOfTxs": "1",
                                "TtlIntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]},
                                    "$value": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        0.0
                                    ]}
                                },
                                "IntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    "9999-12-31"
                                ]},
                                "SttlmInf": {
                                    "SttlmMtd": { "if": [
                                        {"var": "temp_data.settlement_method"},
                                        {"var": "temp_data.settlement_method"},
                                        "INDA"
                                    ]},
                                    "SttlmAcct": { "if": [
                                        { "and": [
                                            {"var": "temp_data.settlement_account"},
                                            {"!=": [{"var": "temp_data.settlement_account"}, ""]}
                                        ]},
                                        {"Id": {"Othr": {"Id": {"var": "temp_data.settlement_account"}}}},
                                        null
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_payment_identification",
            "name": "Map Payment Identification",
            "description": "Maps payment identification fields (InstrId, EndToEndId, UETR) from MT205",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.PmtId",
                            "logic": {
                                "InstrId": {"var": "data.SwiftMT.fields.20.reference"},
                                "EndToEndId": {"var": "data.SwiftMT.fields.21.reference"},
                                "UETR": {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_settlement_amount",
            "name": "Map Settlement Amount",
            "description": "Maps interbank settlement amount from field 32A",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt",
                            "logic": {
                                "@Ccy": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    "USD"
                                ]},
                                "$value": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                    0.0
                                ]}
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmDt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                "9999-12-31"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_instructing_instructed_agents",
            "name": "Map Instructing and Instructed Agents",
            "description": "Maps instructing and instructed agents from message sender/receiver",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstgAgt",
                            "logic": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstdAgt",
                            "logic": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_debtor_info",
            "name": "Map Debtor Information",
            "description": "Maps debtor and debtor account from field 52A",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.Dbtr",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.52.A.bic"},
                                        {"var": "data.SwiftMT.fields.52.A.bic"},
                                        {"var": "temp_data.Sender"}
                                    ]}
                                }
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.DbtrAcct",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.52.A.party_identifier"},
                                {
                                    "Id": {
                                        "Othr": {
                                            "Id": { "if": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//CH"]},
                                                {"substr": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, 4]},
                                                {"var": "data.SwiftMT.fields.52.A.party_identifier"}
                                            ]}
                                        }
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_intermediary_agent",
            "name": "Map Intermediary Agent",
            "description": "Maps intermediary agent from field 56",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.IntrmyAgt1",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.56.A"},
                                    {"var": "data.SwiftMT.fields.56.D"}
                                ]},
                                {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.56.A.bic"},
                                            {"var": "data.SwiftMT.fields.56.A.bic"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.56.D.bic"},
                                                {"var": "data.SwiftMT.fields.56.D.bic"},
                                                null
                                            ]}
                                        ]},
                                        "Nm": { "if": [
                                            { "and": [
                                                {"!": {"var": "data.SwiftMT.fields.56.A.bic"}},
                                                {"var": "data.SwiftMT.fields.56.D.name_and_address"},
                                                {">": [{"length": {"var": "data.SwiftMT.fields.56.D.name_and_address"}}, 0]}
                                            ]},
                                            {"var": "data.SwiftMT.fields.56.D.name_and_address.0"},
                                            null
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "and": [
                                                {"!": {"var": "data.SwiftMT.fields.56.A.bic"}},
                                                {"var": "data.SwiftMT.fields.56.D.name_and_address"},
                                                {">": [{"length": {"var": "data.SwiftMT.fields.56.D.name_and_address"}}, 1]}
                                            ]},
                                            {
                                                "AdrLine": {
                                                    "slice": [
                                                        {"var": "data.SwiftMT.fields.56.D.name_and_address"},
                                                        1,
                                                        {"min": [{"length": {"var": "data.SwiftMT.fields.56.D.name_and_address"}}, 8]}
                                                    ]
                                                }
                                            },
                                            null
                                        ]}
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_creditor_agent",
            "name": "Map Creditor Agent",
            "description": "Maps creditor agent from field 57",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.57.A.bic"},
                                        {"var": "data.SwiftMT.fields.57.A.bic"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.57.B.bic"},
                                            {"var": "data.SwiftMT.fields.57.B.bic"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.57.D.bic"},
                                                {"var": "data.SwiftMT.fields.57.D.bic"},
                                                {"var": "temp_data.Receiver"}
                                            ]}
                                        ]}
                                    ]},
                                    "Nm": { "if": [
                                        { "and": [
                                            {"!": {"var": "data.SwiftMT.fields.57.A.bic"}},
                                            {"var": "data.SwiftMT.fields.57.B.name_and_address"},
                                            {">": [{"length": {"var": "data.SwiftMT.fields.57.B.name_and_address"}}, 0]}
                                        ]},
                                        {"var": "data.SwiftMT.fields.57.B.name_and_address.0"},
                                        { "if": [
                                            { "and": [
                                                {"!": {"var": "data.SwiftMT.fields.57.A.bic"}},
                                                {"!": {"var": "data.SwiftMT.fields.57.B.bic"}},
                                                {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                                {">": [{"length": {"var": "data.SwiftMT.fields.57.D.name_and_address"}}, 0]}
                                            ]},
                                            {"var": "data.SwiftMT.fields.57.D.name_and_address.0"},
                                            null
                                        ]}
                                    ]},
                                    "PstlAdr": { "if": [
                                        { "and": [
                                            {"!": {"var": "data.SwiftMT.fields.57.A.bic"}},
                                            {"var": "data.SwiftMT.fields.57.B"},
                                            {"var": "data.SwiftMT.fields.57.B.location"},
                                            {"var": "data.SwiftMT.fields.57.B.name_and_address"},
                                            {">": [{"length": {"var": "data.SwiftMT.fields.57.B.name_and_address"}}, 1]}
                                        ]},
                                        {
                                            "AdrLine": {
                                                "cat": [
                                                    {
                                                        "slice": [
                                                            {"var": "data.SwiftMT.fields.57.B.name_and_address"},
                                                            1,
                                                            {"min": [{"length": {"var": "data.SwiftMT.fields.57.B.name_and_address"}}, 5]}
                                                        ]
                                                    },
                                                    [{"var": "data.SwiftMT.fields.57.B.location"}]
                                                ]
                                            }
                                        },
                                        { "if": [
                                            { "and": [
                                                {"!": {"var": "data.SwiftMT.fields.57.A.bic"}},
                                                {"!": {"var": "data.SwiftMT.fields.57.B"}},
                                                {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                                {">": [{"length": {"var": "data.SwiftMT.fields.57.D.name_and_address"}}, 1]}
                                            ]},
                                            {
                                                "AdrLine": {
                                                    "slice": [
                                                        {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                                        1,
                                                        {"min": [{"length": {"var": "data.SwiftMT.fields.57.D.name_and_address"}}, 8]}
                                                    ]
                                                }
                                            },
                                            null
                                        ]}
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_creditor_info",
            "name": "Map Creditor Information",
            "description": "Maps creditor from field 58",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.Cdtr",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.58.A.bic"},
                                        {"var": "data.SwiftMT.fields.58.A.bic"},
                                        {"var": "temp_data.Receiver"}
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_payment_type_info",
            "name": "Map Payment Type Information",
            "description": "Maps service level, local instrument, category purpose, and clearing channel",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.PmtTpInf",
                            "logic": {
                                "SvcLvl": [
                                    {"Cd": {"cat": ["G", {"var": "data.SwiftMT.user_header.service_type_identifier"}]}}
                                ],
                                "LclInstrm": { "if": [
                                    {
                                        "some": [
                                            {"var": "data.SwiftMT.fields.72.information"},
                                            {"starts_with": [{"var": ""}, "/LOCINS/"]}
                                        ]
                                    },
                                    {
                                        "map": [
                                            {
                                                "filter": [
                                                    {"var": "data.SwiftMT.fields.72.information"},
                                                    {"starts_with": [{"var": ""}, "/LOCINS/"]}
                                                ]
                                            },
                                            {
                                                "Cd": {
                                                    "substr": [{"var": ""}, 8, 4]
                                                }
                                            }
                                        ]
                                    },
                                    null
                                ]},
                                "CtgyPurp": { "if": [
                                    {
                                        "some": [
                                            {"var": "data.SwiftMT.fields.72.information"},
                                            {"starts_with": [{"var": ""}, "/CATPURP/"]}
                                        ]
                                    },
                                    {
                                        "map": [
                                            {
                                                "filter": [
                                                    {"var": "data.SwiftMT.fields.72.information"},
                                                    {"starts_with": [{"var": ""}, "/CATPURP/"]}
                                                ]
                                            },
                                            {
                                                "Cd": {
                                                    "substr": [{"var": ""}, 9, 4]
                                                }
                                            }
                                        ]
                                    },
                                    null
                                ]},
                                "ClrChanl": { "if": [
                                    { "or": [
                                        {
                                            "some": [
                                                [
                                                    {"var": "data.SwiftMT.fields.52.A.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.52.D.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.56.A.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.56.D.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.57.A.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.57.B.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.57.D.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.58.A.party_identifier"},
                                                    {"var": "data.SwiftMT.fields.58.D.party_identifier"}
                                                ],
                                                { "and": [
                                                    {"var": ""},
                                                    {
                                                        "in": [
                                                            {
                                                                "substr": [{"var": ""}, 0, 4]
                                                            },
                                                            ["//RT", "//FW"]
                                                        ]
                                                    }
                                                ]}
                                            ]
                                        }
                                    ]},
                                    "RTGS",
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_settlement_time_indication",
            "name": "Map Settlement Time Indication",
            "description": "Maps settlement time indication from field 13C",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.SttlmTmIndctn",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.13C.time_indication"},
                                {
                                    "DbtDtTm": { "if": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.13C.time_indication"}, "/SNDTIME/"]},
                                        {
                                            "cat": [
                                                "0001-01-01T",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 9, 2]
                                                },
                                                ":",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 11, 2]
                                                },
                                                ":00",
                                                {"substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 13]}
                                            ]
                                        },
                                        null
                                    ]},
                                    "CdtDtTm": { "if": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.13C.time_indication"}, "/RNCTIME/"]},
                                        {
                                            "cat": [
                                                "0001-01-01T",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 9, 2]
                                                },
                                                ":",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 11, 2]
                                                },
                                                ":00",
                                                {"substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 13]}
                                            ]
                                        },
                                        null
                                    ]},
                                    "ClsTm": { "if": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.13C.time_indication"}, "/CLSTIME/"]},
                                        {
                                            "cat": [
                                                "0001-01-01T",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 9, 2]
                                                },
                                                ":",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 11, 2]
                                                },
                                                ":00",
                                                {"substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 13]}
                                            ]
                                        },
                                        null
                                    ]},
                                    "TillTm": { "if": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.13C.time_indication"}, "/TILTIME/"]},
                                        {
                                            "cat": [
                                                "0001-01-01T",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 9, 2]
                                                },
                                                ":",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 11, 2]
                                                },
                                                ":00",
                                                {"substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 13]}
                                            ]
                                        },
                                        null
                                    ]},
                                    "FrmTm": { "if": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.13C.time_indication"}, "/FROTIME/"]},
                                        {
                                            "cat": [
                                                "0001-01-01T",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 9, 2]
                                                },
                                                ":",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 11, 2]
                                                },
                                                ":00",
                                                {"substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 13]}
                                            ]
                                        },
                                        null
                                    ]},
                                    "RjctTm": { "if": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.13C.time_indication"}, "/REJTIME/"]},
                                        {
                                            "cat": [
                                                "0001-01-01T",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 9, 2]
                                                },
                                                ":",
                                                {
                                                    "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 11, 2]
                                                },
                                                ":00",
                                                {"substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 13]}
                                            ]
                                        },
                                        null
                                    ]}
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_instructions",
            "name": "Map Instructions",
            "description": "Maps instructions for next agent and creditor agent from field 72",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstrForNxtAgt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {
                                    "map": [
                                        {
                                            "filter": [
                                                {"var": "data.SwiftMT.fields.72.information"},
                                                { "and": [
                                                    {"!=": [{"var": ""}, ""]},
                                                    {
                                                        "!": { "or": [
                                                            {"starts_with": [{"var": ""}, "/ACC/"]},
                                                            {"starts_with": [{"var": ""}, "/BNF/"]},
                                                            {"starts_with": [{"var": ""}, "/TSU/"]},
                                                            {"starts_with": [{"var": ""}, "/UDLC/"]},
                                                            {"starts_with": [{"var": ""}, "/PHONBEN/"]},
                                                            {"starts_with": [{"var": ""}, "/TELEBEN/"]},
                                                            {"starts_with": [{"var": ""}, "/LOCINS/"]},
                                                            {"starts_with": [{"var": ""}, "/CATPURP/"]},
                                                            {"starts_with": [{"var": ""}, "/PURP/"]}
                                                        ]}
                                                    }
                                                ]}
                                            ]
                                        },
                                        {
                                            "InstrInf": { "if": [
                                                {">=": [{"length": {"var": ""}}, 35]},
                                                {
                                                    "substr": [{"var": ""}, 0, 35]
                                                },
                                                {"var": ""}
                                            ]}
                                        }
                                    ]
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstrForCdtrAgt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {
                                    "map": [
                                        {
                                            "filter": [
                                                {"var": "data.SwiftMT.fields.72.information"},
                                                { "or": [
                                                    {"starts_with": [{"var": ""}, "/ACC/"]},
                                                    {"starts_with": [{"var": ""}, "/UDLC/"]},
                                                    {"starts_with": [{"var": ""}, "/PHONBEN/"]},
                                                    {"starts_with": [{"var": ""}, "/TELEBEN/"]}
                                                ]}
                                            ]
                                        },
                                        {
                                            "InstrInf": { "if": [
                                                {"starts_with": [{"var": ""}, "/ACC/"]},
                                                {
                                                    "substr": [{"var": ""}, 5, 35]
                                                },
                                                { "if": [
                                                    {"starts_with": [{"var": ""}, "/UDLC/"]},
                                                    {
                                                        "substr": [{"var": ""}, 6, 35]
                                                    },
                                                    { "if": [
                                                        {"starts_with": [{"var": ""}, "/PHONBEN/"]},
                                                        {
                                                            "substr": [{"var": ""}, 9, 35]
                                                        },
                                                        { "if": [
                                                            {"starts_with": [{"var": ""}, "/TELEBEN/"]},
                                                            {
                                                                "substr": [{"var": ""}, 9, 35]
                                                            },
                                                            {"var": ""}
                                                        ]}
                                                    ]}
                                                ]}
                                            ]},
                                            "Cd": { "if": [
                                                {"starts_with": [{"var": ""}, "/PHONBEN/"]},
                                                "PHOB",
                                                { "if": [
                                                    {"starts_with": [{"var": ""}, "/TELEBEN/"]},
                                                    "TELB",
                                                    null
                                                ]}
                                            ]}
                                        }
                                    ]
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_remittance_and_purpose",
            "name": "Map Remittance Information and Purpose",
            "description": "Maps remittance information and purpose from field 72",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.RmtInf",
                            "logic": { "if": [
                                {
                                    "some": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        { "or": [
                                            {"starts_with": [{"var": ""}, "/BNF/"]},
                                            {"starts_with": [{"var": ""}, "/TSU/"]}
                                        ]}
                                    ]
                                },
                                {
                                    "Ustrd": { "reduce": [
                                        {
                                            "filter": [
                                                {"var": "data.SwiftMT.fields.72.information"},
                                                { "or": [
                                                    {"starts_with": [{"var": ""}, "/BNF/"]},
                                                    {"starts_with": [{"var": ""}, "/TSU/"]}
                                                ]}
                                            ]
                                        },
                                        {
                                            "cat": [
                                                {"var": "accumulator"},
                                                { "if": [
                                                    {"var": "accumulator"},
                                                    " ",
                                                    ""
                                                ]},
                                                { "if": [
                                                    {"starts_with": [{"var": "current"}, "/BNF/"]},
                                                    {
                                                        "substr": [{"var": "current"}, 5, 35]
                                                    },
                                                    { "if": [
                                                        {"starts_with": [{"var": "current"}, "/TSU/"]},
                                                        {
                                                            "substr": [{"var": "current"}, 5, 35]
                                                        },
                                                        {"var": "current"}
                                                    ]}
                                                ]}
                                            ]
                                        },
                                        ""
                                    ]}
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.Purp",
                            "logic": { "if": [
                                {
                                    "some": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"starts_with": [{"var": ""}, "/PURP/"]}
                                    ]
                                },
                                {
                                    "map": [
                                        {
                                            "filter": [
                                                {"var": "data.SwiftMT.fields.72.information"},
                                                {"starts_with": [{"var": ""}, "/PURP/"]}
                                            ]
                                        },
                                        { "if": [
                                            {">=": [{"length": {"var": ""}}, 10]},
                                            {
                                                "Cd": {
                                                    "substr": [{"var": ""}, 6, 4]
                                                }
                                            },
                                            null
                                        ]}
                                    ]
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_reimbursement_agents",
            "name": "Map Reimbursement Agents for Serial Payments",
            "description": "Maps reimbursement agents from fields 53B, 54B, 55B for serial cover payments",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstgRmbrsmntAgt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.53B"},
                                {
                                    "FinInstnId": {
                                        "Othr": {
                                            "Id": { "if": [
                                                {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                                {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                                "NOTPROVIDED"
                                            ]}
                                        },
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.53B.location"},
                                            {"var": "data.SwiftMT.fields.53B.location"},
                                            null
                                        ]}
                                    }
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstdRmbrsmntAgt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.54B"},
                                {
                                    "FinInstnId": {
                                        "Othr": {
                                            "Id": { "if": [
                                                {"var": "data.SwiftMT.fields.54B.party_identifier"},
                                                {"var": "data.SwiftMT.fields.54B.party_identifier"},
                                                "NOTPROVIDED"
                                            ]}
                                        },
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.54B.location"},
                                            {"var": "data.SwiftMT.fields.54B.location"},
                                            null
                                        ]}
                                    }
                                },
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.ThrdRmbrsmntAgt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.55B"},
                                {
                                    "FinInstnId": {
                                        "Othr": {
                                            "Id": { "if": [
                                                {"var": "data.SwiftMT.fields.55B.party_identifier"},
                                                {"var": "data.SwiftMT.fields.55B.party_identifier"},
                                                "NOTPROVIDED"
                                            ]}
                                        },
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.55B.location"},
                                            {"var": "data.SwiftMT.fields.55B.location"},
                                            null
                                        ]}
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_previous_instructing_agents",
            "name": "Map Previous Instructing Agents",
            "description": "Maps previous instructing agents if present",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.PrvsInstgAgt1",
                            "logic": { "if": [
                                {"var": "temp_data.previous_instructing_agent_1"},
                                {"FinInstnId": {"BICFI": {"var": "temp_data.previous_instructing_agent_1"}}},
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.PrvsInstgAgt2",
                            "logic": { "if": [
                                {"var": "temp_data.previous_instructing_agent_2"},
                                {"FinInstnId": {"BICFI": {"var": "temp_data.previous_instructing_agent_2"}}},
                                null
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.PrvsInstgAgt3",
                            "logic": { "if": [
                                {"var": "temp_data.previous_instructing_agent_3"},
                                {"FinInstnId": {"BICFI": {"var": "temp_data.previous_instructing_agent_3"}}},
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_underlying_customer_credit_transfer",
            "name": "Map Underlying Customer Credit Transfer",
            "description": "Maps underlying customer credit transfer information for MT205 COV",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.UndrlygCstmrCdtTrf",
                            "logic": {
                                "Dbtr": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.50A"},
                                        {"var": "data.SwiftMT.fields.50F"},
                                        {"var": "data.SwiftMT.fields.50K"}
                                    ]},
                                    {
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.50K.name_and_address.0"},
                                            {"var": "data.SwiftMT.fields.50K.name_and_address.0"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.50F.name_and_address.0"},
                                                {"var": "data.SwiftMT.fields.50F.name_and_address.0"},
                                                "ORDERING CUSTOMER"
                                            ]}
                                        ]},
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.50A.bic"},
                                            {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50A.bic"}}},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.50K.account"},
                                                {"OrgId": {"Othr": [{"Id": {"var": "data.SwiftMT.fields.50K.account"}, "SchmeNm": {"Cd": "TXID"}}]}},
                                                null
                                            ]}
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                                {"var": "data.SwiftMT.fields.50F.name_and_address"}
                                            ]},
                                            {
                                                "AdrLine": { "if": [
                                                    {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                                    {"slice": [{"var": "data.SwiftMT.fields.50K.name_and_address"}, 1, 7]},
                                                    {"slice": [{"var": "data.SwiftMT.fields.50F.name_and_address"}, 1, 7]}
                                                ]}
                                            },
                                            null
                                        ]}
                                    },
                                    {"Id": {"OrgId": {"Othr": [{"Id": "NOTPROVIDED", "SchmeNm": {"Cd": "TXID"}}]}}}
                                ]},
                                "DbtrAcct": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.50K.account"},
                                        {"var": "data.SwiftMT.fields.50F.account"},
                                        {"var": "data.SwiftMT.fields.50A.account"}
                                    ]},
                                    {
                                        "Id": {
                                            "Othr": {
                                                "Id": { "if": [
                                                    {"var": "data.SwiftMT.fields.50K.account"},
                                                    {"var": "data.SwiftMT.fields.50K.account"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.50F.account"},
                                                        {"var": "data.SwiftMT.fields.50F.account"},
                                                        {"var": "data.SwiftMT.fields.50A.account"}
                                                    ]}
                                                ]}
                                            }
                                        }
                                    },
                                    {"Id": {"Othr": {"Id": "NOTPROVIDED"}}}
                                ]},
                                "DbtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "temp_data.Sender"}
                                        ]}
                                    }
                                },
                                "CdtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.58.A.bic"},
                                                {"var": "data.SwiftMT.fields.58.A.bic"},
                                                {"var": "temp_data.Receiver"}
                                            ]}
                                        ]}
                                    }
                                },
                                "Cdtr": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.59"},
                                        {"var": "data.SwiftMT.fields.59A"},
                                        {"var": "data.SwiftMT.fields.59F"}
                                    ]},
                                    {
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.59.name_and_address.0"},
                                            {"var": "data.SwiftMT.fields.59.name_and_address.0"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.59F.name_and_address.0"},
                                                {"var": "data.SwiftMT.fields.59F.name_and_address.0"},
                                                "BENEFICIARY CUSTOMER"
                                            ]}
                                        ]},
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.59A.bic"},
                                            {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.59A.bic"}}},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.59.account"},
                                                {"OrgId": {"Othr": [{"Id": {"var": "data.SwiftMT.fields.59.account"}, "SchmeNm": {"Cd": "TXID"}}]}},
                                                null
                                            ]}
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.59.name_and_address"},
                                                {"var": "data.SwiftMT.fields.59F.name_and_address"}
                                            ]},
                                            {
                                                "AdrLine": { "if": [
                                                    {"var": "data.SwiftMT.fields.59.name_and_address"},
                                                    {"slice": [{"var": "data.SwiftMT.fields.59.name_and_address"}, 1, 7]},
                                                    {"slice": [{"var": "data.SwiftMT.fields.59F.name_and_address"}, 1, 7]}
                                                ]}
                                            },
                                            null
                                        ]}
                                    },
                                    {"Id": {"OrgId": {"Othr": [{"Id": "NOTPROVIDED", "SchmeNm": {"Cd": "TXID"}}]}}}
                                ]},
                                "CdtrAcct": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.59.account"},
                                        {"var": "data.SwiftMT.fields.59F.account"},
                                        {"var": "data.SwiftMT.fields.59A.account"}
                                    ]},
                                    {
                                        "Id": {
                                            "Othr": {
                                                "Id": { "if": [
                                                    {"var": "data.SwiftMT.fields.59.account"},
                                                    {"var": "data.SwiftMT.fields.59.account"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.59F.account"},
                                                        {"var": "data.SwiftMT.fields.59F.account"},
                                                        {"var": "data.SwiftMT.fields.59A.account"}
                                                    ]}
                                                ]}
                                            }
                                        }
                                    },
                                    {"Id": {"Othr": {"Id": "NOTPROVIDED"}}}
                                ]},
                                "IntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]},
                                    "$value": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        0.0
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
