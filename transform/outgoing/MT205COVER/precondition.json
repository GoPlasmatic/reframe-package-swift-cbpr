{
    "id": "mt205cov-precondition",
    "name": "MT205 COV Message Precondition",
    "description": "Precondition checks for MT205 COV message for cover payment scenarios according to MT202-COVE specification",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "205"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "cover"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt205cov-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_related_message_metadata"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "PREC001_validate_temp_variables",
            "name": "PREC001: Validate Temp Variables from TR001",
            "description": "Ensure Temp~Sender and Temp~Receiver are properly defined from BAH translation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "and": [
                                {"var": "temp_data.Sender"},
                                {"var": "temp_data.Receiver"},
                                {"!=": [{"var": "temp_data.Sender"}, "NOTPROVIDED"]},
                                {"!=": [{"var": "temp_data.Receiver"}, "NOTPROVIDED"]}
                            ]},
                            "message": "T20001: Translation stopped: TempSender or TempReceiver is not properly provided from TR001"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC002_rejection_return_check",
            "name": "PREC002: Check for Rejection/Return in Field 72",
            "description": "IF Field 72, Line[1] starts with '/REJT/' OR '/RETN/' THEN T20063 STOP Translation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {
                                    "!": { "or": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/REJT/"]},
                                        {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/RETN/"]}
                                    ]}
                                },
                                true
                            ]},
                            "message": "T20063: Translation stopped: Rejection or Return message detected in Field 72"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC003_validate_mandatory_field_52a",
            "name": "PREC003: Validate Mandatory Field 52a for MT205 COV",
            "description": "Field 52a is mandatory in MT205 COV - enforce strict validation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "or": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.52A.bic"},
                                    {"!=": [{"var": "data.SwiftMT.fields.52A.bic"}, ""]}
                                ]},
                                { "and": [
                                    {"var": "data.SwiftMT.fields.52B"},
                                    {"var": "data.SwiftMT.fields.52B.bic"}
                                ]},
                                { "and": [
                                    {"var": "data.SwiftMT.fields.52D.name_and_address"},
                                    {">=": [{"length": {"var": "data.SwiftMT.fields.52D.name_and_address"}}, 1]}
                                ]}
                            ]},
                            "message": "T20068: Field 52a (Ordering Institution) is mandatory in MT205 COV"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC004_validate_mandatory_fields",
            "name": "PREC004: Validate Other Mandatory MT205 COV Fields",
            "description": "Ensure other mandatory fields for MT205 COV are present and valid",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"exists": ["data", "SwiftMT", "fields", "20", "reference"]},
                                {"exists": ["data", "SwiftMT", "fields", "21", "reference"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "value_date"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "currency"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "amount"]},
                                { "or": [
                                    {"exists": ["data", "SwiftMT", "fields", "58A"]},
                                    {"exists": ["data", "SwiftMT", "fields", "58D"]}
                                ]},
                                {"!=": [{"var": "data.SwiftMT.fields.20.reference"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.21.reference"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.32A.currency"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.32A.value_date"}, ""]},
                                {">=": [{"var": "data.SwiftMT.fields.32A.amount"}, 0]}
                            ]},
                            "message": "T20069: Mandatory MT205 COV fields (20, 21, 32A, 58A/D) are missing or invalid"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC005_extract_field_72_codes",
            "name": "PREC005: Extract Field 72 Codes for Processing",
            "description": "Extract and process field 72 codes for later use in mapping (no field 54a codes for MT205)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field_72_has_ins",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {
                                    "some": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"starts_with": [{"var": ""}, "/INS/"]}
                                    ]
                                },
                                false
                            ]}
                        },
                        {
                            "path": "temp_data.field_72_has_phon",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                { "or": [
                                    {
                                        "some": [
                                            {"var": "data.SwiftMT.fields.72.information"},
                                            {"starts_with": [{"var": ""}, "/PHONBEN/"]}
                                        ]
                                    },
                                    {
                                        "some": [
                                            {"var": "data.SwiftMT.fields.72.information"},
                                            {"starts_with": [{"var": ""}, "/TELEBEN/"]}
                                        ]
                                    }
                                ]},
                                false
                            ]}
                        },
                        {
                            "path": "temp_data.warning_T20200",
                            "logic": { "if": [
                                {"var": "temp_data.field_72_has_phon"},
                                "T20200: Field 72 contains phone/telephone beneficiary information",
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC006_validate_sequence_b",
            "name": "PREC006: Validate Sequence B (Underlying Customer Credit Transfer)",
            "description": "Validate sequence B fields for underlying customer information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.has_sequence_b",
                            "logic": { "or": [
                                {"exists": ["data", "SwiftMT", "fields", "50A"]},
                                {"exists": ["data", "SwiftMT", "fields", "50F"]},
                                {"exists": ["data", "SwiftMT", "fields", "50K"]},
                                {"exists": ["data", "SwiftMT", "fields", "59"]},
                                {"exists": ["data", "SwiftMT", "fields", "59A"]},
                                {"exists": ["data", "SwiftMT", "fields", "59F"]}
                            ]}
                        },
                        {
                            "path": "temp_data.has_reimbursement_agents",
                            "logic": { "or": [
                                {"exists": ["data", "SwiftMT", "fields", "53B"]},
                                {"exists": ["data", "SwiftMT", "fields", "54B"]},
                                {"exists": ["data", "SwiftMT", "fields", "55B"]}
                            ]}
                        },
                        {
                            "path": "temp_data.serial_payment_type",
                            "logic": { "if": [
                                {"var": "temp_data.has_reimbursement_agents"},
                                "SERIAL",
                                "DIRECT"
                            ]}
                        },
                        {
                            "path": "temp_data.amount_value",
                            "logic": {"var": "data.SwiftMT.fields.32A.amount"}
                        },
                        {
                            "path": "temp_data.value_date",
                            "logic": {"var": "data.SwiftMT.fields.32A.value_date"}
                        },
                        {"path": "temp_data.currency", "logic": {"var": "data.SwiftMT.fields.32A.currency"}}
                    ]
                }
            }
        },
        {
            "id": "MT205COV_set_cover_translation",
            "name": "MT205 COV: Set to ADV Cover Translation",
            "description": "MT205 COV translates to pacs.009 ADV (cover payment) - implements METAFCT003 for cover scenarios",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {"path": "temp_data.payment_scenario", "logic": "MT205_COV_ALWAYS_COVER"},
                        {"path": "temp_data.MTType", "logic": "COVER"},
                        {"path": "temp_data.translation_target", "logic": "pacs.009.ADV"},
                        {
                            "path": "warnings",
                            "logic": { "if": [
                                {"var": "temp_data.has_sequence_b"},
                                [
                                    {
                                        "code": "T20237",
                                        "message": "Sequence B (Underlying Customer Credit Transfer) detected. Ensure proper mapping of customer fields.",
                                        "severity": "WARNING",
                                        "field": "50/59"
                                    }
                                ],
                                []
                            ]}
                        },
                        {
                            "path": "warnings",
                            "logic": { "if": [
                                {"var": "temp_data.has_reimbursement_agents"},
                                [
                                    {
                                        "code": "T20238",
                                        "message": "Serial payment with reimbursement agents detected. Ensure proper mapping of fields 53B, 54B, 55B",
                                        "severity": "WARNING",
                                        "field": "53B/54B/55B"
                                    }
                                ],
                                []
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}
