{
    "id": "mt296-precondition",
    "name": "MT296 Message Precondition",
    "description": "Precondition checks for MT296 answer to cancellation request message with TR002, TR003, TR004 implementation",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "296"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt296-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "construct_business_application_header"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_mandatory_fields",
            "name": "Validate Mandatory Fields and Status Codes",
            "description": "Check UETR presence, Field 76 status codes, and temp variables",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.prec001_uetr_check",
                            "logic": { "or": [
                                {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                { "and": [
                                    {"var": "data.SwiftMT.fields.77A.information"},
                                    {"some": [{"var": "data.SwiftMT.fields.77A.information"}, {"in": ["/UETR/", {"var": ""}]}]}
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_all_preconditions",
            "name": "Validate All Preconditions",
            "description": "Validate Field 76 status codes and temp variables",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "logic": { "and": [
                                {"exists": ["data", "SwiftMT", "fields", "76", "information"]},
                                {">": [{"length": {"var": "data.SwiftMT.fields.76.information"}}, 0]},
                                { "or": [
                                    {"starts_with": [{"var": "data.SwiftMT.fields.76.information.0"}, "/CNCL/"]},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.76.information.0"}, "/PDCR/"]},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.76.information.0"}, "/RJCR/"]}
                                ]}
                            ]},
                            "message": "T20093: Field 76 first line must start with /CNCL/, /PDCR/, or /RJCR/"
                        },
                        {
                            "logic": { "and": [
                                {"var": "temp_data.Sender"},
                                {"var": "temp_data.Receiver"},
                                {"!=": [{"var": "temp_data.Sender"}, "NOTPROVIDED"]},
                                {"!=": [{"var": "temp_data.Receiver"}, "NOTPROVIDED"]}
                            ]},
                            "message": "Translation stopped: TempSender or TempReceiver is not properly provided from TR002"
                        }
                    ]
                }
            }
        },
        {
            "id": "extract_field_11S_and_map_message_type",
            "name": "Extract Field 11S and Map Message Type",
            "description": "Extract MT type and date from Field 11S/11R and map to MX equivalent",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field11s_mt_type",
                            "logic": { "if": [
                                {"exists": ["data", "SwiftMT", "fields", "11", "S", "message_type"]},
                                {"var": "data.SwiftMT.fields.11.S.message_type"},
                                { "if": [
                                    {"exists": ["data", "SwiftMT", "fields", "11", "R", "message_type"]},
                                    {"var": "data.SwiftMT.fields.11.R.message_type"},
                                    ""
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.field11s_date",
                            "logic": { "if": [
                                {"exists": ["data", "SwiftMT", "fields", "11", "S", "date"]},
                                {"var": "data.SwiftMT.fields.11.S.date"},
                                { "if": [
                                    {"exists": ["data", "SwiftMT", "fields", "11", "R", "date"]},
                                    {"var": "data.SwiftMT.fields.11.R.date"},
                                    ""
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.original_message_type",
                            "logic": { "if": [
                                {"var": "temp_data.field11s_mt_type"},
                                { "if": [
                                    {"match": [{"var": "temp_data.field11s_mt_type"}, "^10[0-9]$"]},
                                    { "if": [
                                        {"==": [{"var": "temp_data.field11s_mt_type"}, "103"]},
                                        "pacs.008",
                                        { "if": [
                                            {"==": [{"var": "temp_data.field11s_mt_type"}, "104"]},
                                            "pacs.003",
                                            "pacs.008"
                                        ]}
                                    ]},
                                    { "if": [
                                        {"match": [{"var": "temp_data.field11s_mt_type"}, "^20[0-9]$"]},
                                        { "if": [
                                            { "or": [
                                                {"==": [{"var": "temp_data.field11s_mt_type"}, "202"]},
                                                {"==": [{"var": "temp_data.field11s_mt_type"}, "205"]}
                                            ]},
                                            "pacs.009",
                                            { "if": [
                                                {"==": [{"var": "temp_data.field11s_mt_type"}, "204"]},
                                                "pacs.010",
                                                "pacs.009"
                                            ]}
                                        ]},
                                        {"cat": ["MT", {"var": "temp_data.field11s_mt_type"}]}
                                    ]}
                                ]},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "warnings",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.11.R.message_type"},
                                    {"not": {"match": [{"var": "data.SwiftMT.fields.11.R.message_type"}, "^[12]0[0-9]$"]}}
                                ]},
                                {
                                    "cat": [
                                        {"var": "warnings"},
                                        [
                                            {
                                                "code": "T20089",
                                                "message": {"cat": ["Unknown message type: ", {"var": "data.SwiftMT.fields.11.R.message_type"}]},
                                                "severity": "WARNING",
                                                "field": "11R"
                                            }
                                        ]
                                    ]
                                },
                                {"var": "warnings"}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "TR004_extract_uetr_from_77a",
            "name": "TR004: Extract UETR from Field 77A",
            "description": "Complex UETR extraction from field 77A when not present in Block3, implementing TR004 specification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field77a_concatenated",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.77A.information"},
                                { "reduce": [
                                    {"var": "data.SwiftMT.fields.77A.information"},
                                    { "if": [
                                        {"starts_with": [{"var": "current"}, "//"]},
                                        {"cat": [{"var": "accumulator"}, {"substr": [{"var": "current"}, 2]}]},
                                        {"cat": [{"var": "accumulator"}, {"var": "current"}]}
                                    ]},
                                    ""
                                ]},
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.uetr_match",
                            "logic": { "if": [
                                {"var": "temp_data.field77a_concatenated"},
                                {
                                    "match": [
                                        {"var": "temp_data.field77a_concatenated"},
                                        "[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12}"
                                    ]
                                },
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.extracted_uetr",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                { "if": [
                                    {"var": "temp_data.uetr_match"},
                                    {"var": "temp_data.uetr_match"},
                                    ""
                                ]}
                            ]}
                        },
                        {
                            "path": "warnings",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.uetr_match"},
                                    {"var": "temp_data.field77a_concatenated"},
                                    {">": [{"length": {"var": "temp_data.field77a_concatenated"}}, {"+ ": [{"length": {"var": "temp_data.uetr_match"}}, 10]}]}
                                ]},
                                [
                                    {
                                        "code": "T20094",
                                        "message": "Field 77A truncation warning - additional content after UETR extraction",
                                        "severity": "WARNING",
                                        "field": "77A"
                                    }
                                ],
                                []
                            ]}
                        },
                        {
                            "path": "temp_data.field76_status_code",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.76.information.0"},
                                { "if": [
                                    {"starts_with": [{"var": "data.SwiftMT.fields.76.information.0"}, "/CNCL/"]},
                                    "CNCL",
                                    { "if": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.76.information.0"}, "/PDCR/"]},
                                        "PDCR",
                                        { "if": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.76.information.0"}, "/RJCR/"]},
                                            "RJCR",
                                            "NARR"
                                        ]}
                                    ]}
                                ]},
                                "NARR"
                            ]}
                        },
                        {
                            "path": "temp_data.field76_processed_lines",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.76.information"},
                                {
                                    "map": [
                                        {
                                            "filter": [
                                                {"var": "data.SwiftMT.fields.76.information"},
                                                { "and": [
                                                    {"!=": [{"var": ""}, ""]},
                                                    {"!": {"starts_with": [{"var": ""}, "//"]}}
                                                ]}
                                            ]
                                        },
                                        { "if": [
                                            { "and": [
                                                {"==": [{"var": "index"}, 0]},
                                                { "or": [
                                                    {"in": ["/ARPL/", {"var": ""}]},
                                                    {"starts_with": [{"var": ""}, "/ARPL/"]}
                                                ]}
                                            ]},
                                            {"replace": [{"replace": [{"var": ""}, "/ARPL/", ""]}, "/ARPL", ""]},
                                            {"var": ""}
                                        ]}
                                    ]
                                },
                                []
                            ]}
                        },
                        {
                            "path": "temp_data.field76_reason_code",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.76.information.0"},
                                { "if": [
                                    {"in": ["/AC04", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                    "AC04",
                                    { "if": [
                                        {"in": ["/AGNT", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                        "AGNT",
                                        { "if": [
                                            {"in": ["/AM04", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                            "AM04",
                                            { "if": [
                                                {"in": ["/ARDT", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                "ARDT",
                                                { "if": [
                                                    {"in": ["/CUST", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                    "CUST",
                                                    { "if": [
                                                        {"in": ["/INDM", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                        "INDM",
                                                        { "if": [
                                                            {"in": ["/LEGL", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                            "LEGL",
                                                            { "if": [
                                                                {"in": ["/NOAS", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                                "NOAS",
                                                                { "if": [
                                                                    {"in": ["/NOOR", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                                    "NOOR",
                                                                    { "if": [
                                                                        {"in": ["/PTNA", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                                        "PTNA",
                                                                        { "if": [
                                                                            {"in": ["/RQDA", {"var": "data.SwiftMT.fields.76.information.0"}]},
                                                                            "RQDA",
                                                                            ""
                                                                        ]}
                                                                    ]}
                                                                ]}
                                                            ]}
                                                        ]}
                                                    ]}
                                                ]}
                                            ]}
                                        ]}
                                    ]}
                                ]},
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.field76_additional_info",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.76.information"},
                                { "reduce": [
                                    {"slice": [{"var": "data.SwiftMT.fields.76.information"}, 1]},
                                    { "if": [
                                        {"starts_with": [{"var": "current"}, "//"]},
                                        {
                                            "cat": [{"var": "accumulator"}, " ", {"substr": [{"var": "current"}, 2]}]
                                        },
                                        {
                                            "cat": [{"var": "accumulator"}, " ", {"var": "current"}]
                                        }
                                    ]},
                                    ""
                                ]},
                                ""
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC001_validate_uetr",
            "name": "PREC001: Validate UETR Check Result",
            "description": "Validate that UETR was found in Block3 or Field 77A",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": {"!!": {"var": "temp_data.prec001_uetr_check"}},
                            "message": "T20087: UETR not found in Block3 or Field 77A"
                        }
                    ]
                }
            }
        }
    ]
}
