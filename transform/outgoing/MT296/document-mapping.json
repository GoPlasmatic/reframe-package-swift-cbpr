{
    "id": "mt296-document-mapper",
    "name": "MT296 to camt.029 Document Mapping for CBPR+",
    "description": "Maps MT296 message to ISO 20022 camt.029.001.09 ResolutionOfInvestigationV09 document structure with improved structural mapping and TR003, TR004 implementation",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "296"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt296-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "PREC001_validate_uetr"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_assignment_structure",
            "name": "Construct Assignment Structure",
            "description": "Builds camt.029 assignment structure with identification, assigner, assignee, and creation timestamp using structural output based on MT196 pattern",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.RsltnOfInvstgtn",
                            "logic": {
                                "Assgnmt": {
                                    "Id": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "Assgnr": {"Agt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}},
                                    "Assgne": {"Agt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}},
                                    "CreDtTm": {"now": []}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_status_and_confirmation_field76",
            "name": "Map Status and Confirmation from Field 76",
            "description": "Maps Field 76 answers to Status/Confirmation using MT_To_MXField76 logic and handles status code processing",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.RsltnOfInvstgtn.Sts",
                            "logic": {
                                "Conf": { "if": [
                                    {"var": "temp_data.field76_status_code"},
                                    { "if": [
                                        {"==": [{"var": "temp_data.field76_status_code"}, "CNCL"]},
                                        "CNCL",
                                        { "if": [
                                            {"==": [{"var": "temp_data.field76_status_code"}, "PDCR"]},
                                            "PDCR",
                                            { "if": [
                                                {"==": [{"var": "temp_data.field76_status_code"}, "RJCR"]},
                                                "RJCR",
                                                "RJCR"
                                            ]}
                                        ]}
                                    ]},
                                    "RJCR"
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_cancellation_details_and_transaction_info",
            "name": "Map Cancellation Details and Transaction Information",
            "description": "Constructs cancellation details including transaction information, status, original group information, resolved case, and UETR using TR003 mapped message type and TR004 UETR extraction",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.RsltnOfInvstgtn.CxlDtls",
                            "logic": {
                                "TxInfAndSts": {
                                    "CxlStsId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlGrpInf": {
                                        "OrgnlMsgId": { "if": [
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "OrgnlMsgNmId": { "if": [
                                            {"var": "temp_data.original_message_type"},
                                            {"var": "temp_data.original_message_type"},
                                            "NOTPROVIDED"
                                        ]},
                                        "OrgnlCreDtTm": { "if": [
                                            {"var": "temp_data.field11s_date"},
                                            {
                                                "cat": [
                                                    "20",
                                                    {
                                                        "substr": [{"var": "temp_data.field11s_date"}, 0, 2]
                                                    },
                                                    "-",
                                                    {
                                                        "substr": [{"var": "temp_data.field11s_date"}, 2, 2]
                                                    },
                                                    "-",
                                                    {
                                                        "substr": [{"var": "temp_data.field11s_date"}, 4, 2]
                                                    },
                                                    "T00:00:00+00:00"
                                                ]
                                            },
                                            {"now": []}
                                        ]}
                                    },
                                    "RslvdCase": {
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "Cretr": {
                                            "Agt": {
                                                "FinInstnId": {
                                                    "BICFI": {"var": "temp_data.Sender"},
                                                    "Nm": "NOTPROVIDED",
                                                    "PstlAdr": {"AdrLine": ["NOTPROVIDED"]}
                                                }
                                            }
                                        }
                                    },
                                    "OrgnlUETR": { "if": [
                                        {"var": "temp_data.extracted_uetr"},
                                        {"var": "temp_data.extracted_uetr"},
                                        ""
                                    ]},
                                    "CxlStsRsnInf": {
                                        "Rsn": {
                                            "Cd": { "if": [
                                                {"var": "temp_data.field76_reason_code"},
                                                {"var": "temp_data.field76_reason_code"},
                                                { "if": [
                                                    {"var": "temp_data.field76_status_code"},
                                                    { "if": [
                                                        {"==": [{"var": "temp_data.field76_status_code"}, "CNCL"]},
                                                        "CUST",
                                                        { "if": [
                                                            {"==": [{"var": "temp_data.field76_status_code"}, "PDCR"]},
                                                            "AGNT",
                                                            { "if": [
                                                                {"==": [{"var": "temp_data.field76_status_code"}, "RJCR"]},
                                                                "NOOR",
                                                                "NARR"
                                                            ]}
                                                        ]}
                                                    ]},
                                                    "NARR"
                                                ]}
                                            ]}
                                        },
                                        "AddtlInf": { "if": [
                                            {"var": "temp_data.field76_additional_info"},
                                            { "if": [
                                                {">": [{"length": {"var": "temp_data.field76_additional_info"}}, 105]},
                                                [
                                                    {
                                                        "substr": [{"var": "temp_data.field76_additional_info"}, 0, 105]
                                                    },
                                                    {
                                                        "substr": [{"var": "temp_data.field76_additional_info"}, 105, 105]
                                                    }
                                                ],
                                                [
                                                    {
                                                        "substr": [{"var": "temp_data.field76_additional_info"}, 0, 105]
                                                    }
                                                ]
                                            ]},
                                            { "if": [
                                                {"var": "temp_data.field76_processed_lines"},
                                                {"var": "temp_data.field76_processed_lines"},
                                                ["Resolution of investigation based on MT296 response"]
                                            ]}
                                        ]}
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
