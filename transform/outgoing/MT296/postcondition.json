{
    "id": "mt296-postcondition",
    "name": "MT296 to camt.029 Post-Condition Validation",
    "description": "Post-condition validation for MT296 to camt.029 transformation ensuring output message correctness and compliance",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "296"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt296-document-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "publish_document_xml"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_mandatory_fields_and_uetr",
            "name": "Validate Mandatory camt.029 Fields and UETR",
            "description": "Ensure all mandatory fields for camt.029 ResolutionOfInvestigation are properly populated including UETR",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "logic": { "and": [
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "Assgnmt", "Id"]},
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "Assgnmt", "Assgnr", "Agt", "FinInstnId", "BICFI"]},
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "Assgnmt", "Assgne", "Agt", "FinInstnId", "BICFI"]},
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "Assgnmt", "CreDtTm"]},
                                {"!=": [{"var": "data.Document.RsltnOfInvstgtn.Assgnmt.Id"}, "NOTPROVIDED"]}
                            ]},
                            "message": "POSTC001: camt.029 mandatory Assignment fields validation failed"
                        },
                        {
                            "logic": { "and": [
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "Sts", "Conf"]},
                                {"in": [{"var": "data.Document.RsltnOfInvstgtn.Sts.Conf"}, ["CNCL", "PDCR", "RJCR"]]}
                            ]},
                            "message": "POSTC001: camt.029 Status/Confirmation must be CNCL, PDCR, or RJCR"
                        },
                        {
                            "logic": { "and": [
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "CxlDtls", "TxInfAndSts", "CxlStsId"]},
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "CxlDtls", "TxInfAndSts", "OrgnlGrpInf", "OrgnlMsgId"]},
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "CxlDtls", "TxInfAndSts", "RslvdCase", "Id"]}
                            ]},
                            "message": "POSTC001: camt.029 CancellationDetails mandatory fields validation failed"
                        },
                        {
                            "logic": { "or": [
                                {"!": {"var": "temp_data.prec001_uetr_check"}},
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "CxlDtls", "TxInfAndSts", "OrgnlUETR"]}
                            ]},
                            "message": "POSTC002: UETR was present but not properly mapped to OrgnlUETR"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_reason_codes_and_arpl",
            "name": "Validate Cancellation Reason Codes and ARPL Removal",
            "description": "Ensure cancellation reason codes are properly mapped and ARPL is removed",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "logic": { "if": [
                                {"==": [{"var": "data.Document.RsltnOfInvstgtn.Sts.Conf"}, "CNCL"]},
                                {"==": [{"var": "data.Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.CxlStsRsnInf.Rsn.Cd"}, "CUST"]},
                                { "if": [
                                    {"==": [{"var": "data.Document.RsltnOfInvstgtn.Sts.Conf"}, "PDCR"]},
                                    {"==": [{"var": "data.Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.CxlStsRsnInf.Rsn.Cd"}, "AGNT"]},
                                    { "if": [
                                        {"==": [{"var": "data.Document.RsltnOfInvstgtn.Sts.Conf"}, "RJCR"]},
                                        {"==": [{"var": "data.Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.CxlStsRsnInf.Rsn.Cd"}, "NOOR"]},
                                        true
                                    ]}
                                ]}
                            ]},
                            "message": "POSTC003: Cancellation reason code does not match status confirmation"
                        },
                        {
                            "logic": { "or": [
                                {"!": {"exists": ["data", "SwiftMT", "fields", "76", "information"]}},
                                {"exists": ["data", "Document", "RsltnOfInvstgtn", "CxlDtls", "TxInfAndSts", "CxlStsRsnInf", "AddtlInf"]}
                            ]},
                            "message": "POSTC003: Field 76 content not properly mapped to AdditionalInformation"
                        },
                        {
                            "logic": { "if": [
                                { "and": [
                                    {"exists": ["data", "SwiftMT", "fields", "76", "information", "0"]},
                                    {"in": ["/ARPL/", {"var": "data.SwiftMT.fields.76.information.0"}]}
                                ]},
                                {
                                    "!": {
                                        "in": [
                                            "ARPL",
                                            {"var": "data.Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.CxlStsRsnInf.AddtlInf"}
                                        ]
                                    }
                                },
                                true
                            ]},
                            "message": "POSTC004: ARPL code not properly removed from Field 76 (CBPR+ compliance)"
                        }
                    ]
                }
            }
        }
    ]
}
