{
    "id": "mt205rejt-precondition",
    "name": "MT205 REJT Message Precondition",
    "description": "Precondition checks for MT205 REJT message for payment rejection scenarios",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "205"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "reject"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt205rejt-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_related_message_metadata"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "PREC001_validate_temp_variables",
            "name": "PREC001: Validate Temp Variables from TR001",
            "description": "Ensure Temp~Sender and Temp~Receiver are properly defined from BAH translation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "and": [
                                {"var": "temp_data.Sender"},
                                {"var": "temp_data.Receiver"},
                                {"!=": [{"var": "temp_data.Sender"}, "NOTPROVIDED"]},
                                {"!=": [{"var": "temp_data.Receiver"}, "NOTPROVIDED"]}
                            ]},
                            "message": "Translation stopped: TempSender or TempReceiver is not properly provided from TR001"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC002_validate_mandatory_fields",
            "name": "PREC002: Validate Mandatory MT205 Fields",
            "description": "Ensure mandatory fields for MT205 REJT are present and valid",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"exists": ["data", "SwiftMT", "fields", "20", "reference"]},
                                {"exists": ["data", "SwiftMT", "fields", "21", "reference"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "value_date"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "currency"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "amount"]},
                                {"exists": ["data", "SwiftMT", "fields", "72", "information"]},
                                {"!=": [{"var": "data.SwiftMT.fields.20.reference"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.21.reference"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.32A.currency"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.32A.value_date"}, ""]},
                                {">=": [{"var": "data.SwiftMT.fields.32A.amount"}, 0]}
                            ]},
                            "message": "T20087: Translation stopped: Mandatory MT205 fields (20, 21, 32A, 72) are missing or invalid"
                        },
                        {
                            "path": "data",
                            "logic": { "or": [
                                {"exists": ["data", "SwiftMT", "user_header", "unique_end_to_end_reference"]},
                                {"exists": ["data", "SwiftMT", "user_header", "121"]},
                                {"exists": ["data", "SwiftMT", "user_header", "field_121"]}
                            ]},
                            "message": "T20007: Translation stopped: UETR is required for MT205 REJT messages"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC002_complete_field72_validation",
            "name": "PREC002: Complete Field 72 Format Validation",
            "description": "Validates Field 72 lines 1-3 format according to specification",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {">=": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 3]},
                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/REJT/"]}
                            ]},
                            "message": "T20315: Invalid MT205 REJT format - Field 72 must have at least 3 lines starting with /REJT/"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/REJT/"]},
                                {"==": [{"length": {"var": "data.SwiftMT.fields.72.information.1"}}, 6]},
                                true
                            ]},
                            "message": "T20315: Field 72 line 2 must match pattern /2!c2!n/ when line 1 is /REJT/"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/REJT/"]},
                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.2"}, "/MREF/"]},
                                true
                            ]},
                            "message": "T20315: Field 72 line 3 must start with /MREF/ when line 1 is /REJT/"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC003_extract_and_validate_mref",
            "name": "PREC003: Extract and Validate MREF Format",
            "description": "Extract MREF and validate it doesn't start/end with '/' or contain '//'",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.original_instruction_id",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.72.information.2"},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.72.information.2"}, "/MREF/"]}
                                ]},
                                {"substr": [{"var": "data.SwiftMT.fields.72.information.2"}, 6]},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "temp_data.rejection_reason_code",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information.1"},
                                {
                                    "substr": [{"var": "data.SwiftMT.fields.72.information.1"}, 1, 4]
                                },
                                "G000"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC003_validate_mref_format",
            "name": "PREC003: Validate MREF Format",
            "description": "Validate MREF doesn't start/end with '/' or contain '//'",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.original_instruction_id"},
                                    {"!=": [{"var": "temp_data.original_instruction_id"}, "NOTPROVIDED"]},
                                    {">": [{"length": {"var": "temp_data.original_instruction_id"}}, 0]}
                                ]},
                                {
                                    "!": { "or": [
                                        {"starts_with": [{"var": "temp_data.original_instruction_id"}, "/"]},
                                        {"ends_with": [{"var": "temp_data.original_instruction_id"}, "/"]},
                                        {"in": ["//", {"var": "temp_data.original_instruction_id"}]}
                                    ]}
                                },
                                true
                            ]},
                            "message": "T20316: Invalid MREF format - original instruction ID must not start/end with '/' or contain '//'"
                        }
                    ]
                }
            }
        },
        {
            "id": "extract_field72_components",
            "name": "Extract Field 72 Components",
            "description": "Extract TREF, CHGS, and TEXT components from field 72",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field_72_tref",
                            "logic": { "reduce": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                { "if": [
                                    {"starts_with": [{"var": "current"}, "/TREF/"]},
                                    {"substr": [{"var": "current"}, 6]},
                                    {"var": "accumulator"}
                                ]},
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.field_72_text_lines",
                            "logic": {
                                "filter": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    {"starts_with": [{"var": ""}, "/TEXT/"]}
                                ]
                            }
                        },
                        {
                            "path": "temp_data.additional_information",
                            "logic": { "if": [
                                {">": [{"length": {"var": "temp_data.field_72_text_lines"}}, 0]},
                                {"map": [{"var": "temp_data.field_72_text_lines"}, {"substr": [{"var": ""}, 6]}]},
                                []
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC004_extract_rejection_details",
            "name": "PREC004: Extract Rejection Details",
            "description": "Extract and store rejection details for mapping",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.amount_value",
                            "logic": {"var": "data.SwiftMT.fields.32A.amount"}
                        },
                        {
                            "path": "temp_data.value_date",
                            "logic": {"var": "data.SwiftMT.fields.32A.value_date"}
                        },
                        {"path": "temp_data.currency", "logic": {"var": "data.SwiftMT.fields.32A.currency"}},
                        {"path": "temp_data.transaction_status", "logic": "RJCT"},
                        {
                            "path": "temp_data.rejection_timestamp",
                            "logic": {
                                "cat": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    "T",
                                    {"format_date": [{"now": []}, "HH:mm:ss"]},
                                    "+00:00"
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "MT205REJT_set_reject_translation",
            "name": "MT205 REJT: Set to pacs.002 Translation",
            "description": "MT205 REJT translates to pacs.002 payment status report",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {"path": "temp_data.MTType", "logic": "REJECT"},
                        {"path": "temp_data.translation_target", "logic": "pacs.002"}
                    ]
                }
            }
        }
    ]
}
