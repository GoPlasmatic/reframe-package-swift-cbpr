{
    "id": "mt205rejt-document-mapper",
    "name": "MT205 REJT to pacs.002 Document Mapping for CBPR+",
    "description": "Maps MT205 REJT message to ISO 20022 pacs.002.001.10 PaymentStatusReportV10 document structure according to CBPR+ MT202-REJT translation specification",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "205"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "reject"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt205rejt-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "MT205REJT_set_reject_translation"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "TR007_simplified_mref_extraction",
            "name": "TR007: Simplified MREF Extraction",
            "description": "Simplified extraction of original instruction ID from field 72 as per TR007 specification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.original_instruction_id_final",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.original_instruction_id"},
                                    {"!=": [{"var": "temp_data.original_instruction_id"}, "NOTPROVIDED"]},
                                    {">": [{"length": {"var": "temp_data.original_instruction_id"}}, 0]}
                                ]},
                                {"var": "temp_data.original_instruction_id"},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "temp_data.rejection_reason_final",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.rejection_reason_code"},
                                    {"!=": [{"var": "temp_data.rejection_reason_code"}, "G000"]}
                                ]},
                                {"var": "temp_data.rejection_reason_code"},
                                "G000"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_payment_status_report",
            "name": "Construct Payment Status Report",
            "description": "Builds complete pacs.002 payment status report structure including group header, transaction information, status, and reason details using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtStsRpt",
                            "logic": {
                                "GrpHdr": {
                                    "MsgId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "CreDtTm": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        {
                                            "cat": [
                                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                                "T",
                                                {"format_date": [{"now": []}, "HH:mm:ss"]},
                                                "+00:00"
                                            ]
                                        },
                                        "9999-12-31T00:00:00+00:00"
                                    ]},
                                    "InstgAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}},
                                    "InstdAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}
                                },
                                "TxInfAndSts": {
                                    "OrgnlGrpInf": {
                                        "OrgnlMsgId": { "if": [
                                            {"!=": [{"var": "temp_data.original_instruction_id_final"}, "NOTPROVIDED"]},
                                            {"var": "temp_data.original_instruction_id_final"},
                                            "NOTPROVIDED"
                                        ]},
                                        "OrgnlMsgNmId": "pacs.009.001.09",
                                        "OrgnlCreDtTm": { "if": [
                                            {"var": "temp_data.rejection_timestamp"},
                                            {"var": "temp_data.rejection_timestamp"},
                                            "9999-12-31T00:00:00+00:00"
                                        ]}
                                    },
                                    "OrgnlInstrId": { "if": [
                                        {"!=": [{"var": "temp_data.original_instruction_id_final"}, "NOTPROVIDED"]},
                                        {"var": "temp_data.original_instruction_id_final"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            "NOTPROVIDED"
                                        ]}
                                    ]},
                                    "OrgnlEndToEndId": { "if": [
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlUETR": { "if": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        { "if": [
                                            {"var": "data.SwiftMT.user_header.121"},
                                            {"var": "data.SwiftMT.user_header.121"},
                                            ""
                                        ]}
                                    ]},
                                    "OrgnlTxRef": {
                                        "IntrBkSttlmAmt": {
                                            "@Ccy": { "if": [
                                                {"var": "data.SwiftMT.fields.32A.currency"},
                                                {"var": "data.SwiftMT.fields.32A.currency"},
                                                "USD"
                                            ]},
                                            "$value": { "if": [
                                                {"var": "data.SwiftMT.fields.32A.amount"},
                                                {"var": "data.SwiftMT.fields.32A.amount"},
                                                0.0
                                            ]}
                                        },
                                        "IntrBkSttlmDt": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            "9999-12-31"
                                        ]},
                                        "SttlmInf": {"SttlmMtd": "INDA"},
                                        "PmtTpInf": {
                                            "SvcLvl": [
                                                {
                                                    "Cd": { "if": [
                                                        {"var": "data.SwiftMT.user_header.service_type_identifier"},
                                                        {"cat": ["G", {"var": "data.SwiftMT.user_header.service_type_identifier"}]},
                                                        null
                                                    ]}
                                                }
                                            ]
                                        },
                                        "DbtrAgt": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.52A"},
                                                {"var": "data.SwiftMT.fields.52D"}
                                            ]},
                                            {
                                                "FinInstnId": {
                                                    "BICFI": { "if": [
                                                        {"var": "data.SwiftMT.fields.52A.bic"},
                                                        {"var": "data.SwiftMT.fields.52A.bic"},
                                                        null
                                                    ]},
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                                        {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                                        null
                                                    ]},
                                                    "ClrSysMmbId": { "if": [
                                                        { "and": [
                                                            {"var": "data.SwiftMT.fields.52A.party_identifier"},
                                                            {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//"]},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//CH"]}},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//FW"]}},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//RT"]}}
                                                        ]},
                                                        {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 2]}},
                                                        null
                                                    ]}
                                                }
                                            },
                                            null
                                        ]},
                                        "IntrmyAgt1": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.56A"},
                                                {"var": "data.SwiftMT.fields.56D"}
                                            ]},
                                            {
                                                "FinInstnId": {
                                                    "BICFI": { "if": [
                                                        {"var": "data.SwiftMT.fields.56A.bic"},
                                                        {"var": "data.SwiftMT.fields.56A.bic"},
                                                        null
                                                    ]},
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.56D.name_and_address.0"},
                                                        {"var": "data.SwiftMT.fields.56D.name_and_address.0"},
                                                        null
                                                    ]}
                                                }
                                            },
                                            null
                                        ]},
                                        "CdtrAgt": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.57A"},
                                                {"var": "data.SwiftMT.fields.57B"},
                                                {"var": "data.SwiftMT.fields.57D"}
                                            ]},
                                            {
                                                "FinInstnId": {
                                                    "BICFI": { "if": [
                                                        {"var": "data.SwiftMT.fields.57A.bic"},
                                                        {"var": "data.SwiftMT.fields.57A.bic"},
                                                        null
                                                    ]},
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.57D.name_and_address.0"},
                                                        {"var": "data.SwiftMT.fields.57D.name_and_address.0"},
                                                        null
                                                    ]}
                                                }
                                            },
                                            null
                                        ]},
                                        "Cdtr": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.58A"},
                                                {"var": "data.SwiftMT.fields.58D"}
                                            ]},
                                            {
                                                "Pty": {
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.58D.name_and_address.0"},
                                                        {"var": "data.SwiftMT.fields.58D.name_and_address.0"},
                                                        "BENEFICIARY CUSTOMER"
                                                    ]},
                                                    "Id": { "if": [
                                                        {"var": "data.SwiftMT.fields.58A.bic"},
                                                        {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.58A.bic"}}},
                                                        null
                                                    ]}
                                                }
                                            },
                                            null
                                        ]}
                                    },
                                    "TxSts": "RJCT",
                                    "StsRsnInf": {
                                        "Rsn": {
                                            "Cd": { "if": [
                                                { "and": [
                                                    {"var": "temp_data.rejection_reason_final"},
                                                    {"!=": [{"var": "temp_data.rejection_reason_final"}, "G000"]}
                                                ]},
                                                {"var": "temp_data.rejection_reason_final"},
                                                "G000"
                                            ]},
                                            "Prtry": { "if": [
                                                {"==": [{"var": "temp_data.rejection_reason_final"}, "G000"]},
                                                "GENERAL_REJECTION",
                                                null
                                            ]}
                                        },
                                        "AddtlInf": { "if": [
                                            { "and": [
                                                {"var": "temp_data.additional_information"},
                                                {">=": [{"length": {"var": "temp_data.additional_information"}}, 1]}
                                            ]},
                                            {"var": "temp_data.additional_information"},
                                            { "if": [
                                                {"var": "temp_data.field_72_tref"},
                                                [{"cat": ["TREF: ", {"var": "temp_data.field_72_tref"}]}],
                                                []
                                            ]}
                                        ]}
                                    },
                                    "AccptncDtTm": { "if": [
                                        {"var": "temp_data.rejection_timestamp"},
                                        {"var": "temp_data.rejection_timestamp"},
                                        null
                                    ]},
                                    "InstgAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}},
                                    "InstdAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
