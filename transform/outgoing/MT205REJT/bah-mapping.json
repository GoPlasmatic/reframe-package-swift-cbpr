{
    "id": "mt205rejt-bah-mapper",
    "name": "MT205 REJT Business Application Header Mapping for CBPR+",
    "description": "Maps MT205 REJT message to ISO 20022 Business Application Header (AppHdr) using head.001.001.02 schema for pacs.002 payment status report",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "205"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "reject"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt205-method-detector"]},
        {"==": [{"var": "metadata.progress.task_id"}, "detect_mt205_method"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "TR001_define_temp_variables",
            "name": "TR001: Define Temp~Sender and Temp~Receiver Variables",
            "description": "Extract BIC codes from BAH with fallback logic as per TR001 specification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data",
                            "logic": {
                                "Sender": { "if": [
                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                    {"var": "data.SwiftMT.basic_header.sender_bic"},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.52A.bic"},
                                        {"var": "data.SwiftMT.fields.52A.bic"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.52D.name_and_address"},
                                            "NOTPROVIDED",
                                            "NOTPROVIDED"
                                        ]}
                                    ]}
                                ]},
                                "Receiver": { "if": [
                                    {"var": "data.SwiftMT.application_header.receiver_bic"},
                                    {"var": "data.SwiftMT.application_header.receiver_bic"},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.58A.bic"},
                                        {"var": "data.SwiftMT.fields.58A.bic"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.58D.name_and_address"},
                                            "NOTPROVIDED",
                                            "NOTPROVIDED"
                                        ]}
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_business_application_header",
            "name": "Construct Business Application Header",
            "description": "Builds CBPR+ business application header (AppHdr) with sender/receiver BIC, message identification, and creation timestamp for MT205 REJT messages",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.AppHdr",
                            "logic": {
                                "Fr": {"FIId": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}},
                                "To": {"FIId": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}},
                                "BizMsgIdr": {"cat": [{"var": "data.SwiftMT.fields.20.reference"}, "-pacs.002.rejt-205"]},
                                "MsgDefIdr": "pacs.002.001.10",
                                "BizSvc": "swift.cbprplus.02",
                                "CreDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {
                                        "cat": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            "T",
                                            {"format_date": [{"now": []}, "HH:mm:ss"]},
                                            "+00:00"
                                        ]
                                    },
                                    "9999-12-31T00:00:00+00:00"
                                ]},
                                "CpyDplct": "CODU",
                                "PssblDplct": false,
                                "Prty": "NORM"
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_related_message_metadata",
            "name": "Map Related Message Metadata",
            "description": "Maps related message metadata including sender/receiver BIC, message definition identifier, business message identifier, and creation date for message correlation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.AppHdr.Rltd",
                            "logic": {
                                "Fr": {"FIId": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}},
                                "To": {"FIId": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}},
                                "MsgDefIdr": "pacs.002.001.10",
                                "BizMsgIdr": {"var": "data.SwiftMT.fields.20.reference"},
                                "CreDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {
                                        "cat": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            "T",
                                            {"format_date": [{"now": []}, "HH:mm:ss"]},
                                            "+00:00"
                                        ]
                                    },
                                    "9999-12-31T00:00:00+00:00"
                                ]}
                            }
                        }
                    ]
                }
            }
        }
    ]
}
