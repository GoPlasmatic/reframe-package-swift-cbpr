{
    "id": "mt103-rejt-precondition",
    "name": "MT103 REJT Message Precondition",
    "description": "Precondition checks for MT103 REJT rejection message including field 72 validation",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "reject"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt103-rejt-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_cbpr_plus_rejection_metadata"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "TR001_copy_bah_to_temp",
            "name": "TR001: Copy BAH Sender/Receiver to Temp Data",
            "description": "Copy BAH From/To BICFI to Temp~Sender/Temp~Receiver for use in document mapping",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data",
                            "logic": {
                                "Sender": { "if": [
                                    {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                    {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                    "NOTPROVIDED"
                                ]},
                                "Receiver": { "if": [
                                    {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"},
                                    {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"},
                                    "NOTPROVIDED"
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC001_validate_bah_context",
            "name": "PREC001: Validate BAH Context for Rejection",
            "description": "Validates that sender and receiver BIC codes are properly extracted from business application header per TR001",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "and": [
                                {"var": "temp_data.Sender"},
                                {"var": "temp_data.Receiver"},
                                {"!=": [{"var": "temp_data.Sender"}, "NOTPROVIDED"]},
                                {"!=": [{"var": "temp_data.Receiver"}, "NOTPROVIDED"]}
                            ]},
                            "message": "Translation stopped: TempSender or TempReceiver is not properly provided from TR001"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC002_rejection_validation",
            "name": "PREC002: Validate Rejection Message Format",
            "description": "Validate that Field 72 follows the required rejection format: Line 1 starts with /REJT/, Line 2 has pattern /2!c2!n/, Line 3 starts with /MREF/",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.SwiftMT.fields.72",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                { "and": [
                                    {">=": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 3]},
                                    {"==": [{"var": "data.SwiftMT.fields.72.information.0"}, "/REJT/"]},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.72.information.1"}, "/"]},
                                    {"ends_with": [{"var": "data.SwiftMT.fields.72.information.1"}, "/"]},
                                    {"==": [{"length": {"var": "data.SwiftMT.fields.72.information.1"}}, 6]},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.72.information.2"}, "/MREF/"]}
                                ]},
                                false
                            ]},
                            "message": "T20315: Field 72 format invalid - Line 1 must be /REJT/, Line 2 must follow /2!c2!n/ pattern (e.g., /AC04/), Line 3 must start with /MREF/"
                        }
                    ]
                }
            }
        },
        {
            "id": "TR007_extract_mref",
            "name": "TR007: Extract Original Message Reference (MREF)",
            "description": "Extract MREF from Field 72 Line 3 for OriginalMessageIdentification and OriginalInstructionIdentification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.InstructionID",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                { "reduce": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    { "if": [
                                        { "or": [
                                            {"starts_with": [{"var": "current"}, "/MREF/"]},
                                            {"starts_with": [{"var": "current"}, "/ORIG/"]}
                                        ]},
                                        { "if": [
                                            {"starts_with": [{"var": "current"}, "/MREF/"]},
                                            {"trim": [{"substr": [{"var": "current"}, 6]}]},
                                            {"trim": [{"substr": [{"var": "current"}, 6]}]}
                                        ]},
                                        {"var": "accumulator"}
                                    ]},
                                    ""
                                ]},
                                ""
                            ]}
                        },
                        {
                            "path": "data",
                            "logic": {
                                "OriginalMessageIdentification": { "if": [
                                    {"!=": [{"var": "temp_data.InstructionID"}, ""]},
                                    {"var": "temp_data.InstructionID"},
                                    "NOTPROVIDED"
                                ]},
                                "OriginalInstructionIdentification": { "if": [
                                    {"!=": [{"var": "temp_data.InstructionID"}, ""]},
                                    {"var": "temp_data.InstructionID"},
                                    "NOTPROVIDED"
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC003_validate_mref_format",
            "name": "PREC003: Validate MREF Format",
            "description": "Validate that the OrgInstructionID extracted from /MREF/ does not start/end with '/' or contain '//'",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "if": [
                                {"var": "temp_data.InstructionID"},
                                {
                                    "!": { "or": [
                                        {"starts_with": [{"var": "temp_data.InstructionID"}, "/"]},
                                        {"ends_with": [{"var": "temp_data.InstructionID"}, "/"]},
                                        {"in": ["//", {"var": "temp_data.InstructionID"}]}
                                    ]}
                                },
                                true
                            ]},
                            "message": "T20316: Translation stopped: MREF value cannot start or end with '/' or contain '//' within the string"
                        }
                    ]
                }
            }
        },
        {
            "id": "TR008_extract_tref",
            "name": "TR008: Extract Original End-to-End Reference (TREF)",
            "description": "Extract TREF from Field 72 Line 4 for OriginalEndToEndID",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.EndToEndID",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                { "reduce": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    { "if": [
                                        {"starts_with": [{"var": "current"}, "/TREF/"]},
                                        {"substr": [{"var": "current"}, 6]},
                                        {"var": "accumulator"}
                                    ]},
                                    ""
                                ]},
                                ""
                            ]}
                        },
                        {
                            "path": "data.OriginalEndToEndID",
                            "logic": { "if": [
                                {"!=": [{"var": "temp_data.EndToEndID"}, ""]},
                                {"var": "temp_data.EndToEndID"},
                                "NOTPROVIDED"
                            ]}
                        }
                    ]
                }
            }
        }
    ]
}
