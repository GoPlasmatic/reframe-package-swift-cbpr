{
    "id": "mt103-rejt-postcondition",
    "name": "MT103REJT to pacs.002 Postcondition Validation",
    "description": "CBPR+ postcondition validation for MT103REJT to pacs.002 transformation ensuring compliance and data integrity",
    "priority": 6,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "reject"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "combine-header-document-xml"]},
        {"==": [{"var": "metadata.progress.task_id"}, "combine_xml_strings"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "POSTC001_validate_mandatory_fields",
            "name": "Validate Mandatory pacs.002 Fields",
            "description": "Ensures all mandatory pacs.002 fields are present and not empty",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtStsRpt.GrpHdr",
                            "logic": { "and": [
                                {"var": "MsgId"},
                                {"var": "CreDtTm"}
                            ]},
                            "message": "POSTC001: Missing mandatory Group Header fields"
                        },
                        {
                            "path": "data.Document.FIToFIPmtStsRpt",
                            "logic": { "and": [
                                {"var": "OrgnlGrpInfAndSts"},
                                {"var": "TxInfAndSts"}
                            ]},
                            "message": "POSTC001: Missing mandatory Status Report sections"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC002_validate_rejection_reason",
            "name": "Validate Rejection Reason Presence",
            "description": "Ensures rejection reason code and additional information are properly populated",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtStsRpt.TxInfAndSts",
                            "logic": { "and": [
                                {"var": "TxSts"},
                                { "or": [
                                    {"var": "StsRsnInf.Rsn.Cd"},
                                    {"var": "StsRsnInf.Rsn.Prtry"}
                                ]}
                            ]},
                            "message": "POSTC002: Missing rejection reason code in transaction status"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC003_validate_original_references",
            "name": "Validate Original Message References",
            "description": "Ensures original message identification fields are properly populated from MREF/TREF",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtStsRpt",
                            "logic": { "and": [
                                {"var": "OrgnlGrpInfAndSts.OrgnlMsgId"},
                                {"var": "OrgnlGrpInfAndSts.OrgnlMsgNmId"},
                                {"var": "TxInfAndSts.OrgnlInstrId"}
                            ]},
                            "message": "POSTC003: Missing original message references (MREF/TREF)"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC004_validate_transaction_status",
            "name": "Validate Transaction Status",
            "description": "Ensures transaction status is set to RJCT for rejection",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtStsRpt.TxInfAndSts",
                            "logic": {"==": [{"var": "TxSts"}, "RJCT"]},
                            "message": "POSTC004: Transaction status must be RJCT for rejection message"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC005_validate_cbpr_compliance",
            "name": "Validate CBPR+ Compliance",
            "description": "Ensures transformation meets CBPR+ specific requirements",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"==": [{"var": "AppHdr.BizSvc"}, "swift.cbprplus.01"]},
                                {"==": [{"var": "AppHdr.MsgDefIdr"}, "pacs.002.001.10"]}
                            ]},
                            "message": "POSTC005: Invalid CBPR+ service or message definition identifier"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC006_validate_uetr_consistency",
            "name": "Validate UETR Consistency",
            "description": "Ensures UETR from original message is preserved if present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "SwiftMT.user_header.unique_end_to_end_reference"},
                                { "or": [
                                    {"==": [{"var": "Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlUETR"}, {"var": "SwiftMT.user_header.unique_end_to_end_reference"}]},
                                    {"!": {"var": "Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlUETR"}}
                                ]},
                                true
                            ]},
                            "message": "POSTC006: UETR from user header not properly mapped to OriginalUETR"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC007_validate_field72_processing",
            "name": "Validate Field 72 Processing",
            "description": "Ensures Field 72 rejection information is properly processed",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "SwiftMT.fields.72.information"},
                                { "and": [
                                    {"var": "temp_data.InstructionID"},
                                    {"var": "temp_data.ReasonCode"}
                                ]},
                                true
                            ]},
                            "message": "POSTC007: Field 72 rejection information not properly extracted"
                        }
                    ]
                }
            }
        }
    ]
}
