{
    "id": "mt103-rejt-document-mapper",
    "name": "MT103 REJT to pacs.002 Document Mapping for CBPR+",
    "description": "Maps MT103 REJT message to ISO 20022 pacs.002.001.10 FIToFIPaymentStatusReportV10 document structure according to CBPR+ rejection translation specification",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "reject"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt103-rejt-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "TR008_extract_tref"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "map_rejection_group_header",
            "name": "Map pacs.002 Group Header for Rejection",
            "description": "Constructs pacs.002 group header with message identification and creation timestamp using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtStsRpt.GrpHdr",
                            "logic": {
                                "MsgId": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"}
                                    ]},
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"}
                                    ]},
                                    "NOTPROVIDED"
                                ]},
                                "CreDtTm": "9999-12-31T00:00:00+00:00"
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_transaction_information_and_status",
            "name": "Map Transaction Information and Status for Rejection",
            "description": "Constructs complete transaction information and status structure for rejection including agents, original references, transaction status, and group information using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtStsRpt.TxInfAndSts",
                            "logic": {
                                "InstgAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "temp_data.Sender"},
                                            {"var": "temp_data.Sender"},
                                            "NOTPROVIDED"
                                        ]}
                                    }
                                },
                                "InstdAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "temp_data.Receiver"},
                                            {"var": "temp_data.Receiver"},
                                            "NOTPROVIDED"
                                        ]}
                                    }
                                },
                                "OrgnlUETR": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.121"}
                                    ]},
                                    { "or": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.121"}
                                    ]},
                                    "NOTPROVIDED"
                                ]},
                                "TxSts": "RJCT",
                                "OrgnlGrpInf": {
                                    "OrgnlMsgNmId": "MT103",
                                    "OrgnlMsgId": { "if": [
                                        {"var": "data.OriginalMessageIdentification"},
                                        {"var": "data.OriginalMessageIdentification"},
                                        "NOTPROVIDED"
                                    ]}
                                },
                                "OrgnlInstrId": { "if": [
                                    {"var": "data.OriginalInstructionIdentification"},
                                    {"var": "data.OriginalInstructionIdentification"},
                                    "NOTPROVIDED"
                                ]},
                                "OrgnlEndToEndId": { "if": [
                                    {"var": "data.OriginalEndToEndID"},
                                    {"var": "data.OriginalEndToEndID"},
                                    "NOTPROVIDED"
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "extract_rejection_reason_data",
            "name": "Extract Rejection Reason Data from Field 72 (MT_To_MXReject72)",
            "description": "Extract rejection reason code from Line 2 (must match /2!c2!n/ pattern) and process /TEXT/ lines for additional information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.ReasonCode",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    {">=": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 2]},
                                    {"var": "data.SwiftMT.fields.72.information.1"}
                                ]},
                                { "if": [
                                    { "and": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.72.information.1"}, "/"]},
                                        {"ends_with": [{"var": "data.SwiftMT.fields.72.information.1"}, "/"]},
                                        {"==": [{"length": {"var": "data.SwiftMT.fields.72.information.1"}}, 6]}
                                    ]},
                                    {
                                        "substr": [{"var": "data.SwiftMT.fields.72.information.1"}, 1, 4]
                                    },
                                    ""
                                ]},
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.AdditionalTextInfo",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {
                                    "filter": [
                                        {
                                            "map": [
                                                {"var": "data.SwiftMT.fields.72.information"},
                                                { "if": [
                                                    {"starts_with": [{"var": ""}, "/TEXT/"]},
                                                    {"trim": [{"substr": [{"var": ""}, 6]}]},
                                                    {"var": ""}
                                                ]}
                                            ]
                                        },
                                        {"!=": [{"var": ""}, ""]}
                                    ]
                                },
                                []
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_rejection_reason",
            "name": "Map Rejection Reason Information",
            "description": "Maps rejection reason information including standard/proprietary reason codes and additional text information using structural output with conditional logic for code classification",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.standardReasonCodes",
                            "logic": [
                                "AC01",
                                "AC04",
                                "AC06",
                                "AG01",
                                "AG02",
                                "AM05",
                                "BE05",
                                "MS03",
                                "RR01",
                                "RR02",
                                "RR03",
                                "RR04"
                            ]
                        },
                        {
                            "path": "temp_data.isStandardCode",
                            "logic": { "and": [
                                {"var": "temp_data.ReasonCode"},
                                {"!=": [{"var": "temp_data.ReasonCode"}, ""]},
                                {"in": [{"var": "temp_data.ReasonCode"}, {"var": "temp_data.standardReasonCodes"}]}
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf",
                            "logic": {
                                "Rsn": {
                                    "Cd": { "if": [
                                        {"var": "temp_data.isStandardCode"},
                                        {"var": "temp_data.ReasonCode"},
                                        null
                                    ]},
                                    "Prtry": { "if": [
                                        { "and": [
                                            {"var": "temp_data.ReasonCode"},
                                            {"!=": [{"var": "temp_data.ReasonCode"}, ""]},
                                            {"!": {"var": "temp_data.isStandardCode"}}
                                        ]},
                                        {"var": "temp_data.ReasonCode"},
                                        null
                                    ]}
                                },
                                "AddtlInf": { "if": [
                                    { "and": [
                                        {"var": "temp_data.AdditionalTextInfo"},
                                        {">": [{"length": [{"var": "temp_data.AdditionalTextInfo"}]}, 0]}
                                    ]},
                                    {"var": "temp_data.AdditionalTextInfo"},
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_original_transaction_details",
            "name": "Map Original Transaction Details from MT103",
            "description": "Maps original transaction details including amount, value date, and party information from the rejected MT103 message",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtStsRpt.TxInfAndSts.OrgnlTxRef",
                            "logic": {
                                "IntrBkSttlmAmt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A"},
                                    {
                                        "@Ccy": {"var": "data.SwiftMT.fields.32A.currency"},
                                        "$value": {"var": "data.SwiftMT.fields.32A.amount"}
                                    },
                                    null
                                ]},
                                "IntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.date"},
                                    {"var": "data.SwiftMT.fields.32A.date"},
                                    null
                                ]},
                                "InstdAmt": { "if": [
                                    {"var": "data.SwiftMT.fields.33B"},
                                    {
                                        "@Ccy": {"var": "data.SwiftMT.fields.33B.currency"},
                                        "$value": {"var": "data.SwiftMT.fields.33B.amount"}
                                    },
                                    null
                                ]},
                                "XchgRate": { "if": [
                                    {"var": "data.SwiftMT.fields.36"},
                                    {"var": "data.SwiftMT.fields.36.rate"},
                                    null
                                ]},
                                "Dbtr": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.50A"},
                                        {"var": "data.SwiftMT.fields.50F"},
                                        {"var": "data.SwiftMT.fields.50K"}
                                    ]},
                                    {
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                            {"var": "data.SwiftMT.fields.50K.name_and_address.0"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.50F.name_and_address"},
                                                {"var": "data.SwiftMT.fields.50F.name_and_address.0"},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.50A.identifier"},
                                                    {"var": "data.SwiftMT.fields.50A.identifier"},
                                                    null
                                                ]}
                                            ]}
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                                {"var": "data.SwiftMT.fields.50F.name_and_address"}
                                            ]},
                                            {
                                                "AdrLine": { "if": [
                                                    {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                                    {"slice": [{"var": "data.SwiftMT.fields.50K.name_and_address"}, 1, 5]},
                                                    {"slice": [{"var": "data.SwiftMT.fields.50F.name_and_address"}, 1, 5]}
                                                ]}
                                            },
                                            null
                                        ]}
                                    },
                                    null
                                ]},
                                "DbtrAcct": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.50A.account"},
                                        {"var": "data.SwiftMT.fields.50K.account"},
                                        {"var": "data.SwiftMT.fields.50F.party_identifier"}
                                    ]},
                                    {
                                        "Id": {
                                            "Othr": {
                                                "Id": { "if": [
                                                    {"var": "data.SwiftMT.fields.50A.account"},
                                                    {"var": "data.SwiftMT.fields.50A.account"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.50K.account"},
                                                        {"var": "data.SwiftMT.fields.50K.account"},
                                                        {"var": "data.SwiftMT.fields.50F.party_identifier"}
                                                    ]}
                                                ]}
                                            }
                                        }
                                    },
                                    null
                                ]},
                                "DbtrAgt": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.52A"},
                                        {"var": "data.SwiftMT.fields.52D"}
                                    ]},
                                    {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "data.SwiftMT.fields.52A.identifier"},
                                                {"var": "data.SwiftMT.fields.52A.identifier"},
                                                null
                                            ]},
                                            "Nm": { "if": [
                                                {"var": "data.SwiftMT.fields.52D.name_and_address"},
                                                {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                                null
                                            ]}
                                        }
                                    },
                                    null
                                ]},
                                "IntrmyAgt1": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.56A"},
                                        {"var": "data.SwiftMT.fields.56C"},
                                        {"var": "data.SwiftMT.fields.56D"}
                                    ]},
                                    {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "data.SwiftMT.fields.56A.identifier"},
                                                {"var": "data.SwiftMT.fields.56A.identifier"},
                                                null
                                            ]},
                                            "Nm": { "if": [
                                                {"var": "data.SwiftMT.fields.56D.name_and_address"},
                                                {"var": "data.SwiftMT.fields.56D.name_and_address.0"},
                                                null
                                            ]}
                                        }
                                    },
                                    null
                                ]},
                                "CdtrAgt": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.57A"},
                                        {"var": "data.SwiftMT.fields.57B"},
                                        {"var": "data.SwiftMT.fields.57C"},
                                        {"var": "data.SwiftMT.fields.57D"}
                                    ]},
                                    {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "data.SwiftMT.fields.57A.identifier"},
                                                {"var": "data.SwiftMT.fields.57A.identifier"},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.57B.identifier"},
                                                    {"var": "data.SwiftMT.fields.57B.identifier"},
                                                    null
                                                ]}
                                            ]},
                                            "Nm": { "if": [
                                                {"var": "data.SwiftMT.fields.57D.name_and_address"},
                                                {"var": "data.SwiftMT.fields.57D.name_and_address.0"},
                                                null
                                            ]}
                                        }
                                    },
                                    null
                                ]},
                                "Cdtr": { "if": [
                                    {"var": "data.SwiftMT.fields.59"},
                                    {
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.59.name_and_address"},
                                            {"var": "data.SwiftMT.fields.59.name_and_address.0"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.59A.identifier"},
                                                {"var": "data.SwiftMT.fields.59A.identifier"},
                                                null
                                            ]}
                                        ]},
                                        "PstlAdr": { "if": [
                                            {"var": "data.SwiftMT.fields.59.name_and_address"},
                                            {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.59.name_and_address"}, 1, 5]}},
                                            null
                                        ]}
                                    },
                                    null
                                ]},
                                "CdtrAcct": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.59.account"},
                                        {"var": "data.SwiftMT.fields.59A.account"}
                                    ]},
                                    {
                                        "Id": {
                                            "Othr": {
                                                "Id": { "if": [
                                                    {"var": "data.SwiftMT.fields.59.account"},
                                                    {"var": "data.SwiftMT.fields.59.account"},
                                                    {"var": "data.SwiftMT.fields.59A.account"}
                                                ]}
                                            }
                                        }
                                    },
                                    null
                                ]},
                                "RmtInf": { "if": [
                                    {"var": "data.SwiftMT.fields.70"},
                                    {"Ustrd": {"var": "data.SwiftMT.fields.70.narrative"}},
                                    null
                                ]},
                                "PmtTpInf": { "if": [
                                    { "or": [
                                        {"var": "data.SwiftMT.fields.23B"},
                                        {"var": "data.SwiftMT.fields.23E"}
                                    ]},
                                    {
                                        "SvcLvl": { "if": [
                                            {"var": "data.SwiftMT.fields.23E"},
                                            { "if": [
                                                {"some": [{"var": "data.SwiftMT.fields.23E"}, {"==": [{"var": "current"}, "URGP"]}]},
                                                {"Cd": "URGP"},
                                                null
                                            ]},
                                            null
                                        ]},
                                        "CtgyPurp": { "if": [
                                            {"var": "data.SwiftMT.fields.26T"},
                                            {"Cd": {"var": "data.SwiftMT.fields.26T.transaction_type_code"}},
                                            null
                                        ]}
                                    },
                                    null
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_time_indications",
            "name": "Map Time Indication Fields (Field 13C)",
            "description": "Maps various time indications from Field 13C to appropriate pacs.002 fields",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.time_indications",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.13C"},
                                { "reduce": [
                                    {"var": "data.SwiftMT.fields.13C"},
                                    {
                                        "merge": [
                                            {"var": "accumulator"},
                                            { "if": [
                                                {"==": [{"var": "current.code"}, "SNDTIME"]},
                                                {"send_time": {"var": "current.time"}},
                                                { "if": [
                                                    {"==": [{"var": "current.code"}, "RNCTIME"]},
                                                    {"receive_time": {"var": "current.time"}},
                                                    { "if": [
                                                        {"==": [{"var": "current.code"}, "REJTIME"]},
                                                        {"reject_time": {"var": "current.time"}},
                                                        {}
                                                    ]}
                                                ]}
                                            ]}
                                        ]
                                    },
                                    {}
                                ]},
                                {}
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf",
                            "logic": { "if": [
                                {"var": "temp_data.time_indications.reject_time"},
                                {
                                    "cat": [
                                        {"var": "data.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf"},
                                        { "if": [
                                            {"var": "data.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf"},
                                            " ",
                                            ""
                                        ]},
                                        "Rejected at: ",
                                        {"var": "temp_data.time_indications.reject_time"}
                                    ]
                                },
                                {"var": "data.Document.FIToFIPmtStsRpt.TxInfAndSts.StsRsnInf.AddtlInf"}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_rejection_document_xml",
            "name": "Publish Rejection Document XML",
            "description": "Generates the pacs.002 document XML output for MT103 rejection processing using the PublishMX function",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
