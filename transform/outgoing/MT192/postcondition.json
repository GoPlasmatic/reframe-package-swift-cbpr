{
    "id": "mt192-postcondition",
    "name": "MT192 to camt.056 Postcondition Validation",
    "description": "CBPR+ postcondition validation for MT192 to camt.056 transformation ensuring compliance and data integrity",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "192"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "combine-header-document-xml"]},
        {"==": [{"var": "metadata.progress.task_id"}, "combine_xml_strings"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "POSTC001_validate_mandatory_fields",
            "name": "Validate Mandatory camt.056 Fields",
            "description": "Ensures all mandatory camt.056 fields are present and not empty",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtCxlReq.Assgnmt",
                            "logic": { "and": [
                                {"var": "Id"},
                                {"var": "Assgnr.Agt.FinInstnId.BICFI"},
                                {"var": "Assgne.Agt.FinInstnId.BICFI"},
                                {"var": "CreDtTm"}
                            ]},
                            "message": "POSTC001: Missing mandatory Assignment fields in camt.056"
                        },
                        {
                            "path": "data.Document.FIToFIPmtCxlReq",
                            "logic": { "and": [
                                {"var": "Case.Id"},
                                {"var": "Case.Cretr.Agt"}
                            ]},
                            "message": "POSTC001: Missing mandatory Case fields in camt.056"
                        },
                        {
                            "path": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0",
                            "logic": { "and": [
                                {"var": "OrgnlGrpInf.OrgnlMsgId"},
                                {"var": "OrgnlGrpInf.OrgnlMsgNmId"}
                            ]},
                            "message": "POSTC001: Missing mandatory Original Group Information fields"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC002_validate_uetr_mapping",
            "name": "Validate UETR Mapping",
            "description": "Ensures UETR is properly mapped to OriginalUETR field",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "temp_data.extracted_uetr"},
                                { "and": [
                                    {"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.OrgnlUETR"},
                                    {"==": [{"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.OrgnlUETR"}, {"var": "temp_data.extracted_uetr"}]}
                                ]},
                                true
                            ]},
                            "message": "POSTC002: UETR not properly mapped to OriginalUETR"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC003_validate_original_references",
            "name": "Validate Original References",
            "description": "Ensures original message references are properly populated from Field 21 and Field 11S",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0",
                            "logic": { "and": [
                                {"var": "OrgnlInstrId"},
                                {"!=": [{"var": "OrgnlInstrId"}, "NOTPROVIDED"]},
                                {"var": "OrgnlGrpInf.OrgnlCreDtTm"}
                            ]},
                            "message": "POSTC003: Missing original instruction ID or creation date/time"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC004_validate_cancellation_reason",
            "name": "Validate Cancellation Reason",
            "description": "Ensures cancellation reason information is properly populated",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0",
                            "logic": { "if": [
                                {"var": "CxlRsnInf"},
                                { "and": [
                                    { "or": [
                                        {"var": "CxlRsnInf.0.Rsn.Cd"},
                                        {"var": "CxlRsnInf.0.Rsn.Prtry"}
                                    ]},
                                    { "or": [
                                        {">": [{"length": {"var": "CxlRsnInf.0.AddtlInf"}}, 0]},
                                        {"==": [{"var": "CxlRsnInf.0.Rsn.Cd"}, "NARR"]}
                                    ]}
                                ]},
                                true
                            ]},
                            "message": "POSTC004: Cancellation reason information missing or incomplete"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC005_validate_original_amount",
            "name": "Validate Original Amount",
            "description": "Ensures original amount is properly mapped when present in Field 79 or Field 32A",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "temp_data.has_origamt_in_field_79"},
                                    {"var": "temp_data.has_field_32a"}
                                ]},
                                { "and": [
                                    {"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.OrgnlIntrBkSttlmAmt"},
                                    {"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.OrgnlIntrBkSttlmAmt.@Ccy"},
                                    {">": [{"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.OrgnlIntrBkSttlmAmt.$value"}, 0]}
                                ]},
                                true
                            ]},
                            "message": "POSTC005: Original amount not properly mapped from Field 79 or Field 32A"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC006_validate_cbpr_compliance",
            "name": "Validate CBPR+ Compliance",
            "description": "Ensures transformation meets CBPR+ specific requirements",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"==": [{"var": "AppHdr.BizSvc"}, "swift.cbprplus.02"]},
                                {"==": [{"var": "AppHdr.MsgDefIdr"}, "camt.056.001.08"]}
                            ]},
                            "message": "POSTC006: Invalid CBPR+ service or message definition identifier"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC007_validate_message_type_conversion",
            "name": "Validate MT to MX Type Conversion",
            "description": "Ensures Field 11S MT type is properly converted to MX message type",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "temp_data.original_mt_type"},
                                { "and": [
                                    {"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.OrgnlGrpInf.OrgnlMsgNmId"},
                                    {"==": [{"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.OrgnlGrpInf.OrgnlMsgNmId"}, {"var": "temp_data.original_mx_type"}]}
                                ]},
                                true
                            ]},
                            "message": "POSTC007: MT type from Field 11S not properly converted to MX type"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC008_validate_field_79_processing",
            "name": "Validate Field 79 Processing",
            "description": "Ensures Field 79 narrative is properly processed and mapped",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "SwiftMT.fields.79.information"},
                                { "and": [
                                    {"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.CxlRsnInf"},
                                    {">": [{"length": {"var": "Document.FIToFIPmtCxlReq.Undrlyg.TxInf.0.CxlRsnInf.0.AddtlInf"}}, 0]}
                                ]},
                                true
                            ]},
                            "message": "POSTC008: Field 79 narrative not properly mapped to Additional Information"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC009_validate_date_formatting",
            "name": "Validate Date Formatting",
            "description": "Ensures dates are properly formatted according to ISO standard",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtCxlReq",
                            "logic": { "and": [
                                {
                                    "match": [
                                        {"var": "Assgnmt.CreDtTm"},
                                        "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}[+-]\\d{2}:\\d{2}$"
                                    ]
                                },
                                {
                                    "match": [
                                        {"var": "Undrlyg.TxInf.0.OrgnlGrpInf.OrgnlCreDtTm"},
                                        "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}[+-]\\d{2}:\\d{2}$"
                                    ]
                                }
                            ]},
                            "message": "POSTC009: Date/time fields not properly formatted to ISO standard"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC010_validate_agent_information",
            "name": "Validate Agent Information",
            "description": "Ensures agent information includes required CBPR+ elements",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.FIToFIPmtCxlReq",
                            "logic": { "if": [
                                { "or": [
                                    {"!": {"var": "Assgnmt.Assgnr.Agt.FinInstnId.BICFI"}},
                                    {"!": {"var": "Assgnmt.Assgne.Agt.FinInstnId.BICFI"}}
                                ]},
                                { "and": [
                                    {"var": "Assgnmt.Assgnr.Agt.FinInstnId.Nm"},
                                    {"var": "Assgnmt.Assgnr.Agt.FinInstnId.PstlAdr.AdrLine"},
                                    {"var": "Assgnmt.Assgne.Agt.FinInstnId.Nm"},
                                    {"var": "Assgnmt.Assgne.Agt.FinInstnId.PstlAdr.AdrLine"}
                                ]},
                                true
                            ]},
                            "message": "POSTC010: Agent information missing required name and address when BIC is absent"
                        }
                    ]
                }
            }
        }
    ]
}
