{
    "id": "mt192-document-mapper",
    "name": "MT192 to camt.056 Document Mapping for CBPR+",
    "description": "Maps MT192 message to ISO 20022 camt.056.001.08 FIToFIPaymentCancellationRequestV08 document structure",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "192"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt192-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "check_precondition_errors"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]},
        {"!": [{"var": "metadata.temp_data.has_errors"}]}
    ]},
    "tasks": [
        {
            "id": "construct_assignment_structure",
            "name": "Construct Assignment Structure",
            "description": "Builds the Assignment section with identifier, assigner, assignee, and creation date time",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtCxlReq.Assgnmt",
                            "logic": {
                                "Id": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "Assgnr": {"Agt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}},
                                "Assgne": {"Agt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}},
                                "CreDtTm": "9999-12-31T00:00:00+00:00"
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_underlying_transaction_information",
            "name": "Construct Underlying Transaction Information",
            "description": "Builds the Underlying/TransactionInformation section including original transaction details and cancellation reasons",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtCxlReq.Undrlyg.TxInf",
                            "logic": {
                                "OrgnlGrpInf": {
                                    "OrgnlMsgId": { "if": [
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlMsgNmId": {"var": "temp_data.original_mx_type"},
                                    "OrgnlCreDtTm": {"var": "temp_data.original_date_formatted"}
                                },
                                "OrgnlInstrId": { "if": [
                                    {"var": "data.SwiftMT.fields.21.reference"},
                                    {"var": "data.SwiftMT.fields.21.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "OrgnlEndToEndId": "NOTPROVIDED",
                                "OrgnlUETR": { "if": [
                                    {"var": "temp_data.extracted_uetr"},
                                    {"var": "temp_data.extracted_uetr"},
                                    ""
                                ]},
                                "OrgnlIntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "temp_data.extracted_origamt_ccy"},
                                        {"var": "temp_data.extracted_origamt_ccy"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            "USD"
                                        ]}
                                    ]},
                                    "$value": { "if": [
                                        {"var": "temp_data.extracted_origamt_val"},
                                        {"var": "temp_data.extracted_origamt_val"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            0.0
                                        ]}
                                    ]}
                                },
                                "OrgnlIntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    "9999-12-31"
                                ]},
                                "Case": {
                                    "Id": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "Cretr": {"Agt": {"FinInstnId": {"Nm": "NOTPROVIDED", "PstlAdr": {"AdrLine": ["NOTPROVIDED"]}}}}
                                },
                                "CxlRsnInf": {
                                    "Rsn": {"Cd": {"var": "temp_data.cancellation_reason"}},
                                    "AddtlInf": {"var": "temp_data.cancellation_additional_info"}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
