{
    "id": "mt196-postcondition",
    "name": "MT196 to camt.029 Postcondition Validation",
    "description": "CBPR+ postcondition validation for MT196 to camt.029 transformation ensuring compliance and data integrity",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "196"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "combine-header-document-xml"]},
        {"==": [{"var": "metadata.progress.task_id"}, "combine_xml_strings"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_mandatory_fields_and_mappings",
            "name": "Validate Mandatory Fields and Core Mappings",
            "description": "Validates all mandatory camt.029 fields, UETR mapping, and case references (POSTC001, POSTC002, POSTC010)",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.RsltnOfInvstgtn.Assgnmt",
                            "logic": { "and": [
                                {"var": "Id"},
                                {"var": "Assgnr.Agt.FinInstnId.BICFI"},
                                {"var": "Assgne.Agt.FinInstnId.BICFI"},
                                {"var": "CreDtTm"}
                            ]},
                            "message": "POSTC001: Missing mandatory Assignment fields in camt.029"
                        },
                        {
                            "path": "data.Document.RsltnOfInvstgtn",
                            "logic": { "and": [
                                {"var": "Sts.Conf"},
                                {"var": "CxlDtls.TxInfAndSts.CxlStsId"},
                                {"var": "CxlDtls.TxInfAndSts.RslvdCase.Id"}
                            ]},
                            "message": "POSTC001: Missing mandatory Status and Cancellation Details fields"
                        },
                        {
                            "path": "data.Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts",
                            "logic": { "and": [
                                {"var": "OrgnlGrpInf.OrgnlMsgId"},
                                {"var": "OrgnlGrpInf.OrgnlMsgNmId"},
                                {"var": "OrgnlGrpInf.OrgnlCreDtTm"}
                            ]},
                            "message": "POSTC001: Missing mandatory Original Group Information fields"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "SwiftMT.user_header.unique_end_to_end_reference"},
                                    {"var": "temp_data.extracted_uetr"}
                                ]},
                                { "and": [
                                    {"var": "Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.OrgnlUETR"},
                                    {"!=": [{"var": "Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.OrgnlUETR"}, "NOTPROVIDED"]}
                                ]},
                                true
                            ]},
                            "message": "POSTC002: UETR not properly mapped to OriginalUETR"
                        },
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"==": [{"var": "Document.RsltnOfInvstgtn.Assgnmt.Id"}, {"var": "SwiftMT.fields.20.reference"}]},
                                {"==": [{"var": "Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.RslvdCase.Id"}, {"var": "SwiftMT.fields.21.reference"}]}
                            ]},
                            "message": "POSTC010: Case references not properly mapped from Fields 20 and 21"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_status_and_reason_codes",
            "name": "Validate Status and Reason Code Mappings",
            "description": "Validates status confirmation and cancellation reason codes (POSTC003, POSTC004)",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.RsltnOfInvstgtn.Sts",
                            "logic": { "and": [
                                {"var": "Conf"},
                                {
                                    "in": [
                                        {"var": "Conf"},
                                        ["CNCL", "PDCR", "RJCR", "CUST"]
                                    ]
                                }
                            ]},
                            "message": "POSTC003: Invalid status confirmation code in camt.029"
                        },
                        {
                            "path": "data.Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.CxlStsRsnInf",
                            "logic": { "if": [
                                {"var": ""},
                                { "and": [
                                    {"var": "Rsn.Cd"},
                                    {"in": [{"var": "Rsn.Cd"}, ["CUST", "RQDA", "NOOR"]]}
                                ]},
                                true
                            ]},
                            "message": "POSTC004: Invalid cancellation reason code"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_field_processing_and_compliance",
            "name": "Validate Field Processing and CBPR+ Compliance",
            "description": "Validates Field 76/77A processing, original message type, and CBPR+ compliance (POSTC005, POSTC006, POSTC007, POSTC008)",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "SwiftMT.fields.76.information"},
                                { "and": [
                                    {"var": "Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.CxlStsRsnInf.AddtlInf"},
                                    {">": [{"length": {"var": "Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.CxlStsRsnInf.AddtlInf"}}, 0]}
                                ]},
                                true
                            ]},
                            "message": "POSTC005: Field 76 information not properly mapped to Additional Information"
                        },
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"==": [{"var": "AppHdr.BizSvc"}, "swift.cbprplus.02"]},
                                {"==": [{"var": "AppHdr.MsgDefIdr"}, "camt.029.001.09"]}
                            ]},
                            "message": "POSTC006: Invalid CBPR+ service or message definition identifier"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "temp_data.field11_mt_type"},
                                { "and": [
                                    {"var": "Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.OrgnlGrpInf.OrgnlMsgNmId"},
                                    {"!=": [{"var": "Document.RsltnOfInvstgtn.CxlDtls.TxInfAndSts.OrgnlGrpInf.OrgnlMsgNmId"}, "NOTPROVIDED"]}
                                ]},
                                true
                            ]},
                            "message": "POSTC007: Original message type from Field 11R not properly converted"
                        },
                        {
                            "path": "data",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field77A_remaining_lines"},
                                    {">": [{"length": {"var": "temp_data.field77A_remaining_lines"}}, 0]}
                                ]},
                                {"in": ["T20094", {"var": "warnings.0"}]},
                                true
                            ]},
                            "message": "POSTC008: Field 77A truncation warning not properly raised"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_date_formatting",
            "name": "Validate Date Formatting",
            "description": "Ensures dates are properly formatted according to ISO standard (POSTC009)",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.RsltnOfInvstgtn",
                            "logic": { "and": [
                                {
                                    "match": [
                                        {"var": "Assgnmt.CreDtTm"},
                                        "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}[+-]\\d{2}:\\d{2}$"
                                    ]
                                },
                                {
                                    "match": [
                                        {"var": "CxlDtls.TxInfAndSts.OrgnlGrpInf.OrgnlCreDtTm"},
                                        "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}[+-]\\d{2}:\\d{2}$"
                                    ]
                                }
                            ]},
                            "message": "POSTC009: Date/time fields not properly formatted to ISO standard"
                        }
                    ]
                }
            }
        }
    ]
}
