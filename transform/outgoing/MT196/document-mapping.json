{
    "id": "mt196-document-mapper",
    "name": "MT196 to camt.029 Document Mapping for CBPR+",
    "description": "Maps MT196 message to ISO 20022 camt.029.001.09 ResolutionOfInvestigationV09 document structure",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "196"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt196-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_all_preconditions"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_assignment_structure",
            "name": "Construct Assignment Structure",
            "description": "Builds camt.029 assignment structure with identification, assigner, assignee, and creation timestamp using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.RsltnOfInvstgtn",
                            "logic": {
                                "Assgnmt": {
                                    "Id": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "Assgnr": {"Agt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}},
                                    "Assgne": {"Agt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}},
                                    "CreDtTm": { "if": [
                                        {"var": "data.SwiftMT.fields.13C.time_indication"},
                                        {
                                            "cat": [
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 0, 6]
                                                    }
                                                ]},
                                                "T",
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.13C.time_indication"},
                                                    {
                                                        "cat": [
                                                            {
                                                                "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 6, 2]
                                                            },
                                                            ":",
                                                            {
                                                                "substr": [{"var": "data.SwiftMT.fields.13C.time_indication"}, 8, 2]
                                                            },
                                                            ":00"
                                                        ]
                                                    },
                                                    "00:00:00"
                                                ]},
                                                "+00:00"
                                            ]
                                        },
                                        "9999-12-31T00:00:00+00:00"
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_status_and_confirmation_field76",
            "name": "Map Status and Confirmation from Field 76",
            "description": "Maps Field 76 answers to Status/Confirmation using MT_To_MXField76 logic and handles ARPL code removal",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.RsltnOfInvstgtn.Sts",
                            "logic": {"Conf": {"var": "temp_data.status_code"}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_cancellation_details_with_transaction_info",
            "name": "Map Cancellation Details with Transaction Information",
            "description": "Constructs cancellation details including original group information, transaction status, and UETR using TR004 logic",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.RsltnOfInvstgtn.CxlDtls",
                            "logic": {
                                "TxInfAndSts": {
                                    "CxlStsId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "RslvdCase": {
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "Cretr": {
                                            "Agt": {
                                                "FinInstnId": {
                                                    "BICFI": {"var": "temp_data.Sender"},
                                                    "Nm": "NOTPROVIDED",
                                                    "PstlAdr": {"AdrLine": ["NOTPROVIDED"]}
                                                }
                                            }
                                        }
                                    },
                                    "OrgnlGrpInf": {
                                        "OrgnlMsgId": { "if": [
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "OrgnlMsgNmId": {"var": "temp_data.original_mx_type"},
                                        "OrgnlCreDtTm": {"var": "temp_data.original_date_formatted"}
                                    },
                                    "OrgnlUETR": { "if": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        { "if": [
                                            {"var": "temp_data.extracted_uetr"},
                                            {"var": "temp_data.extracted_uetr"},
                                            "NOTPROVIDED"
                                        ]}
                                    ]},
                                    "CxlStsRsnInf": {
                                        "Rsn": {
                                            "Cd": { "if": [
                                                {"==": [{"var": "temp_data.status_code"}, "CNCL"]},
                                                "CUST",
                                                { "if": [
                                                    {"==": [{"var": "temp_data.status_code"}, "PDCR"]},
                                                    "RQDA",
                                                    { "if": [
                                                        {"==": [{"var": "temp_data.status_code"}, "RJCR"]},
                                                        "NOOR",
                                                        { "if": [
                                                            {"==": [{"var": "temp_data.status_code"}, "CUST"]},
                                                            "CUST",
                                                            "NOOR"
                                                        ]}
                                                    ]}
                                                ]}
                                            ]}
                                        },
                                        "AddtlInf": { "if": [
                                            {"var": "temp_data.field76_additional_info"},
                                            [{"var": "temp_data.field76_additional_info"}],
                                            []
                                        ]}
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_statement_entries_if_present",
            "name": "Map Statement Entries if Field 79 Present",
            "description": "Maps narrative information from Field 79 to statement entries if present, otherwise omitted",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.RsltnOfInvstgtn.StmtNtries",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.79.narrative"},
                                [{"Ntry": {"AddtlNtryInf": {"var": "data.SwiftMT.fields.79.narrative"}}}],
                                []
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_supplementary_data_field77a",
            "name": "Map Supplementary Data from Field 77A",
            "description": "Maps filtered Field 77A content to supplementary data after UETR extraction using TR004 logic",
            "function": {
                "name": "map",
                "input": {"mappings": [{"path": "data.MxEnvelope.Document.RsltnOfInvstgtn.SplmtryData", "logic": []}]}
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
