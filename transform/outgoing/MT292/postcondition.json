{
    "id": "mt292-postcondition",
    "name": "MT292 to camt.056 Postcondition Validation",
    "description": "Validates the camt.056 output from MT292 transformation for CBPR+ compliance",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "292"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt292-document-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "publish_document_xml"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_document_and_assignment",
            "name": "Validate Document Structure and Assignment Section",
            "description": "Ensure Document structure and Assignment section have required fields",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq"]},
                            "message": "Document.FIToFIPmtCxlReq structure is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Assgnmt", "Id"]},
                            "message": "Assignment Id is missing (Field 20)"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Assgnmt", "Assgnr", "Agt", "FinInstnId", "BICFI"]},
                            "message": "Assigner BICFI is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Assgnmt", "Assgne", "Agt", "FinInstnId", "BICFI"]},
                            "message": "Assignee BICFI is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Assgnmt", "CreDtTm"]},
                            "message": "Assignment CreationDateTime is missing"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_underlying_transaction_and_case",
            "name": "Validate Underlying Transaction and Case Information",
            "description": "Ensure underlying transaction, cancellation reason, amount, and case have required fields",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf"]},
                            "message": "Underlying TransactionInformation is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "OrgnlGrpInf", "OrgnlMsgId"]},
                            "message": "Original Message Id is missing (Field 21)"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "OrgnlGrpInf", "OrgnlMsgNmId"]},
                            "message": "Original Message Name Id is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "OrgnlUETR"]},
                            "message": "Original UETR is missing - required for CBPR+"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "CxlRsnInf"]},
                            "message": "Cancellation Reason Information is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "CxlRsnInf", "Rsn", "Cd"]},
                            "message": "Cancellation Reason Code is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "OrgnlIntrBkSttlmAmt"]},
                            "message": "Original Interbank Settlement Amount is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "OrgnlIntrBkSttlmAmt", "@Ccy"]},
                            "message": "Original Amount Currency is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "Case", "Id"]},
                            "message": "Case Id is missing"
                        },
                        {
                            "logic": {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "Case", "Cretr", "Agt", "FinInstnId"]},
                            "message": "Case Creator Agent is missing"
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_cbpr_compliance_and_values",
            "name": "Validate CBPR+ Compliance and Field Values",
            "description": "Check CBPR+ specific compliance rules, reason codes, and date formats",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "logic": { "and": [
                                {"exists": ["data", "Document", "FIToFIPmtCxlReq", "Undrlyg", "TxInf", "OrgnlUETR"]},
                                {"!=": [{"var": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.OrgnlUETR"}, ""]}
                            ]},
                            "message": "CBPR+ requires valid UETR in Original UETR field"
                        },
                        {
                            "logic": {
                                "in": [
                                    {"var": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.OrgnlGrpInf.OrgnlMsgNmId"},
                                    [
                                        "pacs.008",
                                        "pacs.009",
                                        "pacs.003",
                                        "pacs.010",
                                        "MT103",
                                        "MT202",
                                        "MT205",
                                        "MT104",
                                        "MT204"
                                    ]
                                ]
                            },
                            "message": "Original Message Name Id must be a valid payment message type"
                        },
                        {
                            "logic": {
                                "in": [
                                    {"var": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.CxlRsnInf.Rsn.Cd"},
                                    [
                                        "AGNT",
                                        "AM09",
                                        "COVR",
                                        "CURR",
                                        "CUST",
                                        "CUTA",
                                        "DUPL",
                                        "FRAD",
                                        "TECH",
                                        "UPAY",
                                        "NARR"
                                    ]
                                ]
                            },
                            "message": "Cancellation reason code must be a valid ISO 20022 code or NARR"
                        },
                        {
                            "logic": { "or": [
                                {"==": [{"var": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.OrgnlIntrBkSttlmDt"}, "9999-12-31"]},
                                {
                                    "match": [
                                        {"var": "data.Document.FIToFIPmtCxlReq.Undrlyg.TxInf.OrgnlIntrBkSttlmDt"},
                                        "^20[0-9]{2}-[0-1][0-9]-[0-3][0-9]$"
                                    ]
                                }
                            ]},
                            "message": "Original Interbank Settlement Date must be in ISO format (YYYY-MM-DD)"
                        }
                    ]
                }
            }
        },
        {
            "id": "set_validation_complete",
            "name": "Set Validation Complete",
            "description": "Mark MT292 postcondition validation as complete",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "postcondition_validation",
                            "logic": {
                                "mt292_postcondition": "complete",
                                "cbpr_compliant": true,
                                "validation_timestamp": {"now": []}
                            }
                        }
                    ]
                }
            }
        }
    ]
}
