{
    "id": "mt103-retn-postcondition",
    "name": "MT103RETN to pacs.004 Postcondition Validation",
    "description": "CBPR+ postcondition validation for MT103RETN to pacs.004 transformation ensuring compliance and data integrity",
    "priority": 6,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "return"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "combine-header-document-xml"]},
        {"==": [{"var": "metadata.progress.task_id"}, "combine_xml_strings"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "POSTC001_validate_mandatory_fields",
            "name": "Validate Mandatory pacs.004 Fields",
            "description": "Ensures all mandatory pacs.004 fields are present and not empty",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.PmtRtr.GrpHdr",
                            "logic": { "and": [
                                {"var": "MsgId"},
                                {"var": "CreDtTm"},
                                {"var": "NbOfTxs"},
                                {"var": "IntrBkSttlmDt"}
                            ]},
                            "message": "POSTC001: Missing mandatory Group Header fields in pacs.004"
                        },
                        {
                            "path": "data.Document.PmtRtr",
                            "logic": { "and": [
                                {"var": "TxInf"},
                                {">": [{"length": {"var": "TxInf"}}, 0]}
                            ]},
                            "message": "POSTC001: Missing mandatory Transaction Information in pacs.004"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC002_validate_uetr_presence",
            "name": "Validate UETR Presence",
            "description": "Ensures UETR from Block 3 is properly mapped to OriginalUETR",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "SwiftMT.user_header.unique_end_to_end_reference"},
                                { "and": [
                                    {"var": "Document.PmtRtr.TxInf.0.OrgnlUETR"},
                                    {"==": [{"var": "Document.PmtRtr.TxInf.0.OrgnlUETR"}, {"var": "SwiftMT.user_header.unique_end_to_end_reference"}]}
                                ]},
                                true
                            ]},
                            "message": "POSTC002: UETR from user header not properly mapped to OriginalUETR"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC003_validate_return_references",
            "name": "Validate Return References",
            "description": "Ensures return identification and original references are properly populated",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.PmtRtr.TxInf.0",
                            "logic": { "and": [
                                {"var": "RtrId"},
                                {"var": "OrgnlInstrId"},
                                {"!=": [{"var": "OrgnlInstrId"}, "NOTPROVIDED"]}
                            ]},
                            "message": "POSTC003: Missing return identification or original instruction ID"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC004_validate_return_amounts",
            "name": "Validate Return Amounts",
            "description": "Ensures returned interbank settlement amount is present and valid",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.PmtRtr.TxInf.0",
                            "logic": { "and": [
                                {"var": "RtrdIntrBkSttlmAmt"},
                                {"var": "RtrdIntrBkSttlmAmt.@Ccy"},
                                {">": [{"var": "RtrdIntrBkSttlmAmt.$value"}, 0]}
                            ]},
                            "message": "POSTC004: Invalid or missing returned interbank settlement amount"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC005_validate_return_reason",
            "name": "Validate Return Reason",
            "description": "Ensures return reason information is properly populated",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.PmtRtr.TxInf.0",
                            "logic": { "if": [
                                {"var": "RtrRsnInf"},
                                { "or": [
                                    {"var": "RtrRsnInf.0.Rsn.Cd"},
                                    {"var": "RtrRsnInf.0.Rsn.Prtry"},
                                    {"var": "RtrRsnInf.0.AddtlInf"}
                                ]},
                                true
                            ]},
                            "message": "POSTC005: Return reason information missing or incomplete"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC006_validate_cbpr_compliance",
            "name": "Validate CBPR+ Compliance",
            "description": "Ensures transformation meets CBPR+ specific requirements",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"==": [{"var": "AppHdr.BizSvc"}, "swift.cbprplus.01"]},
                                {"==": [{"var": "AppHdr.MsgDefIdr"}, "pacs.004.001.09"]}
                            ]},
                            "message": "POSTC006: Invalid CBPR+ service or message definition identifier"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC007_validate_agents",
            "name": "Validate Agent Information",
            "description": "Ensures instructing and instructed agents are properly populated",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.PmtRtr.TxInf.0",
                            "logic": { "and": [
                                {"var": "InstgAgt.FinInstnId.BICFI"},
                                {"var": "InstdAgt.FinInstnId.BICFI"}
                            ]},
                            "message": "POSTC007: Missing instructing or instructed agent BIC"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC008_validate_service_level",
            "name": "Validate Service Level Code",
            "description": "Ensures service level code is properly mapped if present in Block 3",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "SwiftMT.user_header.service_type_identifier"},
                                    {"match": [{"var": "SwiftMT.user_header.service_type_identifier"}, "^00[1-9]$"]}
                                ]},
                                { "and": [
                                    {"var": "Document.PmtRtr.TxInf.0.OrgnlTxRef.PmtTpInf.SvcLvl.Cd"},
                                    {"starts_with": [{"var": "Document.PmtRtr.TxInf.0.OrgnlTxRef.PmtTpInf.SvcLvl.Cd"}, "G00"]}
                                ]},
                                true
                            ]},
                            "message": "POSTC008: Service level code not properly mapped from Block 3"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC009_validate_field72_processing",
            "name": "Validate Field 72 Processing",
            "description": "Ensures Field 72 return information is properly extracted and mapped",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "if": [
                                {"var": "SwiftMT.fields.72.information"},
                                { "and": [
                                    {"var": "temp_data.original_instruction_id"},
                                    {"!=": [{"var": "temp_data.original_instruction_id"}, "NOTPROVIDED"]}
                                ]},
                                true
                            ]},
                            "message": "POSTC009: Field 72 return information not properly extracted"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC010_validate_postc001_dummy_amount",
            "name": "Validate POSTC001 Dummy Instructed Amount",
            "description": "Ensures dummy ReturnedInstructedAmount is created when ChargesInformation is present but ReturnedInstructedAmount is absent",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.Document.PmtRtr.TxInf.0",
                            "logic": { "if": [
                                {"var": "ChrgsInf"},
                                {"var": "RtrdInstdAmt"},
                                true
                            ]},
                            "message": "POSTC010: Missing dummy ReturnedInstructedAmount when ChargesInformation is present"
                        }
                    ]
                }
            }
        }
    ]
}
