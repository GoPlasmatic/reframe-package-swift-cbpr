{
    "id": "mt103-retn-precondition",
    "name": "MT103 RETN Message Precondition",
    "description": "Precondition checks for MT103 RETN return message including UETR validation and field 72 validation",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "103"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "return"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt103-retn-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_cbpr_plus_message_metadata"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "TR001_copy_bah_to_temp",
            "name": "TR001: Copy BAH Sender/Receiver to Temp Data",
            "description": "Copy BAH From/To BICFI to Temp~Sender/Temp~Receiver for use in document mapping per TR001",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data",
                            "logic": {
                                "Sender": { "if": [
                                    {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                    {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"},
                                    "NOTPROVIDED"
                                ]},
                                "Receiver": { "if": [
                                    {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"},
                                    {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"},
                                    "NOTPROVIDED"
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC001_validate_temp_variables",
            "name": "PREC001: Validate Temp Variables from TR001",
            "description": "Ensure Temp~Sender and Temp~Receiver are properly defined from BAH translation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "and": [
                                {"var": "temp_data.Sender"},
                                {"var": "temp_data.Receiver"},
                                {"!=": [{"var": "temp_data.Sender"}, "NOTPROVIDED"]},
                                {"!=": [{"var": "temp_data.Receiver"}, "NOTPROVIDED"]}
                            ]},
                            "message": "Translation stopped: TempSender or TempReceiver is not properly provided from TR001"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC002_uetr_validation",
            "name": "PREC002: Validate UETR Presence",
            "description": "IF Block3/EndToEndReference/UniqueEndToEndTransactionReference IsAbsent THEN T20087 STOP Translation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                {"!=": [{"var": "data.SwiftMT.user_header.unique_end_to_end_reference"}, ""]}
                            ]},
                            "message": "Translation stopped: UETR is mandatory for MT103 RETN messages (T20087)"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC003_field_72_retn_validation",
            "name": "PREC003: Validate Field 72 Return Format",
            "description": "Validate Field 72 or 77B: Line 1 must start with /RETN/ or /RETRES/, Line 2 must follow /2!c2!n/ pattern",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.SwiftMT.fields",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.77B.narrative.0"},
                                {"starts_with": [{"var": "data.SwiftMT.fields.77B.narrative.0"}, "/RETRES/"]},
                                { "if": [
                                    {"var": "data.SwiftMT.fields.72.information.0"},
                                    { "and": [
                                        {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/RETN/"]},
                                        { "if": [
                                            {">": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 1]},
                                            { "and": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.1"}, "/"]},
                                                {"ends_with": [{"var": "data.SwiftMT.fields.72.information.1"}, "/"]},
                                                {"==": [{"length": {"var": "data.SwiftMT.fields.72.information.1"}}, 6]}
                                            ]},
                                            true
                                        ]},
                                        { "if": [
                                            {">": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 2]},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.72.information.2"}, "/MREF/"]},
                                            true
                                        ]}
                                    ]},
                                    false
                                ]}
                            ]},
                            "message": "T20314: Field 72 or 77B format invalid for MT103 RETN"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC004_validate_mref_format",
            "name": "PREC004: Validate MREF Format",
            "description": "Validate that original instruction ID from /MREF/ does not start/end with '/' or contain '//' within the string",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.mref_value",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    {"var": "data.SwiftMT.fields.77B.narrative"}
                                ]},
                                { "reduce": [
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"var": "data.SwiftMT.fields.77B.narrative"}
                                    ]},
                                    { "if": [
                                        { "or": [
                                            {"starts_with": [{"var": "current"}, "/MREF/"]},
                                            {"starts_with": [{"var": "current"}, "/ORIG/"]},
                                            {"starts_with": [{"var": "current"}, "/RETREF/"]}
                                        ]},
                                        {
                                            "substr": [
                                                {"var": "current"},
                                                { "if": [
                                                    {"starts_with": [{"var": "current"}, "/RETREF/"]},
                                                    8,
                                                    6
                                                ]}
                                            ]
                                        },
                                        {"var": "accumulator"}
                                    ]},
                                    ""
                                ]},
                                ""
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "TR007_extract_mref",
            "name": "TR007: Extract MREF from Field 72",
            "description": "Extract Original Message Reference from field 72 line with /MREF/",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.original_instruction_id",
                            "logic": { "if": [
                                {"!=": [{"var": "temp_data.mref_value"}, ""]},
                                {"var": "temp_data.mref_value"},
                                "NOTPROVIDED"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "TR008_extract_tref",
            "name": "TR008: Extract TREF from Field 72",
            "description": "Extract Original End-to-End Reference from field 72 line with /TREF/",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.original_end_to_end_id",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    {"var": "data.SwiftMT.fields.77B.narrative"}
                                ]},
                                { "reduce": [
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"var": "data.SwiftMT.fields.77B.narrative"}
                                    ]},
                                    { "if": [
                                        {"starts_with": [{"var": "current"}, "/TREF/"]},
                                        {"substr": [{"var": "current"}, 6]},
                                        {"var": "accumulator"}
                                    ]},
                                    "NOTPROVIDED"
                                ]},
                                "NOTPROVIDED"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC004_final_mref_validation",
            "name": "PREC004: Final MREF Format Validation",
            "description": "Validate that the extracted MREF value does not start/end with '/' or contain '//' within the string per STDSQASD-177",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.mref_value"},
                                    {"!=": [{"var": "temp_data.mref_value"}, ""]}
                                ]},
                                {
                                    "!": { "or": [
                                        {"starts_with": [{"var": "temp_data.mref_value"}, "/"]},
                                        {"ends_with": [{"var": "temp_data.mref_value"}, "/"]},
                                        {"in": ["//", {"var": "temp_data.mref_value"}]}
                                    ]}
                                },
                                true
                            ]},
                            "message": "T20316: Translation stopped - MREF value cannot start or end with '/' or contain '//' within the string"
                        }
                    ]
                }
            }
        }
    ]
}
