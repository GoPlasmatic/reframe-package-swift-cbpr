{
    "id": "mt202-retn-document-mapper",
    "name": "MT202 RETN to pacs.004 Document Mapping for CBPR+",
    "description": "Maps MT202 RETN message to ISO 20022 pacs.004.001.09 PaymentReturnV09 document structure according to CBPR+ translation specification",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "202"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "return"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt202-retn-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "extract_return_details"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "initialize_context_and_settlement",
            "name": "Initialize Context and Settlement Method",
            "description": "Extract field 72 data, determine settlement method and account, and set service level code",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.service_level_code",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.user_header.service_type_identifier"},
                                { "if": [
                                    { "and": [
                                        {"var": "data.SwiftMT.user_header.service_type_identifier"},
                                        {">=": [{"length": {"var": "data.SwiftMT.user_header.service_type_identifier"}}, 3]},
                                        {"==": [{"substr": [{"var": "data.SwiftMT.user_header.service_type_identifier"}, 0, 2]}, "00"]}
                                    ]},
                                    {"cat": ["G", {"var": "data.SwiftMT.user_header.service_type_identifier"}]},
                                    ""
                                ]},
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.additional_info",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                { "reduce": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    { "if": [
                                        {"starts_with": [{"var": "current"}, "/TEXT/"]},
                                        {
                                            "cat": [{"var": "accumulator"}, " ", {"substr": [{"var": "current"}, 6]}]
                                        },
                                        {"var": "accumulator"}
                                    ]},
                                    ""
                                ]},
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.settlement_method",
                            "logic": { "if": [
                                { "and": [
                                    {
                                        "!": { "or": [
                                            {"var": "data.SwiftMT.fields.53.A"},
                                            {"var": "data.SwiftMT.fields.53.B"},
                                            {"var": "data.SwiftMT.fields.53.D"}
                                        ]}
                                    },
                                    {
                                        "!": { "or": [
                                            {"var": "data.SwiftMT.fields.54.A"},
                                            {"var": "data.SwiftMT.fields.54.B"},
                                            {"var": "data.SwiftMT.fields.54.D"}
                                        ]}
                                    }
                                ]},
                                "INDA",
                                { "if": [
                                    { "and": [
                                        { "or": [
                                            {"var": "data.SwiftMT.fields.53.A"},
                                            {"var": "data.SwiftMT.fields.53.B"},
                                            {"var": "data.SwiftMT.fields.53.D"}
                                        ]},
                                        {
                                            "!": { "or": [
                                                {"var": "data.SwiftMT.fields.54.A"},
                                                {"var": "data.SwiftMT.fields.54.B"},
                                                {"var": "data.SwiftMT.fields.54.D"}
                                            ]}
                                        }
                                    ]},
                                    { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/C"]}
                                        ]},
                                        "INGA",
                                        "INDA"
                                    ]},
                                    { "if": [
                                        { "and": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.53.A"},
                                                {"var": "data.SwiftMT.fields.53.B"},
                                                {"var": "data.SwiftMT.fields.53.D"}
                                            ]},
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.54.A"},
                                                {"var": "data.SwiftMT.fields.54.B"},
                                                {"var": "data.SwiftMT.fields.54.D"}
                                            ]}
                                        ]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.53.A.bic"},
                                                {"var": "data.SwiftMT.fields.54.A.bic"},
                                                {"==": [{"var": "data.SwiftMT.fields.53.A.bic"}, {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}]},
                                                {"==": [{"var": "data.SwiftMT.fields.54.A.bic"}, {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}]}
                                            ]},
                                            "INDA",
                                            "COVE"
                                        ]},
                                        "INDA"
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.settlement_account",
                            "logic": { "if": [
                                { "and": [
                                    {"in": [{"var": "temp_data.settlement_method"}, ["INDA", "INGA"]]},
                                    { "or": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/"]}
                                        ]},
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.53.A.party_identifier"},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, "/"]}
                                        ]},
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.53.D.party_identifier"},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.53.D.party_identifier"}, "/"]}
                                        ]}
                                    ]}
                                ]},
                                { "if": [
                                    {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                    {"substr": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, 1]},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.53.A.party_identifier"},
                                        {"substr": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, 1]},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.53.D.party_identifier"},
                                            {"substr": [{"var": "data.SwiftMT.fields.53.D.party_identifier"}, 1]},
                                            ""
                                        ]}
                                    ]}
                                ]},
                                ""
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_group_header",
            "name": "Construct Group Header",
            "description": "Build the payment return group header",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.GrpHdr",
                            "logic": {
                                "MsgId": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "CreDtTm": "9999-12-31T00:00:00+00:00",
                                "NbOfTxs": "1",
                                "SttlmInf": {
                                    "SttlmMtd": {"var": "temp_data.settlement_method"},
                                    "SttlmAcct": { "if": [
                                        { "and": [
                                            {"var": "temp_data.settlement_account"},
                                            {"!=": [{"var": "temp_data.settlement_account"}, ""]}
                                        ]},
                                        {"Id": {"Othr": {"Id": {"var": "temp_data.settlement_account"}}}},
                                        null
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_transaction_info_and_original_tx_ref",
            "name": "Construct Transaction Information and Original Transaction Reference",
            "description": "Build the transaction information section with original transaction reference details",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf",
                            "logic": {
                                "RtrId": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "OrgnlEndToEndId": { "if": [
                                    {"var": "data.SwiftMT.fields.21.reference"},
                                    {"var": "data.SwiftMT.fields.21.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "OrgnlUETR": { "if": [
                                    {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                    {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                    "NOTPROVIDED"
                                ]},
                                "OrgnlInstrId": { "if": [
                                    {"!=": [{"var": "temp_data.original_instruction_id"}, ""]},
                                    {"var": "temp_data.original_instruction_id"},
                                    ""
                                ]},
                                "TxSts": "PDNG"
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf.OrgnlTxRef",
                            "logic": {
                                "IntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]},
                                    "$value": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        0
                                    ]}
                                },
                                "IntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    "9999-12-31"
                                ]},
                                "PmtTpInf": {
                                    "SvcLvl": [
                                        {
                                            "Cd": { "if": [
                                                {"!=": [{"var": "temp_data.service_level_code"}, ""]},
                                                {"var": "temp_data.service_level_code"},
                                                null
                                            ]}
                                        }
                                    ],
                                    "ClrChanl": { "if": [
                                        { "or": [
                                            {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//RT"]},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, "//RT"]}
                                        ]},
                                        "RTGS",
                                        null
                                    ]}
                                },
                                "DbtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.52.D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.52.D.name_and_address.0"},
                                            ""
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.52.D.name_and_address"},
                                                {">=": [{"length": {"var": "data.SwiftMT.fields.52.D.name_and_address"}}, 2]}
                                            ]},
                                            {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.52.D.name_and_address"}, 1]}},
                                            null
                                        ]}
                                    }
                                },
                                "IntrmyAgt1": { "if": [
                                    {"var": "temp_data.has_intermediary"},
                                    {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "data.SwiftMT.fields.56.A.bic"},
                                                {"var": "data.SwiftMT.fields.56.A.bic"},
                                                ""
                                            ]},
                                            "Nm": { "if": [
                                                {"var": "data.SwiftMT.fields.56.D.name_and_address"},
                                                {"var": "data.SwiftMT.fields.56.D.name_and_address.0"},
                                                ""
                                            ]},
                                            "PstlAdr": { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.56.D.name_and_address"},
                                                    {">=": [{"length": {"var": "data.SwiftMT.fields.56.D.name_and_address"}}, 2]}
                                                ]},
                                                {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.56.D.name_and_address"}, 1]}},
                                                null
                                            ]}
                                        }
                                    },
                                    null
                                ]},
                                "CdtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.57.B.bic"},
                                                {"var": "data.SwiftMT.fields.57.B.bic"},
                                                {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}
                                            ]}
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.57.D.name_and_address.0"},
                                            ""
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                                {">=": [{"length": {"var": "data.SwiftMT.fields.57.D.name_and_address"}}, 2]}
                                            ]},
                                            {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.57.D.name_and_address"}, 1]}},
                                            null
                                        ]}
                                    }
                                },
                                "Cdtr": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.58.A.bic"},
                                            {"var": "data.SwiftMT.fields.58.A.bic"},
                                            {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.58.D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.58.D.name_and_address.0"},
                                            ""
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.58.D.name_and_address"},
                                                {">=": [{"length": {"var": "data.SwiftMT.fields.58.D.name_and_address"}}, 2]}
                                            ]},
                                            {"AdrLine": {"slice": [{"var": "data.SwiftMT.fields.58.D.name_and_address"}, 1]}},
                                            null
                                        ]}
                                    }
                                }
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf.RtrdIntrBkSttlmAmt",
                            "logic": {
                                "@Ccy": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    "USD"
                                ]},
                                "$value": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                    0.0
                                ]}
                            }
                        },
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf.IntrBkSttlmDt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                "9999-12-31"
                            ]}
                        },
                        {"path": "data.MxEnvelope.Document.PmtRtr.TxInf.ChrgBr", "logic": "SHAR"},
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf.InstgAgt",
                            "logic": {"FinInstnId": {"BICFI": {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}}}
                        },
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf.InstdAgt",
                            "logic": {"FinInstnId": {"BICFI": {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}}}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_return_chain",
            "name": "Construct Return Chain",
            "description": "Build the return chain with all agents",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf.RtrChain",
                            "logic": {
                                "Dbtr": {
                                    "Pty": {
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.52.D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.52.D.name_and_address.0"},
                                            "ORDERING INSTITUTION"
                                        ]}
                                    }
                                },
                                "DbtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"var": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI"}
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.52.D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.52.D.name_and_address.0"},
                                            ""
                                        ]},
                                        "ClrSysMmbId": { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.52.A.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//"]},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//CH"]}}
                                            ]},
                                            {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, 2]}},
                                            null
                                        ]}
                                    }
                                },
                                "IntrmyAgt1": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.56.A.bic"},
                                            {"var": "data.SwiftMT.fields.56.A.bic"},
                                            ""
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.56.D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.56.D.name_and_address.0"},
                                            ""
                                        ]},
                                        "ClrSysMmbId": { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.56.A.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//"]},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//CH"]}},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//FW"]}},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//RT"]}}
                                            ]},
                                            {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, 2]}},
                                            null
                                        ]}
                                    }
                                },
                                "CdtrAgt": {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                            {"var": "data.SwiftMT.fields.57.D.name_and_address.0"},
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.57.B.party_identifier"},
                                                    {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, "//"]}},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, "/"]}
                                                ]},
                                                {"var": "data.SwiftMT.fields.57.B.party_identifier"},
                                                "NOTPROVIDED"
                                            ]}
                                        ]},
                                        "ClrSysMmbId": { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.57.A.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//"]},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//CH"]}},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//RT"]}},
                                                {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//FW"]}}
                                            ]},
                                            {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, 2]}},
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.57.B.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, "//"]},
                                                    {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, "//CH"]}}
                                                ]},
                                                {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.57.B.party_identifier"}, 2]}},
                                                null
                                            ]}
                                        ]},
                                        "PstlAdr": { "if": [
                                            { "or": [
                                                {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                                {"var": "data.SwiftMT.fields.57.B.location"}
                                            ]},
                                            {
                                                "AdrLine": { "if": [
                                                    {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.57.D.name_and_address"},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.57.B.location"},
                                                        [{"var": "data.SwiftMT.fields.57.B.location"}],
                                                        ["NOTPROVIDED"]
                                                    ]}
                                                ]}
                                            },
                                            null
                                        ]}
                                    }
                                },
                                "Cdtr": {
                                    "Agt": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "data.SwiftMT.fields.58.A.bic"},
                                                {"var": "data.SwiftMT.fields.58.A.bic"},
                                                {"var": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI"}
                                            ]},
                                            "Nm": { "if": [
                                                {"var": "data.SwiftMT.fields.58.D.name_and_address"},
                                                {"var": "data.SwiftMT.fields.58.D.name_and_address.0"},
                                                ""
                                            ]},
                                            "ClrSysMmbId": { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.58.A.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//"]},
                                                    {"!": {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//CH"]}},
                                                    {"!": {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//FW"]}},
                                                    {"!": {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//RT"]}}
                                                ]},
                                                {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, 2]}},
                                                null
                                            ]}
                                        }
                                    }
                                }
                            },
                            "SttlmTmIndctn": {
                                "DbtDtTm": { "if": [
                                    {"var": "data.SwiftMT.fields.13C"},
                                    { "reduce": [
                                        {"var": "data.SwiftMT.fields.13C"},
                                        { "if": [
                                            {"starts_with": [{"var": "current.time_indication"}, "/SNDTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "current.time_indication"}, 9, 2]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "current.time_indication"}, 11, 2]
                                                    },
                                                    ":00",
                                                    { "if": [
                                                        {">": [{"length": {"var": "current.time_indication"}}, 15]},
                                                        {"substr": [{"var": "current.time_indication"}, 15]},
                                                        "+00:00"
                                                    ]}
                                                ]
                                            },
                                            {"var": "accumulator"}
                                        ]},
                                        ""
                                    ]},
                                    ""
                                ]},
                                "CdtDtTm": { "if": [
                                    {"var": "data.SwiftMT.fields.13C"},
                                    { "reduce": [
                                        {"var": "data.SwiftMT.fields.13C"},
                                        { "if": [
                                            {"starts_with": [{"var": "current.time_indication"}, "/RNCTIME/"]},
                                            {
                                                "cat": [
                                                    "0001-01-01T",
                                                    {
                                                        "substr": [{"var": "current.time_indication"}, 10, 2]
                                                    },
                                                    ":",
                                                    {
                                                        "substr": [{"var": "current.time_indication"}, 12, 2]
                                                    },
                                                    ":00",
                                                    { "if": [
                                                        {">": [{"length": {"var": "current.time_indication"}}, 16]},
                                                        {"substr": [{"var": "current.time_indication"}, 16]},
                                                        "+00:00"
                                                    ]}
                                                ]
                                            },
                                            {"var": "accumulator"}
                                        ]},
                                        ""
                                    ]},
                                    ""
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_return_reason",
            "name": "Construct Return Reason",
            "description": "Build the return reason information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr.TxInf.RtrRsnInf",
                            "logic": {
                                "Rsn": { "if": [
                                    {
                                        "in": [
                                            {"var": "temp_data.return_reason_code"},
                                            ["CUST", "TECH", "RQST", "DUPL", "AGNT"]
                                        ]
                                    },
                                    {"Cd": {"var": "temp_data.return_reason_code"}},
                                    {
                                        "Prtry": { "if": [
                                            {"!=": [{"var": "temp_data.return_reason_code"}, ""]},
                                            {"var": "temp_data.return_reason_code"},
                                            "CUST"
                                        ]}
                                    }
                                ]},
                                "Orgtr": { "if": [
                                    {"var": "data.SwiftMT.fields.52.D.name_and_address"},
                                    {"Pty": {"Nm": {"var": "data.SwiftMT.fields.52.D.name_and_address.0"}}},
                                    { "if": [
                                        {"var": "data.SwiftMT.fields.52.A.bic"},
                                        {"Agt": {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.52.A.bic"}}}},
                                        null
                                    ]}
                                ]},
                                "AddtlInf": { "if": [
                                    {"!=": [{"var": "temp_data.additional_info"}, ""]},
                                    [{"var": "temp_data.additional_info"}],
                                    { "if": [
                                        {"!=": [{"var": "temp_data.additional_information"}, ""]},
                                        [{"var": "temp_data.additional_information"}],
                                        ["Return requested"]
                                    ]}
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
