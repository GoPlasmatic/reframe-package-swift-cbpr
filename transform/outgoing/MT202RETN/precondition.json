{
    "id": "mt202-retn-precondition",
    "name": "MT202 RETN Message Precondition",
    "description": "Precondition checks for MT202 RETN message including validation of return format",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "202"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "return"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt202-retn-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "construct_business_application_header"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_and_extract_field72",
            "name": "Validate and Extract Field 72 Data",
            "description": "Validates basic requirements, Field 72 format, and extracts MREF and return details",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.validation_error",
                            "logic": { "if": [
                                {
                                    "!": { "and": [
                                        {"var": "temp_data.Sender"},
                                        {"var": "temp_data.Receiver"},
                                        {"!=": [{"var": "temp_data.Sender"}, "NOTPROVIDED"]},
                                        {"!=": [{"var": "temp_data.Receiver"}, "NOTPROVIDED"]}
                                    ]}
                                },
                                "Translation stopped: TempSender or TempReceiver is not properly provided from TR001",
                                { "if": [
                                    {
                                        "!": { "if": [
                                            {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                            {">=": [{"length": {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"}}, 36]},
                                            false
                                        ]}
                                    },
                                    "T20087: UETR is required and must be properly formatted for MT202 RETN messages",
                                    { "if": [
                                        {
                                            "!": { "and": [
                                                {">": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 0]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.0"}, "/RETN/"]},
                                                {">": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 1]},
                                                {"match": [{"var": "data.SwiftMT.fields.72.information.1"}, "^/[A-Z]{2}[0-9]{2}/$"]},
                                                {">": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 2]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.72.information.2"}, "/MREF/"]}
                                            ]}
                                        },
                                        "T20314: Field 72 format invalid - Line 1 must be /RETN/, Line 2 must follow /[A-Z]{2}[0-9]{2}/ pattern, Line 3 must start with /MREF/",
                                        null
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.original_instruction_id_raw",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.72.information.2"},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.72.information.2"}, "/MREF/"]}
                                ]},
                                {"substr": [{"var": "data.SwiftMT.fields.72.information.2"}, 6]},
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.original_instruction_id",
                            "logic": { "if": [
                                {"var": "temp_data.original_instruction_id_raw"},
                                { "if": [
                                    {"ends_with": [{"var": "temp_data.original_instruction_id_raw"}, "/"]},
                                    {
                                        "substr": [
                                            {"var": "temp_data.original_instruction_id_raw"},
                                            0,
                                            {"subtract": [{"length": {"var": "temp_data.original_instruction_id_raw"}}, 1]}
                                        ]
                                    },
                                    {"var": "temp_data.original_instruction_id_raw"}
                                ]},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "temp_data.return_reason_code_raw",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.72.information.1"},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.72.information.1"}, "/"]}
                                ]},
                                {
                                    "substr": [{"var": "data.SwiftMT.fields.72.information.1"}, 1, 4]
                                },
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.tref_line",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information.3"},
                                { "if": [
                                    {"starts_with": [{"var": "data.SwiftMT.fields.72.information.3"}, "/TREF/"]},
                                    {"substr": [{"var": "data.SwiftMT.fields.72.information.3"}, 6]},
                                    null
                                ]},
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.chgs_line",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {
                                    "some": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"starts_with": [{"var": ""}, "/CHGS/"]}
                                    ]
                                },
                                false
                            ]}
                        },
                        {
                            "path": "temp_data.chgs_info",
                            "logic": { "if": [
                                {"var": "temp_data.chgs_line"},
                                {
                                    "find": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"starts_with": [{"var": ""}, "/CHGS/"]}
                                    ]
                                },
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.text_lines",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.72.information"},
                                {
                                    "filter": [
                                        {"var": "data.SwiftMT.fields.72.information"},
                                        {"starts_with": [{"var": ""}, "/TEXT/"]}
                                    ]
                                },
                                []
                            ]}
                        },
                        {
                            "path": "temp_data.additional_information",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.text_lines"},
                                    {">": [{"length": {"var": "temp_data.text_lines"}}, 0]}
                                ]},
                                { "reduce": [
                                    {"var": "temp_data.text_lines"},
                                    {
                                        "cat": [
                                            {"var": "accumulator"},
                                            { "if": [
                                                {"var": "accumulator"},
                                                " ",
                                                ""
                                            ]},
                                            {"substr": [{"var": "current"}, 6]}
                                        ]
                                    },
                                    ""
                                ]},
                                ""
                            ]}
                        }
                    ],
                    "preserve": true
                }
            }
        },
        {
            "id": "validate_mandatory_and_agent_fields",
            "name": "Validate Mandatory and Agent Fields",
            "description": "Ensure all mandatory fields and agent fields for MT202 RETN are present and valid",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.validation_error",
                            "logic": { "if": [
                                {"var": "temp_data.validation_error"},
                                {"var": "temp_data.validation_error"},
                                { "if": [
                                    {
                                        "!": { "and": [
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            {"var": "data.SwiftMT.fields.21.reference"},
                                            {"var": "data.SwiftMT.fields.32A"},
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            {"!=": [{"var": "data.SwiftMT.fields.20.reference"}, ""]},
                                            {"!=": [{"var": "data.SwiftMT.fields.21.reference"}, ""]},
                                            {"!=": [{"var": "data.SwiftMT.fields.32A.currency"}, ""]},
                                            {"!=": [{"var": "data.SwiftMT.fields.32A.value_date"}, ""]},
                                            {">=": [{"var": "data.SwiftMT.fields.32A.amount"}, 0]}
                                        ]}
                                    },
                                    "T20070: Mandatory MT202 RETN fields (20, 21, 32A) are missing or invalid",
                                    { "if": [
                                        {
                                            "!": { "and": [
                                                { "or": [
                                                    {"var": "data.SwiftMT.fields.52.A"},
                                                    {"var": "data.SwiftMT.fields.52.D"}
                                                ]},
                                                { "or": [
                                                    {"var": "data.SwiftMT.fields.57.A"},
                                                    {"var": "data.SwiftMT.fields.57.B"},
                                                    {"var": "data.SwiftMT.fields.57.D"}
                                                ]},
                                                { "or": [
                                                    {"var": "data.SwiftMT.fields.58.A"},
                                                    {"var": "data.SwiftMT.fields.58.D"}
                                                ]}
                                            ]}
                                        },
                                        "T20071: Fields 52a, 57a, and 58a are mandatory for MT202 RETN",
                                        null
                                    ]}
                                ]}
                            ]}
                        }
                    ],
                    "preserve": true
                }
            }
        },
        {
            "id": "extract_return_details",
            "name": "Extract Return Details",
            "description": "Extract return reason and additional information from field 72",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {"path": "temp_data.return_reason_raw", "logic": "/RETN/"},
                        {
                            "path": "temp_data.return_reason_code",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.return_reason_code_raw"},
                                    {"!=": [{"var": "temp_data.return_reason_code_raw"}, ""]}
                                ]},
                                {"var": "temp_data.return_reason_code_raw"},
                                { "if": [
                                    { "and": [
                                        {"var": "temp_data.return_reason_raw"},
                                        {"!=": [{"var": "temp_data.return_reason_raw"}, ""]}
                                    ]},
                                    {
                                        "substr": [{"var": "temp_data.return_reason_raw"}, 6, 4]
                                    },
                                    "CUST"
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.has_intermediary",
                            "logic": { "or": [
                                {"var": "data.SwiftMT.fields.56.A"},
                                {"var": "data.SwiftMT.fields.56.D"}
                            ]}
                        },
                        {
                            "path": "temp_data.amount_value",
                            "logic": {"var": "data.SwiftMT.fields.32A.amount"}
                        },
                        {
                            "path": "temp_data.value_date",
                            "logic": {"var": "data.SwiftMT.fields.32A.value_date"}
                        },
                        {"path": "temp_data.currency", "logic": {"var": "data.SwiftMT.fields.32A.currency"}}
                    ],
                    "preserve": true
                }
            }
        }
    ]
}
