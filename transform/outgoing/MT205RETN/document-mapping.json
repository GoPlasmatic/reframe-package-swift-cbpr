{
    "id": "mt205retn-document-mapper",
    "name": "MT205 RETN to pacs.004 Document Mapping for CBPR+",
    "description": "Maps MT205 RETN message to ISO 20022 pacs.004.001.09 PaymentReturnV09 document structure according to CBPR+ MT202-RETN translation specification",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "205"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "return"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt205retn-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "MT205RETN_set_return_translation"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "METAFCT005_settlement_method_determination",
            "name": "METAFCT005: Settlement Method and Agents Determination",
            "description": "Determines settlement method and agents based on field 53a presence and values",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field_53a_present",
                            "logic": { "or": [
                                {"var": "data.SwiftMT.fields.53.A"},
                                {"var": "data.SwiftMT.fields.53.B"},
                                {"var": "data.SwiftMT.fields.53.D"}
                            ]}
                        },
                        {
                            "path": "temp_data.field_53b_has_C_prefix",
                            "logic": { "and": [
                                {"var": "data.SwiftMT.fields.53.B"},
                                {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/C"]}
                            ]}
                        },
                        {
                            "path": "temp_data.settlement_method",
                            "logic": { "if": [
                                {"!": {"var": "temp_data.field_53a_present"}},
                                "INDA",
                                { "if": [
                                    {"var": "temp_data.field_53b_has_C_prefix"},
                                    "INGA",
                                    "INDA"
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.settlement_account",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_53b_has_C_prefix"},
                                    {"==": [{"var": "temp_data.settlement_method"}, "INGA"]}
                                ]},
                                {"substr": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, 2]},
                                { "if": [
                                    { "and": [
                                        {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                        {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/"]}
                                    ]},
                                    {"substr": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, 1]},
                                    { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.53.A.party_identifier"},
                                            {"starts_with": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, "/"]}
                                        ]},
                                        {"substr": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, 1]},
                                        null
                                    ]}
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "TR006_TR007_extract_field72_data",
            "name": "TR006/TR007: Extract Field 72 Data",
            "description": "Extract service level code from ServiceTypeIdentifier and instruction ID from field 72 /MREF/",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.service_level_code",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.user_header.service_type_identifier"},
                                { "if": [
                                    { "and": [
                                        {"==": [{"length": {"var": "data.SwiftMT.user_header.service_type_identifier"}}, 3]},
                                        {"==": [{"substr": [{"var": "data.SwiftMT.user_header.service_type_identifier"}, 0, 2]}, "00"]},
                                        {">=": [{"substr": [{"var": "data.SwiftMT.user_header.service_type_identifier"}, 2, 1]}, "1"]},
                                        {"<=": [{"substr": [{"var": "data.SwiftMT.user_header.service_type_identifier"}, 2, 1]}, "9"]}
                                    ]},
                                    {"cat": ["G", {"var": "data.SwiftMT.user_header.service_type_identifier"}]},
                                    ""
                                ]},
                                ""
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_payment_return",
            "name": "Construct Payment Return",
            "description": "Builds complete pacs.004 payment return structure including group header, transaction information, return chain agents, settlement timing, and return reason using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.PmtRtr",
                            "logic": {
                                "GrpHdr": {
                                    "MsgId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "CreDtTm": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        {
                                            "cat": [
                                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                                "T",
                                                {"format_date": [{"now": []}, "HH:mm:ss"]},
                                                "+00:00"
                                            ]
                                        },
                                        "9999-12-31T00:00:00+00:00"
                                    ]},
                                    "NbOfTxs": "1",
                                    "SttlmInf": {
                                        "SttlmMtd": { "if": [
                                            {"var": "temp_data.settlement_method"},
                                            {"var": "temp_data.settlement_method"},
                                            "INDA"
                                        ]},
                                        "SttlmAcct": { "if": [
                                            { "and": [
                                                {"var": "temp_data.settlement_account"},
                                                {"!=": [{"var": "temp_data.settlement_account"}, ""]}
                                            ]},
                                            {"Id": {"Othr": {"Id": {"var": "temp_data.settlement_account"}}}},
                                            null
                                        ]}
                                    },
                                    "InstgAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}},
                                    "InstdAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}
                                },
                                "TxInf": {
                                    "RtrId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlEndToEndId": { "if": [
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlUETR": { "if": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlInstrId": { "if": [
                                        {"!=": [{"var": "temp_data.original_instruction_id"}, ""]},
                                        {"var": "temp_data.original_instruction_id"},
                                        ""
                                    ]},
                                    "OrgnlTxRef": {
                                        "PmtTpInf": {
                                            "SvcLvl": [
                                                {
                                                    "Cd": { "if": [
                                                        {"!=": [{"var": "temp_data.service_level_code"}, ""]},
                                                        {"var": "temp_data.service_level_code"},
                                                        null
                                                    ]}
                                                }
                                            ]
                                        }
                                    },
                                    "RtrdIntrBkSttlmAmt": {
                                        "@Ccy": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            "USD"
                                        ]},
                                        "$value": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            0.0
                                        ]}
                                    },
                                    "IntrBkSttlmDt": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        "9999-12-31"
                                    ]},
                                    "ChrgBr": "SHAR",
                                    "InstgAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}},
                                    "InstdAgt": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}},
                                    "RtrChain": {
                                        "Dbtr": {
                                            "Pty": {
                                                "Nm": { "if": [
                                                    {"var": "data.SwiftMT.fields.52D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                                    "ORDERING INSTITUTION"
                                                ]}
                                            }
                                        },
                                        "DbtrAgt": {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"var": "data.SwiftMT.fields.52A.bic"},
                                                    {"var": "data.SwiftMT.fields.52A.bic"},
                                                    {"var": "temp_data.Sender"}
                                                ]},
                                                "Nm": { "if": [
                                                    {"var": "data.SwiftMT.fields.52D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                                    ""
                                                ]},
                                                "ClrSysMmbId": { "if": [
                                                    { "and": [
                                                        {"var": "data.SwiftMT.fields.52A.party_identifier"},
                                                        {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//"]},
                                                        {"!": {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//CH"]}}
                                                    ]},
                                                    {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 2]}},
                                                    null
                                                ]}
                                            }
                                        },
                                        "IntrmyAgt1": {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"var": "data.SwiftMT.fields.56A.bic"},
                                                    {"var": "data.SwiftMT.fields.56A.bic"},
                                                    ""
                                                ]},
                                                "Nm": { "if": [
                                                    {"var": "data.SwiftMT.fields.56D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.56D.name_and_address.0"},
                                                    ""
                                                ]},
                                                "ClrSysMmbId": { "if": [
                                                    { "and": [
                                                        {"var": "data.SwiftMT.fields.56A.party_identifier"},
                                                        {"starts_with": [{"var": "data.SwiftMT.fields.56A.party_identifier"}, "//"]},
                                                        {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56A.party_identifier"}, "//CH"]}},
                                                        {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56A.party_identifier"}, "//FW"]}},
                                                        {"!": {"starts_with": [{"var": "data.SwiftMT.fields.56A.party_identifier"}, "//RT"]}}
                                                    ]},
                                                    {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.56A.party_identifier"}, 2]}},
                                                    null
                                                ]}
                                            }
                                        },
                                        "CdtrAgt": {
                                            "FinInstnId": {
                                                "BICFI": { "if": [
                                                    {"var": "data.SwiftMT.fields.57A.bic"},
                                                    {"var": "data.SwiftMT.fields.57A.bic"},
                                                    {"var": "temp_data.Receiver"}
                                                ]},
                                                "Nm": { "if": [
                                                    {"var": "data.SwiftMT.fields.57D.name_and_address"},
                                                    {"var": "data.SwiftMT.fields.57D.name_and_address.0"},
                                                    { "if": [
                                                        { "and": [
                                                            {"var": "data.SwiftMT.fields.57B.party_identifier"},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, "//"]}},
                                                            {"starts_with": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, "/"]}
                                                        ]},
                                                        {"var": "data.SwiftMT.fields.57B.party_identifier"},
                                                        "NOTPROVIDED"
                                                    ]}
                                                ]},
                                                "ClrSysMmbId": { "if": [
                                                    { "and": [
                                                        {"var": "data.SwiftMT.fields.57A.party_identifier"},
                                                        {"starts_with": [{"var": "data.SwiftMT.fields.57A.party_identifier"}, "//"]},
                                                        {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57A.party_identifier"}, "//CH"]}},
                                                        {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57A.party_identifier"}, "//RT"]}},
                                                        {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57A.party_identifier"}, "//FW"]}}
                                                    ]},
                                                    {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.57A.party_identifier"}, 2]}},
                                                    { "if": [
                                                        { "and": [
                                                            {"var": "data.SwiftMT.fields.57B.party_identifier"},
                                                            {"starts_with": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, "//"]},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, "//CH"]}}
                                                        ]},
                                                        {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.57B.party_identifier"}, 2]}},
                                                        null
                                                    ]}
                                                ]},
                                                "PstlAdr": { "if": [
                                                    { "or": [
                                                        {"var": "data.SwiftMT.fields.57D.name_and_address"},
                                                        {"var": "data.SwiftMT.fields.57B"}
                                                    ]},
                                                    {
                                                        "AdrLine": { "if": [
                                                            {"var": "data.SwiftMT.fields.57D.name_and_address"},
                                                            {
                                                                "slice": [
                                                                    {"var": "data.SwiftMT.fields.57D.name_and_address"},
                                                                    1,
                                                                    {"min": [{"length": {"var": "data.SwiftMT.fields.57D.name_and_address"}}, 8]}
                                                                ]
                                                            },
                                                            { "if": [
                                                                { "and": [
                                                                    {"var": "data.SwiftMT.fields.57B"},
                                                                    {"var": "data.SwiftMT.fields.57B.location"},
                                                                    {"var": "data.SwiftMT.fields.57B.name_and_address"}
                                                                ]},
                                                                {
                                                                    "cat": [
                                                                        {
                                                                            "slice": [
                                                                                {"var": "data.SwiftMT.fields.57B.name_and_address"},
                                                                                1,
                                                                                {"min": [{"length": {"var": "data.SwiftMT.fields.57B.name_and_address"}}, 4]}
                                                                            ]
                                                                        },
                                                                        [{"var": "data.SwiftMT.fields.57B.location"}]
                                                                    ]
                                                                },
                                                                []
                                                            ]}
                                                        ]}
                                                    },
                                                    null
                                                ]}
                                            }
                                        },
                                        "PrvsInstgAgt1": { "if": [
                                            {"var": "data.SwiftMT.fields.53B"},
                                            {
                                                "FinInstnId": {
                                                    "Othr": {
                                                        "Id": { "if": [
                                                            {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                                            {"var": "data.SwiftMT.fields.53B.party_identifier"},
                                                            "NOTPROVIDED"
                                                        ]}
                                                    },
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.53B.location"},
                                                        {"var": "data.SwiftMT.fields.53B.location"},
                                                        ""
                                                    ]}
                                                }
                                            },
                                            null
                                        ]},
                                        "PrvsInstgAgt2": { "if": [
                                            {"var": "data.SwiftMT.fields.54B"},
                                            {
                                                "FinInstnId": {
                                                    "Othr": {
                                                        "Id": { "if": [
                                                            {"var": "data.SwiftMT.fields.54B.party_identifier"},
                                                            {"var": "data.SwiftMT.fields.54B.party_identifier"},
                                                            "NOTPROVIDED"
                                                        ]}
                                                    },
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.54B.location"},
                                                        {"var": "data.SwiftMT.fields.54B.location"},
                                                        ""
                                                    ]}
                                                }
                                            },
                                            null
                                        ]},
                                        "PrvsInstgAgt3": { "if": [
                                            {"var": "data.SwiftMT.fields.55B"},
                                            {
                                                "FinInstnId": {
                                                    "Othr": {
                                                        "Id": { "if": [
                                                            {"var": "data.SwiftMT.fields.55B.party_identifier"},
                                                            {"var": "data.SwiftMT.fields.55B.party_identifier"},
                                                            "NOTPROVIDED"
                                                        ]}
                                                    },
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.55B.location"},
                                                        {"var": "data.SwiftMT.fields.55B.location"},
                                                        ""
                                                    ]}
                                                }
                                            },
                                            null
                                        ]},
                                        "Cdtr": {
                                            "Agt": {
                                                "FinInstnId": {
                                                    "BICFI": { "if": [
                                                        {"var": "data.SwiftMT.fields.58A.bic"},
                                                        {"var": "data.SwiftMT.fields.58A.bic"},
                                                        {"var": "temp_data.Receiver"}
                                                    ]},
                                                    "Nm": { "if": [
                                                        {"var": "data.SwiftMT.fields.58D.name_and_address"},
                                                        {"var": "data.SwiftMT.fields.58D.name_and_address.0"},
                                                        ""
                                                    ]},
                                                    "ClrSysMmbId": { "if": [
                                                        { "and": [
                                                            {"var": "data.SwiftMT.fields.58A.party_identifier"},
                                                            {"starts_with": [{"var": "data.SwiftMT.fields.58A.party_identifier"}, "//"]},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.58A.party_identifier"}, "//CH"]}},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.58A.party_identifier"}, "//FW"]}},
                                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.58A.party_identifier"}, "//RT"]}}
                                                        ]},
                                                        {"MmbId": {"substr": [{"var": "data.SwiftMT.fields.58A.party_identifier"}, 2]}},
                                                        null
                                                    ]}
                                                }
                                            }
                                        }
                                    },
                                    "SttlmTmIndctn": {
                                        "DbtDtTm": { "if": [
                                            {"var": "data.SwiftMT.fields.13C"},
                                            { "reduce": [
                                                {"var": "data.SwiftMT.fields.13C"},
                                                { "if": [
                                                    {"==": [{"var": "current.code"}, "SNDTIME"]},
                                                    {
                                                        "cat": [
                                                            "0001-01-01T",
                                                            {
                                                                "substr": [{"var": "current.time"}, 0, 2]
                                                            },
                                                            ":",
                                                            {
                                                                "substr": [{"var": "current.time"}, 2, 2]
                                                            },
                                                            ":00",
                                                            {"var": "current.sign"},
                                                            {
                                                                "substr": [{"var": "current.offset"}, 0, 2]
                                                            },
                                                            ":",
                                                            {
                                                                "substr": [{"var": "current.offset"}, 2, 2]
                                                            }
                                                        ]
                                                    },
                                                    {"var": "accumulator"}
                                                ]},
                                                ""
                                            ]},
                                            ""
                                        ]},
                                        "CdtDtTm": { "if": [
                                            {"var": "data.SwiftMT.fields.13C"},
                                            { "reduce": [
                                                {"var": "data.SwiftMT.fields.13C"},
                                                { "if": [
                                                    {"==": [{"var": "current.code"}, "RNCTIME"]},
                                                    {
                                                        "cat": [
                                                            "0001-01-01T",
                                                            {
                                                                "substr": [{"var": "current.time"}, 0, 2]
                                                            },
                                                            ":",
                                                            {
                                                                "substr": [{"var": "current.time"}, 2, 2]
                                                            },
                                                            ":00",
                                                            {"var": "current.sign"},
                                                            {
                                                                "substr": [{"var": "current.offset"}, 0, 2]
                                                            },
                                                            ":",
                                                            {
                                                                "substr": [{"var": "current.offset"}, 2, 2]
                                                            }
                                                        ]
                                                    },
                                                    {"var": "accumulator"}
                                                ]},
                                                ""
                                            ]},
                                            ""
                                        ]}
                                    },
                                    "RtrRsnInf": {
                                        "Rsn": {
                                            "Cd": { "if": [
                                                { "and": [
                                                    {"var": "temp_data.return_reason_code"},
                                                    {"!=": [{"var": "temp_data.return_reason_code"}, ""]},
                                                    {"!=": [{"var": "temp_data.return_reason_code"}, "NARR"]}
                                                ]},
                                                {"var": "temp_data.return_reason_code"},
                                                "NARR"
                                            ]},
                                            "Prtry": { "if": [
                                                {"==": [{"var": "temp_data.return_reason_code"}, "NARR"]},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.72.information.1"},
                                                    {
                                                        "substr": [{"var": "data.SwiftMT.fields.72.information.1"}, 1, 4]
                                                    },
                                                    "NARR"
                                                ]},
                                                null
                                            ]}
                                        },
                                        "AddtlInf": { "if": [
                                            { "and": [
                                                {"var": "temp_data.additional_information"},
                                                {">": [{"length": {"var": "temp_data.additional_information"}}, 0]}
                                            ]},
                                            {"var": "temp_data.additional_information"},
                                            { "if": [
                                                {"==": [{"var": "temp_data.return_reason_code"}, "NARR"]},
                                                ["Return reason provided in narrative form"],
                                                []
                                            ]}
                                        ]}
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
