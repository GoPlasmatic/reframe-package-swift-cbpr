{
    "id": "mt900-postcondition",
    "name": "MT900 to camt.054 Post-Transformation Validation",
    "description": "Validates the transformed camt.054 message for CBPR+ compliance after MT900 transformation",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "900"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt900-document-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "publish_mx_message"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_document_structure_and_account",
            "name": "Validate Document Structure, Notification, and Account",
            "description": "Ensures document header, notification structure, and account information are properly set",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "logic": { "and": [
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "GrpHdr", "MsgId"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "GrpHdr", "CreDtTm"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "GrpHdr", "MsgRcpt"]},
                                {"!=": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.GrpHdr.MsgId"}, ""]},
                                {"!=": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.GrpHdr.CreDtTm"}, ""]}
                            ]},
                            "message": "GroupHeader is missing mandatory fields"
                        },
                        {
                            "logic": { "and": [
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn"]},
                                {"==": [{"length": {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn"}}, 1]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Id"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "CreDtTm"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Acct"]}
                            ]},
                            "message": "Notification structure is invalid or missing mandatory fields"
                        },
                        {
                            "logic": { "and": [
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Acct", "Id"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Acct", "Ccy"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Acct", "Svcr"]},
                                {"!=": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Acct.Ccy"}, ""]}
                            ]},
                            "message": "Account information is missing mandatory fields"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC004_validate_entry_structure",
            "name": "POSTC004: Validate Entry Structure",
            "description": "Ensure entry contains correct debit confirmation details",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry",
                            "logic": { "and": [
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Ntry"]},
                                {"==": [{"length": {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry"}}, 1]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Ntry", "0", "NtryRef"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Ntry", "0", "Amt"]},
                                {"==": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.CdtDbtInd"}, "DBIT"]},
                                {"==": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.Sts.Cd"}, "BOOK"]}
                            ]},
                            "message": "POSTC004: Entry structure is invalid or missing debit confirmation details"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC005_validate_entry_amounts",
            "name": "POSTC005: Validate Entry Amounts",
            "description": "Ensure entry amount details are properly set",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0",
                            "logic": { "and": [
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Ntry", "0", "Amt", "@Ccy"]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Ntry", "0", "Amt", "$value"]},
                                {">": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.Amt.$value"}, 0]},
                                {"exists": ["data", "MxEnvelope", "Document", "BkToCstmrDbtCdtNtfctn", "Ntfctn", "0", "Ntry", "0", "ValDt"]}
                            ]},
                            "message": "POSTC005: Entry amount or value date is invalid"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC006_validate_transaction_details",
            "name": "POSTC006: Validate Transaction Details",
            "description": "Ensure transaction details contain proper references and amounts",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls",
                            "logic": { "and": [
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls"},
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls"},
                                {"==": [{"length": {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls"}}, 1]},
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs"},
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Amt"}
                            ]},
                            "message": "POSTC006: Transaction details structure is invalid"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC007_validate_transaction_references",
            "name": "POSTC007: Validate Transaction References",
            "description": "Ensure all required reference fields are present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs",
                            "logic": { "and": [
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs.MsgId"},
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs.AcctSvcrRef"},
                                {"!=": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs.MsgId"}, ""]},
                                {"!=": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Refs.AcctSvcrRef"}, ""]}
                            ]},
                            "message": "POSTC007: Transaction references are missing mandatory fields"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC008_validate_transaction_amounts",
            "name": "POSTC008: Validate Transaction Amounts",
            "description": "Ensure transaction amounts match entry amounts and have correct indicators",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0",
                            "logic": { "and": [
                                {"==": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.CdtDbtInd"}, "DBIT"]},
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Amt.@Ccy"},
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Amt.$value"},
                                {"==": [{"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.Amt.$value"}, {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.Amt.$value"}]}
                            ]},
                            "message": "POSTC008: Transaction amounts do not match entry amounts or have incorrect indicators"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC009_validate_cbpr_compliance",
            "name": "POSTC009: Validate CBPR+ Compliance",
            "description": "Ensure CBPR+ specific requirements are met",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data.MxEnvelope.AppHdr",
                            "logic": { "and": [
                                {"var": "data.MxEnvelope.AppHdr.BizSvc"},
                                {"==": [{"var": "data.MxEnvelope.AppHdr.BizSvc"}, "swift.cbprplus.02"]},
                                {"var": "data.MxEnvelope.AppHdr.MsgDefIdr"},
                                {"==": [{"var": "data.MxEnvelope.AppHdr.MsgDefIdr"}, "camt.054.001.08"]}
                            ]},
                            "message": "POSTC009: Message does not meet CBPR+ compliance requirements"
                        }
                    ]
                }
            }
        },
        {
            "id": "POSTC010_validate_related_parties",
            "name": "POSTC010: Validate Related Parties",
            "description": "Ensure related parties (field 52) are properly mapped when present",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "or": [
                                {"!": {"var": "data.SwiftMT.fields.52"}},
                                {"var": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls.0.TxDtls.0.RltdPties.DbtrAgt"}
                            ]},
                            "message": "POSTC010: Field 52 (Ordering Institution) present but not mapped to related parties"
                        }
                    ]
                }
            }
        }
    ]
}
