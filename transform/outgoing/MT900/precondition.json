{
    "id": "mt900-precondition",
    "name": "MT900 Message Precondition",
    "description": "Precondition checks for MT900 confirmation of debit message",
    "priority": 3,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "900"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt900-bah-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "map_related_message_metadata"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "PREC001_validate_temp_variables",
            "name": "PREC001: Validate Temp Variables from TR001",
            "description": "Ensure Temp~Sender and Temp~Receiver are properly defined from BAH translation",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "temp_data",
                            "logic": { "and": [
                                {"var": "temp_data.Sender"},
                                {"var": "temp_data.Receiver"},
                                {"!=": [{"var": "temp_data.Sender"}, "NOTPROVIDED"]},
                                {"!=": [{"var": "temp_data.Receiver"}, "NOTPROVIDED"]}
                            ]},
                            "message": "Translation stopped: TempSender or TempReceiver is not properly provided from TR001"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC002_validate_mandatory_fields",
            "name": "PREC002: Validate Mandatory MT900 Fields",
            "description": "Ensure mandatory fields for MT900 are present and valid",
            "function": {
                "name": "validate",
                "input": {
                    "rules": [
                        {
                            "path": "data",
                            "logic": { "and": [
                                {"exists": ["data", "SwiftMT", "fields", "20", "reference"]},
                                {"exists": ["data", "SwiftMT", "fields", "21", "reference"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "amount"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "currency"]},
                                {"exists": ["data", "SwiftMT", "fields", "32A", "value_date"]},
                                {"!=": [{"var": "data.SwiftMT.fields.20.reference"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.21.reference"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.32A.amount"}, null]},
                                {"!=": [{"var": "data.SwiftMT.fields.32A.currency"}, ""]},
                                {"!=": [{"var": "data.SwiftMT.fields.32A.value_date"}, ""]},
                                {">=": [{"var": "data.SwiftMT.fields.32A.amount"}, 0]}
                            ]},
                            "message": "Translation stopped: Mandatory MT900 fields (20, 21, 32A) are missing or invalid"
                        },
                        {
                            "path": "data",
                            "logic": { "or": [
                                {"exists": ["data", "SwiftMT", "fields", "25", "authorisation"]},
                                {"exists": ["data", "SwiftMT", "fields", "25", "P", "account"]}
                            ]},
                            "message": "Translation stopped: Field 25 or 25P (Account Identification) is mandatory but missing"
                        }
                    ]
                }
            }
        },
        {
            "id": "PREC003_set_notification_type",
            "name": "PREC003: Set Notification Type for MT900",
            "description": "Set notification type as DBIT for MT900 debit confirmation and extract currency from field 32A",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {"path": "temp_data.notification_type", "logic": "DBIT"},
                        {"path": "temp_data.entry_status", "logic": "BOOK"},
                        {
                            "path": "temp_data.account_currency",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.32A.currency"},
                                {"var": "data.SwiftMT.fields.32A.currency"},
                                "USD"
                            ]}
                        },
                        {
                            "path": "temp_data.amount_value",
                            "logic": {"var": "data.SwiftMT.fields.32A.amount"}
                        },
                        {
                            "path": "temp_data.value_date",
                            "logic": {"var": "data.SwiftMT.fields.32A.value_date"}
                        },
                        {
                            "path": "warnings",
                            "logic": [
                                {
                                    "code": "T20200",
                                    "message": "Account/Currency is mandatory in CBPR+ camt.054. Currency extracted from field 32A.",
                                    "severity": "WARNING",
                                    "field": "32A",
                                    "extracted_currency": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]}
                                }
                            ]
                        }
                    ]
                }
            }
        }
    ]
}
