{
    "id": "mt900-document-mapper",
    "name": "MT900 to camt.054 Document Mapping for CBPR+",
    "description": "Maps MT900 message to ISO 20022 camt.054.001.08 BankToCustomerDebitCreditNotificationV08 document structure",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "900"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt900-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "PREC003_set_notification_type"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_document_notification_and_account",
            "name": "Construct Document Structure, Notification, and Account",
            "description": "Builds complete camt.054 document structure with notification and account information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn",
                            "logic": {
                                "GrpHdr": {
                                    "MsgId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "CreDtTm": "9999-12-31T00:00:00+00:00",
                                    "MsgRcpt": {
                                        "Nm": "CUSTOMER",
                                        "Id": {"OrgId": {"Othr": [{"Id": {"var": "temp_data.Receiver"}, "SchmeNm": {"Cd": "TXID"}}]}}
                                    }
                                },
                                "Ntfctn": [
                                    {
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            {"var": "data.SwiftMT.fields.20.reference"},
                                            "NOTPROVIDED"
                                        ]},
                                        "CreDtTm": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {
                                                "cat": [
                                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                                    "T",
                                                    {"format_date": [{"now": []}, "HH:mm:ss"]},
                                                    "+00:00"
                                                ]
                                            },
                                            "9999-12-31T00:00:00+00:00"
                                        ]},
                                        "FrToDt": {
                                            "FrDtTm": { "if": [
                                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                                {"cat": [{"var": "data.SwiftMT.fields.32A.value_date"}, "T00:00:00+00:00"]},
                                                "9999-12-31T00:00:00+00:00"
                                            ]},
                                            "ToDtTm": { "if": [
                                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                                {"cat": [{"var": "data.SwiftMT.fields.32A.value_date"}, "T23:59:59+00:00"]},
                                                "9999-12-31T23:59:59+00:00"
                                            ]}
                                        },
                                        "Acct": {
                                            "Id": {
                                                "Othr": {
                                                    "Id": { "if": [
                                                        {"var": "data.SwiftMT.fields.25.authorisation"},
                                                        {"var": "data.SwiftMT.fields.25.authorisation"},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.25.P.account"},
                                                            {"var": "data.SwiftMT.fields.25.P.account"},
                                                            "NOTPROVIDED"
                                                        ]}
                                                    ]}
                                                }
                                            },
                                            "Ccy": { "if": [
                                                {"var": "data.SwiftMT.fields.32A.currency"},
                                                {"var": "data.SwiftMT.fields.32A.currency"},
                                                "USD"
                                            ]},
                                            "Ownr": {
                                                "Id": {
                                                    "OrgId": {
                                                        "AnyBIC": { "if": [
                                                            {"var": "data.SwiftMT.fields.25.P.identifier_code"},
                                                            {"var": "data.SwiftMT.fields.25.P.identifier_code"},
                                                            null
                                                        ]}
                                                    }
                                                }
                                            },
                                            "Svcr": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_entry_structure",
            "name": "Construct Entry Structure",
            "description": "Builds entry structure with proper booking date handling from field 13D",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry",
                            "logic": [
                                {
                                    "NtryRef": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "Amt": {
                                        "@Ccy": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            "USD"
                                        ]},
                                        "$value": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            0.0
                                        ]}
                                    },
                                    "CdtDbtInd": "DBIT",
                                    "Sts": {"Cd": "BOOK"},
                                    "BookgDt": {
                                        "DtTm": { "if": [
                                            {"var": "data.SwiftMT.fields.13D.date"},
                                            {
                                                "cat": [
                                                    {"var": "data.SwiftMT.fields.13D.date"},
                                                    "T",
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.13D.time"},
                                                        {
                                                            "cat": [
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.time"}, 0, 2]
                                                                },
                                                                ":",
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.time"}, 2, 2]
                                                                },
                                                                ":",
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.time"}, 4, 2]
                                                                }
                                                            ]
                                                        },
                                                        "00:00:00"
                                                    ]},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.13D.offset_sign"},
                                                        {
                                                            "cat": [
                                                                {"var": "data.SwiftMT.fields.13D.offset_sign"},
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.offset_seconds"}, 0, 2]
                                                                },
                                                                ":",
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.offset_seconds"}, 2, 2]
                                                                }
                                                            ]
                                                        },
                                                        "+00:00"
                                                    ]}
                                                ]
                                            },
                                            "9999-12-31T00:00:00+00:00"
                                        ]}
                                    },
                                    "ValDt": {
                                        "Dt": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            "9999-12-31"
                                        ]}
                                    },
                                    "BkTxCd": {"Prtry": {"Cd": "NOTPROVIDED", "Issr": "NOTPROVIDED"}}
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_transaction_details",
            "name": "Construct Transaction Details",
            "description": "Builds transaction details structure with proper field 52 handling and processed field 72",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls",
                            "logic": [
                                {
                                    "TxDtls": [
                                        {
                                            "Refs": {
                                                "InstrId": { "if": [
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "EndToEndId": { "if": [
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "MsgId": { "if": [
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "AcctSvcrRef": { "if": [
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "UETR": { "if": [
                                                    {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                                    {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                                    null
                                                ]}
                                            },
                                            "Amt": {
                                                "@Ccy": { "if": [
                                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                                    "USD"
                                                ]},
                                                "$value": { "if": [
                                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                                    0.0
                                                ]}
                                            },
                                            "CdtDbtInd": "DBIT",
                                            "AmtDtls": {
                                                "TxAmt": {
                                                    "Amt": {
                                                        "@Ccy": { "if": [
                                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                                            "USD"
                                                        ]},
                                                        "$value": { "if": [
                                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                                            0.0
                                                        ]}
                                                    },
                                                    "CdtDbtInd": "DBIT"
                                                }
                                            },
                                            "RltdDts": {
                                                "IntrBkSttlmDt": { "if": [
                                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                                    "9999-12-31"
                                                ]}
                                            },
                                            "RltdPties": {
                                                "DbtrAcct": { "if": [
                                                    {"var": "data.SwiftMT.fields.52.A.party_identifier"},
                                                    { "if": [
                                                        { "and": [
                                                            {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//"]},
                                                            {"not": {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//CH"]}},
                                                            {"not": {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//FW"]}}
                                                        ]},
                                                        null,
                                                        {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.52.A.party_identifier"}}}}
                                                    ]},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.52.D.party_identifier"},
                                                        {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.52.D.party_identifier"}}}},
                                                        null
                                                    ]}
                                                ]},
                                                "DbtrAgt": {
                                                    "FinInstnId": { "if": [
                                                        {"var": "data.SwiftMT.fields.52.A"},
                                                        { "if": [
                                                            { "and": [
                                                                {"var": "data.SwiftMT.fields.52.A.party_identifier"},
                                                                {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//"]},
                                                                {"not": {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//CH"]}},
                                                                {"not": {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//FW"]}}
                                                            ]},
                                                            { "if": [
                                                                {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//RT"]},
                                                                {
                                                                    "ClrSysMmbId": {
                                                                        "ClrSysId": {"Cd": "ATBLZ"},
                                                                        "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, 4]}
                                                                    }
                                                                },
                                                                {
                                                                    "ClrSysMmbId": {
                                                                        "ClrSysId": {"Cd": "NOTPROVIDED"},
                                                                        "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, 2]}
                                                                    }
                                                                }
                                                            ]},
                                                            { "if": [
                                                                {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//CH"]},
                                                                {
                                                                    "ClrSysMmbId": {
                                                                        "ClrSysId": {"Cd": "CHSIC"},
                                                                        "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, 4]}
                                                                    }
                                                                },
                                                                { "if": [
                                                                    {"starts_with": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, "//FW"]},
                                                                    {
                                                                        "ClrSysMmbId": {
                                                                            "ClrSysId": {"Cd": "USABA"},
                                                                            "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52.A.party_identifier"}, 4]}
                                                                        }
                                                                    },
                                                                    {"BICFI": {"var": "data.SwiftMT.fields.52.A.bic"}}
                                                                ]}
                                                            ]}
                                                        ]},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.52.D"},
                                                            {
                                                                "Nm": {"var": "data.SwiftMT.fields.52.D.name_and_address.0"},
                                                                "PstlAdr": {"AdrLine": {"var": "data.SwiftMT.fields.52.D.name_and_address"}}
                                                            },
                                                            {"BICFI": {"var": "temp_data.Sender"}}
                                                        ]}
                                                    ]}
                                                }
                                            },
                                            "AddtlTxInf": { "if": [
                                                {"var": "data.SwiftMT.fields.72.information"},
                                                {
                                                    "trim": { "reduce": [
                                                        {"var": "data.SwiftMT.fields.72.information"},
                                                        { "if": [
                                                            {"==": [{"var": "index"}, 0]},
                                                            { "if": [
                                                                {"<": [{"length": {"var": "current"}}, 35]},
                                                                {"cat": [{"var": "current"}, " "]},
                                                                {"var": "current"}
                                                            ]},
                                                            { "if": [
                                                                {"starts_with": [{"var": "current"}, "//"]},
                                                                { "if": [
                                                                    {"<": [{"length": {"substr": [{"var": "current"}, 2]}}, 33]},
                                                                    {
                                                                        "cat": [{"var": "accumulator"}, {"substr": [{"var": "current"}, 2]}, " "]
                                                                    },
                                                                    {"cat": [{"var": "accumulator"}, {"substr": [{"var": "current"}, 2]}]}
                                                                ]},
                                                                { "if": [
                                                                    {"<": [{"length": {"var": "current"}}, 35]},
                                                                    {
                                                                        "cat": [{"var": "accumulator"}, {"var": "current"}, " "]
                                                                    },
                                                                    {"cat": [{"var": "accumulator"}, {"var": "current"}]}
                                                                ]}
                                                            ]}
                                                        ]},
                                                        ""
                                                    ]}
                                                },
                                                "MT900 Confirmation of Debit"
                                            ]}
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish Complete MX Message (AppHdr + Document)",
            "description": "Publish the complete MX message with both AppHdr and Document wrapped in MxEnvelope",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
