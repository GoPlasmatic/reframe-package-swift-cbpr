{
    "id": "mt202-rejt-document-mapper",
    "name": "MT202 REJT to pacs.002 Document Mapping for CBPR+",
    "description": "Maps MT202 REJT message to ISO 20022 pacs.002.001.10 FIToFIPaymentStatusReportV10 document structure according to CBPR+ rejection translation specification",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "202"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "reject"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt202-rejt-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "validate_uetr_present"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_rejection_status_report",
            "name": "Construct Complete Rejection Status Report",
            "description": "Constructs complete pacs.002 rejection status report with all agents, categorized reason codes, and transaction details inline",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.standard_reason_codes",
                            "logic": [
                                "AC01",
                                "AC04",
                                "AC06",
                                "AG01",
                                "AG02",
                                "AM05",
                                "BE05",
                                "MS03",
                                "RR01",
                                "RR02",
                                "RR03",
                                "RR04"
                            ]
                        },
                        {
                            "path": "temp_data.is_standard_code",
                            "logic": { "and": [
                                {"var": "temp_data.rejection_code"},
                                {"!=": [{"var": "temp_data.rejection_code"}, ""]},
                                {"in": [{"var": "temp_data.rejection_code"}, {"var": "temp_data.standard_reason_codes"}]}
                            ]}
                        },
                        {
                            "path": "temp_data.message_type_variant",
                            "logic": { "if": [
                                {"==": [{"var": "data.SwiftMT.user_header.validation_flag"}, "COV"]},
                                { "if": [
                                    {"==": [{"var": "data.SwiftMT.message_type"}, "202"]},
                                    "MT202 COVE",
                                    "MT205 COVE"
                                ]},
                                { "if": [
                                    {"==": [{"var": "data.SwiftMT.message_type"}, "202"]},
                                    "MT202",
                                    "MT205"
                                ]}
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FIToFIPmtStsRpt",
                            "logic": {
                                "GrpHdr": {
                                    "MsgId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "CreDtTm": "9999-12-31T00:00:00+00:00",
                                    "InstgAgt": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "temp_data.Sender"},
                                                {"var": "temp_data.Sender"},
                                                "NOTPROVIDED"
                                            ]}
                                        }
                                    },
                                    "InstdAgt": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "temp_data.Receiver"},
                                                {"var": "temp_data.Receiver"},
                                                "NOTPROVIDED"
                                            ]}
                                        }
                                    }
                                },
                                "TxInfAndSts": {
                                    "OrgnlGrpInf": {
                                        "OrgnlMsgId": { "if": [
                                            {"var": "temp_data.original_instruction_id"},
                                            {"var": "temp_data.original_instruction_id"},
                                            "NOTPROVIDED"
                                        ]},
                                        "OrgnlMsgNmId": {"var": "temp_data.message_type_variant"}
                                    },
                                    "OrgnlInstrId": { "if": [
                                        {"var": "temp_data.original_instruction_id"},
                                        {"var": "temp_data.original_instruction_id"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlEndToEndId": { "if": [
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        {"var": "data.SwiftMT.fields.21.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlUETR": { "if": [
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "OrgnlIntrBkSttlmAmt": {
                                        "@Ccy": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            "USD"
                                        ]},
                                        "$value": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            0.0
                                        ]}
                                    },
                                    "OrgnlIntrBkSttlmDt": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        "9999-12-31"
                                    ]},
                                    "OrgnlTxRef": {
                                        "IntrBkSttlmAmt": { "if": [
                                            {"var": "data.SwiftMT.fields.32A"},
                                            {
                                                "@Ccy": {"var": "data.SwiftMT.fields.32A.currency"},
                                                "$value": {"var": "data.SwiftMT.fields.32A.amount"}
                                            },
                                            null
                                        ]},
                                        "IntrBkSttlmDt": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            null
                                        ]},
                                        "DbtrAgt": { "if": [
                                            {"var": "data.SwiftMT.fields.52.A.bic"},
                                            {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.52.A.bic"}}},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.52.D"},
                                                {"FinInstnId": {"BICFI": "NOTPROVIDED"}},
                                                null
                                            ]}
                                        ]},
                                        "IntrmyAgt1": { "if": [
                                            {"var": "data.SwiftMT.fields.56.A.bic"},
                                            {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.56.A.bic"}}},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.56.D"},
                                                {"FinInstnId": {"BICFI": "NOTPROVIDED"}},
                                                null
                                            ]}
                                        ]},
                                        "CdtrAgt": { "if": [
                                            {"var": "data.SwiftMT.fields.57.A.bic"},
                                            {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.57.A.bic"}}},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.57.D"},
                                                {"FinInstnId": {"BICFI": "NOTPROVIDED"}},
                                                null
                                            ]}
                                        ]},
                                        "Cdtr": { "if": [
                                            {"var": "data.SwiftMT.fields.58.A.bic"},
                                            {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.58.A.bic"}}},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.58.D"},
                                                {"FinInstnId": {"BICFI": "NOTPROVIDED"}},
                                                null
                                            ]}
                                        ]}
                                    },
                                    "TxSts": "RJCT",
                                    "InstgAgt": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "temp_data.Sender"},
                                                {"var": "temp_data.Sender"},
                                                "NOTPROVIDED"
                                            ]}
                                        }
                                    },
                                    "InstdAgt": {
                                        "FinInstnId": {
                                            "BICFI": { "if": [
                                                {"var": "temp_data.Receiver"},
                                                {"var": "temp_data.Receiver"},
                                                "NOTPROVIDED"
                                            ]}
                                        }
                                    },
                                    "StsRsnInf": {
                                        "Rsn": {
                                            "Cd": { "if": [
                                                {"var": "temp_data.is_standard_code"},
                                                {"var": "temp_data.rejection_code"},
                                                null
                                            ]},
                                            "Prtry": { "if": [
                                                { "and": [
                                                    {"var": "temp_data.rejection_code"},
                                                    {"!=": [{"var": "temp_data.rejection_code"}, ""]},
                                                    {"!": {"var": "temp_data.is_standard_code"}}
                                                ]},
                                                {"var": "temp_data.rejection_code"},
                                                null
                                            ]}
                                        },
                                        "AddtlInf": { "if": [
                                            { "or": [
                                                { "and": [
                                                    {"var": "temp_data.additional_information"},
                                                    {"!=": [{"var": "temp_data.additional_information"}, ""]}
                                                ]},
                                                {"var": "temp_data.rejection_code"}
                                            ]},
                                            [
                                                { "if": [
                                                    {"var": "temp_data.rejection_code"},
                                                    {
                                                        "cat": ["/", {"var": "temp_data.rejection_code"}, "/"]
                                                    },
                                                    ""
                                                ]},
                                                { "if": [
                                                    {"var": "temp_data.additional_information"},
                                                    {"var": "temp_data.additional_information"},
                                                    ""
                                                ]}
                                            ],
                                            null
                                        ]}
                                    },
                                    "OrgnlGrpInfAndSts": {"OrgnlMsgNmId": {"var": "temp_data.message_type_variant"}, "GrpSts": "RJCT"}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
