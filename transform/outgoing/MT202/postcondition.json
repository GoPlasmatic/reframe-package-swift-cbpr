{
    "id": "mt202-postcondition",
    "name": "MT202 to pacs.009 Post-condition Validation",
    "description": "Post-condition validation for MT202 to pacs.009 CBPR+ transformation ensuring output compliance",
    "priority": 6,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "202"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt202-document-mapper"]},
        {"==": [{"var": "metadata.progress.task_id"}, "publish_document_xml"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "validate_settlement_and_routing",
            "name": "Validate Settlement Method and Routing",
            "description": "Validates settlement method determination and serial/cover routing",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.settlement_validation_error",
                            "logic": { "if": [
                                {
                                    "!": { "and": [
                                        {"var": "data.Document.FIToFICdtTrf.GrpHdr.SttlmInf.SttlmMtd"},
                                        {
                                            "in": [
                                                {"var": "data.Document.FIToFICdtTrf.GrpHdr.SttlmInf.SttlmMtd"},
                                                ["INDA", "INGA", "COVE"]
                                            ]
                                        }
                                    ]}
                                },
                                "T20001: Settlement method must be INDA, INGA, or COVE based on METAFCT002",
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.routing_validation_error",
                            "logic": { "if": [
                                {"==": [{"var": "temp_data.MTType"}, "COVER"]},
                                "T20089: COVER payment detected - must be routed to pacs.009 ADV workflow",
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_field_mappings",
            "name": "Validate Field Mappings and Processing",
            "description": "Validates clearing channel detection, time indications, field 72 instructions, and clearing system exclusions",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.clearing_channel_error",
                            "logic": { "if": [
                                { "and": [
                                    { "or": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.56.A.party_identifier"},
                                            { "or": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//RT"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//FW"]}
                                            ]}
                                        ]},
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.57.A.party_identifier"},
                                            { "or": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//RT"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//FW"]}
                                            ]}
                                        ]},
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.58.A.party_identifier"},
                                            { "or": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//RT"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//FW"]}
                                            ]}
                                        ]}
                                    ]},
                                    {"!=": [{"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.PmtTpInf.ClrChanl"}, "RTGS"]}
                                ]},
                                "T20230: RTGS clearing channel not properly detected from //RT or //FW patterns",
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.time_indication_error",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.13.C.time_indication"},
                                    {
                                        "!": { "or": [
                                            {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.SttlmTmIndctn.DbtDtTm"},
                                            {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.SttlmTmIndctn.CdtDtTm"},
                                            {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.SttlmTmIndctn.ClsTm"},
                                            {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.SttlmTmIndctn.TillTm"},
                                            {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.SttlmTmIndctn.FrTm"},
                                            {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.SttlmTmIndctn.RjctTm"}
                                        ]}
                                    }
                                ]},
                                "T20232: Time indication from field 13C not properly mapped",
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.field72_ins_error",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_72_has_ins"},
                                    { "or": [
                                        {"var": "temp_data.field_53a_bic_8char"},
                                        {"var": "temp_data.field_54a_bic_8char"}
                                    ]},
                                    {
                                        "!": {
                                            "some": [
                                                {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.InstrForNxtAgt"},
                                                {"starts_with": [{"var": "InstrInf"}, "/INS/"]}
                                            ]
                                        }
                                    }
                                ]},
                                "T20235: Field 72 /INS/ instruction not properly prioritized for field 53a/54a",
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.clearing_system_error",
                            "logic": { "if": [
                                { "and": [
                                    { "or": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.56.A.party_identifier"},
                                            { "or": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//CH"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//FW"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.56.A.party_identifier"}, "//RT"]}
                                            ]}
                                        ]},
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.57.A.party_identifier"},
                                            { "or": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//CH"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//FW"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.57.A.party_identifier"}, "//RT"]}
                                            ]}
                                        ]},
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.58.A.party_identifier"},
                                            { "or": [
                                                {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//CH"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//FW"]},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.58.A.party_identifier"}, "//RT"]}
                                            ]}
                                        ]}
                                    ]},
                                    { "or": [
                                        {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.IntrmyAgt1.FinInstnId.ClrSysMmbId"},
                                        {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.ClrSysMmbId"},
                                        {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.Cdtr.FinInstnId.ClrSysMmbId"}
                                    ]}
                                ]},
                                "T11001: Clearing system member IDs must not be populated for //CH, //FW, //RT patterns",
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "validate_formatting_and_complete",
            "name": "Validate Formatting and Mark Success",
            "description": "Validates service level code, field 72 truncation, and marks postcondition success",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.service_level_error",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.PmtTpInf.SvcLvl.Cd"},
                                    {
                                        "!": {
                                            "match": [
                                                {"var": "data.Document.FIToFICdtTrf.CdtTrfTxInf.PmtTpInf.SvcLvl.Cd"},
                                                "^G00[1-9]$"
                                            ]
                                        }
                                    }
                                ]},
                                "T20240: Service level code must match pattern G00n where n is 1-9",
                                null
                            ]}
                        },
                        {
                            "path": "temp_data.field72_truncation_error",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_72_concatenated"},
                                    {">": [{"length": {"var": "temp_data.field_72_concatenated"}}, 210]},
                                    {">": [{"length": {"var": "temp_data.instruction_for_next_agent"}}, 210]}
                                ]},
                                "T20250: Field 72 instructions must be truncated to 210 characters (6*35)",
                                null
                            ]}
                        },
                        {"path": "temp_data.postcondition_validation", "logic": "SUCCESS"},
                        {"path": "temp_data.mt202_compliance_version", "logic": "1.0.0"}
                    ]
                }
            }
        }
    ]
}
