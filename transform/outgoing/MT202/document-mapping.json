{
    "id": "mt202-document-mapper",
    "name": "MT202 to pacs.009 Document Mapping for CBPR+",
    "description": "Maps MT202 message to ISO 20022 pacs.009.001.08 FinancialInstitutionCreditTransferV08 document structure according to CBPR+ translation specification",
    "priority": 5,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "202"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt202-precondition"]},
        {
            "in": [
                {"var": "metadata.progress.task_id"},
                ["detect_clearing_and_payment_type", "MT205_set_serial_type"]
            ]
        },
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "determine_settlement_method_and_agents_metafct002",
            "name": "Determine Settlement Method and Agents with Complete METAFCT002",
            "description": "Implements complete METAFCT002 settlement method logic based on table determination with INDA/INGA/COVE methods and instruction generation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.settlement_method",
                            "logic": { "if": [
                                {"==": [{"var": "temp_data.MTType"}, "COVER"]},
                                "COVE",
                                { "if": [
                                    {"==": [{"var": "temp_data.metafct002_table"}, "TABLE1"]},
                                    "INDA",
                                    { "if": [
                                        {"==": [{"var": "temp_data.metafct002_table"}, "TABLE2"]},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/C"]}
                                            ]},
                                            "INGA",
                                            "INDA"
                                        ]},
                                        { "if": [
                                            {"==": [{"var": "temp_data.metafct002_table"}, "TABLE3"]},
                                            "INDA",
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/C"]}
                                                ]},
                                                "INGA",
                                                "INDA"
                                            ]}
                                        ]}
                                    ]}
                                ]}
                            ]}
                        },
                        {
                            "path": "temp_data.settlement_account",
                            "logic": { "if": [
                                { "and": [
                                    {"==": [{"var": "temp_data.settlement_method"}, "INGA"]},
                                    {"var": "data.SwiftMT.fields.53.B.party_identifier"},
                                    {"starts_with": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, "/C"]}
                                ]},
                                {"substr": [{"var": "data.SwiftMT.fields.53.B.party_identifier"}, 1]},
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.instruction_for_next_agent_fin53",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_72_has_ins"},
                                    {"var": "temp_data.field_53a_bic_8char"}
                                ]},
                                "/INS/",
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.instruction_for_next_agent_fin54",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_72_has_ins"},
                                    {"var": "temp_data.field_54a_bic_8char"}
                                ]},
                                "/INS/",
                                ""
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "extract_and_process_field72_tr008",
            "name": "TR008: Extract and Process Field 72 with Priority Logic",
            "description": "Implements TR008 field 72 processing with priority handling for InstructionForNextAgent codes and proper concatenation",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.field_72_concatenated",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "data.SwiftMT.fields.72.information"},
                                    {">": [{"length": {"var": "data.SwiftMT.fields.72.information"}}, 0]}
                                ]},
                                {
                                    "cat": [
                                        { "if": [
                                            {"var": "temp_data.instruction_for_next_agent_fin53"},
                                            {"var": "temp_data.instruction_for_next_agent_fin53"},
                                            ""
                                        ]},
                                        { "if": [
                                            {"var": "temp_data.instruction_for_next_agent_fin54"},
                                            {"var": "temp_data.instruction_for_next_agent_fin54"},
                                            ""
                                        ]},
                                        { "reduce": [
                                            {"var": "data.SwiftMT.fields.72.information"},
                                            { "if": [
                                                { "and": [
                                                    {"!": {"starts_with": [{"var": "current"}, "/INS/"]}},
                                                    { "or": [
                                                        {"starts_with": [{"var": "current"}, "/ACC/"]},
                                                        {"starts_with": [{"var": "current"}, "/UDLC/"]},
                                                        {"starts_with": [{"var": "current"}, "/BNF/"]},
                                                        {"starts_with": [{"var": "current"}, "/TSU/"]},
                                                        {"starts_with": [{"var": "current"}, "/TEXT/"]},
                                                        {"starts_with": [{"var": "current"}, "/PURP/"]}
                                                    ]}
                                                ]},
                                                {"cat": [{"var": "accumulator"}, {"var": "current"}]},
                                                {"var": "accumulator"}
                                            ]},
                                            ""
                                        ]}
                                    ]
                                },
                                ""
                            ]}
                        },
                        {
                            "path": "temp_data.instruction_for_next_agent",
                            "logic": { "if": [
                                { "and": [
                                    {"var": "temp_data.field_72_concatenated"},
                                    {">": [{"length": {"var": "temp_data.field_72_concatenated"}}, 210]}
                                ]},
                                {
                                    "substr": [{"var": "temp_data.field_72_concatenated"}, 0, 210]
                                },
                                { "if": [
                                    {"var": "temp_data.field_72_concatenated"},
                                    {"var": "temp_data.field_72_concatenated"},
                                    ""
                                ]}
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_group_header",
            "name": "Construct Group Header",
            "description": "Builds pacs.009 group header with message identification, creation timestamp, settlement information, and reimbursement agent details from MT202 fields and computed settlement method using structural output",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {"path": "data.MxEnvelope.Document.FICdtTrf.GrpHdr", "logic": {}},
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.GrpHdr",
                            "logic": {
                                "MsgId": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "CreDtTm": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"cat": [{"var": "data.SwiftMT.fields.32A.value_date"}, "T00:00:00+00:00"]},
                                    "9999-12-31T00:00:00+00:00"
                                ]},
                                "NbOfTxs": "1",
                                "TtlIntrBkSttlmAmt": {
                                    "@Ccy": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        {"var": "data.SwiftMT.fields.32A.currency"},
                                        "USD"
                                    ]},
                                    "$value": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        {"var": "data.SwiftMT.fields.32A.amount"},
                                        0.0
                                    ]}
                                },
                                "IntrBkSttlmDt": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                    "9999-12-31"
                                ]},
                                "SttlmInf": {
                                    "SttlmMtd": { "if": [
                                        {"var": "temp_data.settlement_method"},
                                        {"var": "temp_data.settlement_method"},
                                        "INDA"
                                    ]},
                                    "ClrChanl": { "if": [
                                        {"var": "temp_data.clearing_channel"},
                                        {"var": "temp_data.clearing_channel"},
                                        null
                                    ]},
                                    "SttlmAcct": { "if": [
                                        { "and": [
                                            {"var": "temp_data.settlement_account"},
                                            {"!=": [{"var": "temp_data.settlement_account"}, ""]}
                                        ]},
                                        {"Id": {"Othr": {"Id": {"var": "temp_data.settlement_account"}}}},
                                        null
                                    ]},
                                    "InstrReimbAgtAcct": { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.53.A.party_identifier"},
                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, "//"]}}
                                        ]},
                                        {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.53.A.party_identifier"}}}},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.53.A.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, "//CH"]}
                                            ]},
                                            {"Id": {"Othr": {"Id": {"substr": [{"var": "data.SwiftMT.fields.53.A.party_identifier"}, 4]}}}},
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.53.D.party_identifier"},
                                                    {"!": {"starts_with": [{"var": "data.SwiftMT.fields.53.D.party_identifier"}, "//"]}}
                                                ]},
                                                {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.53.D.party_identifier"}}}},
                                                { "if": [
                                                    { "and": [
                                                        {"var": "data.SwiftMT.fields.53.D.party_identifier"},
                                                        {"starts_with": [{"var": "data.SwiftMT.fields.53.D.party_identifier"}, "//CH"]}
                                                    ]},
                                                    {"Id": {"Othr": {"Id": {"substr": [{"var": "data.SwiftMT.fields.53.D.party_identifier"}, 4]}}}},
                                                    null
                                                ]}
                                            ]}
                                        ]}
                                    ]},
                                    "InstdReimbAgtAcct": { "if": [
                                        { "and": [
                                            {"var": "data.SwiftMT.fields.54.A.party_identifier"},
                                            {"!": {"starts_with": [{"var": "data.SwiftMT.fields.54.A.party_identifier"}, "//"]}}
                                        ]},
                                        {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.54.A.party_identifier"}}}},
                                        { "if": [
                                            { "and": [
                                                {"var": "data.SwiftMT.fields.54.A.party_identifier"},
                                                {"starts_with": [{"var": "data.SwiftMT.fields.54.A.party_identifier"}, "//CH"]}
                                            ]},
                                            {"Id": {"Othr": {"Id": {"substr": [{"var": "data.SwiftMT.fields.54.A.party_identifier"}, 4]}}}},
                                            { "if": [
                                                { "and": [
                                                    {"var": "data.SwiftMT.fields.54.D.party_identifier"},
                                                    {"!": {"starts_with": [{"var": "data.SwiftMT.fields.54.D.party_identifier"}, "//"]}}
                                                ]},
                                                {"Id": {"Othr": {"Id": {"var": "data.SwiftMT.fields.54.D.party_identifier"}}}},
                                                { "if": [
                                                    { "and": [
                                                        {"var": "data.SwiftMT.fields.54.D.party_identifier"},
                                                        {"starts_with": [{"var": "data.SwiftMT.fields.54.D.party_identifier"}, "//CH"]}
                                                    ]},
                                                    {"Id": {"Othr": {"Id": {"substr": [{"var": "data.SwiftMT.fields.54.D.party_identifier"}, 4]}}}},
                                                    null
                                                ]}
                                            ]}
                                        ]}
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_payment_id_fields",
            "name": "Map Payment ID Fields",
            "description": "Maps payment identification fields separately to debug UETR issue",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.PmtId",
                            "logic": {
                                "InstrId": { "if": [
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    {"var": "data.SwiftMT.fields.20.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "EndToEndId": { "if": [
                                    {"var": "data.SwiftMT.fields.21.reference"},
                                    {"var": "data.SwiftMT.fields.21.reference"},
                                    "NOTPROVIDED"
                                ]},
                                "UETR": {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_settlement_info",
            "name": "Map Settlement Information",
            "description": "Maps interbank settlement date from field 32A",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmDt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                "9999-12-31"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_instructing_instructed_agents",
            "name": "Map Instructing and Instructed Agents",
            "description": "Maps sender and receiver as instructing and instructed agents",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstgAgt",
                            "logic": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}
                        },
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.InstdAgt",
                            "logic": {"FinInstnId": {"BICFI": {"var": "temp_data.Receiver"}}}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_debtor_info",
            "name": "Map Debtor Information",
            "description": "Maps debtor financial institution from field 52",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.Dbtr",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.52.A.bic"},
                                        {"var": "data.SwiftMT.fields.52.A.bic"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.52.D.name_and_address"},
                                            {"var": "temp_data.Sender"},
                                            {"var": "temp_data.Sender"}
                                        ]}
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_debtor_agent",
            "name": "Map Debtor Agent",
            "description": "Maps debtor agent from field 53",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.DbtrAgt",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.53.A.bic"},
                                        {"var": "data.SwiftMT.fields.53.A.bic"},
                                        {"var": "temp_data.Sender"}
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_intermediary_agent",
            "name": "Map Intermediary Agent",
            "description": "Maps intermediary agent from field 56A/C/D",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.IntrmyAgt1",
                            "logic": { "if": [
                                { "or": [
                                    {"var": "data.SwiftMT.fields.56.A"},
                                    {"var": "data.SwiftMT.fields.56.C"},
                                    {"var": "data.SwiftMT.fields.56.D"}
                                ]},
                                {
                                    "FinInstnId": {
                                        "BICFI": { "if": [
                                            {"var": "data.SwiftMT.fields.56.A.bic"},
                                            {"var": "data.SwiftMT.fields.56.A.bic"},
                                            null
                                        ]},
                                        "ClrSysMmbId": { "if": [
                                            {"var": "data.SwiftMT.fields.56.C.party_identifier"},
                                            {
                                                "ClrSysId": {
                                                    "Cd": { "if": [
                                                        {"starts_with": [{"var": "data.SwiftMT.fields.56.C.party_identifier"}, "//CH"]},
                                                        "CHBCC",
                                                        { "if": [
                                                            {"starts_with": [{"var": "data.SwiftMT.fields.56.C.party_identifier"}, "//SC"]},
                                                            "SESBA",
                                                            "NOTPROVIDED"
                                                        ]}
                                                    ]}
                                                },
                                                "MmbId": { "if": [
                                                    {"starts_with": [{"var": "data.SwiftMT.fields.56.C.party_identifier"}, "//"]},
                                                    {"substr": [{"var": "data.SwiftMT.fields.56.C.party_identifier"}, 4]},
                                                    {"var": "data.SwiftMT.fields.56.C.party_identifier"}
                                                ]}
                                            },
                                            null
                                        ]},
                                        "Nm": { "if": [
                                            {"var": "data.SwiftMT.fields.56.D.name_and_address.0"},
                                            {"var": "data.SwiftMT.fields.56.D.name_and_address.0"},
                                            null
                                        ]},
                                        "PstlAdr": { "if": [
                                            {">": [{"length": {"var": "data.SwiftMT.fields.56.D.name_and_address"}}, 1]},
                                            {
                                                "AdrLine": {
                                                    "slice": [
                                                        {"var": "data.SwiftMT.fields.56.D.name_and_address"},
                                                        1,
                                                        {"min": [5, {"length": {"var": "data.SwiftMT.fields.56.D.name_and_address"}}]}
                                                    ]
                                                }
                                            },
                                            null
                                        ]}
                                    }
                                },
                                null
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_creditor_agent",
            "name": "Map Creditor Agent",
            "description": "Maps creditor agent from field 57A/B/C/D - simplified for standard case",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.CdtrAgt",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.57.A.bic"},
                                        {"var": "data.SwiftMT.fields.57.A.bic"},
                                        { "if": [
                                            {"var": "data.SwiftMT.fields.57.B.location"},
                                            {"var": "temp_data.Receiver"},
                                            {"var": "temp_data.Receiver"}
                                        ]}
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_creditor_info",
            "name": "Map Creditor Information",
            "description": "Maps creditor financial institution from field 58",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.Cdtr",
                            "logic": {
                                "FinInstnId": {
                                    "BICFI": { "if": [
                                        {"var": "data.SwiftMT.fields.58.A.bic"},
                                        {"var": "data.SwiftMT.fields.58.A.bic"},
                                        {"var": "temp_data.Receiver"}
                                    ]}
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_settlement_amount",
            "name": "Map Settlement Amount",
            "description": "Maps interbank settlement amount from field 32A",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.FICdtTrf.CdtTrfTxInf.IntrBkSttlmAmt",
                            "logic": {
                                "@Ccy": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    "USD"
                                ]},
                                "$value": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                    0.0
                                ]}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish MX Message",
            "description": "Publish the complete MX message with AppHdr and Document",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
