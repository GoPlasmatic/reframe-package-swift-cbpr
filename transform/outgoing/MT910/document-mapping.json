{
    "id": "mt910-document-mapper",
    "name": "MT910 to camt.054 Document Mapping for CBPR+",
    "description": "Maps MT910 message to ISO 20022 camt.054.001.08 BankToCustomerDebitCreditNotificationV08 document structure",
    "priority": 4,
    "condition": { "and": [
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "910"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "mt910-precondition"]},
        {"==": [{"var": "metadata.progress.task_id"}, "PREC003_set_notification_type"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_document_structure",
            "name": "Construct camt.054 Document Structure",
            "description": "Builds complete camt.054 document structure using structural output pattern from reference implementations",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn",
                            "logic": {
                                "GrpHdr": {
                                    "MsgId": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "CreDtTm": "9999-12-31T00:00:00+00:00",
                                    "MsgRcpt": {
                                        "Nm": "CUSTOMER",
                                        "Id": {"OrgId": {"Othr": [{"Id": {"var": "temp_data.Receiver"}, "SchmeNm": {"Cd": "TXID"}}]}}
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_notification_structure",
            "name": "Construct Notification Structure",
            "description": "Builds notification structure with proper date handling and account information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn",
                            "logic": [
                                {
                                    "Id": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "CreDtTm": { "if": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        {
                                            "cat": [
                                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                                "T",
                                                {"format_date": [{"now": []}, "HH:mm:ss"]},
                                                "+00:00"
                                            ]
                                        },
                                        "9999-12-31T00:00:00+00:00"
                                    ]},
                                    "FrToDt": {
                                        "FrDtTm": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {"cat": [{"var": "data.SwiftMT.fields.32A.value_date"}, "T00:00:00+00:00"]},
                                            "9999-12-31T00:00:00+00:00"
                                        ]},
                                        "ToDtTm": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {"cat": [{"var": "data.SwiftMT.fields.32A.value_date"}, "T23:59:59+00:00"]},
                                            "9999-12-31T23:59:59+00:00"
                                        ]}
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_account_structure",
            "name": "Construct Account Structure",
            "description": "Builds account structure with proper field 25/25P handling and currency extraction",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Acct",
                            "logic": {
                                "Id": {
                                    "Othr": {
                                        "Id": { "if": [
                                            {"var": "data.SwiftMT.fields.25.authorisation"},
                                            {"var": "data.SwiftMT.fields.25.authorisation"},
                                            { "if": [
                                                {"var": "data.SwiftMT.fields.25.P.account"},
                                                {"var": "data.SwiftMT.fields.25.P.account"},
                                                "NOTPROVIDED"
                                            ]}
                                        ]}
                                    }
                                },
                                "Ccy": { "if": [
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                    "USD"
                                ]},
                                "Ownr": {
                                    "Id": {
                                        "OrgId": {
                                            "AnyBIC": { "if": [
                                                {"var": "data.SwiftMT.fields.25.NoOption.bic"},
                                                {"var": "data.SwiftMT.fields.25.NoOption.bic"},
                                                { "if": [
                                                    {"var": "data.SwiftMT.fields.25.P.identifier_code"},
                                                    {"var": "data.SwiftMT.fields.25.P.identifier_code"},
                                                    null
                                                ]}
                                            ]}
                                        }
                                    }
                                },
                                "Svcr": {"FinInstnId": {"BICFI": {"var": "temp_data.Sender"}}}
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_entry_structure",
            "name": "Construct Entry Structure",
            "description": "Builds entry structure with proper booking date handling from field 13D",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry",
                            "logic": [
                                {
                                    "NtryRef": { "if": [
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        {"var": "data.SwiftMT.fields.20.reference"},
                                        "NOTPROVIDED"
                                    ]},
                                    "Amt": {
                                        "@Ccy": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                            "USD"
                                        ]},
                                        "$value": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                            0.0
                                        ]}
                                    },
                                    "CdtDbtInd": "CRDT",
                                    "Sts": {"Cd": "BOOK"},
                                    "BookgDt": {
                                        "DtTm": { "if": [
                                            {"var": "data.SwiftMT.fields.13D.date"},
                                            {
                                                "cat": [
                                                    {"var": "data.SwiftMT.fields.13D.date"},
                                                    "T",
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.13D.time"},
                                                        {
                                                            "cat": [
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.time"}, 0, 2]
                                                                },
                                                                ":",
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.time"}, 2, 2]
                                                                },
                                                                ":",
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.time"}, 4, 2]
                                                                }
                                                            ]
                                                        },
                                                        "00:00:00"
                                                    ]},
                                                    { "if": [
                                                        {"var": "data.SwiftMT.fields.13D.offset_sign"},
                                                        {
                                                            "cat": [
                                                                {"var": "data.SwiftMT.fields.13D.offset_sign"},
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.offset_seconds"}, 0, 2]
                                                                },
                                                                ":",
                                                                {
                                                                    "substr": [{"var": "data.SwiftMT.fields.13D.offset_seconds"}, 2, 2]
                                                                }
                                                            ]
                                                        },
                                                        "+00:00"
                                                    ]}
                                                ]
                                            },
                                            "9999-12-31T00:00:00+00:00"
                                        ]}
                                    },
                                    "ValDt": {
                                        "Dt": { "if": [
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            {"var": "data.SwiftMT.fields.32A.value_date"},
                                            "9999-12-31"
                                        ]}
                                    },
                                    "BkTxCd": {"Prtry": {"Cd": "NOTPROVIDED", "Issr": "NOTPROVIDED"}}
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "id": "construct_transaction_details",
            "name": "Construct Transaction Details with Field 50 and 52 Logic",
            "description": "Builds transaction details structure with proper field 50 (Ordering Customer), field 52 (Ordering Institution), field 56 (Intermediary), and field 72 handling",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MxEnvelope.Document.BkToCstmrDbtCdtNtfctn.Ntfctn.0.Ntry.0.NtryDtls",
                            "logic": [
                                {
                                    "TxDtls": [
                                        {
                                            "Refs": {
                                                "InstrId": { "if": [
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "EndToEndId": { "if": [
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    {"var": "data.SwiftMT.fields.21.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "MsgId": { "if": [
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "AcctSvcrRef": { "if": [
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    {"var": "data.SwiftMT.fields.20.reference"},
                                                    "NOTPROVIDED"
                                                ]},
                                                "UETR": { "if": [
                                                    {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                                    {"var": "data.SwiftMT.user_header.unique_end_to_end_reference"},
                                                    null
                                                ]}
                                            },
                                            "Amt": {
                                                "@Ccy": { "if": [
                                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                                    {"var": "data.SwiftMT.fields.32A.currency"},
                                                    "USD"
                                                ]},
                                                "$value": { "if": [
                                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                                    {"var": "data.SwiftMT.fields.32A.amount"},
                                                    0.0
                                                ]}
                                            },
                                            "CdtDbtInd": "CRDT",
                                            "AmtDtls": {
                                                "TxAmt": {
                                                    "Amt": {
                                                        "@Ccy": { "if": [
                                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                                            {"var": "data.SwiftMT.fields.32A.currency"},
                                                            "USD"
                                                        ]},
                                                        "$value": { "if": [
                                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                                            {"var": "data.SwiftMT.fields.32A.amount"},
                                                            0.0
                                                        ]}
                                                    },
                                                    "CdtDbtInd": "CRDT"
                                                }
                                            },
                                            "RltdDts": {
                                                "IntrBkSttlmDt": { "if": [
                                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                                    {"var": "data.SwiftMT.fields.32A.value_date"},
                                                    "9999-12-31"
                                                ]}
                                            },
                                            "RltdPties": { "if": [
                                                { "or": [
                                                    {"var": "data.SwiftMT.fields.50A"},
                                                    {"var": "data.SwiftMT.fields.50F"},
                                                    {"var": "data.SwiftMT.fields.50K"}
                                                ]},
                                                {
                                                    "Cdtr": { "if": [
                                                        {"var": "data.SwiftMT.fields.50A"},
                                                        {"Id": {"OrgId": {"AnyBIC": {"var": "data.SwiftMT.fields.50A.bic"}}}},
                                                        { "if": [
                                                            {"var": "data.SwiftMT.fields.50F"},
                                                            { "if": [
                                                                {"starts_with": [{"var": "data.SwiftMT.fields.50F.party_identifier"}, "/"]},
                                                                {
                                                                    "Id": {
                                                                        "OrgId": {
                                                                            "Othr": [
                                                                                {
                                                                                    "Id": {"substr": [{"var": "data.SwiftMT.fields.50F.party_identifier"}, 1]},
                                                                                    "SchmeNm": {"Cd": "TXID"}
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                },
                                                                {
                                                                    "Nm": { "if": [
                                                                        {"var": "data.SwiftMT.fields.50F.name_and_address.0"},
                                                                        {"var": "data.SwiftMT.fields.50F.name_and_address.0"},
                                                                        "NOTPROVIDED"
                                                                    ]},
                                                                    "PstlAdr": {
                                                                        "AdrLine": { "if": [
                                                                            {"var": "data.SwiftMT.fields.50F.name_and_address"},
                                                                            {"var": "data.SwiftMT.fields.50F.name_and_address"},
                                                                            ["NOTPROVIDED"]
                                                                        ]}
                                                                    }
                                                                }
                                                            ]},
                                                            { "if": [
                                                                {"var": "data.SwiftMT.fields.50K"},
                                                                {
                                                                    "Nm": { "if": [
                                                                        {"var": "data.SwiftMT.fields.50K.name_and_address.0"},
                                                                        {"var": "data.SwiftMT.fields.50K.name_and_address.0"},
                                                                        "NOTPROVIDED"
                                                                    ]},
                                                                    "PstlAdr": {
                                                                        "AdrLine": { "if": [
                                                                            {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                                                            {"var": "data.SwiftMT.fields.50K.name_and_address"},
                                                                            ["NOTPROVIDED"]
                                                                        ]}
                                                                    }
                                                                },
                                                                null
                                                            ]}
                                                        ]}
                                                    ]},
                                                    "CdtrAcct": {
                                                        "Id": {
                                                            "Othr": {
                                                                "Id": { "if": [
                                                                    {"var": "data.SwiftMT.fields.50A.party_identifier"},
                                                                    {"var": "data.SwiftMT.fields.50A.party_identifier"},
                                                                    { "if": [
                                                                        { "and": [
                                                                            {"var": "data.SwiftMT.fields.50F.party_identifier"},
                                                                            {"not": {"starts_with": [{"var": "data.SwiftMT.fields.50F.party_identifier"}, "/"]}}
                                                                        ]},
                                                                        {"var": "data.SwiftMT.fields.50F.party_identifier"},
                                                                        { "if": [
                                                                            {"var": "data.SwiftMT.fields.50K.account"},
                                                                            {"var": "data.SwiftMT.fields.50K.account"},
                                                                            "NOTPROVIDED"
                                                                        ]}
                                                                    ]}
                                                                ]}
                                                            }
                                                        }
                                                    },
                                                    "CdtrAgt": { "if": [
                                                        { "and": [
                                                            { "or": [
                                                                {"var": "data.SwiftMT.fields.52A"},
                                                                {"var": "data.SwiftMT.fields.52D"}
                                                            ]},
                                                            { "or": [
                                                                {"var": "data.SwiftMT.fields.50A"},
                                                                {"var": "data.SwiftMT.fields.50F"},
                                                                {"var": "data.SwiftMT.fields.50K"}
                                                            ]}
                                                        ]},
                                                        {
                                                            "FinInstnId": { "if": [
                                                                {"var": "data.SwiftMT.fields.52A"},
                                                                { "if": [
                                                                    {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//CH"]},
                                                                    {
                                                                        "ClrSysMmbId": {
                                                                            "ClrSysId": {"Cd": "CHSIC"},
                                                                            "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 4]}
                                                                        }
                                                                    },
                                                                    { "if": [
                                                                        {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//FW"]},
                                                                        {
                                                                            "ClrSysMmbId": {
                                                                                "ClrSysId": {"Cd": "USABA"},
                                                                                "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 4]}
                                                                            }
                                                                        },
                                                                        { "if": [
                                                                            {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//RT"]},
                                                                            {
                                                                                "ClrSysMmbId": {
                                                                                    "ClrSysId": {"Cd": "ATBLZ"},
                                                                                    "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 4]}
                                                                                }
                                                                            },
                                                                            {"BICFI": {"var": "data.SwiftMT.fields.52A.bic"}}
                                                                        ]}
                                                                    ]}
                                                                ]},
                                                                { "if": [
                                                                    {"var": "data.SwiftMT.fields.52D"},
                                                                    {
                                                                        "Nm": {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                                                        "PstlAdr": {"AdrLine": {"var": "data.SwiftMT.fields.52D.name_and_address"}}
                                                                    },
                                                                    null
                                                                ]}
                                                            ]}
                                                        },
                                                        null
                                                    ]}
                                                },
                                                {}
                                            ]},
                                            "RltdAgts": { "if": [
                                                {
                                                    "not": { "or": [
                                                        {"var": "data.SwiftMT.fields.50A"},
                                                        {"var": "data.SwiftMT.fields.50F"},
                                                        {"var": "data.SwiftMT.fields.50K"}
                                                    ]}
                                                },
                                                { "if": [
                                                    { "or": [
                                                        {"var": "data.SwiftMT.fields.52A"},
                                                        {"var": "data.SwiftMT.fields.52D"}
                                                    ]},
                                                    {
                                                        "CdtrAgt": {
                                                            "FinInstnId": { "if": [
                                                                {"var": "data.SwiftMT.fields.52A"},
                                                                { "if": [
                                                                    {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//CH"]},
                                                                    {
                                                                        "ClrSysMmbId": {
                                                                            "ClrSysId": {"Cd": "CHSIC"},
                                                                            "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 4]}
                                                                        }
                                                                    },
                                                                    { "if": [
                                                                        {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//FW"]},
                                                                        {
                                                                            "ClrSysMmbId": {
                                                                                "ClrSysId": {"Cd": "USABA"},
                                                                                "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 4]}
                                                                            }
                                                                        },
                                                                        { "if": [
                                                                            {"starts_with": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, "//RT"]},
                                                                            {
                                                                                "ClrSysMmbId": {
                                                                                    "ClrSysId": {"Cd": "ATBLZ"},
                                                                                    "MmbId": {"substr": [{"var": "data.SwiftMT.fields.52A.party_identifier"}, 4]}
                                                                                }
                                                                            },
                                                                            {"BICFI": {"var": "data.SwiftMT.fields.52A.bic"}}
                                                                        ]}
                                                                    ]}
                                                                ]},
                                                                { "if": [
                                                                    {"var": "data.SwiftMT.fields.52D"},
                                                                    {
                                                                        "Nm": {"var": "data.SwiftMT.fields.52D.name_and_address.0"},
                                                                        "PstlAdr": {"AdrLine": {"var": "data.SwiftMT.fields.52D.name_and_address"}}
                                                                    },
                                                                    null
                                                                ]}
                                                            ]}
                                                        },
                                                        "IntrmyAgt1": { "if": [
                                                            {"var": "data.SwiftMT.fields.56A"},
                                                            {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.56A.bic"}}},
                                                            { "if": [
                                                                {"var": "data.SwiftMT.fields.56D"},
                                                                {"FinInstnId": {"Nm": {"var": "data.SwiftMT.fields.56D.name_and_address.0"}}},
                                                                null
                                                            ]}
                                                        ]}
                                                    },
                                                    {
                                                        "IntrmyAgt1": { "if": [
                                                            {"var": "data.SwiftMT.fields.56A"},
                                                            {"FinInstnId": {"BICFI": {"var": "data.SwiftMT.fields.56A.bic"}}},
                                                            { "if": [
                                                                {"var": "data.SwiftMT.fields.56D"},
                                                                {"FinInstnId": {"Nm": {"var": "data.SwiftMT.fields.56D.name_and_address.0"}}},
                                                                null
                                                            ]}
                                                        ]}
                                                    }
                                                ]},
                                                {}
                                            ]},
                                            "AddtlTxInf": { "if": [
                                                {"var": "data.SwiftMT.fields.72.information"},
                                                {
                                                    "trim": { "reduce": [
                                                        {"var": "data.SwiftMT.fields.72.information"},
                                                        { "if": [
                                                            {"==": [{"var": "index"}, 0]},
                                                            { "if": [
                                                                {"<": [{"length": {"var": "current"}}, 35]},
                                                                {"cat": [{"var": "current"}, " "]},
                                                                {"var": "current"}
                                                            ]},
                                                            { "if": [
                                                                {"starts_with": [{"var": "current"}, "//"]},
                                                                { "if": [
                                                                    {"<": [{"length": {"substr": [{"var": "current"}, 2]}}, 33]},
                                                                    {
                                                                        "cat": [{"var": "accumulator"}, {"substr": [{"var": "current"}, 2]}, " "]
                                                                    },
                                                                    {"cat": [{"var": "accumulator"}, {"substr": [{"var": "current"}, 2]}]}
                                                                ]},
                                                                { "if": [
                                                                    {"<": [{"length": {"var": "current"}}, 35]},
                                                                    {
                                                                        "cat": [{"var": "accumulator"}, {"var": "current"}, " "]
                                                                    },
                                                                    {"cat": [{"var": "accumulator"}, {"var": "current"}]}
                                                                ]}
                                                            ]}
                                                        ]},
                                                        ""
                                                    ]}
                                                },
                                                "MT910 Confirmation of Credit"
                                            ]}
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_mx_message",
            "name": "Publish Complete MX Message (AppHdr + Document)",
            "description": "Publish the complete MX message with both AppHdr and Document wrapped in MxEnvelope",
            "function": {"name": "publish_mx", "input": {"source": "MxEnvelope", "target": "result"}}
        }
    ]
}
