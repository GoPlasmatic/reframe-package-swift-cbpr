{
    "id": "mt910-bah-mapper",
    "name": "MT910 Business Application Header Mapping for CBPR+",
    "description": "Maps MT910 message to ISO 20022 Business Application Header (AppHdr) using head.001.001.02 schema for camt.054 notification",
    "priority": 2,
    "condition": { "and": [
        {"==": [{"var": "metadata.direction"}, "outgoing"]},
        {"==": [{"var": "metadata.SwiftMT.message_type"}, "910"]},
        {"==": [{"var": "metadata.SwiftMT.method"}, "normal"]},
        {"==": [{"var": "metadata.progress.workflow_id"}, "parser"]},
        {"==": [{"var": "metadata.progress.task_id"}, "parse_mt_message"]},
        {"==": [{"var": "metadata.progress.status_code"}, 200]}
    ]},
    "tasks": [
        {
            "id": "construct_business_application_header",
            "name": "Construct CBPR+ Business Application Header and Related Metadata",
            "description": "Maps MT910 to complete ISO 20022 BAH with sender/receiver extraction and related message metadata",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "temp_data.Sender",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "temp_data.Receiver",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.AppHdr.Fr.FIId.FinInstnId.BICFI",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.AppHdr.To.FIId.FinInstnId.BICFI",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.AppHdr.BizMsgIdr",
                            "logic": {"cat": [{"var": "data.SwiftMT.fields.20.reference"}, "-camt.054-001"]}
                        },
                        {"path": "data.MxEnvelope.AppHdr.MsgDefIdr", "logic": "camt.054.001.08"},
                        {"path": "data.MxEnvelope.AppHdr.BizSvc", "logic": "swift.cbprplus.02"},
                        {
                            "path": "data.MxEnvelope.AppHdr.CreDt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                {
                                    "cat": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        "T",
                                        {"format_date": [{"now": []}, "HH:mm:ss"]},
                                        "+00:00"
                                    ]
                                },
                                "9999-12-31T00:00:00+00:00"
                            ]}
                        },
                        {"path": "data.MxEnvelope.AppHdr.CpyDplct", "logic": "CODU"},
                        {"path": "data.MxEnvelope.AppHdr.PssblDplct", "logic": false},
                        {"path": "data.MxEnvelope.AppHdr.Prty", "logic": "NORM"},
                        {
                            "path": "data.MxEnvelope.AppHdr.Rltd.Fr.FIId.FinInstnId.BICFI",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                {"var": "data.SwiftMT.basic_header.sender_bic"},
                                "NOTPROVIDED"
                            ]}
                        },
                        {
                            "path": "data.MxEnvelope.AppHdr.Rltd.To.FIId.FinInstnId.BICFI",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                {"var": "data.SwiftMT.application_header.receiver_bic"},
                                "NOTPROVIDED"
                            ]}
                        },
                        {"path": "data.MxEnvelope.AppHdr.Rltd.MsgDefIdr", "logic": "camt.054.001.08"},
                        {
                            "path": "data.MxEnvelope.AppHdr.Rltd.BizMsgIdr",
                            "logic": {"var": "data.SwiftMT.fields.20.reference"}
                        },
                        {
                            "path": "data.MxEnvelope.AppHdr.Rltd.CreDt",
                            "logic": { "if": [
                                {"var": "data.SwiftMT.fields.32A.value_date"},
                                {
                                    "cat": [
                                        {"var": "data.SwiftMT.fields.32A.value_date"},
                                        "T",
                                        {"format_date": [{"now": []}, "HH:mm:ss"]},
                                        "+00:00"
                                    ]
                                },
                                "9999-12-31T00:00:00+00:00"
                            ]}
                        }
                    ]
                }
            }
        },
        {
            "id": "map_related_message_metadata",
            "name": "Map Related Message Metadata for Workflow Coordination",
            "description": "Set metadata to indicate BAH mapping completion for precondition triggering",
            "function": {
                "name": "map",
                "input": {"mappings": [{"path": "temp_data.bah_mapping_complete", "logic": true}]}
            }
        }
    ]
}
